<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Chromy Chen">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2023/11/23/test/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="转载自博客园https:&#x2F;&#x2F;www.cnblogs.com&#x2F;leffss&#x2F;p&#x2F;15598094.html 原作者：https:&#x2F;&#x2F;home.cnblogs.com&#x2F;u&#x2F;leffss&#x2F; 目录  一、规划  主机规划  系统拓扑  Vmware 虚拟机网络配置  虚拟网络设置 ha node controller + network node compute node ceph node   整体规划">
<meta property="og:type" content="article">
<meta property="og:title" content="&lt;转&gt;openstack高可用集群搭建(分布式路由)(train版)">
<meta property="og:url" content="http://example.com/2023/11/23/test/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="转载自博客园https:&#x2F;&#x2F;www.cnblogs.com&#x2F;leffss&#x2F;p&#x2F;15598094.html 原作者：https:&#x2F;&#x2F;home.cnblogs.com&#x2F;u&#x2F;leffss&#x2F; 目录  一、规划  主机规划  系统拓扑  Vmware 虚拟机网络配置  虚拟网络设置 ha node controller + network node compute node ceph node   整体规划">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111231723742.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111081632888.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111081633336.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111161003689.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111231722703.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111081636775.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111041259114.webp">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111041300835.webp">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111041445300.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111041446630.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111041512175.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111041514657.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111041516604.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111041534702.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111041837974.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111041855768.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111231317249.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091117888.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091118274.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091126128.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091127965.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091129875.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091130586.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111232105683.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111232105260.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091503134.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091504744.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091505254.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091506606.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091132698.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091132077.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091512662.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091512631.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091513134.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091515544.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091516373.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091520498.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091521987.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091521093.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091521908.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091522735.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091529548.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091530412.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091531045.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091545065.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091605012.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091642053.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091642994.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091644604.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091647058.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091645685.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091651880.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091652719.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091652100.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091653477.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091653300.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091655298.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091658537.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111091709278.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111101227824.webp">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111101249333.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111101309543.webp">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111121043328.webp">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111101310108.webp">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111101920716.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111101922271.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111102001607.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111102002694.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111102047269.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111102047053.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111102014876.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111102015585.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111102017825.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111102018434.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111102027181.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111102039046.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111102054862.webp">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111111032591.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111111036789.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111222046328.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111222047130.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111222047665.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111222048097.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111222048081.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111222049262.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111222050120.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111222105239.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111222052369.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111222054613.png">
<meta property="og:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111222055750.png">
<meta property="article:published_time" content="2023-11-23T01:39:40.000Z">
<meta property="article:modified_time" content="2023-11-23T01:58:47.801Z">
<meta property="article:author" content="Chromy Chen">
<meta property="article:tag" content="Openstack">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/leffss/images/master/img/202111231723742.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/Chromy1201/imagebed/UsuallyUsed/Avatar.png" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/Chromy1201/imagebed/UsuallyUsed/Avatar.png">
    <meta name="theme-color" content="#AF9B2D">
    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/Chromy1201/imagebed/UsuallyUsed/Avatar.png">
    <!--- Page Info-->
    
    <title>
        
            &lt;转&gt;openstack高可用集群搭建(分布式路由)(train版) -
        
        Chromy&#39;s Personal Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/assets/fonts.css">

    <!--- Font Part-->
    
        <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap" rel="stylesheet">
    
    
    
        <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap" rel="stylesheet">
    
    
        <link href="https://fonts.googleapis.com/css2?family=Forum&display=swap" rel="stylesheet">
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"example.com","root":"/","language":"en"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[""]},"code_block":{"copy":true,"style":"simple","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":false,"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#AF9B2D","secondary":null},"global":{"fonts":{"chinese":{"enable":true,"family":"Noto Serif SC","url":"https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap"},"english":{"enable":true,"family":"Forum","url":"https://fonts.googleapis.com/css2?family=Forum&display=swap"}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"busuanzi_counter":{"enable":false,"site_pv":true,"site_uv":true,"post_pv":true},"pjax":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"static","image":{"light":"https://cdn.jsdelivr.net/gh/Chromy1201/imagebed/UsuallyUsed/wheat-field-light.jpg","dark":"https://cdn.jsdelivr.net/gh/Chromy1201/imagebed/UsuallyUsed/wheat-field-dark.jpg"},"title":"Hello! This is Chromy.","subtitle":{"text":[],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":true,"family":"Noto Serif SC","url":"https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap"},"social_links":{"enable":false,"links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.7.1","navbar":{"auto_hide":false,"color":{"left":"#367df7","right":"#ced3db","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"About":{"icon":"fa-regular fa-user","submenus":{"Github":"https://github.com/Chromy1201","Twitter":"https://twitter.com/ChromyWasTaken","Youtube":"https://www.youtube.com/@ChromyWasTaken","Steam":"https://steamcommunity.com/profiles/76561199057461426","Bilibili":"https://space.bilibili.com/303493219","Murmurs":"/murmurs"}}},"search":{"enable":false,"preload":true},"tags":{"Tags":{"icon":"fa-solid fa-tags","path":"/tags/"}},"categories":{"Categories":{"icon":"fa-solid fa-folder","path":"/categories/"}}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":null},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}}};
    Global.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    Global.data_config = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="main-content-container">

        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="https://cdn.jsdelivr.net/gh/Chromy1201/imagebed/UsuallyUsed/Avatar.png">
                </a>
            
            <a class="logo-title" href="/">
                
                Chromy&#39;s Personal Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        ARCHIVES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/Chromy1201">GITHUB
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://twitter.com/ChromyWasTaken">TWITTER
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://www.youtube.com/@ChromyWasTaken">YOUTUBE
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://steamcommunity.com/profiles/76561199057461426">STEAM
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://space.bilibili.com/303493219">BILIBILI
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a href="/murmurs">MURMURS
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer">
        <ul class="drawer-navbar-list">
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                ARCHIVES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://github.com/Chromy1201">GITHUB</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://twitter.com/ChromyWasTaken">TWITTER</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://www.youtube.com/@ChromyWasTaken">YOUTUBE</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://steamcommunity.com/profiles/76561199057461426">STEAM</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://space.bilibili.com/303493219">BILIBILI</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" href="/murmurs">MURMURS</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">&lt;转&gt;openstack高可用集群搭建(分布式路由)(train版)</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="https://cdn.jsdelivr.net/gh/Chromy1201/imagebed/UsuallyUsed/Avatar.png">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Chromy Chen</span>
                            
                                <span class="author-label"></span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-11-23 09:39:40</span>
        <span class="mobile">2023-11-23 09:39</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-11-23 09:58:47</span>
            <span class="mobile">2023-11-23 09:58</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Docs/">Docs</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Openstack/">Openstack</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <p><strong>转载自博客园<a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/leffss/p/15598094.html" >https://www.cnblogs.com/leffss/p/15598094.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></strong><br><br><strong>原作者：<a class="link"   target="_blank" rel="noopener" href="https://home.cnblogs.com/u/leffss/" >https://home.cnblogs.com/u/leffss/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></strong><br><br>目录</p>
<ul>
<li><p><a href="#%E4%B8%80%E8%A7%84%E5%88%92">一、规划</a></p>
<ul>
<li><p><a href="#%E4%B8%BB%E6%9C%BA%E8%A7%84%E5%88%92">主机规划</a></p>
</li>
<li><p><a href="#%E7%B3%BB%E7%BB%9F%E6%8B%93%E6%89%91">系统拓扑</a></p>
</li>
<li><p><a href="#vmware-%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE">Vmware 虚拟机网络配置</a></p>
<ul>
<li><a href="#%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E8%AE%BE%E7%BD%AE">虚拟网络设置</a></li>
<li><a href="#ha-node">ha node</a></li>
<li><a href="#controller--network-node">controller + network node</a></li>
<li><a href="#compute-node">compute node</a></li>
<li><a href="#ceph-node">ceph node</a></li>
</ul>
</li>
<li><p><a href="#%E6%95%B4%E4%BD%93%E8%A7%84%E5%88%92">整体规划</a></p>
</li>
<li><p><a href="#%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE%E5%8F%82%E8%80%83">网卡配置参考</a></p>
</li>
<li><p><a href="#%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8">升级内核</a></p>
</li>
<li><p><a href="#%E9%85%8D%E7%BD%AEfirewalldselinuxntp%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5hostnamehosts%E6%96%87%E4%BB%B6">配置firewalld、selinux、ntp时间同步、hostname、hosts文件</a></p>
</li>
<li><p><a href="#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4-ssh-%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB">配置集群 ssh 信任关系</a></p>
</li>
<li><p><a href="#%E4%BC%98%E5%8C%96-ssh-%E7%99%BB%E9%99%86%E9%80%9F%E5%BA%A6">优化 ssh 登陆速度</a></p>
</li>
<li><p><a href="#%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96">内核参数优化</a></p>
</li>
<li><p><a href="#%E5%AE%89%E8%A3%85%E5%9F%BA%E7%A1%80%E8%BD%AF%E4%BB%B6%E5%8C%85">安装基础软件包</a></p>
</li>
</ul>
</li>
<li><p><a href="#%E4%BA%8C%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1">二、基础服务</a></p>
<ul>
<li><p><a href="#mariadb%E9%9B%86%E7%BE%A4">MariaDB集群</a></p>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE%E4%BF%AE%E6%94%B9">安装与配置修改</a></li>
<li><a href="#%E6%9E%84%E5%BB%BA%E9%9B%86%E7%BE%A4">构建集群</a></li>
<li><a href="#%E8%AE%BE%E7%BD%AE%E5%BF%83%E8%B7%B3%E6%A3%80%E6%B5%8Bclustercheck">设置心跳检测clustercheck</a></li>
<li><a href="#%E5%BC%82%E5%B8%B8%E5%85%B3%E6%9C%BA%E6%88%96%E5%BC%82%E5%B8%B8%E6%96%AD%E7%94%B5%E5%90%8E%E7%9A%84%E4%BF%AE%E5%A4%8D">异常关机或异常断电后的修复</a></li>
</ul>
</li>
<li><p><a href="#rabbitmq%E9%9B%86%E7%BE%A4">RabbitMQ集群</a></p>
<ul>
<li><a href="#%E4%B8%8B%E8%BD%BD%E7%9B%B8%E5%85%B3%E8%BD%AF%E4%BB%B6%E5%8C%85%E6%89%80%E6%9C%89%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9">下载相关软件包(所有控制节点)</a></li>
<li><a href="#%E6%9E%84%E5%BB%BArabbitmq%E9%9B%86%E7%BE%A4">构建rabbitmq集群</a></li>
</ul>
</li>
<li><p><a href="#memcached%E9%9B%86%E7%BE%A4">Memcached集群</a></p>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85memcache%E7%9A%84%E8%BD%AF%E4%BB%B6%E5%8C%85">安装memcache的软件包</a></li>
<li><a href="#%E8%AE%BE%E7%BD%AEmemcached">设置memcached</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1">启动服务</a></li>
</ul>
</li>
<li><p><a href="#%E9%AB%98%E5%8F%AF%E7%94%A8-haproxy--keepalived">高可用 haproxy + keepalived</a></p>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6">安装软件</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE-keepalived">配置 keepalived</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8-haproxy-%E4%B8%8E-keepalived">启动 haproxy 与 keepalived</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95%E9%AB%98%E5%8F%AF%E7%94%A8">测试高可用</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE-haproxy">配置 haproxy</a></li>
</ul>
</li>
</ul>
</li>
<li><p><a href="#%E4%B8%89keystone%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2">三、Keystone集群部署</a></p>
<ul>
<li><p><a href="#%E5%88%9B%E5%BB%BAkeystone%E6%95%B0%E6%8D%AE%E5%BA%93">创建keystone数据库</a></p>
</li>
<li><p><a href="#%E5%AE%89%E8%A3%85keystone">安装keystone</a></p>
</li>
<li><p><a href="#%E9%85%8D%E7%BD%AEkeystone">配置Keystone</a></p>
</li>
<li><p><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96keystone%E6%95%B0%E6%8D%AE%E5%BA%93">初始化keystone数据库</a></p>
</li>
<li><p><a href="#%E9%85%8D%E7%BD%AEhttp-server">配置Http Server</a></p>
</li>
<li><p><a href="#%E9%85%8D%E7%BD%AEadmin%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F%E8%84%9A%E6%9C%AC">配置admin用户变量脚本</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E5%9F%9F%E9%A1%B9%E7%9B%AE%E7%94%A8%E6%88%B7%E5%92%8C%E8%A7%92%E8%89%B2">创建新域、项目、用户和角色</a></p>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E5%9F%9F">创建域</a></li>
<li><a href="#%E5%88%9B%E5%BB%BAdemo%E9%A1%B9%E7%9B%AE">创建demo项目</a></li>
<li><a href="#%E5%88%9B%E5%BB%BAdemo%E7%94%A8%E6%88%B7">创建demo用户</a></li>
<li><a href="#%E5%88%9B%E5%BB%BAuser%E8%A7%92%E8%89%B2">创建user角色</a></li>
<li><a href="#%E6%9F%A5%E7%9C%8B%E8%A7%92%E8%89%B2">查看角色</a></li>
</ul>
</li>
<li><p><a href="#%E9%AA%8C%E8%AF%81keystone">验证keystone</a></p>
</li>
</ul>
</li>
<li><p><a href="#%E5%9B%9Bglance%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2">四、Glance集群部署</a></p>
<ul>
<li><p><a href="#%E5%88%9B%E5%BB%BAglance%E6%95%B0%E6%8D%AE%E5%BA%93">创建glance数据库</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BAglance-api%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1%E5%87%AD%E8%AF%81">创建glance-api相关服务凭证</a></p>
</li>
<li><p><a href="#%E9%83%A8%E7%BD%B2%E4%B8%8E%E9%85%8D%E7%BD%AEglance">部署与配置glance</a></p>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85glance">安装glance</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEglance-apiconf">配置glance-api.conf</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%AD%98%E5%82%A8%E7%9B%AE%E5%BD%95%E5%B9%B6%E8%B5%8B%E6%9D%83%E9%99%90">创建镜像存储目录并赋权限</a></li>
</ul>
</li>
<li><p><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96glance%E6%95%B0%E6%8D%AE%E5%BA%93">初始化glance数据库</a></p>
</li>
<li><p><a href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-1">启动服务</a></p>
</li>
<li><p><a href="#%E4%B8%8B%E8%BD%BDcirros%E9%95%9C%E5%83%8F%E9%AA%8C%E8%AF%81glance%E6%9C%8D%E5%8A%A1">下载cirros镜像验证glance服务</a></p>
</li>
</ul>
</li>
<li><p><a href="#%E4%BA%94placement%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2">五、Placement服务部署</a></p>
<ul>
<li><p><a href="#%E5%88%9B%E5%BB%BAplacement%E6%95%B0%E6%8D%AE%E5%BA%93">创建Placement数据库</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BAplacement-api">创建placement-api</a></p>
</li>
<li><p><a href="#%E5%AE%89%E8%A3%85placement%E8%BD%AF%E4%BB%B6%E5%8C%85">安装placement软件包</a></p>
</li>
<li><p><a href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">修改配置文件</a></p>
</li>
<li><p><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96placement%E6%95%B0%E6%8D%AE%E5%BA%93">初始化placement数据库</a></p>
</li>
<li><p><a href="#%E9%85%8D%E7%BD%AE00-placement-apiconf">配置00-placement-api.conf</a></p>
<ul>
<li><a href="#%E4%BF%AE%E6%94%B9placement%E7%9A%84apache%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">修改placement的apache配置文件</a></li>
<li><a href="#%E5%90%AF%E7%94%A8placement-api%E8%AE%BF%E9%97%AE">启用placement API访问</a></li>
<li><a href="#%E9%87%8D%E5%90%AFapache%E6%9C%8D%E5%8A%A1">重启apache服务</a></li>
</ul>
</li>
<li><p><a href="#%E9%AA%8C%E8%AF%81%E6%A3%80%E6%9F%A5placement%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81">验证检查Placement健康状态</a></p>
</li>
</ul>
</li>
<li><p><a href="#%E5%85%ADnova%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2">六、Nova控制节点集群部署</a></p>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BAnova%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E5%BA%93">创建nova相关数据库</a></li>
<li><a href="#%E5%88%9B%E5%BB%BAnova%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1%E5%87%AD%E8%AF%81">创建nova相关服务凭证</a></li>
<li><a href="#%E5%AE%89%E8%A3%85nova%E8%BD%AF%E4%BB%B6%E5%8C%85">安装nova软件包</a></li>
<li><a href="#%E9%83%A8%E7%BD%B2%E4%B8%8E%E9%85%8D%E7%BD%AE">部署与配置</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96nova%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B9%B6%E9%AA%8C%E8%AF%81">初始化nova相关数据库并验证</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8nova%E6%9C%8D%E5%8A%A1">启动nova服务</a></li>
<li><a href="#%E9%AA%8C%E8%AF%81">验证</a></li>
</ul>
</li>
<li><p><a href="#%E4%B8%83nova%E8%AE%A1%E7%AE%97%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2">七、Nova计算节点集群部署</a></p>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85nova-compute">安装nova-compute</a></li>
<li><a href="#%E9%83%A8%E7%BD%B2%E4%B8%8E%E9%85%8D%E7%BD%AE-1">部署与配置</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8%E8%AE%A1%E7%AE%97%E8%8A%82%E7%82%B9%E7%9A%84nova%E6%9C%8D%E5%8A%A1">启动计算节点的nova服务</a></li>
<li><a href="#%E5%90%91cell%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B7%BB%E5%8A%A0%E8%AE%A1%E7%AE%97%E8%8A%82%E7%82%B9">向cell数据库添加计算节点</a></li>
<li><a href="#%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9%E4%B8%8A%E5%8F%91%E7%8E%B0%E8%AE%A1%E7%AE%97%E4%B8%BB%E6%9C%BA">控制节点上发现计算主机</a></li>
<li><a href="#%E9%AA%8C%E8%AF%81-1">验证</a></li>
<li><a href="#%E6%89%A9%E5%B1%95openstacknovakvmqemu%E5%92%8Clibvirtd%E4%B9%8B%E9%97%B4%E7%9A%84%E8%81%94%E7%B3%BB">扩展：openstack(nova)、kvm、qemu和libvirtd之间的联系</a></li>
</ul>
</li>
<li><p><a href="#%E5%85%ABneutron%E6%8E%A7%E5%88%B6%E7%BD%91%E7%BB%9C%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2openvswitch%E6%96%B9%E5%BC%8F">八、Neutron控制+网络节点集群部署（openvswitch方式）</a></p>
<ul>
<li><p><a href="#%E5%88%9B%E5%BB%BAnova%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9">创建nova相关数据库（控制节点）</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BAneutron%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1%E5%87%AD%E8%AF%81">创建neutron相关服务凭证</a></p>
</li>
<li><p><a href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE">安装配置</a></p>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E5%8C%85">安装软件包</a></li>
<li><a href="#%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE">内核配置</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEneutronconf">配置neutron.conf</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEml2_confini">配置ml2_conf.ini</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEnovaconf">配置nova.conf</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96neutron%E6%95%B0%E6%8D%AE%E5%BA%93">初始化neutron数据库</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEl3_agentiniself-networking">配置l3_agent.ini（self-networking）</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEdhcp_agentini">配置dhcp_agent.ini</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEmetadata_agentini">配置metadata_agent.ini</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEopenvswitch_agentini">配置openvswitch_agent.ini</a></li>
</ul>
</li>
<li><p><a href="#%E5%90%AF%E5%8A%A8openvswitch%E6%9C%8D%E5%8A%A1">启动openvswitch服务</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E6%A1%A5br-ex">创建网桥br-ex</a></p>
</li>
<li><p><a href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-2">启动服务</a></p>
</li>
<li><p><a href="#%E9%AA%8C%E8%AF%81-2">验证</a></p>
</li>
</ul>
</li>
<li><p><a href="#%E4%B9%9Dneutron%E8%AE%A1%E7%AE%97%E8%8A%82%E7%82%B9openvswitch%E6%96%B9%E5%BC%8F">九、Neutron计算节点（openvswitch方式）</a></p>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85neutron-openvswitch">安装neutron-openvswitch</a></li>
<li><a href="#%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE-1">内核配置</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEmetadata_agentini-1">配置metadata_agent.ini</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEl3_agentiniself-networking-1">配置l3_agent.ini（self-networking）</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEopenvswitch_agentini-1">配置openvswitch_agent.ini</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEneutronconf-1">配置neutron.conf</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEnovaconf-1">配置nova.conf</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8openvswitch%E6%9C%8D%E5%8A%A1-1">启动openvswitch服务</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E6%A1%A5br-ex-1">创建网桥br-ex</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-3">启动服务</a></li>
<li><a href="#%E9%AA%8C%E8%AF%81-3">验证</a></li>
</ul>
</li>
<li><p><a href="#%E5%8D%81horazion%E4%BB%AA%E8%A1%A8%E7%9B%98%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2">十、Horazion仪表盘集群部署</a></p>
<ul>
<li><a href="#%E5%AE%89%E8%A3%85dashboard">安装dashboard</a></li>
<li><a href="#%E9%85%8D%E7%BD%AElocal_settings">配置local_settings</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEopenstack-dashboardconf">配置openstack-dashboard.conf</a></li>
<li><a href="#%E9%87%8D%E5%90%AFapache%E5%92%8Cmemcache">重启apache和memcache</a></li>
<li><a href="#%E9%AA%8C%E8%AF%81%E8%AE%BF%E9%97%AE">验证访问</a></li>
</ul>
</li>
<li><p><a href="#%E5%8D%81%E4%B8%80%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E5%B9%B6%E5%90%AF%E5%8A%A8%E5%AE%9E%E4%BE%8B%E6%93%8D%E4%BD%9C">十一、创建虚拟网络并启动实例操作</a></p>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BAexternal%E5%A4%96%E9%83%A8%E7%BD%91%E7%BB%9C">创建external外部网络</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%B7%AF%E7%94%B1">创建路由</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E5%AE%89%E5%85%A8%E7%BB%84">创建安全组</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B%E7%B1%BB%E5%9E%8B">创建实例类型</a></li>
<li><a href="#%E5%88%9B%E5%BB%BAvpc%E7%BD%91%E7%BB%9C">创建vpc网络</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B">创建实例</a></li>
<li><a href="#%E4%B8%8D%E5%90%8Cvpc%E5%86%85%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4%E9%80%9A%E4%BF%A1">不同vpc内主机之间通信</a></li>
<li><a href="#%E6%B5%AE%E5%8A%A8ip">浮动IP</a></li>
</ul>
</li>
<li><p><a href="#%E5%8D%81%E4%BA%8Cceph%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2">十二、Ceph集群部署</a></p>
</li>
<li><p><a href="#%E5%8D%81%E4%B8%89cinder%E9%83%A8%E7%BD%B2">十三、Cinder部署</a></p>
<ul>
<li><p><a href="#cinder%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2">Cinder控制节点集群部署</a></p>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BAcinder%E6%95%B0%E6%8D%AE%E5%BA%93">创建cinder数据库</a></li>
<li><a href="#%E5%88%9B%E5%BB%BAcinder%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1%E5%87%AD%E8%AF%81">创建cinder相关服务凭证</a></li>
<li><a href="#%E9%83%A8%E7%BD%B2%E4%B8%8E%E9%85%8D%E7%BD%AEcinder">部署与配置cinder</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96cinder%E6%95%B0%E6%8D%AE%E5%BA%93">初始化cinder数据库</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-4">启动服务</a></li>
<li><a href="#%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9%E9%AA%8C%E8%AF%81">控制节点验证</a></li>
</ul>
</li>
<li><p><a href="#cinder%E5%AD%98%E5%82%A8%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2">Cinder存储节点集群部署</a></p>
<ul>
<li><a href="#openstack%E7%9A%84%E5%AD%98%E5%82%A8%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98">Openstack的存储面临的问题</a></li>
<li><a href="#%E5%AE%89%E8%A3%85cinder">安装cinder</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEcinderconf">配置cinder.conf</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-5">启动服务</a></li>
<li><a href="#%E5%9C%A8%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81">在控制节点进行验证</a></li>
</ul>
</li>
</ul>
</li>
<li><p><a href="#%E5%8D%81%E5%9B%9B%E5%AF%B9%E6%8E%A5ceph%E5%AD%98%E5%82%A8">十四、对接Ceph存储</a></p>
<ul>
<li><p><a href="#openstack-%E9%9B%86%E7%BE%A4%E5%87%86%E5%A4%87">openstack 集群准备</a></p>
<ul>
<li><a href="#%E5%85%A8%E9%83%A8%E8%8A%82%E7%82%B9%E4%B8%8A%E6%B7%BB%E5%8A%A0ceph%E7%9A%84yum%E6%BA%90">全部节点上添加ceph的yum源</a></li>
<li><a href="#%E5%AE%89%E8%A3%85ceph%E5%AE%A2%E6%88%B7%E7%AB%AF">安装Ceph客户端</a></li>
<li><a href="#%E9%9C%80%E8%A6%81%E6%9C%89ceph%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6ceph%E9%9B%86%E7%BE%A4%E4%B8%8A%E6%93%8D%E4%BD%9C">需要有ceph的配置文件(ceph集群上操作)</a></li>
</ul>
</li>
<li><p><a href="#ceph-%E9%9B%86%E7%BE%A4%E5%87%86%E5%A4%87">ceph 集群准备</a></p>
<ul>
<li><a href="#%E9%9C%80%E6%B1%82%E8%AF%B4%E6%98%8E">需求说明</a></li>
<li><a href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90">原理解析</a></li>
<li><a href="#%E5%88%9B%E5%BB%BApool%E6%B1%A0">创建pool池</a></li>
<li><a href="#ceph%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81">ceph授权认证</a></li>
<li><a href="#%E6%8E%88%E6%9D%83%E6%B7%BB%E5%8A%A0%E5%88%B0libvirt%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B">授权添加到Libvirt守护进程</a></li>
</ul>
</li>
<li><p><a href="#%E9%85%8D%E7%BD%AEglance%E9%9B%86%E6%88%90ceph">配置glance集成ceph</a></p>
<ul>
<li><a href="#%E9%85%8D%E7%BD%AEglance-apiconf-1">配置glance-api.conf</a></li>
<li><a href="#%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E6%B5%8B%E8%AF%95">上传镜像测试</a></li>
<li><a href="#%E6%9F%A5%E7%9C%8B%E9%95%9C%E5%83%8F%E5%92%8Cglance%E6%B1%A0%E6%95%B0%E6%8D%AE">查看镜像和glance池数据</a></li>
<li><a href="#ceph%E6%89%A7%E8%A1%8Cimage%E9%95%9C%E5%83%8F%E7%9A%84%E6%AD%A5%E9%AA%A4%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3">Ceph执行image镜像的步骤过程详解</a></li>
</ul>
</li>
<li><p><a href="#%E4%BD%BF%E7%94%A8ceph%E4%BD%9C%E4%B8%BAcinder%E7%9A%84%E5%90%8E%E7%AB%AF%E5%AD%98%E5%82%A8">使用Ceph作为Cinder的后端存储</a></p>
<ul>
<li><a href="#%E9%85%8D%E7%BD%AEcinderconf-1">配置cinder.conf</a></li>
<li><a href="#%E9%87%8D%E5%90%AFcinder-volume%E6%9C%8D%E5%8A%A1">重启cinder-volume服务</a></li>
<li><a href="#%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81">验证服务状态</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E7%A9%BA%E7%99%BD%E5%8D%B7volume%E6%B5%8B%E8%AF%95">创建空白卷Volume测试</a></li>
<li><a href="#%E4%BB%8E%E9%95%9C%E5%83%8F%E5%88%9B%E5%BB%BAvolume%E6%B5%8B%E8%AF%95">从镜像创建Volume测试</a></li>
<li><a href="#%E4%B8%BA%E9%95%9C%E5%83%8F%E5%88%9B%E5%BB%BA%E7%9A%84%E5%8D%B7%E7%94%9F%E6%88%90%E5%BF%AB%E7%85%A7%E6%B5%8B%E8%AF%95">为镜像创建的卷生成快照测试</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA-volume%E5%8D%B7%E5%A4%87%E4%BB%BD%E6%B5%8B%E8%AF%95">创建 Volume卷备份测试</a></li>
</ul>
</li>
<li><p><a href="#%E4%BD%BF%E7%94%A8ceph%E4%BD%9C%E4%B8%BAnova%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AD%98%E5%82%A8">使用Ceph作为Nova的虚拟机存储</a></p>
<ul>
<li><a href="#%E9%85%8D%E7%BD%AEcephconf">配置ceph.conf</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEnovaconf-2">配置nova.conf</a></li>
<li><a href="#%E9%87%8D%E5%90%AF%E8%AE%A1%E7%AE%97%E6%9C%8D%E5%8A%A1">重启计算服务</a></li>
<li><a href="#%E9%85%8D%E7%BD%AElive-migration%E7%83%AD%E8%BF%81%E7%A7%BB">配置live-migration热迁移</a></li>
<li><a href="#%E8%AE%A1%E7%AE%97%E8%8A%82%E7%82%B9%E8%AE%BE%E7%BD%AE%E5%85%8D%E5%AF%86%E8%AE%BF%E9%97%AE">计算节点设置免密访问</a></li>
<li><a href="#%E8%AE%BE%E7%BD%AEiptables">设置iptables</a></li>
<li><a href="#%E9%9C%80%E9%87%8D%E5%90%AF%E6%9C%8D%E5%8A%A1">需重启服务</a></li>
<li><a href="#%E9%AA%8C%E8%AF%81%E7%83%AD%E8%BF%81%E7%A7%BB">验证热迁移</a></li>
</ul>
</li>
</ul>
</li>
<li><p><a href="#%E5%8D%81%E4%BA%94%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1octavia%E9%83%A8%E7%BD%B2">十五、负载均衡Octavia部署</a></p>
<ul>
<li><p><a href="#%E6%9B%B4%E6%96%B0-haproxy-%E9%85%8D%E7%BD%AE">更新 haproxy 配置</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93">创建数据库</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BAoctavia%E7%9A%84keystone%E8%AE%A4%E8%AF%81%E4%BD%93%E7%B3%BB%E7%94%A8%E6%88%B7%E8%A7%92%E8%89%B2endpoint">创建octavia的keystone认证体系（用户、角色、endpoint）</a></p>
</li>
<li><p><a href="#%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E5%8C%85-1">安装软件包</a></p>
</li>
<li><p><a href="#%E5%88%B6%E4%BD%9Camphora%E9%95%9C%E5%83%8F">制作Amphora镜像</a></p>
<ul>
<li><a href="#%E5%8D%87%E7%BA%A7-git">升级 git</a></li>
<li><a href="#%E5%BC%80%E5%A7%8B%E5%88%B6%E4%BD%9C">开始制作</a></li>
<li><a href="#%E8%87%AA%E8%A1%8C%E4%B8%8B%E8%BD%BDcentos%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C">自行下载centos镜像制作</a></li>
</ul>
</li>
<li><p><a href="#%E5%AF%BC%E5%85%A5%E9%95%9C%E5%83%8F">导入镜像</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B%E6%A8%A1%E6%9D%BF">创建实例模板</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BA%E8%AE%A4%E8%AF%81%E5%AF%86%E9%92%A5">创建认证密钥</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BA%E5%AE%89%E5%85%A8%E7%BB%84-1">创建安全组</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BA%E7%99%BB%E9%99%86-amphora-%E5%AE%9E%E4%BE%8B%E7%9A%84-ssh-key">创建登陆 amphora 实例的 ssh key</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BA-dhclientconf-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">创建 dhclient.conf 配置文件</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C">创建网络</a></p>
<ul>
<li><p><a href="#controller01%E6%89%A7%E8%A1%8C">controller01执行</a></p>
<ul>
<li><a href="#openvswitch%E6%96%B9%E5%BC%8F">openvswitch方式</a></li>
</ul>
</li>
<li><p><a href="#controller02%E6%89%A7%E8%A1%8C">controller02执行</a></p>
<ul>
<li><a href="#openvswitch%E6%96%B9%E5%BC%8F-1">openvswitch方式</a></li>
</ul>
</li>
<li><p><a href="#controller03%E6%89%A7%E8%A1%8C">controller03执行</a></p>
<ul>
<li><a href="#openvswitch%E6%96%B9%E5%BC%8F-2">openvswitch方式</a></li>
</ul>
</li>
</ul>
</li>
<li><p><a href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1">修改配置文件</a></p>
</li>
<li><p><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93">初始化数据库</a></p>
</li>
<li><p><a href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-6">启动服务</a></p>
</li>
<li><p><a href="#%E5%8D%87%E7%BA%A7dashboard%E5%BC%80%E5%90%AF">升级dashboard开启</a></p>
</li>
<li><p><a href="#%E5%88%9B%E5%BB%BA-loadbalancer">创建 loadbalancer</a></p>
</li>
</ul>
</li>
<li><p><a href="#%E5%85%B6%E4%BB%96%E7%BB%84%E4%BB%B6">其他组件</a></p>
</li>
<li><p><a href="#%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BD%95">错误记录</a></p>
<ul>
<li><a href="#libvirterror-internal-error-end-of-file-from-qemu-monitor">libvirtError: internal error: End of file from qemu monitor</a></li>
<li><a href="#lost-connection-to-mysql-server-during-query">Lost connection to MySQL server during query</a></li>
<li><a href="#could-not-sign-the-certificate-request-failed-to-load-ca-certificate">Could not sign the certificate request: Failed to load CA Certificate</a></li>
</ul>
</li>
</ul>
<h1 id="一、规划"><a href="#一、规划" class="headerlink" title="一、规划"></a>一、规划</h1><h2 id="主机规划"><a href="#主机规划" class="headerlink" title="主机规划"></a>主机规划</h2><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ha-node</span></span><br><span class="line">10.10.10.21 ha01</span><br><span class="line">10.10.10.22 ha02</span><br><span class="line"></span><br><span class="line"><span class="comment"># controller-node</span></span><br><span class="line">10.10.10.31 controller01</span><br><span class="line">10.10.10.32 controller02</span><br><span class="line">10.10.10.33 controller03</span><br><span class="line"></span><br><span class="line"><span class="comment"># compute-node</span></span><br><span class="line">10.10.10.41 compute01</span><br><span class="line">10.10.10.42 compute02</span><br><span class="line"></span><br><span class="line"><span class="comment"># ceph-node</span></span><br><span class="line">10.10.10.51 ceph01</span><br><span class="line">10.10.10.52 ceph02</span><br><span class="line">10.10.10.53 ceph03</span><br></pre></td></tr></table></figure></div>

<ul>
<li>ha-node 使用 haproxy + keepalived 实现高可用，vip 10.10.10.10</li>
<li>controller-node 部署控制节点相关组件以及网络节点 neutron 的 sever 与 agent 组件</li>
<li>系统：centos 7.9 ，内核：5.4.152-1.el7.elrepo.x86_64</li>
</ul>
<h2 id="系统拓扑"><a href="#系统拓扑" class="headerlink" title="系统拓扑"></a>系统拓扑</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111231723742.png"
                      alt="image-20211123172325552"
                ></p>
<ol>
<li>congtroller节点运行keystone，glance，horizon，nova&amp;neutron&amp;cinder管理相关组件，另外openstack相关的基础服务；</li>
<li>compute节点运行nova-compute，neutron-openvswitch-agent（只有openvswitch支持分布式路由），cinder-volume（后经验证，如果后端使用共享存储，建议部署在controller节点，可通过pacemaker控制运行模式，但写文档时，此验证环境的cinder-volume部署在compute节点）等</li>
<li>控制+网络节点</li>
</ol>
<ul>
<li>控制节点和网络节点部署在相同机器，也可以控制节点和网络节点分开（控制节点部署neutron-server；网络节点部署neutron-agent）</li>
<li>管理网络（红色）：含host os管理，api等网络，如果生产环境允许，建议各逻辑网络使用独立的物理网络，api区分admin&#x2F;internal&#x2F;public接口，对客户端只开放public接口；</li>
<li>外部网络（蓝色，External Network）：主要针对guest os访问internet&#x2F;外部的floating ip；</li>
<li>租户（虚机）隧道网络（与vlan网络共存 <strong>或</strong> 2选1）（紫色）：guest os之间通讯的网络，采用vxlan&#x2F;gre等方式；</li>
<li>租户（虚机）vlan网络（与隧道网络共存 <strong>或</strong> 2选1）（黄色，不需要配置ip）：guest os之间通讯的网络，采用vlan方式（虽然规划了，但是后面创建实例时是没有使用的）；</li>
<li>存储网络（绿色）：与存储集群通讯；为了glance和ceph通信；</li>
</ul>
<ol start="4">
<li>计算节点网络</li>
</ol>
<ul>
<li>管理网络（红色）：含host os管理，api等网络；</li>
<li>外部网络（蓝色，External Network）：主要针对guest os访问internet&#x2F;外部的floating ip；</li>
<li>存储网络（绿色）：与存储集群通讯；</li>
<li>租户（虚机）隧道网络（与vlan网络共存 <strong>或</strong> 2选1）（紫色）：guest os之间通讯的网络，采用vxlan&#x2F;gre等方式；</li>
<li>租户（虚机）vlan网络（与隧道网络共存 <strong>或</strong> 2选1）（黄色，不需要配置ip）：guest os之间通讯的网络，采用vlan方式（虽然规划了，但是后面创建实例时是没有使用的）；</li>
</ul>
<ol start="5">
<li>存储节点</li>
</ol>
<ul>
<li>管理网络（红色）：含host os管理，api等网络；</li>
<li>存储网络（绿色）：与外部存储客户端通信；</li>
<li>存储集群网络（黑色）：存储集群内部通讯，数据复制同步网络，与外界没有直接联系；</li>
</ul>
<ol start="6">
<li>无状态的服务，如xxx-api，采取active&#x2F;active的模式运行；有状态的服务，如neturon-xxx-agent，cinder-volume等，建议采取active&#x2F;passive的模式运行（因前端采用haproxy，客户端的多次请求可能会被转发到不同的控制节点，如果客户端请求被负载到无状态信息的控制节点，可能会导致操作请求失败）；自身具有集群机制的服务，如rabbitmq，memcached等采用本身的集群机制即可；</li>
</ol>
<h2 id="Vmware-虚拟机网络配置"><a href="#Vmware-虚拟机网络配置" class="headerlink" title="Vmware 虚拟机网络配置"></a>Vmware 虚拟机网络配置</h2><h3 id="虚拟网络设置"><a href="#虚拟网络设置" class="headerlink" title="虚拟网络设置"></a>虚拟网络设置</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111081632888.png"
                      alt="image-20211108163217264"
                ></p>
<ul>
<li>因为外部网络ens34是连接在VMnet2上的，按理说应该是VMnet2是NAT模式（vmware只能设置一个NAT网络），但是因为所有主机需要yum安装软件，所以暂时把管理网络VMnet1设置为NAT模式，后面测试外部网络功能的时候会把VMnet2设置为NAT模式</li>
</ul>
<h3 id="ha-node"><a href="#ha-node" class="headerlink" title="ha node"></a>ha node</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111081633336.png"
                      alt="image-20211108163329977"
                ></p>
<h3 id="controller-network-node"><a href="#controller-network-node" class="headerlink" title="controller + network node"></a>controller + network node</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111161003689.png"
                      alt="image-20211116100313530"
                ></p>
<h3 id="compute-node"><a href="#compute-node" class="headerlink" title="compute node"></a>compute node</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111231722703.png"
                      alt="image-20211123172223641"
                ></p>
<h3 id="ceph-node"><a href="#ceph-node" class="headerlink" title="ceph node"></a>ceph node</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111081636775.png"
                      alt="image-20211108163653587"
                ></p>
<h2 id="整体规划"><a href="#整体规划" class="headerlink" title="整体规划"></a>整体规划</h2><p>hostipserviceremarkha01-02ens33:10.10.10.21-221.haproxy</p>
<p>2.keepalived1.高可用 vip：10.10.10.10controller01-03ens33:10.10.10.31-33</p>
<p>ens34:10.10.20.31-33</p>
<p>ens35:10.10.30.31-33</p>
<p>ens36:Vlan Tenant Network</p>
<p>ens37:10.10.50.31-331. keystone</p>
<p>2. glance-api , glance-registry</p>
<p>3. nova-api, nova-conductor, nova-consoleauth, nova-scheduler, nova-novncproxy</p>
<p>4. neutron-api, neutron-openvswitch-agent, neutron-dhcp-agent, neutron-metadata-agent, neutron-l3-agent</p>
<p>5. cinder-api, cinder-schedulera</p>
<p>6. dashboard</p>
<p>7. mariadb, rabbitmq, memcached等1.控制节点: keystone, glance, horizon, nova&amp;neutron管理组件；</p>
<p>2.网络节点：虚机网络，L2（虚拟交换机）&#x2F;L3（虚拟路由器），dhcp，route，nat等；</p>
<p>3.openstack基础服务compute01-02ens33:10.10.10.41-42</p>
<p>ens34:10.10.50.41-42</p>
<p>ens35:10.10.30.41-42</p>
<p>ens36:Vlan Tenant Network</p>
<p>ens37:10.10.50.41-421. nova-compute</p>
<p>2. neutron-openvswitch-agent, neutron-metadata-agent, neutron-l3-agent</p>
<p>3. cinder-volume(如果后端使用共享存储，建议部署在controller节点)</p>
<p>1.计算节点：hypervisor(kvm)；</p>
<p>2.网络节点：虚机网络 L2（虚拟交换机）&#x2F;L3（虚拟路由器）等；ceph01-03ens33:10.10.10.51-53</p>
<p>ens34:10.10.50.51-53</p>
<p>ens35:10.10.60.51-531. ceph-mon, ceph-mgr</p>
<p>2. ceph-osd1.存储节点：调度，监控(ceph)等组件；</p>
<p>2.存储节点：卷服务等组件</p>
<h2 id="网卡配置参考"><a href="#网卡配置参考" class="headerlink" title="网卡配置参考"></a>网卡配置参考</h2><div class="highlight-container" data-rel="Makefile"><figure class="iseeu highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[root@controller01 ~]<span class="comment"># tail /etc/sysconfig/network-scripts/ifcfg-ens*</span></span><br><span class="line">==&gt; /etc/sysconfig/network-scripts/ifcfg-ens33 &lt;==</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens33</span><br><span class="line">UUID=7fff7303-8b35-4728-a4f2-f33d20aefdf4</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=10.10.10.31</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=10.10.10.2</span><br><span class="line">DNS1=10.10.10.2</span><br><span class="line"></span><br><span class="line">==&gt; /etc/sysconfig/network-scripts/ifcfg-ens34 &lt;==</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens34</span><br><span class="line">UUID=8f98810c-a504-4d16-979d-4829501a8c7c</span><br><span class="line">DEVICE=ens34</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=10.10.20.31</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line"></span><br><span class="line">==&gt; /etc/sysconfig/network-scripts/ifcfg-ens35 &lt;==</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens35</span><br><span class="line">UUID=ba3ac372-df26-4226-911e-4a48031f80a8</span><br><span class="line">DEVICE=ens35</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=10.10.30.31</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line"></span><br><span class="line">==&gt; /etc/sysconfig/network-scripts/ifcfg-ens36 &lt;==</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens36</span><br><span class="line">UUID=d7ab5617-a38f-4c28-b30a-f49a1cfd0060</span><br><span class="line">DEVICE=ens36</span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">==&gt; /etc/sysconfig/network-scripts/ifcfg-ens37 &lt;==</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens40</span><br><span class="line">UUID=662b80cb-31f1-386d-b293-c86cfe98d755</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=10.10.50.31</span><br><span class="line">NETMASK=255.255.255.0</span><br></pre></td></tr></table></figure></div>

<ul>
<li>其中一张网卡配置默认网关和DNS</li>
</ul>
<h2 id="升级内核"><a href="#升级内核" class="headerlink" title="升级内核"></a>升级内核</h2><div class="highlight-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https:<span class="regexp">//</span>www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line"><span class="comment"># 安装ELRepo</span></span><br><span class="line">rpm -Uvh http:<span class="regexp">//</span>www.elrepo.org/elrepo-release-<span class="number">7.0</span>-<span class="number">3</span>.el7.elrepo.noarch.rpm</span><br><span class="line"><span class="comment"># 载入elrepo-kernel元数据</span></span><br><span class="line">yum --disablerepo=\* --enablerepo=elrepo-kernel repolist</span><br><span class="line"><span class="comment"># 查看可用的rpm包</span></span><br><span class="line">yum --disablerepo=\* --enablerepo=elrepo-kernel list kernel*</span><br><span class="line"><span class="comment"># 安装长期支持版本的kernel</span></span><br><span class="line">yum --disablerepo=\* --enablerepo=elrepo-kernel install -<span class="keyword">y</span> kernel-lt.x86_64</span><br><span class="line"><span class="comment"># 删除旧版本工具包</span></span><br><span class="line">yum remove kernel-tools-libs.x86_64 kernel-tools.x86_64 -<span class="keyword">y</span></span><br><span class="line"><span class="comment"># 安装新版本工具包</span></span><br><span class="line">yum --disablerepo=\* --enablerepo=elrepo-kernel install -<span class="keyword">y</span> kernel-<span class="keyword">lt</span>-tools.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看默认启动顺序</span></span><br><span class="line">awk -F\<span class="string">&#x27; &#x27;</span>$1==<span class="string">&quot;menuentry &quot;</span> &#123;<span class="keyword">print</span> $2&#125;<span class="string">&#x27; /etc/grub2.cfg</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#默认启动的顺序是从0开始，新内核是从头插入（目前位置在0，而4.4.4的是在1），所以需要选择0。</span></span><br><span class="line"><span class="string">grub2-set-default 0</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>内核：5.4.152-1.el7.elrepo.x86_64</li>
</ul>
<h2 id="配置firewalld、selinux、ntp时间同步、hostname、hosts文件"><a href="#配置firewalld、selinux、ntp时间同步、hostname、hosts文件" class="headerlink" title="配置firewalld、selinux、ntp时间同步、hostname、hosts文件"></a>配置firewalld、selinux、ntp时间同步、hostname、hosts文件</h2><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;# ha-node</span></span><br><span class="line"><span class="string">10.10.10.21 ha01</span></span><br><span class="line"><span class="string">10.10.10.22 ha02</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># controller-node</span></span><br><span class="line"><span class="string">10.10.10.31 controller01</span></span><br><span class="line"><span class="string">10.10.10.32 controller02</span></span><br><span class="line"><span class="string">10.10.10.33 controller03</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># compute-node</span></span><br><span class="line"><span class="string">10.10.10.41 compute01</span></span><br><span class="line"><span class="string">10.10.10.42 compute02</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># ceph-node</span></span><br><span class="line"><span class="string">10.10.10.51 ceph01</span></span><br><span class="line"><span class="string">10.10.10.52 ceph02</span></span><br><span class="line"><span class="string">10.10.10.53 ceph03</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure></div>

<h2 id="配置集群-ssh-信任关系"><a href="#配置集群-ssh-信任关系" class="headerlink" title="配置集群 ssh 信任关系"></a>配置集群 ssh 信任关系</h2><div class="highlight-container" data-rel="Ruby"><figure class="iseeu highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成密钥</span></span><br><span class="line">ssh-keygen -t rsa -P <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝公钥给本机</span></span><br><span class="line">ssh-copy-id -i .ssh/id_rsa.pub root<span class="variable">@localhost</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝 .ssh 目录所有文件到集群其他节点</span></span><br><span class="line">scp -rp .ssh/ root<span class="variable">@ha01</span><span class="symbol">:/root</span></span><br><span class="line">scp -rp .ssh/ root<span class="variable">@ha02</span><span class="symbol">:/root</span></span><br><span class="line">scp -rp .ssh/ root<span class="variable">@controller01</span><span class="symbol">:/root</span></span><br><span class="line">scp -rp .ssh/ root<span class="variable">@controller02</span><span class="symbol">:/root</span></span><br><span class="line">scp -rp .ssh/ root<span class="variable">@controller03</span><span class="symbol">:/root</span></span><br><span class="line">scp -rp .ssh/ root<span class="variable">@compute1</span><span class="symbol">:/root</span></span><br><span class="line">scp -rp .ssh/ root<span class="variable">@compute2</span><span class="symbol">:/root</span></span><br><span class="line">scp -rp .ssh/ root<span class="variable">@ceph01</span><span class="symbol">:/root</span></span><br><span class="line">scp -rp .ssh/ root<span class="variable">@ceph02</span><span class="symbol">:/root</span></span><br><span class="line">scp -rp .ssh/ root<span class="variable">@ceph03</span><span class="symbol">:/root</span></span><br></pre></td></tr></table></figure></div>

<p>完成后，集群中所有主机可以互相免密登录了</p>
<h2 id="优化-ssh-登陆速度"><a href="#优化-ssh-登陆速度" class="headerlink" title="优化 ssh 登陆速度"></a>优化 ssh 登陆速度</h2><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s/#UseDNS yes/UseDNS no/g&#x27;</span> /etc/ssh/sshd_config</span><br><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure></div>

<h2 id="内核参数优化"><a href="#内核参数优化" class="headerlink" title="内核参数优化"></a>内核参数优化</h2><p>所有节点</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;modprobe br_netfilter&#x27;</span> &gt;&gt; /etc/rc.d/rc.local</span><br><span class="line"><span class="built_in">chmod</span> 755 /etc/rc.d/rc.local</span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.ip_forward = 1&#x27;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.bridge.bridge-nf-call-iptables=1&#x27;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.bridge.bridge-nf-call-ip6tables=1&#x27;</span>  &gt;&gt;/etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></div>

<p>在 ha01 和 ha02 节点上添加，允许本地不存在 IP 绑定监听端口，允许运行中的 HAProxy 实例绑定端口到VIP</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.ip_nonlocal_bind = 1&#x27;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></div>

<h2 id="安装基础软件包"><a href="#安装基础软件包" class="headerlink" title="安装基础软件包"></a>安装基础软件包</h2><p>所有节点</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install epel<span class="operator">-</span><span class="keyword">release</span> <span class="operator">-</span>y</span><br><span class="line">yum install centos<span class="operator">-</span><span class="keyword">release</span><span class="operator">-</span>openstack<span class="operator">-</span>train <span class="operator">-</span>y</span><br><span class="line">yum clean <span class="keyword">all</span></span><br><span class="line">yum makecache</span><br><span class="line">yum install python<span class="operator">-</span>openstackclient <span class="operator">-</span>y</span><br></pre></td></tr></table></figure></div>

<ul>
<li>ha 节点可以不用安装</li>
</ul>
<p>openstack-utils能够让openstack安装更加简单，直接在命令行修改配置文件(全部节点)</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/tools</span><br><span class="line">yum install wget crudini -y</span><br><span class="line">wget --no-check-certificate -P /opt/tools https://cbs.centos.org/kojifiles/packages/openstack-utils/2017.1/1.el7/noarch/openstack-utils-2017.1-1.el7.noarch.rpm</span><br><span class="line">rpm -ivh /opt/tools/openstack-utils-2017.1-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure></div>

<ul>
<li>ha 节点可以不用安装</li>
</ul>
<h1 id="二、基础服务"><a href="#二、基础服务" class="headerlink" title="二、基础服务"></a>二、基础服务</h1><h2 id="MariaDB集群"><a href="#MariaDB集群" class="headerlink" title="MariaDB集群"></a>MariaDB集群</h2><p>采用 <code>MariaDB + Galera</code> 组成三个Active节点，外部访问通过Haproxy的active + backend方式代理。平时主库为A，当A出现故障，则切换到B或C节点。 <strong>目前测试将MariaDB三个节点部署到了控制节点上。</strong></p>
<p>官方推荐：三个节点的MariaDB和Galera集群，建议每个集群具有4个vCPU和8 GB RAM</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111041259114.webp"
                      alt="img"
                ></p>
<h3 id="安装与配置修改"><a href="#安装与配置修改" class="headerlink" title="安装与配置修改"></a>安装与配置修改</h3><p><strong>在全部controller节点安装mariadb，以controller01节点为例</strong></p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>mariadb mariadb-server python2-PyMySQL -y</span><br></pre></td></tr></table></figure></div>

<p><strong>在全部controller节点安装galera相关插件，利用galera搭建集群</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install mariadb-server-galera mariadb-galera-common galera xinetd rsync -y</span><br><span class="line"></span><br><span class="line">systemctl restart mariadb.service</span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb.service</span><br></pre></td></tr></table></figure></div>

<p><strong>在全部controller节点初始化mariadb数据库密码，以controller01节点为例</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@controller01 ~]<span class="comment"># mysql_secure_installation</span></span><br><span class="line"><span class="comment">#输入root用户的当前密码（不输入密码）</span></span><br><span class="line">Enter current password <span class="keyword">for</span> root (enter <span class="keyword">for</span> none):</span><br><span class="line"><span class="comment">#设置root密码？</span></span><br><span class="line">Set root password? [Y/n] y</span><br><span class="line"><span class="comment">#新密码：</span></span><br><span class="line">New password:</span><br><span class="line"><span class="comment">#重新输入新的密码：</span></span><br><span class="line">Re-enter new password:</span><br><span class="line"><span class="comment">#删除匿名用户？</span></span><br><span class="line">Remove anonymous <span class="built_in">users</span>? [Y/n] y</span><br><span class="line"><span class="comment">#禁止远程root登录？</span></span><br><span class="line">Disallow root login remotely? [Y/n] n</span><br><span class="line"><span class="comment">#删除测试数据库并访问它？</span></span><br><span class="line">Remove <span class="built_in">test</span> database and access to it? [Y/n] y</span><br><span class="line"><span class="comment">#现在重新加载特权表？</span></span><br><span class="line">Reload privilege tables now? [Y/n] y</span><br></pre></td></tr></table></figure></div>

<p><strong>修改mariadb配置文件</strong></p>
<p>在全部控制节点&#x2F;etc&#x2F;my.cnf.d&#x2F;目录下新增openstack.cnf配置文件，主要设置集群同步相关参数，以controller01节点为例，个别涉及ip地址&#x2F;host名等参数根据当前节点实际情况修改</p>
<p>创建和编辑 <code>/etc/my.cnf.d/openstack.cnf</code> 文件</p>
<div class="highlight-container" data-rel="Ini"><figure class="iseeu highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[server]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">bind-address</span> = <span class="number">10.10</span>.<span class="number">10.31</span></span><br><span class="line"><span class="attr">max_connections</span> = <span class="number">1000</span></span><br><span class="line"><span class="attr">datadir</span>=/var/lib/mysql</span><br><span class="line"><span class="attr">socket</span>=/var/lib/mysql/mysql.sock</span><br><span class="line"><span class="attr">log-error</span>=/var/log/mariadb/mariadb.log</span><br><span class="line"><span class="attr">pid-file</span>=/run/mariadb/mariadb.pid</span><br><span class="line"><span class="attr">max_allowed_packet</span> = <span class="number">500</span>M</span><br><span class="line"><span class="attr">net_read_timeout</span> = <span class="number">120</span></span><br><span class="line"><span class="attr">net_write_timeout</span> = <span class="number">300</span></span><br><span class="line"><span class="attr">thread_pool_idle_timeout</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"><span class="section">[galera]</span></span><br><span class="line"><span class="attr">wsrep_on</span>=<span class="literal">ON</span></span><br><span class="line"><span class="attr">wsrep_provider</span>=/usr/lib64/galera/libgalera_smm.so</span><br><span class="line"><span class="attr">wsrep_cluster_name</span>=<span class="string">&quot;mariadb_galera_cluster&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">wsrep_cluster_address</span>=<span class="string">&quot;gcomm://controller01,controller02,controller03&quot;</span></span><br><span class="line"><span class="attr">wsrep_node_name</span>=<span class="string">&quot;controller01&quot;</span></span><br><span class="line"><span class="attr">wsrep_node_address</span>=<span class="string">&quot;10.10.10.31&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">binlog_format</span>=ROW</span><br><span class="line"><span class="attr">default_storage_engine</span>=InnoDB</span><br><span class="line"><span class="attr">innodb_autoinc_lock_mode</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">wsrep_slave_threads</span>=<span class="number">4</span></span><br><span class="line"><span class="attr">innodb_flush_log_at_trx_commit</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span>=<span class="number">1024</span>M</span><br><span class="line"><span class="attr">wsrep_sst_method</span>=rsync</span><br><span class="line"></span><br><span class="line"><span class="section">[embedded]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[mariadb]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[mariadb-10.3]</span></span><br></pre></td></tr></table></figure></div>

<h3 id="构建集群"><a href="#构建集群" class="headerlink" title="构建集群"></a>构建集群</h3><p><strong>停止全部控制节点的mariadb服务，以controller01节点为例</strong></p>
<div class="highlight-container" data-rel="Vbnet"><figure class="iseeu highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="keyword">stop</span> mariadb</span><br></pre></td></tr></table></figure></div>

<p><strong>在controller01节点通过如下方式启动mariadb服务</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/libexec/mysqld --wsrep-new-cluster --user=root &amp;</span><br></pre></td></tr></table></figure></div>

<p><strong>其他控制节点加入mariadb集群</strong></p>
<div class="highlight-container" data-rel="Lua"><figure class="iseeu highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb.service</span><br><span class="line">systemctl <span class="built_in">status</span> mariadb.service</span><br></pre></td></tr></table></figure></div>

<ul>
<li>启动后加入集群，当前节点会从 controller01 节点同步数据，查看 mariadb 日志 &#x2F;var&#x2F;log&#x2F;mariadb&#x2F;mariadb.log</li>
</ul>
<p><strong>回到controller01节点重新配置mariadb</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#重启controller01节点；并在启动前删除contrller01节点之前的数据</span></span><br><span class="line">pkill -9 mysqld</span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/mysql/*</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意以system unit方式启动mariadb服务时的权限</span></span><br><span class="line"><span class="built_in">chown</span> mysql:mysql /var/run/mariadb/mariadb.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动后查看节点所在服务状态，正常的话 contrller01 节点会从 contrller02 节点同步数据</span></span><br><span class="line">systemctl start mariadb.service</span><br><span class="line">systemctl status mariadb.service</span><br></pre></td></tr></table></figure></div>

<p><strong>查看集群状态</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123456</span><br><span class="line">Welcome <span class="keyword">to</span> the MariaDB monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MariaDB connection id <span class="keyword">is</span> <span class="number">13</span></span><br><span class="line">Server version: <span class="number">10.3</span><span class="number">.20</span><span class="operator">-</span>MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2018</span>, Oracle, MariaDB Corporation Ab <span class="keyword">and</span> others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> &quot;wsrep_cluster_size&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name      <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> wsrep_cluster_size <span class="operator">|</span> <span class="number">3</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.001</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">LIKE</span> <span class="string">&#x27;wsrep_ready&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> wsrep_ready   <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></div>

<p><strong>在controller01创建数据库，到另外两台节点上查看是否可以同步</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123456</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">create</span> database cluster_test charset utf8mb4;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.005</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> cluster_test       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br></pre></td></tr></table></figure></div>

<p>另外两台查看</p>
<div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@controller02 ~]# mysql -uroot -p123456 -e <span class="string">&#x27;show databases;&#x27;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| <span class="type">Database</span>           |</span><br><span class="line">+--------------------+</span><br><span class="line">| cluster_test       |  √</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line">[root@controller03 ~]# mysql -uroot -p123456 -e <span class="string">&#x27;show databases;&#x27;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| <span class="type">Database</span>           |</span><br><span class="line">+--------------------+</span><br><span class="line">| cluster_test       |  √</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure></div>

<h3 id="设置心跳检测clustercheck"><a href="#设置心跳检测clustercheck" class="headerlink" title="设置心跳检测clustercheck"></a>设置心跳检测clustercheck</h3><p><strong>在全部控制节点下载修改 clustercheck 脚本</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -P /extend/shell/ https://raw.githubusercontent.com/olafz/percona-clustercheck/master/clustercheck</span><br></pre></td></tr></table></figure></div>

<p><strong>在任意一个控制节点的数据库中创建 clustercheck_user 用户并赋权; 其他两台节点会自动同步</strong></p>
<div class="highlight-container" data-rel="Delphi"><figure class="iseeu highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p123456</span><br><span class="line">GRANT PROCESS <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">&#x27;clustercheck&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line"><span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure></div>

<p><strong>修改所有控制节点 clustercheck 脚本，注意账号&#x2F;密码与上一步新建的账号&#x2F;密码对应</strong></p>
<div class="highlight-container" data-rel="Dockerfile"><figure class="iseeu highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ vi /extend/<span class="keyword">shell</span><span class="language-bash">/clustercheck</span></span><br><span class="line">MYSQL_USERNAME=<span class="string">&quot;clustercheck&quot;</span></span><br><span class="line">MYSQL_PASSWORD=<span class="string">&quot;123456&quot;</span></span><br><span class="line">MYSQL_HOST=<span class="string">&quot;localhost&quot;</span></span><br><span class="line">MYSQL_PORT=<span class="string">&quot;3306&quot;</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加执行权限并复制到/usr/bin/下</span></span><br><span class="line">$ chmod +x /extend/<span class="keyword">shell</span><span class="language-bash">/clustercheck</span></span><br><span class="line">$ cp /extend/<span class="keyword">shell</span><span class="language-bash">/clustercheck /usr/bin/</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>最新下载的 clustercheck 脚本好像不用设置 MYSQL_HOST 与 MYSQL_PORT 参数</li>
<li>&#x2F;usr&#x2F;bin&#x2F;clustercheck 参考</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Script to make a proxy (ie HAProxy) capable of monitoring Percona XtraDB Cluster nodes properly</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: Olaf van Zandwijk &lt;olaf.vanzandwijk@nedap.com&gt;</span></span><br><span class="line"><span class="comment"># Author: Raghavendra Prabhu &lt;raghavendra.prabhu@percona.com&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Documentation and download: https://github.com/olafz/percona-clustercheck</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Based on the original script from Unai Rodriguez</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$1</span> == <span class="string">&#x27;-h&#x27;</span> || <span class="variable">$1</span> == <span class="string">&#x27;--help&#x27;</span> ]];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> &lt;user&gt; &lt;pass&gt; &lt;available_when_donor=0|1&gt; &lt;log_file&gt; &lt;available_when_readonly=0|1&gt; &lt;defaults_extra_file&gt;&quot;</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if the disabled file is present, return 503. This allows</span></span><br><span class="line"><span class="comment"># admins to manually remove a node from a cluster easily.</span></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="string">&quot;/var/tmp/clustercheck.disabled&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="comment"># Shell return-code is 1</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;HTTP/1.1 503 Service Unavailable\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;Content-Type: text/plain\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;Content-Length: 51\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;Percona XtraDB Cluster Node is manually disabled.\r\n&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 0.1</span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/sysconfig/clustercheck ]; <span class="keyword">then</span></span><br><span class="line">. /etc/sysconfig/clustercheck</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">MYSQL_USERNAME=<span class="string">&quot;clustercheck&quot;</span></span><br><span class="line">MYSQL_PASSWORD=<span class="string">&quot;123456&quot;</span></span><br><span class="line">MYSQL_HOST=<span class="string">&quot;localhost&quot;</span></span><br><span class="line">MYSQL_PORT=<span class="string">&quot;3306&quot;</span></span><br><span class="line"></span><br><span class="line">AVAILABLE_WHEN_DONOR=<span class="variable">$&#123;AVAILABLE_WHEN_DONOR:-0&#125;</span></span><br><span class="line">ERR_FILE=<span class="string">&quot;<span class="variable">$&#123;ERR_FILE:-/dev/null&#125;</span>&quot;</span></span><br><span class="line">AVAILABLE_WHEN_READONLY=<span class="variable">$&#123;AVAILABLE_WHEN_READONLY:-1&#125;</span></span><br><span class="line">DEFAULTS_EXTRA_FILE=<span class="variable">$&#123;DEFAULTS_EXTRA_FILE:-/etc/my.cnf&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Timeout exists for instances where mysqld may be hung</span></span><br><span class="line">TIMEOUT=10</span><br><span class="line"></span><br><span class="line">EXTRA_ARGS=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$MYSQL_USERNAME</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">EXTRA_ARGS=<span class="string">&quot;<span class="variable">$EXTRA_ARGS</span> --user=<span class="variable">$&#123;MYSQL_USERNAME&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$MYSQL_PASSWORD</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">EXTRA_ARGS=<span class="string">&quot;<span class="variable">$EXTRA_ARGS</span> --password=<span class="variable">$&#123;MYSQL_PASSWORD&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [[ -r <span class="variable">$DEFAULTS_EXTRA_FILE</span> ]];<span class="keyword">then</span></span><br><span class="line">MYSQL_CMDLINE=<span class="string">&quot;mysql --defaults-extra-file=<span class="variable">$DEFAULTS_EXTRA_FILE</span> -nNE --connect-timeout=<span class="variable">$TIMEOUT</span> \</span></span><br><span class="line"><span class="string">            <span class="variable">$&#123;EXTRA_ARGS&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">MYSQL_CMDLINE=<span class="string">&quot;mysql -nNE --connect-timeout=<span class="variable">$TIMEOUT</span> <span class="variable">$&#123;EXTRA_ARGS&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Perform the query to check the wsrep_local_state</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">WSREP_STATUS=$(<span class="variable">$MYSQL_CMDLINE</span> -e <span class="string">&quot;SHOW STATUS LIKE &#x27;wsrep_local_state&#x27;;&quot;</span> \</span><br><span class="line">2&gt;<span class="variable">$&#123;ERR_FILE&#125;</span> | <span class="built_in">tail</span> -1 2&gt;&gt;<span class="variable">$&#123;ERR_FILE&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;WSREP_STATUS&#125;</span>&quot;</span> == <span class="string">&quot;4&quot;</span> ]] || [[ <span class="string">&quot;<span class="variable">$&#123;WSREP_STATUS&#125;</span>&quot;</span> == <span class="string">&quot;2&quot;</span> &amp;&amp; <span class="variable">$&#123;AVAILABLE_WHEN_DONOR&#125;</span> == 1 ]]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="comment"># Check only when set to 0 to avoid latency in response.</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$AVAILABLE_WHEN_READONLY</span> -eq 0 ]];<span class="keyword">then</span></span><br><span class="line">READ_ONLY=$(<span class="variable">$MYSQL_CMDLINE</span> -e <span class="string">&quot;SHOW GLOBAL VARIABLES LIKE &#x27;read_only&#x27;;&quot;</span> \</span><br><span class="line">            2&gt;<span class="variable">$&#123;ERR_FILE&#125;</span> | <span class="built_in">tail</span> -1 2&gt;&gt;<span class="variable">$&#123;ERR_FILE&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;READ_ONLY&#125;</span>&quot;</span> == <span class="string">&quot;ON&quot;</span> ]];<span class="keyword">then</span></span><br><span class="line">    <span class="comment"># Percona XtraDB Cluster node local state is &#x27;Synced&#x27;, but it is in</span></span><br><span class="line">    <span class="comment"># read-only mode. The variable AVAILABLE_WHEN_READONLY is set to 0.</span></span><br><span class="line">    <span class="comment"># =&gt; return HTTP 503</span></span><br><span class="line">    <span class="comment"># Shell return-code is 1</span></span><br><span class="line">    <span class="built_in">echo</span> -en <span class="string">&quot;HTTP/1.1 503 Service Unavailable\r\n&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -en <span class="string">&quot;Content-Type: text/plain\r\n&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -en <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -en <span class="string">&quot;Content-Length: 43\r\n&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -en <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -en <span class="string">&quot;Percona XtraDB Cluster Node is read-only.\r\n&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> 0.1</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># Percona XtraDB Cluster node local state is &#x27;Synced&#x27; =&gt; return HTTP 200</span></span><br><span class="line"><span class="comment"># Shell return-code is 0</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;Content-Type: text/plain\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;Content-Length: 40\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;Percona XtraDB Cluster Node is synced.\r\n&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 0.1</span><br><span class="line"><span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment"># Percona XtraDB Cluster node local state is not &#x27;Synced&#x27; =&gt; return HTTP 503</span></span><br><span class="line"><span class="comment"># Shell return-code is 1</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;HTTP/1.1 503 Service Unavailable\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;Content-Type: text/plain\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;Content-Length: 44\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;\r\n&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;Percona XtraDB Cluster Node is not synced.\r\n&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 0.1</span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></div>

<p><strong>创建心跳检测服务</strong></p>
<p>在全部控制节点新增心跳检测服务配置文件&#x2F;etc&#x2F;xinetd.d&#x2F;galera-monitor，以controller01节点为例</p>
<div class="highlight-container" data-rel="Makefile"><figure class="iseeu highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ vi /etc/xinetd.d/galera-monitor</span><br><span class="line"><span class="comment"># default:on</span></span><br><span class="line"><span class="comment"># description: galera-monitor</span></span><br><span class="line">service galera-monitor</span><br><span class="line">&#123;</span><br><span class="line">port = 9200</span><br><span class="line">disable = no</span><br><span class="line">socket_type = stream</span><br><span class="line">protocol = tcp</span><br><span class="line">wait = no</span><br><span class="line">user = root</span><br><span class="line">group = root</span><br><span class="line">groups = yes</span><br><span class="line">server = /usr/bin/clustercheck</span><br><span class="line">type = UNLISTED</span><br><span class="line">per_source = UNLIMITED</span><br><span class="line">log_on_success =</span><br><span class="line">log_on_failure = HOST</span><br><span class="line">flags = REUSE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>修改 &#x2F;etc&#x2F;services</p>
<div class="highlight-container" data-rel="Python-repl"><figure class="iseeu highlight python-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">...</span></span><br><span class="line">#wap-wsp        9200/tcp                # WAP connectionless session service</span><br><span class="line">galera-monitor  9200/tcp                # galera-monitor</span><br><span class="line"><span class="meta prompt_">...</span></span><br></pre></td></tr></table></figure></div>

<p>启动 xinetd 服务</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全部控制节点都需要启动</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> xinetd</span><br><span class="line">systemctl start xinetd</span><br><span class="line">systemctl status xinetd</span><br></pre></td></tr></table></figure></div>

<p><strong>测试心跳检测脚本</strong></p>
<p>在全部控制节点验证，以controller01节点为例</p>
<div class="highlight-container" data-rel="Makefile"><figure class="iseeu highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/bin/clustercheck</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line"><span class="section">Content-Type: text/plain</span></span><br><span class="line"><span class="section">Connection: close</span></span><br><span class="line"><span class="section">Content-Length: 40</span></span><br><span class="line"></span><br><span class="line">Percona XtraDB Cluster Node is synced.</span><br></pre></td></tr></table></figure></div>

<h3 id="异常关机或异常断电后的修复"><a href="#异常关机或异常断电后的修复" class="headerlink" title="异常关机或异常断电后的修复"></a>异常关机或异常断电后的修复</h3><p>当突然停电，所有galera主机都非正常关机，来电后开机，会导致galera集群服务无法正常启动。以下为处理办法</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">第1步：开启galera集群的群主主机的mariadb服务。</span><br><span class="line">第2步：开启galera集群的成员主机的mariadb服务。</span><br><span class="line"></span><br><span class="line">异常处理：galera集群的群主主机和成员主机的mysql服务无法启动，如何处理？</span><br><span class="line"></span><br><span class="line"><span class="comment">#解决方法一：</span></span><br><span class="line">第1步、删除garlera群主主机的/var/lib/mysql/grastate.dat状态文件</span><br><span class="line">/bin/galera_new_cluster启动服务。启动正常。登录并查看wsrep状态。</span><br><span class="line"></span><br><span class="line">第2步：删除galera成员主机中的/var/lib/mysql/grastate.dat状态文件</span><br><span class="line">systemctl restart mariadb重启服务。启动正常。登录并查看wsrep状态。</span><br><span class="line"></span><br><span class="line"><span class="comment">#解决方法二：</span></span><br><span class="line">第1步、修改garlera群主主机的/var/lib/mysql/grastate.dat状态文件中的0为1</span><br><span class="line">/bin/galera_new_cluster启动服务。启动正常。登录并查看wsrep状态。</span><br><span class="line"></span><br><span class="line">第2步：修改galera成员主机中的/var/lib/mysql/grastate.dat状态文件中的0为1</span><br><span class="line">systemctl restart mariadb重启服务。启动正常。登录并查看wsrep状态。</span><br><span class="line"></span><br><span class="line">经过实际发现，以下操作步骤也可以：</span><br><span class="line">第1步、修改garlera群主主机的/var/lib/mysql/grastate.dat状态文件中的0为1</span><br><span class="line">systemctl restart mariadb重启服务</span><br><span class="line"></span><br><span class="line">第2步：修改galera成员主机直接使用systemctl restart mariadb重启服务</span><br></pre></td></tr></table></figure></div>

<h2 id="RabbitMQ集群"><a href="#RabbitMQ集群" class="headerlink" title="RabbitMQ集群"></a>RabbitMQ集群</h2><p>RabbitMQ采用原生Cluster集群，所有节点同步镜像队列。三台物理机，其中2个Mem节点主要提供服务，1个Disk节点用于持久化消息，客户端根据需求分别配置主从策略。</p>
<p><strong>目前测试将RabbitMQ三个节点部署到了控制节点上。</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111041300835.webp"
                      alt="img"
                ></p>
<h3 id="下载相关软件包-所有控制节点"><a href="#下载相关软件包-所有控制节点" class="headerlink" title="下载相关软件包(所有控制节点)"></a>下载相关软件包(所有控制节点)</h3><p>以controller01节点为例，RabbbitMQ基与erlang开发，首先安装erlang，采用yum方式</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install erlang rabbitmq-server -y</span><br><span class="line">systemctl <span class="built_in">enable</span> rabbitmq-server.service</span><br></pre></td></tr></table></figure></div>

<h3 id="构建rabbitmq集群"><a href="#构建rabbitmq集群" class="headerlink" title="构建rabbitmq集群"></a>构建rabbitmq集群</h3><p><strong>任选1个控制节点首先启动rabbitmq服务</strong></p>
<p>这里选择controller01节点</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="keyword">start</span> rabbitmq<span class="operator">-</span>server.service</span><br><span class="line">rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure></div>

<p><strong>分发.erlang.cookie到其他控制节点</strong></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -p /<span class="keyword">var</span>/lib/rabbitmq/.<span class="property">erlang</span>.<span class="property">cookie</span>  <span class="attr">controller02</span>:<span class="regexp">/var/</span>lib/rabbitmq/</span><br><span class="line">scp -p /<span class="keyword">var</span>/lib/rabbitmq/.<span class="property">erlang</span>.<span class="property">cookie</span>  <span class="attr">controller03</span>:<span class="regexp">/var/</span>lib/rabbitmq/</span><br></pre></td></tr></table></figure></div>

<p><strong>修改controller02和03节点.erlang.cookie文件的用户&#x2F;组</strong></p>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@controller02 ~</span>]<span class="meta"># chown rabbitmq:rabbitmq /var/lib/rabbitmq/.erlang.cookie</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">root@controller03 ~</span>]<span class="meta"># chown rabbitmq:rabbitmq /var/lib/rabbitmq/.erlang.cookie</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>注意：修改全部控制节点.erlang.cookie文件的权限，默认为400权限，可用不修改</li>
</ul>
<p><strong>启动controller02和03节点的rabbitmq服务</strong></p>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@controller02 ~</span>]<span class="meta"># systemctl start rabbitmq-server</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">root@controller03 ~</span>]<span class="meta"># systemctl start rabbitmq-server</span></span><br></pre></td></tr></table></figure></div>

<p><strong>构建集群，controller02和03节点以ram节点的形式加入集群</strong></p>
<p>controller02</p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl join_cluster <span class="attr">--ram</span> rabbit<span class="keyword">@controller01</span></span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></table></figure></div>

<p>controller03</p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl join_cluster <span class="attr">--ram</span> rabbit<span class="keyword">@controller01</span></span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></table></figure></div>

<p><strong>任意控制节点查看RabbitMQ集群状态</strong></p>
<div class="highlight-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rabbitmqctl cluster_status</span><br><span class="line">Cluster status of node rabbit@controller01</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit@controller01]&#125;,</span><br><span class="line"> &#123;ram,[rabbit@controller03,rabbit@controller02]&#125;]&#125;,</span><br><span class="line">&#123;running_nodes,[rabbit@controller03,rabbit@controller02,rabbit@controller01]&#125;,</span><br><span class="line">&#123;cluster_name,&lt;&lt;<span class="string">&quot;rabbit@controller01&quot;</span>&gt;&gt;&#125;,</span><br><span class="line">&#123;partitions,[]&#125;,</span><br><span class="line">&#123;alarms,[&#123;rabbit@controller03,[]&#125;,</span><br><span class="line">  &#123;rabbit@controller02,[]&#125;,</span><br><span class="line">  &#123;rabbit@controller01,[]&#125;]&#125;]</span><br></pre></td></tr></table></figure></div>

<p><strong>创建rabbitmq管理员账号</strong></p>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 在任意节点新建账号并设置密码，以controller01节点为例</span></span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta"># rabbitmqctl add_user openstack 123456</span></span><br><span class="line">Creating user <span class="string">&quot;openstack&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 设置新建账号的状态</span></span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta"># rabbitmqctl set_user_tags openstack administrator</span></span><br><span class="line">Setting tags <span class="keyword">for</span> user <span class="string">&quot;openstack&quot;</span> to [administrator]</span><br><span class="line"></span><br><span class="line"><span class="meta"># 设置新建账号的权限</span></span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta"># rabbitmqctl set_permissions -p &quot;/&quot; openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span></span><br><span class="line">Setting permissions <span class="keyword">for</span> user <span class="string">&quot;openstack&quot;</span> <span class="keyword">in</span> vhost <span class="string">&quot;/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 查看账号</span></span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta"># rabbitmqctl list_users</span></span><br><span class="line">Listing users</span><br><span class="line">openstack       [administrator]</span><br><span class="line">guest   [administrator]</span><br></pre></td></tr></table></figure></div>

<p><strong>镜像队列的ha</strong></p>
<p>设置镜像队列高可用</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# rabbitmqctl set_policy ha<span class="operator">-</span><span class="keyword">all</span> &quot;^&quot; <span class="string">&#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;</span></span><br><span class="line">Setting policy &quot;ha-all&quot; <span class="keyword">for</span> <span class="keyword">pattern</span> &quot;^&quot; <span class="keyword">to</span> &quot;&#123;\&quot;ha<span class="operator">-</span>mode\&quot;:\&quot;<span class="keyword">all</span>\&quot;&#125;&quot; <span class="keyword">with</span> priority &quot;0&quot;</span><br></pre></td></tr></table></figure></div>

<p>任意控制节点查看镜像队列策略</p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@controller01 ~]</span># rabbitmqctl list_policies</span><br><span class="line">Listing policies</span><br><span class="line">/       ha-<span class="attribute">all</span>  <span class="attribute">all</span>     ^       &#123;&quot;ha-mode&quot;:<span class="string">&quot;all&quot;</span>&#125;       <span class="number">0</span></span><br></pre></td></tr></table></figure></div>

<p><strong>安装web管理插件</strong></p>
<p>在全部控制节点安装web管理插件，以controller01节点为例</p>
<div class="highlight-container" data-rel="Ruby"><figure class="iseeu highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@controller01</span> ~]<span class="comment"># rabbitmq-plugins enable rabbitmq_management</span></span><br><span class="line"><span class="title class_">The</span> following plugins have been <span class="symbol">enabled:</span></span><br><span class="line">amqp_client</span><br><span class="line">cowlib</span><br><span class="line">cowboy</span><br><span class="line">rabbitmq_web_dispatch</span><br><span class="line">rabbitmq_management_agent</span><br><span class="line">rabbitmq_management</span><br><span class="line"></span><br><span class="line"><span class="title class_">Applying</span> plugin configuration to rabbit<span class="variable">@controller01</span>... started <span class="number">6</span> plugins.</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@controller01</span> ~]<span class="comment"># ss -ntlp|grep 5672</span></span><br><span class="line"><span class="variable constant_">LISTEN</span>     <span class="number">0</span>      <span class="number">128</span>          *<span class="symbol">:</span><span class="number">25672</span>                    *<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">&quot;beam&quot;</span>,pid=<span class="number">2222</span>,fd=<span class="number">42</span>))</span><br><span class="line"><span class="variable constant_">LISTEN</span>     <span class="number">0</span>      <span class="number">1024</span>         *<span class="symbol">:</span><span class="number">15672</span>                    *<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">&quot;beam&quot;</span>,pid=<span class="number">2222</span>,fd=<span class="number">54</span>))</span><br><span class="line"><span class="variable constant_">LISTEN</span>     <span class="number">0</span>      <span class="number">128</span>       [<span class="symbol">:</span><span class="symbol">:</span>]<span class="symbol">:</span><span class="number">5672</span>                  [<span class="symbol">:</span><span class="symbol">:</span>]<span class="symbol">:*</span>                   <span class="symbol">users:</span>((<span class="string">&quot;beam&quot;</span>,pid=<span class="number">2222</span>,fd=<span class="number">53</span>))</span><br></pre></td></tr></table></figure></div>

<ul>
<li>访问任意控制节点，如： <a class="link"   target="_blank" rel="noopener" href="http://10.10.10.31:15672/" >http://10.10.10.31:15672 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111041445300.png"
                      alt="image-20211104144552147"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111041446630.png"
                      alt="image-20211104144643284"
                ></p>
<h2 id="Memcached集群"><a href="#Memcached集群" class="headerlink" title="Memcached集群"></a>Memcached集群</h2><p>Memcached是无状态的，各控制节点独立部署，openstack各服务模块统一调用多个控制节点的memcached服务即可。</p>
<h3 id="安装memcache的软件包"><a href="#安装memcache的软件包" class="headerlink" title="安装memcache的软件包"></a>安装memcache的软件包</h3><p>在全部控制节点安装</p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>memcached python-memcached -y</span><br></pre></td></tr></table></figure></div>

<h3 id="设置memcached"><a href="#设置memcached" class="headerlink" title="设置memcached"></a>设置memcached</h3><p>在全部安装memcached服务的节点设置服务监听本地地址</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s|127.0.0.1,::1|0.0.0.0|g&#x27;</span> /etc/sysconfig/memcached</span><br></pre></td></tr></table></figure></div>

<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> memcached.service</span><br><span class="line">systemctl start memcached.service</span><br><span class="line">systemctl status memcached.service</span><br><span class="line">ss -tnlp|grep memcached</span><br></pre></td></tr></table></figure></div>

<h2 id="高可用-haproxy-keepalived"><a href="#高可用-haproxy-keepalived" class="headerlink" title="高可用 haproxy + keepalived"></a>高可用 haproxy + keepalived</h2><p>Openstack官网使用开源的pacemaker cluster stack做为集群高可用资源管理软件。但是我没接触过，也不想去研究了，直接使用熟悉的配方：haproxy + keepalived。</p>
<p>vip规划：10.10.10.10</p>
<h3 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h3><p>两台 ha 节点执行</p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>haproxy keepalived -y</span><br></pre></td></tr></table></figure></div>

<h3 id="配置-keepalived"><a href="#配置-keepalived" class="headerlink" title="配置 keepalived"></a>配置 keepalived</h3><p>修改 ha01 节点 keepalived 配置 &#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf：</p>
<div class="highlight-container" data-rel="Fsharp"><figure class="iseeu highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">!</span> Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line"><span class="keyword">global_defs</span> &#123;</span><br><span class="line"><span class="keyword">notification_email</span> &#123;</span><br><span class="line">acassen<span class="operator">@</span>firewall.loc</span><br><span class="line">failover<span class="operator">@</span>firewall.loc</span><br><span class="line">sysadmin<span class="operator">@</span>firewall.loc</span><br><span class="line">&#125;</span><br><span class="line">notification_email_from Alexandre.Cassen<span class="operator">@</span>firewall.loc</span><br><span class="line">smtp_server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">smtp_connect_timeout <span class="number">30</span></span><br><span class="line">router_id LVS_DEVEL</span><br><span class="line">vrrp_skip_check_adv_addr</span><br><span class="line">#vrrp_strict</span><br><span class="line">vrrp_garp_interval <span class="number">0</span></span><br><span class="line">vrrp_gna_interval <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script <span class="keyword">chk_haproxy</span> &#123;</span><br><span class="line">script <span class="string">&quot;/data/sh/check_haproxy.sh&quot;</span></span><br><span class="line">interval <span class="number">2</span></span><br><span class="line">weight <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state MASTER</span><br><span class="line"><span class="keyword">interface</span> ens33</span><br><span class="line">virtual_router_id <span class="number">51</span></span><br><span class="line">priority <span class="number">100</span></span><br><span class="line">advert_int <span class="number">1</span></span><br><span class="line"><span class="keyword">authentication</span> &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass <span class="number">1111</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">virtual_ipaddress</span> &#123;</span><br><span class="line"><span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">track_script</span> &#123;</span><br><span class="line">chk_haproxy</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>注意网卡名与vip</li>
</ul>
<p>修改 ha02 节点 keepalived 配置 &#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf：</p>
<div class="highlight-container" data-rel="Fsharp"><figure class="iseeu highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">!</span> Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line"><span class="keyword">global_defs</span> &#123;</span><br><span class="line"><span class="keyword">notification_email</span> &#123;</span><br><span class="line">acassen<span class="operator">@</span>firewall.loc</span><br><span class="line">failover<span class="operator">@</span>firewall.loc</span><br><span class="line">sysadmin<span class="operator">@</span>firewall.loc</span><br><span class="line">&#125;</span><br><span class="line">notification_email_from Alexandre.Cassen<span class="operator">@</span>firewall.loc</span><br><span class="line">smtp_server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">smtp_connect_timeout <span class="number">30</span></span><br><span class="line">router_id LVS_DEVEL</span><br><span class="line">vrrp_skip_check_adv_addr</span><br><span class="line">#vrrp_strict</span><br><span class="line">vrrp_garp_interval <span class="number">0</span></span><br><span class="line">vrrp_gna_interval <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script <span class="keyword">chk_haproxy</span> &#123;</span><br><span class="line">script <span class="string">&quot;/data/sh/check_haproxy.sh&quot;</span></span><br><span class="line">interval <span class="number">2</span></span><br><span class="line">weight <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state BACKUP</span><br><span class="line"><span class="keyword">interface</span> ens33</span><br><span class="line">virtual_router_id <span class="number">51</span></span><br><span class="line">priority <span class="number">90</span></span><br><span class="line">advert_int <span class="number">1</span></span><br><span class="line"><span class="keyword">authentication</span> &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass <span class="number">1111</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">virtual_ipaddress</span> &#123;</span><br><span class="line"><span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">track_script</span> &#123;</span><br><span class="line">chk_haproxy</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ha01 和 ha02 添加 haproxy 检测脚本：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> -p /data/sh/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vi /data/sh/check_haproxy.sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">auto check haprox process</span></span><br><span class="line"></span><br><span class="line">haproxy_process_count=$(ps aux|grep haproxy|grep -v check_haproxy|grep -v grep|wc -l)</span><br><span class="line"></span><br><span class="line">if [[ $haproxy_process_count == 0 ]];then</span><br><span class="line">systemctl stop keepalived</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> 755 /data/sh/check_haproxy.sh</span></span><br></pre></td></tr></table></figure></div>

<h3 id="启动-haproxy-与-keepalived"><a href="#启动-haproxy-与-keepalived" class="headerlink" title="启动 haproxy 与 keepalived"></a>启动 haproxy 与 keepalived</h3><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line">systemctl start haproxy</span><br><span class="line">systemctl status haproxy</span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived</span><br><span class="line">systemctl start keepalived</span><br><span class="line">systemctl status keepalived</span><br></pre></td></tr></table></figure></div>

<p>启动正常后，在 ha01 节点应该可以看到已经正常添加 vip 10.10.10.10</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111041512175.png"
                      alt="image-20211104151247959"
                ></p>
<h3 id="测试高可用"><a href="#测试高可用" class="headerlink" title="测试高可用"></a>测试高可用</h3><p>在 ha01 停止 haproxy，正常的话 vip 会漂移到 ha02 主机上</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111041514657.png"
                      alt="image-20211104151423454"
                ></p>
<p>在 ha01 重新启动 haproxy 和 keepalived 后 vip 会漂移回来</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111041516604.png"
                      alt="image-20211104151627452"
                ></p>
<h3 id="配置-haproxy"><a href="#配置-haproxy" class="headerlink" title="配置 haproxy"></a>配置 haproxy</h3><p>建议开启haproxy的日志功能，便于后续的问题排查</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /var/log/haproxy</span><br><span class="line"><span class="built_in">chmod</span> a+w /var/log/haproxy</span><br></pre></td></tr></table></figure></div>

<p>在rsyslog文件下修改以下字段</p>
<div class="highlight-container" data-rel="Ruby"><figure class="iseeu highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取消注释并添加</span></span><br><span class="line"><span class="variable">$ </span>vi /etc/rsyslog.conf</span><br><span class="line"><span class="number">19</span> <span class="variable">$ModLoad</span> imudp</span><br><span class="line"><span class="number">20</span> <span class="variable">$UDPServerRun</span> <span class="number">514</span></span><br><span class="line"></span><br><span class="line"><span class="number">24</span> <span class="variable">$ModLoad</span> imtcp</span><br><span class="line"><span class="number">25</span> <span class="variable">$InputTCPServerRun</span> <span class="number">514</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在文件最后添加haproxy配置日志</span></span><br><span class="line">local0.=info    -<span class="regexp">/var/log</span><span class="regexp">/haproxy/haproxy</span>-info.log</span><br><span class="line">local0.=err     -<span class="regexp">/var/log</span><span class="regexp">/haproxy/haproxy</span>-err.log</span><br><span class="line">local0.notice;local0.!=err      -<span class="regexp">/var/log</span><span class="regexp">/haproxy/haproxy</span>-notice.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启rsyslog</span></span><br><span class="line"><span class="variable">$ </span>systemctl restart rsyslog</span><br></pre></td></tr></table></figure></div>

<p>haproxy 配置中涉及服务较多，这里针对涉及到的 openstack 服务，一次性设置完成</p>
<p>全部 ha 节点都需配置，配置文件 &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg</p>
<div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">global</span></span><br><span class="line"><span class="string">log</span>      <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>     <span class="string">local0</span></span><br><span class="line"><span class="string">chroot</span>   <span class="string">/var/lib/haproxy</span></span><br><span class="line"><span class="string">daemon</span></span><br><span class="line"><span class="string">group</span>    <span class="string">haproxy</span></span><br><span class="line"><span class="string">user</span>     <span class="string">haproxy</span></span><br><span class="line"><span class="string">maxconn</span>  <span class="number">4000</span></span><br><span class="line"><span class="string">pidfile</span>  <span class="string">/var/run/haproxy.pid</span></span><br><span class="line"><span class="string">stats</span>    <span class="string">socket</span> <span class="string">/var/lib/haproxy/stats</span></span><br><span class="line"></span><br><span class="line"><span class="string">defaults</span></span><br><span class="line"><span class="string">mode</span>                    <span class="string">http</span></span><br><span class="line"><span class="string">log</span>                     <span class="string">global</span></span><br><span class="line"><span class="string">maxconn</span>                 <span class="number">4000</span>    <span class="comment">#最大连接数</span></span><br><span class="line"><span class="string">option</span>                  <span class="string">httplog</span></span><br><span class="line"><span class="string">option</span>                  <span class="string">redispatch</span></span><br><span class="line"><span class="string">retries</span>                 <span class="number">3</span></span><br><span class="line"><span class="string">timeout</span> <span class="string">http-request</span>    <span class="string">10s</span></span><br><span class="line"><span class="string">timeout</span> <span class="string">queue</span>           <span class="string">1m</span></span><br><span class="line"><span class="string">timeout</span> <span class="string">connect</span>         <span class="string">10s</span></span><br><span class="line"><span class="string">timeout</span> <span class="string">client</span>          <span class="string">1m</span></span><br><span class="line"><span class="string">timeout</span> <span class="string">server</span>          <span class="string">1m</span></span><br><span class="line"><span class="string">timeout</span> <span class="string">check</span>           <span class="string">10s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># haproxy监控页</span></span><br><span class="line"><span class="string">listen</span> <span class="string">stats</span></span><br><span class="line"><span class="string">bind</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:1080</span></span><br><span class="line"><span class="string">mode</span> <span class="string">http</span></span><br><span class="line"><span class="string">stats</span> <span class="string">enable</span></span><br><span class="line"><span class="string">stats</span> <span class="string">uri</span> <span class="string">/</span></span><br><span class="line"><span class="string">stats</span> <span class="string">realm</span> <span class="string">OpenStack\</span> <span class="string">Haproxy</span></span><br><span class="line"><span class="string">stats</span> <span class="string">auth</span> <span class="string">admin:123456</span></span><br><span class="line"><span class="string">stats</span>  <span class="string">refresh</span> <span class="string">30s</span></span><br><span class="line"><span class="string">stats</span>  <span class="string">show-node</span></span><br><span class="line"><span class="string">stats</span>  <span class="string">show-legends</span></span><br><span class="line"><span class="string">stats</span>  <span class="string">hide-version</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># horizon服务</span></span><br><span class="line"><span class="string">listen</span> <span class="string">dashboard_cluster</span></span><br><span class="line"><span class="string">bind</span>  <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span><span class="string">:80</span></span><br><span class="line"><span class="string">balance</span>  <span class="string">source</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcpka</span></span><br><span class="line"><span class="string">option</span>  <span class="string">httpchk</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcplog</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller01</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.31</span><span class="string">:80</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller02</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.32</span><span class="string">:80</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller03</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.33</span><span class="string">:80</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mariadb服务；</span></span><br><span class="line"><span class="comment">#设置controller01节点为master，controller02/03节点为backup，一主多备的架构可规避数据不一致性；</span></span><br><span class="line"><span class="comment">#另外官方示例为检测9200（心跳）端口，测试在mariadb服务宕机的情况下，虽然”/usr/bin/clustercheck”脚本已探测不到服务，但受xinetd控制的9200端口依然正常，导致haproxy始终将请求转发到mariadb服务宕机的节点，暂时修改为监听3306端口</span></span><br><span class="line"><span class="string">listen</span> <span class="string">galera_cluster</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span><span class="string">:3306</span></span><br><span class="line"><span class="string">balance</span>  <span class="string">source</span></span><br><span class="line"><span class="string">mode</span>    <span class="string">tcp</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller01</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.31</span><span class="string">:3306</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller02</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.32</span><span class="string">:3306</span> <span class="string">backup</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller03</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.33</span><span class="string">:3306</span> <span class="string">backup</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#为rabbirmq提供ha集群访问端口，供openstack各服务访问；</span></span><br><span class="line"><span class="comment">#如果openstack各服务直接连接rabbitmq集群，这里可不设置rabbitmq的负载均衡</span></span><br><span class="line"><span class="string">listen</span> <span class="string">rabbitmq_cluster</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span><span class="string">:5672</span></span><br><span class="line"><span class="string">mode</span> <span class="string">tcp</span></span><br><span class="line"><span class="string">option</span> <span class="string">tcpka</span></span><br><span class="line"><span class="string">balance</span> <span class="string">roundrobin</span></span><br><span class="line"><span class="string">timeout</span> <span class="string">client</span>  <span class="string">3h</span></span><br><span class="line"><span class="string">timeout</span> <span class="string">server</span>  <span class="string">3h</span></span><br><span class="line"><span class="string">option</span>  <span class="string">clitcpka</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller01</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.31</span><span class="string">:5672</span> <span class="string">check</span> <span class="string">inter</span> <span class="string">10s</span> <span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller02</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.32</span><span class="string">:5672</span> <span class="string">check</span> <span class="string">inter</span> <span class="string">10s</span> <span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller03</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.33</span><span class="string">:5672</span> <span class="string">check</span> <span class="string">inter</span> <span class="string">10s</span> <span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># glance_api服务</span></span><br><span class="line"><span class="string">listen</span> <span class="string">glance_api_cluster</span></span><br><span class="line"><span class="string">bind</span>  <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span><span class="string">:9292</span></span><br><span class="line"><span class="string">balance</span>  <span class="string">source</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcpka</span></span><br><span class="line"><span class="string">option</span>  <span class="string">httpchk</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcplog</span></span><br><span class="line"><span class="string">timeout</span> <span class="string">client</span> <span class="string">3h</span></span><br><span class="line"><span class="string">timeout</span> <span class="string">server</span> <span class="string">3h</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller01</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.31</span><span class="string">:9292</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller02</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.32</span><span class="string">:9292</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller03</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.33</span><span class="string">:9292</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># keystone_public _api服务</span></span><br><span class="line"><span class="string">listen</span> <span class="string">keystone_public_cluster</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span><span class="string">:5000</span></span><br><span class="line"><span class="string">balance</span>  <span class="string">source</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcpka</span></span><br><span class="line"><span class="string">option</span>  <span class="string">httpchk</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcplog</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller01</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.31</span><span class="string">:5000</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller02</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.32</span><span class="string">:5000</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller03</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.33</span><span class="string">:5000</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="string">listen</span> <span class="string">nova_compute_api_cluster</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span><span class="string">:8774</span></span><br><span class="line"><span class="string">balance</span>  <span class="string">source</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcpka</span></span><br><span class="line"><span class="string">option</span>  <span class="string">httpchk</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcplog</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller01</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.31</span><span class="string">:8774</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller02</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.32</span><span class="string">:8774</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller03</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.33</span><span class="string">:8774</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="string">listen</span> <span class="string">nova_placement_cluster</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span><span class="string">:8778</span></span><br><span class="line"><span class="string">balance</span>  <span class="string">source</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcpka</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcplog</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller01</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.31</span><span class="string">:8778</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller02</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.32</span><span class="string">:8778</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller03</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.33</span><span class="string">:8778</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="string">listen</span> <span class="string">nova_metadata_api_cluster</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span><span class="string">:8775</span></span><br><span class="line"><span class="string">balance</span>  <span class="string">source</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcpka</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcplog</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller01</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.31</span><span class="string">:8775</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller02</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.32</span><span class="string">:8775</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller03</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.33</span><span class="string">:8775</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="string">listen</span> <span class="string">nova_vncproxy_cluster</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span><span class="string">:6080</span></span><br><span class="line"><span class="string">balance</span>  <span class="string">source</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcpka</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcplog</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller01</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.31</span><span class="string">:6080</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller02</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.32</span><span class="string">:6080</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller03</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.33</span><span class="string">:6080</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="string">listen</span> <span class="string">neutron_api_cluster</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span><span class="string">:9696</span></span><br><span class="line"><span class="string">balance</span>  <span class="string">source</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcpka</span></span><br><span class="line"><span class="string">option</span>  <span class="string">httpchk</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcplog</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller01</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.31</span><span class="string">:9696</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller02</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.32</span><span class="string">:9696</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller03</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.33</span><span class="string">:9696</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="string">listen</span> <span class="string">cinder_api_cluster</span></span><br><span class="line"><span class="string">bind</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span><span class="string">:8776</span></span><br><span class="line"><span class="string">balance</span>  <span class="string">source</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcpka</span></span><br><span class="line"><span class="string">option</span>  <span class="string">httpchk</span></span><br><span class="line"><span class="string">option</span>  <span class="string">tcplog</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller01</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.31</span><span class="string">:8776</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller02</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.32</span><span class="string">:8776</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br><span class="line"><span class="string">server</span> <span class="string">controller03</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.33</span><span class="string">:8776</span> <span class="string">check</span> <span class="string">inter</span> <span class="number">2000 </span><span class="string">rise</span> <span class="number">2</span> <span class="string">fall</span> <span class="number">5</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>bind ip 设置为 vip</li>
</ul>
<p>重启 haproxy</p>
<div class="highlight-container" data-rel="Lua"><figure class="iseeu highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart haproxy</span><br><span class="line">systemctl <span class="built_in">status</span> haproxy</span><br></pre></td></tr></table></figure></div>

<p>访问 haproxy 自带 web 管理页面：</p>
<p><a class="link"   target="_blank" rel="noopener" href="http://10.10.10.10:1080/" >http://10.10.10.10:1080/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> or <a class="link"   target="_blank" rel="noopener" href="http://10.10.10.21:1080/" >http://10.10.10.21:1080/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> or <a class="link"   target="_blank" rel="noopener" href="http://10.10.10.22:1080/" >http://10.10.10.22:1080/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>admin 123456</p>
<p>每个项的状态可以清晰看到；可以看到很多为红色，正常，因为这些服务现在还未安装；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111041534702.png"
                      alt="image-20211104153418231"
                ></p>
<p>至此，openstack的基础依赖服务基本部署完成。</p>
<h1 id="三、Keystone集群部署"><a href="#三、Keystone集群部署" class="headerlink" title="三、Keystone集群部署"></a>三、Keystone集群部署</h1><p>Keystone 的主要功能：</p>
<ul>
<li>管理用户及其权限；</li>
<li>维护 OpenStack 服务的 Endpoint；</li>
<li>Authentication（认证）和 Authorization（鉴权）。</li>
</ul>
<h2 id="创建keystone数据库"><a href="#创建keystone数据库" class="headerlink" title="创建keystone数据库"></a>创建keystone数据库</h2><p>在任意控制节点创建数据库，数据库自动同步</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123456</span><br><span class="line"><span class="keyword">create</span> database keystone;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> keystone.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;keystone&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> keystone.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;keystone&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line">exit;</span><br></pre></td></tr></table></figure></div>

<h2 id="安装keystone"><a href="#安装keystone" class="headerlink" title="安装keystone"></a>安装keystone</h2><p>在全部控制节点安装 keystone</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://ftp.pbone.net/mirror/archive.fedoraproject.org/epel/testing/6.2019-05-29/x86_64/Packages/p/python2-qpid-proton-0.28.0-1.el7.x86_64.rpm</span><br><span class="line">wget ftp://ftp.pbone.net/mirror/vault.centos.org/7.8.2003/messaging/x86_64/qpid-proton/Packages/q/qpid-proton-c-0.28.0-1.el7.x86_64.rpm</span><br><span class="line">rpm -ivh qpid-proton-c-0.28.0-1.el7.x86_64.rpm</span><br><span class="line">rpm -ivh python2-qpid-proton-0.28.0-1.el7.x86_64.rpm</span><br><span class="line"><span class="comment"># yum install openstack-keystone httpd python3-mod_wsgi mod_ssl -y # centos 8</span></span><br><span class="line">yum install openstack-keystone httpd mod_wsgi mod_ssl -y</span><br><span class="line"></span><br><span class="line"><span class="comment">#备份Keystone配置文件</span></span><br><span class="line"><span class="built_in">cp</span> /etc/keystone/keystone.conf&#123;,.bak&#125;</span><br><span class="line">egrep -v <span class="string">&#x27;^$|^#&#x27;</span> /etc/keystone/keystone.conf.bak &gt; /etc/keystone/keystone.conf</span><br></pre></td></tr></table></figure></div>

<ul>
<li>如果要使用https访问，需要安装mod_ssl</li>
<li>自带的 python2-qpid-proton 为 0.26，不满足版本需求，需升级</li>
</ul>
<h2 id="配置Keystone"><a href="#配置Keystone" class="headerlink" title="配置Keystone"></a>配置Keystone</h2><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/keystone/keystone.conf cache backend oslo_cache.memcache_pool</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/keystone/keystone.conf cache enabled <span class="literal">true</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/keystone/keystone.conf cache memcache_servers controller01:11211,controller02:11211,controller03:11211</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/keystone/keystone.conf database connection mysql+pymysql://keystone:123456@10.10.10.10/keystone</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/keystone/keystone.conf token provider fernet</span><br></pre></td></tr></table></figure></div>

<ul>
<li>三个控制节点配置一样</li>
</ul>
<h2 id="初始化keystone数据库"><a href="#初始化keystone数据库" class="headerlink" title="初始化keystone数据库"></a>初始化keystone数据库</h2><p><strong>在任意控制节点操作</strong></p>
<div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"># keystone用户初始化数据库</span><br><span class="line"><span class="string">$ </span>su -s /bin/sh -c <span class="comment">&quot;keystone-manage db_sync&quot;</span> keystone</span><br><span class="line"></span><br><span class="line"># 验证数据库</span><br><span class="line"><span class="string">$ </span>mysql -uroot -p123456 keystone -e <span class="comment">&quot;show tables&quot;</span>;</span><br><span class="line">+------------------------------------+</span><br><span class="line">| <span class="type">Tables_in_keystone</span>                 |</span><br><span class="line">+------------------------------------+</span><br><span class="line">| access_rule                        |</span><br><span class="line">| access_token                       |</span><br><span class="line">| application_credential             |</span><br><span class="line">| application_credential_access_rule |</span><br><span class="line">| application_credential_role        |</span><br><span class="line">| assignment                         |</span><br><span class="line">| config_register                    |</span><br><span class="line">| consumer                           |</span><br><span class="line">| credential                         |</span><br><span class="line">| endpoint                           |</span><br><span class="line">| endpoint_group                     |</span><br><span class="line">| federated_user                     |</span><br><span class="line">| federation_protocol                |</span><br><span class="line">| group                              |</span><br><span class="line">| id_mapping                         |</span><br><span class="line">| identity_provider                  |</span><br><span class="line">| idp_remote_ids                     |</span><br><span class="line">| implied_role                       |</span><br><span class="line">| limit                              |</span><br><span class="line">| local_user                         |</span><br><span class="line">| mapping                            |</span><br><span class="line">| migrate_version                    |</span><br><span class="line">| nonlocal_user                      |</span><br><span class="line">| password                           |</span><br><span class="line">| policy                             |</span><br><span class="line">| policy_association                 |</span><br><span class="line">| project                            |</span><br><span class="line">| project_endpoint                   |</span><br><span class="line">| project_endpoint_group             |</span><br><span class="line">| project_option                     |</span><br><span class="line">| project_tag                        |</span><br><span class="line">| region                             |</span><br><span class="line">| registered_limit                   |</span><br><span class="line">| request_token                      |</span><br><span class="line">| revocation_event                   |</span><br><span class="line">| role                               |</span><br><span class="line">| role_option                        |</span><br><span class="line">| sensitive_config                   |</span><br><span class="line">| service                            |</span><br><span class="line">| service_provider                   |</span><br><span class="line">| system_assignment                  |</span><br><span class="line">| token                              |</span><br><span class="line">| trust                              |</span><br><span class="line">| trust_role                         |</span><br><span class="line">| user                               |</span><br><span class="line">| user_group_membership              |</span><br><span class="line">| user_option                        |</span><br><span class="line">| whitelisted_config                 |</span><br><span class="line">+------------------------------------+</span><br></pre></td></tr></table></figure></div>

<p><strong>初始化Fernet密钥存储库，无报错即为成功</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在/etc/keystone/生成相关秘钥及目录</span></span><br><span class="line">keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone</span><br><span class="line">keystone-manage credential_setup --keystone-user keystone --keystone-group keystone</span><br><span class="line"></span><br><span class="line"><span class="comment">#并将初始化的密钥拷贝到其他的控制节点</span></span><br><span class="line">scp -rp /etc/keystone/fernet-keys /etc/keystone/credential-keys controller02:/etc/keystone/</span><br><span class="line">scp -rp /etc/keystone/fernet-keys /etc/keystone/credential-keys controller03:/etc/keystone/</span><br><span class="line"></span><br><span class="line"><span class="comment">#同步后修改另外两台控制节点fernet的权限</span></span><br><span class="line"><span class="built_in">chown</span> -R keystone:keystone /etc/keystone/credential-keys/</span><br><span class="line"><span class="built_in">chown</span> -R keystone:keystone /etc/keystone/fernet-keys/</span><br></pre></td></tr></table></figure></div>

<p><strong>认证引导</strong></p>
<p>任意控制节点操作；初始化admin用户（管理用户）与密码，3种api端点，服务实体可用区等</p>
<p>注意：这里使用的是vip</p>
<div class="highlight-container" data-rel="Fsharp"><figure class="iseeu highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keystone<span class="operator">-</span>manage bootstrap <span class="operator">--</span>bootstrap<span class="operator">-</span>password <span class="number">123456</span> \</span><br><span class="line"><span class="operator">--</span>bootstrap<span class="operator">-</span>admin<span class="operator">-</span>url http<span class="operator">:</span><span class="comment">//10.10.10.10:5000/v3/ \</span></span><br><span class="line"><span class="operator">--</span>bootstrap<span class="operator">-</span><span class="keyword">internal</span><span class="operator">-</span>url http<span class="operator">:</span><span class="comment">//10.10.10.10:5000/v3/ \</span></span><br><span class="line"><span class="operator">--</span>bootstrap<span class="operator">-</span><span class="keyword">public</span><span class="operator">-</span>url http<span class="operator">:</span><span class="comment">//10.10.10.10:5000/v3/ \</span></span><br><span class="line"><span class="operator">--</span>bootstrap<span class="operator">-</span>region<span class="operator">-</span><span class="built_in">id</span> RegionOne</span><br></pre></td></tr></table></figure></div>

<h2 id="配置Http-Server"><a href="#配置Http-Server" class="headerlink" title="配置Http Server"></a>配置Http Server</h2><p>在全部控制节点设置，以controller01节点为例</p>
<p><strong>配置 httpd.conf</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改域名为主机名</span></span><br><span class="line"><span class="built_in">cp</span> /etc/httpd/conf/httpd.conf&#123;,.bak&#125;</span><br><span class="line">sed -i <span class="string">&quot;s/#ServerName www.example.com:80/ServerName <span class="variable">$&#123;HOSTNAME&#125;</span>/&quot;</span> /etc/httpd/conf/httpd.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#不同的节点替换不同的ip地址</span></span><br><span class="line"><span class="comment"># controller01</span></span><br><span class="line">sed -i <span class="string">&quot;s/Listen\ 80/Listen\ 10.10.10.31:80/g&quot;</span> /etc/httpd/conf/httpd.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># controller02</span></span><br><span class="line">sed -i <span class="string">&quot;s/Listen\ 80/Listen\ 10.10.10.32:80/g&quot;</span> /etc/httpd/conf/httpd.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># controller03</span></span><br><span class="line">sed -i <span class="string">&quot;s/Listen\ 80/Listen\ 10.10.10.33:80/g&quot;</span> /etc/httpd/conf/httpd.conf</span><br></pre></td></tr></table></figure></div>

<p><strong>配置wsgi-keystone.conf</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建软连接wsgi-keystone.conf文件</span></span><br><span class="line"><span class="built_in">ln</span> -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/</span><br><span class="line"></span><br><span class="line"><span class="comment">#不同的节点替换不同的ip地址</span></span><br><span class="line"><span class="comment">##controller01</span></span><br><span class="line">sed -i <span class="string">&quot;s/Listen\ 5000/Listen\ 10.10.10.31:5000/g&quot;</span> /etc/httpd/conf.d/wsgi-keystone.conf</span><br><span class="line">sed -i <span class="string">&quot;s#*:5000#10.10.10.31:5000#g&quot;</span> /etc/httpd/conf.d/wsgi-keystone.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">##controller02</span></span><br><span class="line">sed -i <span class="string">&quot;s/Listen\ 5000/Listen\ 10.10.10.32:5000/g&quot;</span> /etc/httpd/conf.d/wsgi-keystone.conf</span><br><span class="line">sed -i <span class="string">&quot;s#*:5000#10.10.10.32:5000#g&quot;</span> /etc/httpd/conf.d/wsgi-keystone.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">##controller03</span></span><br><span class="line">sed -i <span class="string">&quot;s/Listen\ 5000/Listen\ 10.10.10.33:5000/g&quot;</span> /etc/httpd/conf.d/wsgi-keystone.conf</span><br><span class="line">sed -i <span class="string">&quot;s#*:5000#10.10.10.33:5000#g&quot;</span> /etc/httpd/conf.d/wsgi-keystone.conf</span><br></pre></td></tr></table></figure></div>

<p><strong>启动服务</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd.service</span><br><span class="line">systemctl <span class="built_in">enable</span> httpd.service</span><br><span class="line">systemctl status httpd.service</span><br></pre></td></tr></table></figure></div>

<h2 id="配置admin用户变量脚本"><a href="#配置admin用户变量脚本" class="headerlink" title="配置admin用户变量脚本"></a>配置admin用户变量脚本</h2><blockquote>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack client环境脚本定义client调用openstack api环境变量，以方便api的调用（不必在命令行中携带环境变量）;</span><br><span class="line">官方文档将admin用户和demo租户的变量写入到了家目录下,根据不同的用户角色，需要定义不同的脚本；</span><br><span class="line">一般将脚本创建在用户主目录</span><br></pre></td></tr></table></figure></div>
</blockquote>
<p>admin-openrc</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> &gt;&gt; ~/admin-openrc &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"># admin-openrc</span></span><br><span class="line"><span class="string">export OS_USERNAME=admin</span></span><br><span class="line"><span class="string">export OS_PASSWORD=123456</span></span><br><span class="line"><span class="string">export OS_PROJECT_NAME=admin</span></span><br><span class="line"><span class="string">export OS_USER_DOMAIN_NAME=Default</span></span><br><span class="line"><span class="string">export OS_PROJECT_DOMAIN_NAME=Default</span></span><br><span class="line"><span class="string">export OS_AUTH_URL=http://10.10.10.10:5000/v3</span></span><br><span class="line"><span class="string">export OS_IDENTITY_API_VERSION=3</span></span><br><span class="line"><span class="string">export OS_IMAGE_API_VERSION=2</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span>  ~/admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">$ openstack domain list</span><br><span class="line">+---------+---------+---------+--------------------+</span><br><span class="line">| ID      | Name    | Enabled | Description        |</span><br><span class="line">+---------+---------+---------+--------------------+</span><br><span class="line">| default | Default | True    | The default domain |</span><br><span class="line">+---------+---------+---------+--------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用下面的命令</span></span><br><span class="line">$ openstack token issue</span><br><span class="line"></span><br><span class="line"><span class="comment">#拷贝到其他的控制节点</span></span><br><span class="line">scp -rp ~/admin-openrc controller02:~/</span><br><span class="line">scp -rp ~/admin-openrc controller03:~/</span><br></pre></td></tr></table></figure></div>

<h2 id="创建新域、项目、用户和角色"><a href="#创建新域、项目、用户和角色" class="headerlink" title="创建新域、项目、用户和角色"></a>创建新域、项目、用户和角色</h2><p>身份服务为每个OpenStack服务提供身份验证服务，其中包括服务使用域、项目、用户和角色的组合。</p>
<p>在任意控制节点操作</p>
<h3 id="创建域"><a href="#创建域" class="headerlink" title="创建域"></a>创建域</h3><div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$ </span>openstack domain create --description <span class="comment">&quot;An Example Domain&quot;</span> example</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| <span class="type">Field</span>       | <span class="type">Value</span>                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description | <span class="type">An</span> <span class="type">Example</span> <span class="type">Domain</span>                |</span><br><span class="line">| enabled     | <span class="type">True</span>                             |</span><br><span class="line">| id          | <span class="number">4</span>a208138a0004bb1a05d6c61e14f47dc |</span><br><span class="line">| name        | example                          |</span><br><span class="line">| options     | &#123;&#125;                               |</span><br><span class="line">| tags        | []                               |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line"></span><br><span class="line"><span class="string">$ </span>openstack domain list</span><br><span class="line">+----------------------------------+---------+---------+--------------------+</span><br><span class="line">| <span class="type">ID</span>                               | <span class="type">Name</span>    | <span class="type">Enabled</span> | <span class="type">Description</span>        |</span><br><span class="line">+----------------------------------+---------+---------+--------------------+</span><br><span class="line">| <span class="number">4</span>a208138a0004bb1a05d6c61e14f47dc | example | <span class="type">True</span>    | <span class="type">An</span> <span class="type">Example</span> <span class="type">Domain</span>  |</span><br><span class="line">| default                          | <span class="type">Default</span> | <span class="type">True</span>    | <span class="type">The</span> default domain |</span><br><span class="line">+----------------------------------+---------+---------+--------------------+</span><br></pre></td></tr></table></figure></div>

<h3 id="创建demo项目"><a href="#创建demo项目" class="headerlink" title="创建demo项目"></a>创建demo项目</h3><p>由于admin的项目角色用户都已经存在了；重新创建一个新的项目角色demo</p>
<p>以创建demo项目为例，demo项目属于”default”域</p>
<div class="highlight-container" data-rel="Scss"><figure class="iseeu highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack project create <span class="attr">--domain</span> default <span class="attr">--description</span> &quot;demo Project&quot; demo</span><br></pre></td></tr></table></figure></div>

<h3 id="创建demo用户"><a href="#创建demo用户" class="headerlink" title="创建demo用户"></a>创建demo用户</h3><p>需要输入新用户的密码</p>
<p><code>--password-prompt</code> 为交互式； <code>--password+密码</code> 为非交互式</p>
<div class="highlight-container" data-rel="Scss"><figure class="iseeu highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack user create <span class="attr">--domain</span> default   <span class="attr">--password</span> <span class="number">123456</span> demo</span><br></pre></td></tr></table></figure></div>

<h3 id="创建user角色"><a href="#创建user角色" class="headerlink" title="创建user角色"></a>创建user角色</h3><div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role <span class="keyword">create</span> <span class="keyword">user</span></span><br></pre></td></tr></table></figure></div>

<h3 id="查看角色"><a href="#查看角色" class="headerlink" title="查看角色"></a>查看角色</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role list</span><br></pre></td></tr></table></figure></div>

<p>将user角色添加到demo项目和demo用户</p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add <span class="attr">--project</span> demo <span class="attr">--user</span>  demo user</span><br></pre></td></tr></table></figure></div>

<p>配置 demo 用户变量脚本</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt; ~/demo-openrc &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">#demo-openrc</span></span><br><span class="line"><span class="string">export OS_USERNAME=demo</span></span><br><span class="line"><span class="string">export OS_PASSWORD=123456</span></span><br><span class="line"><span class="string">export OS_PROJECT_NAME=</span></span><br><span class="line"><span class="string">export OS_USER_DOMAIN_NAME=Default</span></span><br><span class="line"><span class="string">export OS_PROJECT_DOMAIN_NAME=Default</span></span><br><span class="line"><span class="string">export OS_AUTH_URL=http://10.10.10.10:5000/v3</span></span><br><span class="line"><span class="string">export OS_IDENTITY_API_VERSION=3</span></span><br><span class="line"><span class="string">export OS_IMAGE_API_VERSION=2</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span>  ~/demo-openrc</span><br><span class="line">openstack token issue</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝到其他的控制节点</span></span><br><span class="line">scp -rp ~/demo-openrc controller02:~/</span><br><span class="line">scp -rp ~/demo-openrc controller03:~/</span><br></pre></td></tr></table></figure></div>

<h2 id="验证keystone"><a href="#验证keystone" class="headerlink" title="验证keystone"></a>验证keystone</h2><p>任意一台控制节点；以admin用户身份，请求身份验证令牌, 使用admin用户变量</p>
<div class="highlight-container" data-rel="Delphi"><figure class="iseeu highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ source admin-openrc</span><br><span class="line">$ openstack --os-auth-url http:<span class="comment">//10.10.10.10:5000/v3 \</span></span><br><span class="line">--os-project-domain-<span class="keyword">name</span> <span class="keyword">Default</span> --os-user-domain-<span class="keyword">name</span> <span class="keyword">Default</span> \</span><br><span class="line">--os-project-<span class="keyword">name</span> admin --os-username admin token issue</span><br></pre></td></tr></table></figure></div>

<p>任意一台控制节点；以demo用户身份，请请求认证令牌, 使用demo用户变量</p>
<div class="highlight-container" data-rel="Delphi"><figure class="iseeu highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ source demo-openrc</span><br><span class="line">$ openstack --os-auth-url http:<span class="comment">//10.10.10.10:5000/v3 \</span></span><br><span class="line">--os-project-domain-<span class="keyword">name</span> <span class="keyword">Default</span> --os-user-domain-<span class="keyword">name</span> <span class="keyword">Default</span> \</span><br><span class="line">--os-project-<span class="keyword">name</span> demo --os-username demo token issue</span><br></pre></td></tr></table></figure></div>

<h1 id="四、Glance集群部署"><a href="#四、Glance集群部署" class="headerlink" title="四、Glance集群部署"></a>四、Glance集群部署</h1><p><strong>Glance 具体功能如下：</strong></p>
<ul>
<li>提供 RESTful API 让用户能够查询和获取镜像的元数据和镜像本身；</li>
<li>支持多种方式存储镜像，包括普通的文件系统、Swift、Ceph 等；</li>
<li>对实例执行快照创建新的镜像。</li>
</ul>
<h2 id="创建glance数据库"><a href="#创建glance数据库" class="headerlink" title="创建glance数据库"></a>创建glance数据库</h2><p>在任意控制节点创建数据库，数据库自动同步，以controller01节点为例</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p123456</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE glance;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> glance.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;glance&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> glance.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;glance&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line">exit;</span><br></pre></td></tr></table></figure></div>

<h2 id="创建glance-api相关服务凭证"><a href="#创建glance-api相关服务凭证" class="headerlink" title="创建glance-api相关服务凭证"></a>创建glance-api相关服务凭证</h2><p>在任意控制节点创建数据库，以controller01节点为例</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">source <span class="operator">~</span><span class="operator">/</span>admin<span class="operator">-</span>openrc</span><br><span class="line"># 创建service项目</span><br><span class="line">openstack project <span class="keyword">create</span> <span class="comment">--domain default --description &quot;Service Project&quot; service</span></span><br><span class="line"></span><br><span class="line"># 创建glance用户</span><br><span class="line">openstack <span class="keyword">user</span> <span class="keyword">create</span> <span class="comment">--domain default --password 123456 glance</span></span><br><span class="line"></span><br><span class="line"># 将管理员admin用户添加到glance用户和项目中</span><br><span class="line">openstack role <span class="keyword">add</span> <span class="comment">--project service --user glance admin</span></span><br><span class="line"></span><br><span class="line"># 创建glance服务实体</span><br><span class="line">openstack service <span class="keyword">create</span> <span class="comment">--name glance --description &quot;OpenStack Image&quot; image</span></span><br><span class="line"></span><br><span class="line"># 创建glance<span class="operator">-</span>api;</span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne image public http://10.10.10.10:9292</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne image internal http://10.10.10.10:9292</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne image admin http://10.10.10.10:9292</span></span><br><span class="line"></span><br><span class="line"># 查看创建之后的api;</span><br><span class="line">openstack endpoint list</span><br></pre></td></tr></table></figure></div>

<h2 id="部署与配置glance"><a href="#部署与配置glance" class="headerlink" title="部署与配置glance"></a>部署与配置glance</h2><h3 id="安装glance"><a href="#安装glance" class="headerlink" title="安装glance"></a>安装glance</h3><p>在全部控制节点安装glance，以controller01节点为例</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install openstack-glance python-glance python-glanceclient -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份glance配置文件</span></span><br><span class="line"><span class="built_in">cp</span> /etc/glance/glance-api.conf&#123;,.bak&#125;</span><br><span class="line">egrep -v <span class="string">&#x27;^$|^#&#x27;</span> /etc/glance/glance-api.conf.bak &gt;/etc/glance/glance-api.conf</span><br></pre></td></tr></table></figure></div>

<h3 id="配置glance-api-conf"><a href="#配置glance-api-conf" class="headerlink" title="配置glance-api.conf"></a>配置glance-api.conf</h3><p>注意 <code>bind_host</code> 参数，根据不同节点修改；以controller01节点为例</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf DEFAULT bind_host 10.10.10.31</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf database connection  mysql+pymysql://glance:123456@10.10.10.10/glance</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf glance_store stores file,http</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf glance_store default_store file</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf keystone_authtoken www_authenticate_uri   http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf keystone_authtoken auth_url  http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf keystone_authtoken memcached_servers controller01:11211,controller02:11211,controller03:11211</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf keystone_authtoken auth_type password</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf keystone_authtoken project_domain_name Default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf keystone_authtoken user_domain_name Default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf keystone_authtoken project_name  service</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf keystone_authtoken username glance</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf keystone_authtoken password 123456</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf paste_deploy flavor keystone</span><br></pre></td></tr></table></figure></div>

<h3 id="创建镜像存储目录并赋权限"><a href="#创建镜像存储目录并赋权限" class="headerlink" title="创建镜像存储目录并赋权限"></a>创建镜像存储目录并赋权限</h3><p>&#x2F;var&#x2F;lib&#x2F;glance&#x2F;images是默认的存储目录，在全部控制节点创建</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /var/lib/glance/images/</span><br><span class="line"><span class="built_in">chown</span> glance:nobody /var/lib/glance/images</span><br></pre></td></tr></table></figure></div>

<h2 id="初始化glance数据库"><a href="#初始化glance数据库" class="headerlink" title="初始化glance数据库"></a>初始化glance数据库</h2><p>任意控制节点操作</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c <span class="string">&quot;glance-manage db_sync&quot;</span> glance</span><br></pre></td></tr></table></figure></div>

<p>验证glance数据库是否正常写入</p>
<div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$ </span>mysql -uglance -p123456 -e <span class="comment">&quot;use glance;show tables;&quot;</span></span><br><span class="line">+----------------------------------+</span><br><span class="line">| <span class="type">Tables_in_glance</span>                 |</span><br><span class="line">+----------------------------------+</span><br><span class="line">| alembic_version                  |</span><br><span class="line">| image_locations                  |</span><br><span class="line">| image_members                    |</span><br><span class="line">| image_properties                 |</span><br><span class="line">| image_tags                       |</span><br><span class="line">| images                           |</span><br><span class="line">| metadef_namespace_resource_types |</span><br><span class="line">| metadef_namespaces               |</span><br><span class="line">| metadef_objects                  |</span><br><span class="line">| metadef_properties               |</span><br><span class="line">| metadef_resource_types           |</span><br><span class="line">| metadef_tags                     |</span><br><span class="line">| migrate_version                  |</span><br><span class="line">| task_info                        |</span><br><span class="line">| tasks                            |</span><br><span class="line">+----------------------------------+</span><br></pre></td></tr></table></figure></div>

<h2 id="启动服务-1"><a href="#启动服务-1" class="headerlink" title="启动服务"></a>启动服务</h2><p>全部控制节点</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> openstack-glance-api.service</span><br><span class="line">systemctl restart openstack-glance-api.service</span><br><span class="line">systemctl status openstack-glance-api.service</span><br><span class="line"><span class="built_in">sleep</span> 3s</span><br><span class="line">lsof -i:9292</span><br></pre></td></tr></table></figure></div>

<h2 id="下载cirros镜像验证glance服务"><a href="#下载cirros镜像验证glance服务" class="headerlink" title="下载cirros镜像验证glance服务"></a>下载cirros镜像验证glance服务</h2><p>在任意控制节点上;下载cirros镜像；格式指定为qcow2，bare；设置public权限；</p>
<p>镜像生成后，在指定的存储目录下生成以镜像id命名的镜像文件</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">source</span> ~/admin-openrc</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget -c http://download.cirros-cloud.net/0.5.2/cirros-0.5.2-x86_64-disk.img</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openstack image create --file ~/cirros-0.5.2-x86_64-disk.img --disk-format qcow2 --container-format bare --public cirros-qcow2</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openstack image list</span></span><br><span class="line">+--------------------------------------+--------------+--------+</span><br><span class="line">| ID                                   | Name         | Status |</span><br><span class="line">+--------------------------------------+--------------+--------+</span><br><span class="line">| 1c66cd7e-b6d9-4e70-a3d4-f73b27a84230 | cirros-qcow2 | active |</span><br><span class="line">+--------------------------------------+--------------+--------+</span><br></pre></td></tr></table></figure></div>

<p>查看镜像</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@controller01 ~]<span class="comment"># ls -l /var/lib/glance/images/</span></span><br><span class="line">total 0</span><br><span class="line"></span><br><span class="line">[root@controller02 ~]<span class="comment"># ls -l /var/lib/glance/images/</span></span><br><span class="line">total 15956</span><br><span class="line">-rw-r----- 1 glance glance 16338944 Nov  4 17:25 1c66cd7e-b6d9-4e70-a3d4-f73b27a84230</span><br><span class="line"></span><br><span class="line">[root@controller03 ~]<span class="comment"># ls -l /var/lib/glance/images/</span></span><br><span class="line">total 0</span><br><span class="line"></span><br><span class="line">scp -<span class="built_in">pr</span> /var/lib/glance/images/* controller01:/var/lib/glance/images/</span><br><span class="line">scp -<span class="built_in">pr</span> /var/lib/glance/images/* controller03:/var/lib/glance/images/</span><br><span class="line"><span class="built_in">chown</span> -R glance. /var/lib/glance/images/*</span><br></pre></td></tr></table></figure></div>

<p>这时候发现只有1台glance节点上有相关镜像，如果请求发到没有的机器就会找不到镜像；所以实际生产中一般用共性存储 nfs，或者 swift、ceph，方法后面再说。</p>
<h1 id="五、Placement服务部署"><a href="#五、Placement服务部署" class="headerlink" title="五、Placement服务部署"></a>五、Placement服务部署</h1><p>Placement具体功能：</p>
<ul>
<li>通过HTTP请求来跟踪和过滤资源</li>
<li>数据保存在本地数据库中</li>
<li>具备丰富的资源管理和筛选策略</li>
</ul>
<h2 id="创建Placement数据库"><a href="#创建Placement数据库" class="headerlink" title="创建Placement数据库"></a>创建Placement数据库</h2><p>在任意控制节点创建数据库</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p123456</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE placement;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> placement.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;placement&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> placement.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;placement&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line">exit;</span><br></pre></td></tr></table></figure></div>

<h2 id="创建placement-api"><a href="#创建placement-api" class="headerlink" title="创建placement-api"></a>创建placement-api</h2><p>在任意控制节点操作</p>
<p><strong>创建Placement服务用户</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack <span class="keyword">user</span> <span class="keyword">create</span> <span class="comment">--domain default --password=123456 placement</span></span><br></pre></td></tr></table></figure></div>

<p><strong>将Placement用户添加到服务项目并赋予admin权限</strong></p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add <span class="attr">--project</span> service <span class="attr">--user</span> placement admin</span><br></pre></td></tr></table></figure></div>

<p><strong>创建placement API服务实体</strong></p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack service create <span class="attr">--name</span> placement <span class="attr">--description</span> &quot;Placement API&quot; placement</span><br></pre></td></tr></table></figure></div>

<p><strong>创建placement API服务访问端点</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne placement public http://10.10.10.10:8778</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne placement internal http://10.10.10.10:8778</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne placement admin http://10.10.10.10:8778</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>使用vip</li>
</ul>
<h2 id="安装placement软件包"><a href="#安装placement软件包" class="headerlink" title="安装placement软件包"></a>安装placement软件包</h2><p>在全部控制节点操作</p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>openstack-placement-api -y</span><br></pre></td></tr></table></figure></div>

<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p>在全部控制节点操作</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份Placement配置</span></span><br><span class="line"><span class="built_in">cp</span> /etc/placement/placement.conf /etc/placement/placement.conf.bak</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/placement/placement.conf.bak &gt; /etc/placement/placement.conf</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/placement/placement.conf placement_database connection mysql+pymysql://placement:123456@10.10.10.10/placement</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/placement/placement.conf api auth_strategy keystone</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/placement/placement.conf keystone_authtoken auth_url  http://10.10.10.10:5000/v3</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/placement/placement.conf keystone_authtoken memcached_servers controller01:11211,controller02:11211,controller03:11211</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/placement/placement.conf keystone_authtoken auth_type password</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/placement/placement.conf keystone_authtoken project_domain_name Default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/placement/placement.conf keystone_authtoken user_domain_name Default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/placement/placement.conf keystone_authtoken project_name service</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/placement/placement.conf keystone_authtoken username placement</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/placement/placement.conf keystone_authtoken password 123456</span><br></pre></td></tr></table></figure></div>

<h2 id="初始化placement数据库"><a href="#初始化placement数据库" class="headerlink" title="初始化placement数据库"></a>初始化placement数据库</h2><p>任意控制节点操作</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c <span class="string">&quot;placement-manage db sync&quot;</span> placement</span><br><span class="line">mysql -uroot -p123456 placement -e <span class="string">&quot; show tables;&quot;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="配置00-placement-api-conf"><a href="#配置00-placement-api-conf" class="headerlink" title="配置00-placement-api.conf"></a>配置00-placement-api.conf</h2><h3 id="修改placement的apache配置文件"><a href="#修改placement的apache配置文件" class="headerlink" title="修改placement的apache配置文件"></a>修改placement的apache配置文件</h3><p>在全部控制节点操作，以controller01节点为例；注意根据不同节点修改监听地址；官方文档没有提到，如果不修改，计算服务检查时将会报错；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份00-Placement-api配置</span></span><br><span class="line"><span class="comment"># controller01上</span></span><br><span class="line"><span class="built_in">cp</span> /etc/httpd/conf.d/00-placement-api.conf&#123;,.bak&#125;</span><br><span class="line">sed -i <span class="string">&quot;s/Listen\ 8778/Listen\ 10.10.10.31:8778/g&quot;</span> /etc/httpd/conf.d/00-placement-api.conf</span><br><span class="line">sed -i <span class="string">&quot;s/*:8778/10.10.10.31:8778/g&quot;</span> /etc/httpd/conf.d/00-placement-api.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># controller02上</span></span><br><span class="line"><span class="built_in">cp</span> /etc/httpd/conf.d/00-placement-api.conf&#123;,.bak&#125;</span><br><span class="line">sed -i <span class="string">&quot;s/Listen\ 8778/Listen\ 10.10.10.32:8778/g&quot;</span> /etc/httpd/conf.d/00-placement-api.conf</span><br><span class="line">sed -i <span class="string">&quot;s/*:8778/10.10.10.32:8778/g&quot;</span> /etc/httpd/conf.d/00-placement-api.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># controller03上</span></span><br><span class="line"><span class="built_in">cp</span> /etc/httpd/conf.d/00-placement-api.conf&#123;,.bak&#125;</span><br><span class="line">sed -i <span class="string">&quot;s/Listen\ 8778/Listen\ 10.10.10.33:8778/g&quot;</span> /etc/httpd/conf.d/00-placement-api.conf</span><br><span class="line">sed -i <span class="string">&quot;s/*:8778/10.10.10.33:8778/g&quot;</span> /etc/httpd/conf.d/00-placement-api.conf</span><br></pre></td></tr></table></figure></div>

<h3 id="启用placement-API访问"><a href="#启用placement-API访问" class="headerlink" title="启用placement API访问"></a>启用placement API访问</h3><p>在全部控制节点操作</p>
<div class="highlight-container" data-rel="Php-template"><figure class="iseeu highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">$ vi /etc/httpd/conf.d/00-placement-api.conf (15gg)</span></span><br><span class="line"><span class="language-xml">...</span></span><br><span class="line"><span class="language-xml">#SSLCertificateKeyFile</span></span><br><span class="line"><span class="language-xml">#SSLCertificateKeyFile ...</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">Directory</span> /<span class="attr">usr</span>/<span class="attr">bin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">IfVersion</span> &gt;</span>= 2.4&gt;</span></span><br><span class="line"><span class="language-xml">Require all granted</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">IfVersion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">IfVersion</span> &lt; <span class="attr">2.4</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">Order allow,deny</span></span><br><span class="line"><span class="language-xml">Allow from all</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">IfVersion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">...</span></span><br></pre></td></tr></table></figure></div>

<h3 id="重启apache服务"><a href="#重启apache服务" class="headerlink" title="重启apache服务"></a>重启apache服务</h3><p>在全部控制节点操作；启动placement-api监听端口</p>
<div class="highlight-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd.service</span><br><span class="line">ss -tnlp|<span class="keyword">grep</span> <span class="number">8778</span></span><br><span class="line">lsof -i:<span class="number">8778</span></span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl地址看是否能返回json</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">curl</span> http://<span class="number">10.10</span>.<span class="number">10.10</span>:<span class="number">8778</span></span><br><span class="line">&#123;<span class="string">&quot;versions&quot;</span>: [&#123;<span class="string">&quot;id&quot;</span>: <span class="string">&quot;v1.0&quot;</span>, <span class="string">&quot;max_version&quot;</span>: <span class="string">&quot;1.36&quot;</span>, <span class="string">&quot;min_version&quot;</span>: <span class="string">&quot;1.0&quot;</span>, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;CURRENT&quot;</span>, <span class="string">&quot;links&quot;</span>: [&#123;<span class="string">&quot;rel&quot;</span>: <span class="string">&quot;self&quot;</span>, <span class="string">&quot;href&quot;</span>: <span class="string">&quot;&quot;</span>&#125;]&#125;]&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="验证检查Placement健康状态"><a href="#验证检查Placement健康状态" class="headerlink" title="验证检查Placement健康状态"></a>验证检查Placement健康状态</h2><div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ placement<span class="operator">-</span>status upgrade <span class="keyword">check</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Upgrade <span class="keyword">Check</span> Results            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Check</span>: Missing Root Provider IDs <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Result</span>: Success                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Details: <span class="keyword">None</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Check</span>: Incomplete Consumers      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Result</span>: Success                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Details: <span class="keyword">None</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+</span></span><br></pre></td></tr></table></figure></div>

<h1 id="六、Nova控制节点集群部署"><a href="#六、Nova控制节点集群部署" class="headerlink" title="六、Nova控制节点集群部署"></a>六、Nova控制节点集群部署</h1><p><strong>Nova具体功能如下：</strong></p>
<ol>
<li>实例生命周期管理</li>
<li>管理计算资源</li>
<li>网络和认证管理</li>
<li>REST风格的API</li>
<li>异步的一致性通信</li>
<li>Hypervisor透明：支持Xen,XenServer&#x2F;XCP, KVM, UML, VMware vSphere and Hyper-V</li>
</ol>
<h2 id="创建nova相关数据库"><a href="#创建nova相关数据库" class="headerlink" title="创建nova相关数据库"></a>创建nova相关数据库</h2><p>在任意控制节点创建数据库</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 创建nova_api，nova和nova_cell0数据库并授权</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123456</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE nova_api;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE nova;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE nova_cell0;</span><br><span class="line"></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> nova_api.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> nova_api.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> nova.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> nova.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> nova_cell0.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> nova_cell0.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line">flush privileges;</span><br><span class="line">exit;</span><br></pre></td></tr></table></figure></div>

<h2 id="创建nova相关服务凭证"><a href="#创建nova相关服务凭证" class="headerlink" title="创建nova相关服务凭证"></a>创建nova相关服务凭证</h2><p>在任意控制节点操作</p>
<p><strong>创建nova用户</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source <span class="operator">~</span><span class="operator">/</span>admin<span class="operator">-</span>openrc</span><br><span class="line">openstack <span class="keyword">user</span> <span class="keyword">create</span> <span class="comment">--domain default --password 123456 nova</span></span><br></pre></td></tr></table></figure></div>

<p><strong>向nova用户赋予admin权限</strong></p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add <span class="attr">--project</span> service <span class="attr">--user</span> nova admin</span><br></pre></td></tr></table></figure></div>

<p><strong>创建nova服务实体</strong></p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack service create <span class="attr">--name</span> nova <span class="attr">--description</span> &quot;OpenStack Compute&quot; compute</span><br></pre></td></tr></table></figure></div>

<p><strong>创建Compute API服务端点</strong></p>
<p>api地址统一采用vip，如果 <code>public/internal/admin</code> 分别设计使用不同的vip，请注意区分；</p>
<p><code>--region</code> 与初始化admin用户时生成的 <code>region</code> 一致；</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne compute public http://10.10.10.10:8774/v2.1</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne compute internal http://10.10.10.10:8774/v2.1</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne compute admin http://10.10.10.10:8774/v2.1</span></span><br></pre></td></tr></table></figure></div>

<h2 id="安装nova软件包"><a href="#安装nova软件包" class="headerlink" title="安装nova软件包"></a>安装nova软件包</h2><p>在全部控制节点安装nova相关服务，以controller01节点为例</p>
<ul>
<li>nova-api（nova主服务）</li>
<li>nova-scheduler（nova调度服务）</li>
<li>nova-conductor（nova数据库服务，提供数据库访问）</li>
<li>nova-novncproxy（nova的vnc服务，提供实例的控制台）</li>
</ul>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>openstack-nova-api openstack-nova-conductor openstack-nova-novncproxy openstack-nova-<span class="keyword">scheduler </span>-y</span><br></pre></td></tr></table></figure></div>

<h2 id="部署与配置"><a href="#部署与配置" class="headerlink" title="部署与配置"></a>部署与配置</h2><p>在全部控制节点配置nova相关服务，以controller01节点为例</p>
<p>注意 <code>my_ip</code> 参数，根据节点修改；注意 <code>nova.conf</code> 文件的权限： <code>root:nova</code></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件/etc/nova/nova.conf</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/nova/nova.conf&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/nova/nova.conf.bak &gt; /etc/nova/nova.conf</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf DEFAULT enabled_apis  osapi_compute,metadata</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf DEFAULT my_ip  10.10.10.31</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf DEFAULT use_neutron  <span class="literal">true</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf DEFAULT firewall_driver  nova.virt.firewall.NoopFirewallDriver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂不使用haproxy配置的rabbitmq；直接连接rabbitmq集群</span></span><br><span class="line"><span class="comment">#openstack-config --set /etc/nova/nova.conf DEFAULT transport_url rabbit://openstack:123456@10.10.10.10:5672</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf DEFAULT transport_url rabbit://openstack:123456@controller01:5672,openstack:123456@controller02:5672,openstack:123456@controller03:5672</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动发现 nova 计算节点</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf scheduler discover_hosts_in_cells_interval 600</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf DEFAULT osapi_compute_listen_port 8774</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf DEFAULT metadata_listen_port 8775</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf DEFAULT metadata_listen <span class="string">&#x27;$my_ip&#x27;</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf DEFAULT osapi_compute_listen <span class="string">&#x27;$my_ip&#x27;</span></span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf api auth_strategy  keystone</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf api_database  connection  mysql+pymysql://nova:123456@10.10.10.10/nova_api</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf cache backend oslo_cache.memcache_pool</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf cache enabled True</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf cache memcache_servers controller01:11211,controller02:11211,controller03:11211</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf database connection  mysql+pymysql://nova:123456@10.10.10.10/nova</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf keystone_authtoken www_authenticate_uri  http://10.10.10.10:5000/v3</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf keystone_authtoken auth_url  http://10.10.10.10:5000/v3</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf keystone_authtoken memcached_servers  controller01:11211,controller02:11211,controller03:11211</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf keystone_authtoken auth_type  password</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf keystone_authtoken project_domain_name  Default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf keystone_authtoken user_domain_name  Default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf keystone_authtoken project_name  service</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf keystone_authtoken username  nova</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf keystone_authtoken password  123456</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf vnc enabled  <span class="literal">true</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf vnc server_listen  <span class="string">&#x27;$my_ip&#x27;</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf vnc server_proxyclient_address  <span class="string">&#x27;$my_ip&#x27;</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf vnc novncproxy_host <span class="string">&#x27;$my_ip&#x27;</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf vnc novncproxy_port  6080</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf glance  api_servers  http://10.10.10.10:9292</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf oslo_concurrency lock_path  /var/lib/nova/tmp</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf placement region_name  RegionOne</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf placement project_domain_name  Default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf placement project_name  service</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf placement auth_type  password</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf placement user_domain_name  Default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf placement auth_url  http://10.10.10.10:5000/v3</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf placement username  placement</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf placement password  123456</span><br></pre></td></tr></table></figure></div>

<p><strong>注意：</strong></p>
<p>前端采用haproxy时，服务连接rabbitmq会出现连接超时重连的情况，可通过各服务与rabbitmq的日志查看；</p>
<p>transport_url&#x3D;rabbit:&#x2F;&#x2F;openstack:<a class="link"   href="mailto:&#49;&#50;&#x33;&#x34;&#53;&#54;&#64;&#x31;&#x30;&#46;&#49;&#x30;&#46;&#49;&#x30;&#46;&#x31;&#48;" >&#49;&#50;&#x33;&#x34;&#53;&#54;&#64;&#x31;&#x30;&#46;&#49;&#x30;&#46;&#49;&#x30;&#46;&#x31;&#48; <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>:5672</p>
<p>rabbitmq本身具备集群机制，官方文档建议直接连接rabbitmq集群；但采用此方式时服务启动有时会报错，原因不明；如果没有此现象，建议连接rabbitmq直接对接集群而非通过前端haproxy的vip+端口</p>
<div class="highlight-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --set /etc/nova/nova.conf DEFAULT transport_url rabbit:<span class="regexp">//</span>openstack:<span class="number">123456</span>@controller01:<span class="number">5672</span>,openstack:<span class="number">123456</span>@controller02:<span class="number">5672</span>,openstack:<span class="number">123456</span>@controller03:<span class="number">5672</span></span><br></pre></td></tr></table></figure></div>

<h2 id="初始化nova相关数据库并验证"><a href="#初始化nova相关数据库并验证" class="headerlink" title="初始化nova相关数据库并验证"></a>初始化nova相关数据库并验证</h2><p>任意控制节点操作</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化nova-api数据库,无输出</span></span><br><span class="line"><span class="comment"># 初始化cell0数据库,无输出</span></span><br><span class="line"><span class="comment"># 创建cell1表</span></span><br><span class="line"><span class="comment"># 初始化nova数据库</span></span><br><span class="line">su -s /bin/sh -c <span class="string">&quot;nova-manage api_db sync&quot;</span> nova</span><br><span class="line">su -s /bin/sh -c <span class="string">&quot;nova-manage cell_v2 map_cell0&quot;</span> nova</span><br><span class="line">su -s /bin/sh -c <span class="string">&quot;nova-manage cell_v2 create_cell --name=cell1 --verbose&quot;</span> nova</span><br><span class="line">su -s /bin/sh -c <span class="string">&quot;nova-manage db sync&quot;</span> nova</span><br></pre></td></tr></table></figure></div>

<p>验证nova cell0和cell1是否正确注册</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ su <span class="operator">-</span>s <span class="operator">/</span>bin<span class="operator">/</span>sh <span class="operator">-</span>c &quot;nova-manage cell_v2 list_cells&quot; nova</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------+-------------------------------------------+--------------------------------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span>  Name <span class="operator">|</span>                 UUID                 <span class="operator">|</span>               Transport URL               <span class="operator">|</span>               Database Connection                <span class="operator">|</span> Disabled <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------+-------------------------------------------+--------------------------------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> cell0 <span class="operator">|</span> <span class="number">00000000</span><span class="number">-0000</span><span class="number">-0000</span><span class="number">-0000</span><span class="number">-000000000000</span> <span class="operator">|</span>                   <span class="keyword">none</span>:<span class="operator">/</span>                  <span class="operator">|</span> mysql<span class="operator">+</span>pymysql:<span class="operator">/</span><span class="operator">/</span>nova:<span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="variable">@10</span><span class="number">.10</span><span class="number">.10</span><span class="number">.10</span><span class="operator">/</span>nova_cell0 <span class="operator">|</span>  <span class="literal">False</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cell1 <span class="operator">|</span> <span class="number">3e74</span>f43a<span class="number">-74</span>db<span class="number">-4</span>eba<span class="number">-85</span>ee<span class="operator">-</span>c8330f906b1b <span class="operator">|</span> rabbit:<span class="operator">/</span><span class="operator">/</span>openstack:<span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="variable">@controller03</span>:<span class="number">5672</span> <span class="operator">|</span>    mysql<span class="operator">+</span>pymysql:<span class="operator">/</span><span class="operator">/</span>nova:<span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="variable">@10</span><span class="number">.10</span><span class="number">.10</span><span class="number">.10</span><span class="operator">/</span>nova    <span class="operator">|</span>  <span class="literal">False</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------------------------------+-------------------------------------------+--------------------------------------------------+----------+</span></span><br></pre></td></tr></table></figure></div>

<p>验证nova数据库是否正常写入</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -unova -p123456 -e <span class="string">&quot;use nova_api;show tables;&quot;</span></span><br><span class="line">mysql -unova -p123456 -e <span class="string">&quot;use nova;show tables;&quot;</span></span><br><span class="line">mysql -unova -p123456 -e <span class="string">&quot;use nova_cell0;show tables;&quot;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="启动nova服务"><a href="#启动nova服务" class="headerlink" title="启动nova服务"></a>启动nova服务</h2><p>在全部控制节点操作，以controller01节点为例</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> openstack-nova-api.service</span><br><span class="line">systemctl <span class="built_in">enable</span> openstack-nova-scheduler.service</span><br><span class="line">systemctl <span class="built_in">enable</span> openstack-nova-conductor.service</span><br><span class="line">systemctl <span class="built_in">enable</span> openstack-nova-novncproxy.service</span><br><span class="line"></span><br><span class="line">systemctl restart openstack-nova-api.service</span><br><span class="line">systemctl restart openstack-nova-scheduler.service</span><br><span class="line">systemctl restart openstack-nova-conductor.service</span><br><span class="line">systemctl restart openstack-nova-novncproxy.service</span><br><span class="line"></span><br><span class="line">systemctl status openstack-nova-api.service</span><br><span class="line">systemctl status openstack-nova-scheduler.service</span><br><span class="line">systemctl status openstack-nova-conductor.service</span><br><span class="line">systemctl status openstack-nova-novncproxy.service</span><br><span class="line"></span><br><span class="line">ss -tlnp | egrep <span class="string">&#x27;8774|8775|8778|6080&#x27;</span></span><br><span class="line">curl http://10.10.10.10:8774</span><br></pre></td></tr></table></figure></div>

<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p><strong>列出各服务控制组件，查看状态</strong></p>
<div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$ </span>source ~/admin-openrc</span><br><span class="line"><span class="string">$ </span>openstack compute service list</span><br><span class="line">+----+----------------+--------------+----------+---------+-------+----------------------------+</span><br><span class="line">| <span class="type">ID</span> | <span class="type">Binary</span>         | <span class="type">Host</span>         | <span class="type">Zone</span>     | <span class="type">Status</span>  | <span class="type">State</span> | <span class="type">Updated</span> <span class="type">At</span>                 |</span><br><span class="line">+----+----------------+--------------+----------+---------+-------+----------------------------+</span><br><span class="line">| <span class="number">21</span> | nova-scheduler | controller01 | internal | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">24</span>:<span class="number">01.000000</span> |</span><br><span class="line">| <span class="number">24</span> | nova-conductor | controller01 | internal | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">24</span>:<span class="number">05.000000</span> |</span><br><span class="line">| <span class="number">27</span> | nova-scheduler | controller02 | internal | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">24</span>:<span class="number">13.000000</span> |</span><br><span class="line">| <span class="number">30</span> | nova-scheduler | controller03 | internal | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">24</span>:<span class="number">05.000000</span> |</span><br><span class="line">| <span class="number">33</span> | nova-conductor | controller02 | internal | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">24</span>:<span class="number">07.000000</span> |</span><br><span class="line">| <span class="number">36</span> | nova-conductor | controller03 | internal | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">24</span>:<span class="number">10.000000</span> |</span><br><span class="line">+----+----------------+--------------+----------+---------+-------+----------------------------+</span><br></pre></td></tr></table></figure></div>

<p><strong>展示api端点</strong></p>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ openstack catalog list</span><br><span class="line">+-----------+-----------+------------------------------------------+</span><br><span class="line">| Name      | Type      | Endpoints                                |</span><br><span class="line">+-----------+-----------+------------------------------------------+</span><br><span class="line">| placement | placement | RegionOne                                |</span><br><span class="line">|           |           |   admin: http:<span class="comment">//10.10.10.10:8778         |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">internal</span>: http:<span class="comment">//10.10.10.10:8778      |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">public</span>: http:<span class="comment">//10.10.10.10:8778        |</span></span><br><span class="line">|           |           |                                          |</span><br><span class="line">| glance    | image     | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">public</span>: http:<span class="comment">//10.10.10.10:9292        |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">internal</span>: http:<span class="comment">//10.10.10.10:9292      |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   admin: http:<span class="comment">//10.10.10.10:9292         |</span></span><br><span class="line">|           |           |                                          |</span><br><span class="line">| keystone  | identity  | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">internal</span>: http:<span class="comment">//10.10.10.10:5000/v3/  |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   admin: http:<span class="comment">//10.10.10.10:5000/v3/     |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">public</span>: http:<span class="comment">//10.10.10.10:5000/v3/    |</span></span><br><span class="line">|           |           |                                          |</span><br><span class="line">| nova      | compute   | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">public</span>: http:<span class="comment">//10.10.10.10:8774/v2.1   |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">internal</span>: http:<span class="comment">//10.10.10.10:8774/v2.1 |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   admin: http:<span class="comment">//10.10.10.10:8774/v2.1    |</span></span><br><span class="line">|           |           |                                          |</span><br><span class="line">+-----------+-----------+------------------------------------------+</span><br></pre></td></tr></table></figure></div>

<p><strong>检查cell与placement api；都为success为正常</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ nova<span class="operator">-</span>status upgrade <span class="keyword">check</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Upgrade <span class="keyword">Check</span> Results                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Check</span>: Cells v2                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Result</span>: Success                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Details: <span class="keyword">No</span> host mappings <span class="keyword">or</span> compute nodes were found. Remember <span class="keyword">to</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   run command <span class="string">&#x27;nova-manage cell_v2 discover_hosts&#x27;</span> <span class="keyword">when</span> <span class="keyword">new</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   compute hosts <span class="keyword">are</span> deployed.                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Check</span>: Placement API                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Result</span>: Success                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Details: <span class="keyword">None</span>                                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Check</span>: Ironic Flavor Migration                                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Result</span>: Success                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Details: <span class="keyword">None</span>                                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Check</span>: Cinder API                                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Result</span>: Success                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Details: <span class="keyword">None</span>                                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure></div>

<h1 id="七、Nova计算节点集群部署"><a href="#七、Nova计算节点集群部署" class="headerlink" title="七、Nova计算节点集群部署"></a>七、Nova计算节点集群部署</h1><h2 id="安装nova-compute"><a href="#安装nova-compute" class="headerlink" title="安装nova-compute"></a>安装nova-compute</h2><p>在全部计算节点安装nova-compute服务，以compute01节点为例</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在基础配置时已经下载好了openstack的源和需要的依赖，所以直接下载需要的服务组件即可</span></span><br><span class="line">wget ftp://ftp.pbone.net/mirror/archive.fedoraproject.org/epel/testing/6.2019-05-29/x86_64/Packages/p/python2-qpid-proton-0.28.0-1.el7.x86_64.rpm</span><br><span class="line">wget ftp://ftp.pbone.net/mirror/vault.centos.org/7.8.2003/messaging/x86_64/qpid-proton/Packages/q/qpid-proton-c-0.28.0-1.el7.x86_64.rpm</span><br><span class="line">rpm -ivh qpid-proton-c-0.28.0-1.el7.x86_64.rpm</span><br><span class="line">rpm -ivh python2-qpid-proton-0.28.0-1.el7.x86_64.rpm</span><br><span class="line">yum install openstack-nova-compute -y</span><br></pre></td></tr></table></figure></div>

<h2 id="部署与配置-1"><a href="#部署与配置-1" class="headerlink" title="部署与配置"></a>部署与配置</h2><p>在全部计算节点安装nova-compute服务，以compute01节点为例</p>
<p>注意 <code>my_ip</code> 参数，根据节点修改；注意 <code>nova.conf</code> 文件的权限： <code>root:nova</code></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件/etc/nova/nova.conf</span></span><br><span class="line"><span class="built_in">cp</span> /etc/nova/nova.conf&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/nova/nova.conf.bak &gt; /etc/nova/nova.conf</span><br></pre></td></tr></table></figure></div>

<p><strong>确定计算节点是否支持虚拟机硬件加速</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">egrep -c <span class="string">&#x27;(vmx|svm)&#x27;</span> /proc/cpuinfo</span></span><br><span class="line">4</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果此命令返回值不是0，则计算节点支持硬件加速，不需要加入下面的配置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果此命令返回值是0，则计算节点不支持硬件加速，并且必须配置libvirt为使用QEMU而不是KVM</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">需要编辑/etc/nova/nova.conf 配置中的[libvirt]部分, vmware按照下面设置可以开启硬件加速</span></span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111041837974.png"
                      alt="image-20211104183711075"
                ></p>
<p><strong>编辑配置文件nova.conf</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf DEFAULT enabled_apis  osapi_compute,metadata</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf DEFAULT transport_url  rabbit://openstack:123456@10.10.10.10</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf DEFAULT my_ip 10.10.10.41</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf DEFAULT use_neutron  <span class="literal">true</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf DEFAULT firewall_driver  nova.virt.firewall.NoopFirewallDriver</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf api auth_strategy  keystone</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf  keystone_authtoken www_authenticate_uri  http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf keystone_authtoken auth_url  http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf keystone_authtoken memcached_servers  controller01:11211,controller02:11211,controller03:11211</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf keystone_authtoken auth_type  password</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf keystone_authtoken project_domain_name  Default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf keystone_authtoken user_domain_name  Default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf keystone_authtoken project_name  service</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf keystone_authtoken username  nova</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf keystone_authtoken password  123456</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf libvirt virt_type  kvm</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf vnc enabled  <span class="literal">true</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf vnc server_listen  0.0.0.0</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf vnc server_proxyclient_address  <span class="string">&#x27;$my_ip&#x27;</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf vnc novncproxy_base_url http://10.10.10.10:6080/vnc_auto.html</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf glance api_servers  http://10.10.10.10:9292</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf oslo_concurrency lock_path  /var/lib/nova/tmp</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf placement region_name  RegionOne</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf placement project_domain_name  Default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf placement project_name  service</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf placement auth_type  password</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf placement user_domain_name  Default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf placement auth_url  http://10.10.10.10:5000/v3</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf placement username  placement</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf placement password  123456</span><br></pre></td></tr></table></figure></div>

<h2 id="启动计算节点的nova服务"><a href="#启动计算节点的nova服务" class="headerlink" title="启动计算节点的nova服务"></a>启动计算节点的nova服务</h2><p>全部计算节点操作</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart libvirtd.service openstack-nova-compute.service</span><br><span class="line">systemctl <span class="built_in">enable</span> libvirtd.service openstack-nova-compute.service</span><br><span class="line">systemctl status libvirtd.service openstack-nova-compute.service</span><br></pre></td></tr></table></figure></div>

<h2 id="向cell数据库添加计算节点"><a href="#向cell数据库添加计算节点" class="headerlink" title="向cell数据库添加计算节点"></a>向cell数据库添加计算节点</h2><p>任意控制节点执行；查看计算节点列表</p>
<div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$ </span>source ~/admin-openrc</span><br><span class="line"><span class="string">$ </span>openstack compute service list --service nova-compute</span><br><span class="line">+----+--------------+-----------+------+---------+-------+----------------------------+</span><br><span class="line">| <span class="type">ID</span> | <span class="type">Binary</span>       | <span class="type">Host</span>      | <span class="type">Zone</span> | <span class="type">Status</span>  | <span class="type">State</span> | <span class="type">Updated</span> <span class="type">At</span>                 |</span><br><span class="line">+----+--------------+-----------+------+---------+-------+----------------------------+</span><br><span class="line">| <span class="number">39</span> | nova-compute | compute01 | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">45</span>:<span class="number">46.000000</span> |</span><br><span class="line">| <span class="number">42</span> | nova-compute | compute02 | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">45</span>:<span class="number">48.000000</span> |</span><br><span class="line">+----+--------------+-----------+------+---------+-------+----------------------------+</span><br></pre></td></tr></table></figure></div>

<h2 id="控制节点上发现计算主机"><a href="#控制节点上发现计算主机" class="headerlink" title="控制节点上发现计算主机"></a>控制节点上发现计算主机</h2><p>添加每台新的计算节点时，都必须在控制器节点上运行</p>
<p><strong>手动发现计算节点</strong></p>
<div class="highlight-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ su -s /bin/sh -c <span class="string">&quot;nova-manage cell_v2 discover_hosts --verbose&quot;</span> nova</span><br><span class="line">Found <span class="number">2</span> cell mappings.</span><br><span class="line">Skipping cell0 since it does not contain hosts.</span><br><span class="line">Getting computes from cell <span class="symbol">&#x27;cell1</span>&#x27;: <span class="number">3e74</span>f43a-<span class="number">74</span>db-<span class="number">4</span>eba-<span class="number">85</span>ee-c8330f906b1b</span><br><span class="line">Checking host mapping <span class="keyword">for</span> <span class="title class_">compute</span> host <span class="symbol">&#x27;compute01</span>&#x27;: a476abf2-<span class="number">030</span>f-<span class="number">4943</span>-b8a7-<span class="number">167</span>d4a65a393</span><br><span class="line">Creating host mapping <span class="keyword">for</span> <span class="title class_">compute</span> host <span class="symbol">&#x27;compute01</span>&#x27;: a476abf2-<span class="number">030</span>f-<span class="number">4943</span>-b8a7-<span class="number">167</span>d4a65a393</span><br><span class="line">Checking host mapping <span class="keyword">for</span> <span class="title class_">compute</span> host <span class="symbol">&#x27;compute02</span>&#x27;: ed0a899f-d898-<span class="number">4</span>a73-<span class="number">9100</span>-a69a26edb932</span><br><span class="line">Creating host mapping <span class="keyword">for</span> <span class="title class_">compute</span> host <span class="symbol">&#x27;compute02</span>&#x27;: ed0a899f-d898-<span class="number">4</span>a73-<span class="number">9100</span>-a69a26edb932</span><br><span class="line">Found <span class="number">2</span> unmapped computes <span class="keyword">in</span> cell: <span class="number">3e74</span>f43a-<span class="number">74</span>db-<span class="number">4</span>eba-<span class="number">85</span>ee-c8330f906b1b</span><br></pre></td></tr></table></figure></div>

<p><strong>自动发现计算节点</strong></p>
<p>为避免新加入计算节点时，手动执行注册操作 <code>nova-manage cell_v2 discover_hosts</code>，可设置控制节点定时自动发现主机；涉及控制节点 <code>nova.conf</code> 文件的 <code>[scheduler]</code> 字段；</p>
<p><strong>在全部控制节点操作</strong>；设置自动发现时间为10min，可根据实际环境调节</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf scheduler discover_hosts_in_cells_interval 600</span><br><span class="line">systemctl restart openstack-nova-api.service</span><br></pre></td></tr></table></figure></div>

<h2 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h2><p><strong>列出服务组件以验证每个进程的成功启动和注册情况</strong></p>
<div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$ </span>source ~/admin-openrc</span><br><span class="line"><span class="string">$ </span>openstack compute service list</span><br><span class="line">+----+----------------+--------------+----------+---------+-------+----------------------------+</span><br><span class="line">| <span class="type">ID</span> | <span class="type">Binary</span>         | <span class="type">Host</span>         | <span class="type">Zone</span>     | <span class="type">Status</span>  | <span class="type">State</span> | <span class="type">Updated</span> <span class="type">At</span>                 |</span><br><span class="line">+----+----------------+--------------+----------+---------+-------+----------------------------+</span><br><span class="line">| <span class="number">21</span> | nova-scheduler | controller01 | internal | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">49</span>:<span class="number">48.000000</span> |</span><br><span class="line">| <span class="number">24</span> | nova-conductor | controller01 | internal | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">49</span>:<span class="number">42.000000</span> |</span><br><span class="line">| <span class="number">27</span> | nova-scheduler | controller02 | internal | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">49</span>:<span class="number">43.000000</span> |</span><br><span class="line">| <span class="number">30</span> | nova-scheduler | controller03 | internal | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">49</span>:<span class="number">45.000000</span> |</span><br><span class="line">| <span class="number">33</span> | nova-conductor | controller02 | internal | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">49</span>:<span class="number">47.000000</span> |</span><br><span class="line">| <span class="number">36</span> | nova-conductor | controller03 | internal | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">49</span>:<span class="number">50.000000</span> |</span><br><span class="line">| <span class="number">39</span> | nova-compute   | compute01    | nova     | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">49</span>:<span class="number">46.000000</span> |</span><br><span class="line">| <span class="number">42</span> | nova-compute   | compute02    | nova     | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-04</span>T10:<span class="number">49</span>:<span class="number">48.000000</span> |</span><br><span class="line">+----+----------------+--------------+----------+---------+-------+----------------------------+</span><br></pre></td></tr></table></figure></div>

<p><strong>列出身份服务中的API端点以验证与身份服务的连接</strong></p>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ openstack catalog list</span><br><span class="line">+-----------+-----------+------------------------------------------+</span><br><span class="line">| Name      | Type      | Endpoints                                |</span><br><span class="line">+-----------+-----------+------------------------------------------+</span><br><span class="line">| placement | placement | RegionOne                                |</span><br><span class="line">|           |           |   admin: http:<span class="comment">//10.10.10.10:8778         |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">internal</span>: http:<span class="comment">//10.10.10.10:8778      |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">public</span>: http:<span class="comment">//10.10.10.10:8778        |</span></span><br><span class="line">|           |           |                                          |</span><br><span class="line">| glance    | image     | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">public</span>: http:<span class="comment">//10.10.10.10:9292        |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">internal</span>: http:<span class="comment">//10.10.10.10:9292      |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   admin: http:<span class="comment">//10.10.10.10:9292         |</span></span><br><span class="line">|           |           |                                          |</span><br><span class="line">| keystone  | identity  | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">internal</span>: http:<span class="comment">//10.10.10.10:5000/v3/  |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   admin: http:<span class="comment">//10.10.10.10:5000/v3/     |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">public</span>: http:<span class="comment">//10.10.10.10:5000/v3/    |</span></span><br><span class="line">|           |           |                                          |</span><br><span class="line">| nova      | compute   | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">public</span>: http:<span class="comment">//10.10.10.10:8774/v2.1   |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   <span class="keyword">internal</span>: http:<span class="comment">//10.10.10.10:8774/v2.1 |</span></span><br><span class="line">|           |           | RegionOne                                |</span><br><span class="line">|           |           |   admin: http:<span class="comment">//10.10.10.10:8774/v2.1    |</span></span><br><span class="line">|           |           |                                          |</span><br><span class="line">+-----------+-----------+------------------------------------------+</span><br></pre></td></tr></table></figure></div>

<p><strong>列出镜像服务中的镜像以及镜像的状态</strong></p>
<div class="highlight-container" data-rel="Diff"><figure class="iseeu highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ openstack image list</span><br><span class="line"><span class="addition">+--------------------------------------+--------------+--------+</span></span><br><span class="line">| ID                                   | Name         | Status |</span><br><span class="line"><span class="addition">+--------------------------------------+--------------+--------+</span></span><br><span class="line">| 1c66cd7e-b6d9-4e70-a3d4-f73b27a84230 | cirros-qcow2 | active |</span><br><span class="line"><span class="addition">+--------------------------------------+--------------+--------+</span></span><br></pre></td></tr></table></figure></div>

<p><strong>检查Cells和placement API是否正常运行</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ nova<span class="operator">-</span>status upgrade <span class="keyword">check</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Upgrade <span class="keyword">Check</span> Results          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Check</span>: Cells v2                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Result</span>: Success                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Details: <span class="keyword">None</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Check</span>: Placement API           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Result</span>: Success                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Details: <span class="keyword">None</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Check</span>: Ironic Flavor Migration <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Result</span>: Success                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Details: <span class="keyword">None</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Check</span>: Cinder API              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Result</span>: Success                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Details: <span class="keyword">None</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+</span></span><br></pre></td></tr></table></figure></div>

<h2 id="扩展：openstack-nova-、kvm、qemu和libvirtd之间的联系"><a href="#扩展：openstack-nova-、kvm、qemu和libvirtd之间的联系" class="headerlink" title="扩展：openstack(nova)、kvm、qemu和libvirtd之间的联系"></a>扩展：openstack(nova)、kvm、qemu和libvirtd之间的联系</h2><p><strong>一：QEMU</strong></p>
<p>QEMU是一个模拟器，通过动态二进制转换来模拟cpu以及其他一系列硬件，使guest os认为自己就是在和真正的硬件打交道，其实是和qemu模拟的硬件交互。这种模式下，guest os可以和主机上的硬件进行交互，但是所有的指令都需要qemu来进行翻译，性能会比较差。</p>
<p><strong>二：KVM</strong></p>
<p>KVM是Linux内核提供的虚拟化架构，它需要硬件硬件CPU支持，比如采用硬件辅助虚拟化的Intel-VT，AMD-V。</p>
<p>KVM通过一个内核模块kvm.ko来实现核心虚拟化功能，以及一个和处理器相关的模块，如kvm-intel.ko或者kvm-amd.ko。kvm本身不实现模拟，仅暴露一个接口&#x2F;dev&#x2F;kvm,用户态程序可以通过访问这个接口的ioctl函数来实现vcpu的创建，和虚拟内存的地址空间分配。</p>
<p>有了kvm之后，guest-os的CPU指令不用再经过qemu翻译就可以运行，大大提升了运行速度。</p>
<p>但是kvm只能模拟cpu和内存，不能模拟其他设备，于是就有了下面这个两者合一的技术qemu-kvm。</p>
<p><strong>三：QEMU-KVM</strong></p>
<p>qemu-kvm，是qemu一个特定于kvm加速模块的分支。</p>
<p>qemu将kvm整合进来，通过ioctl调用&#x2F;dev&#x2F;kvm，将cpu相关的指令交给内核模块来做，kvm只实现了cpu和内存虚拟化，但不能模拟其它设备，因此qemu还需要模拟其它设备(如：硬盘、网卡等)，qemu加上kvm就是完整意义上的服务器虚拟化</p>
<p>综上所述，QEMU-KVM具有两大作用：</p>
<ol>
<li>提供对cpu，内存（KVM负责），IO设备（QEMU负责）的虚拟</li>
<li>对各种虚拟设备的创建，调用进行管理（QEMU负责）</li>
</ol>
<p>qemu-kvm架构如下：</p>
<p><strong>四：libvirtd</strong></p>
<p>Libvirtd是目前使用最广泛的对kvm虚拟机进行管理的工具和api。Libvirtd是一个Domain进程可以被本地virsh调用，也可以被远端的virsh调用，libvirtd调用kvm-qemu控制虚拟机。</p>
<p>libvirtd由几个不同的部分组成，其中包括应用程序编程接口（API）库，一个守护进程（libvirtd）和一个默认的命令行工具(virsh)，libvirtd守护进程负责对虚拟机的管理，因此要确保这个进程的运行。</p>
<p><strong>五：openstack(nova)、kvm、qemu-kvm和libvirtd之间的关系。</strong></p>
<p>kvm是最底层的VMM，它可以模拟cpu和内存，但是缺少对网络、I&#x2F;O及周边设备的支持，因此不能直接使用。</p>
<p>qemu-kvm是构建与kvm之上的，它提供了完整的虚拟化方案</p>
<p>openstack(nova)的核心功能就是管理一大堆虚拟机，虚拟机可以是各种各样（kvm, qemu, xen, vmware…），而且管理的方法也可以是各种各样（libvirt, xenapi, vmwareapi…）。而nova中默认使用的管理虚拟机的API就是libvirtd。</p>
<p>简单说就是，openstack不会去直接控制qemu-kvm，而是通过libvirtd库去间接控制qemu-kvm。</p>
<p>另外，libvirt还提供了跨VM平台的功能，它可以控制除了QEMU之外的模拟器，包括vmware, virtualbox， xen等等。所以为了openstack的跨VM性，所以openstack只会用libvirt而不直接用qemu-kvm</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111041855768.png"
                      alt="1364540142_7304"
                ></p>
<h1 id="八、Neutron控制-网络节点集群部署（openvswitch方式）"><a href="#八、Neutron控制-网络节点集群部署（openvswitch方式）" class="headerlink" title="八、Neutron控制+网络节点集群部署（openvswitch方式）"></a>八、Neutron控制+网络节点集群部署（openvswitch方式）</h1><p><strong>Nova具体功能如下：</strong></p>
<ul>
<li>Neutron 为整个 OpenStack 环境提供网络支持，包括二层交换，三层路由，负载均衡，防火墙和 VPN 等。</li>
<li>Neutron 提供了一个灵活的框架，通过配置，无论是开源还是商业软件都可以被用来实现这些功能。</li>
</ul>
<h2 id="创建nova相关数据库（控制节点）"><a href="#创建nova相关数据库（控制节点）" class="headerlink" title="创建nova相关数据库（控制节点）"></a>创建nova相关数据库（控制节点）</h2><p>在任意控制节点创建数据库；</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123456</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE neutron;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> neutron.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;neutron&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> neutron.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;neutron&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line">exit;</span><br></pre></td></tr></table></figure></div>

<h2 id="创建neutron相关服务凭证"><a href="#创建neutron相关服务凭证" class="headerlink" title="创建neutron相关服务凭证"></a>创建neutron相关服务凭证</h2><p>在任意控制节点操作；</p>
<p><strong>创建neutron用户</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source <span class="operator">~</span><span class="operator">/</span>admin<span class="operator">-</span>openrc</span><br><span class="line">openstack <span class="keyword">user</span> <span class="keyword">create</span> <span class="comment">--domain default --password 123456 neutron</span></span><br></pre></td></tr></table></figure></div>

<p><strong>向neutron用户赋予admin权限</strong></p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add <span class="attr">--project</span> service <span class="attr">--user</span> neutron admin</span><br></pre></td></tr></table></figure></div>

<p><strong>创建neutron服务实体</strong></p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack service create <span class="attr">--name</span> neutron <span class="attr">--description</span> &quot;OpenStack Networking&quot; network</span><br></pre></td></tr></table></figure></div>

<p><strong>创建neutron API服务端点</strong></p>
<p>api地址统一采用vip，如果 <code>public/internal/admin</code> 分别设计使用不同的vip，请注意区分；</p>
<p><code>--region</code> 与初始化admin用户时生成的 <code>region</code> 一致；neutron-api 服务类型为network；</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne network public http://10.10.10.10:9696</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne network internal http://10.10.10.10:9696</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne network admin http://10.10.10.10:9696</span></span><br></pre></td></tr></table></figure></div>

<h2 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h2><ul>
<li>openstack-neutron：neutron-server的包</li>
<li>openstack-neutron-ml2：ML2 plugin的包</li>
<li>openstack-neutron-openvswitch：openvswitch相关的包</li>
<li>ebtables：防火墙相关的包</li>
<li>conntrack-tools： 该模块可以对iptables进行状态数据包检查</li>
</ul>
<h3 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h3><p><strong>在全部控制节点安装neutron相关服务</strong></p>
<div class="highlight-container" data-rel="Dos"><figure class="iseeu highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install openstack-neutron openstack-neutron-ml2 ebtables conntrack-tools openstack-neutron-openvswitch libibverbs <span class="built_in">net</span>-tools -y</span><br></pre></td></tr></table></figure></div>

<p><strong>在全部控制节点配置neutron相关服务</strong>，以controller01节点为例；</p>
<h3 id="内核配置"><a href="#内核配置" class="headerlink" title="内核配置"></a>内核配置</h3><p><strong>在全部控制节点执行</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter=0</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter=0</span></span><br><span class="line"><span class="string">&#x27;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></div>

<h3 id="配置neutron-conf"><a href="#配置neutron-conf" class="headerlink" title="配置neutron.conf"></a>配置neutron.conf</h3><p>注意 <code>my_ip</code> 参数，根据节点修改；注意 <code>neutron.conf</code> 文件的权限： <code>root:neutron</code></p>
<p>注意 <code>bind_host</code> 参数，根据节点修改；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件/etc/neutron/neutron.conf</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/neutron/neutron.conf&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/neutron/neutron.conf.bak &gt; /etc/neutron/neutron.conf</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT bind_host 10.10.10.31</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT core_plugin ml2</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT service_plugins router</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT allow_overlapping_ips <span class="literal">true</span></span><br><span class="line"><span class="comment">#直接连接rabbitmq集群</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/neutron.conf DEFAULT transport_url rabbit://openstack:123456@controller01:5672,openstack:123456@controller02:5672,openstack:123456@controller03:5672</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT auth_strategy  keystone</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_status_changes  <span class="literal">true</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_data_changes  <span class="literal">true</span></span><br><span class="line"><span class="comment">#启用l3 ha功能</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT l3_ha True</span><br><span class="line"><span class="comment">#最多在几个l3 agent上创建ha router</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT max_l3_agents_per_router 3</span><br><span class="line"><span class="comment">#可创建ha router的最少正常运行的l3 agnet数量</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT min_l3_agents_per_router 2</span><br><span class="line"><span class="comment">#dhcp高可用，在3个网络节点各生成1个dhcp服务器</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT dhcp_agents_per_network 3</span><br><span class="line"><span class="comment">#开启分布式路由</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT router_distributed <span class="literal">true</span></span><br><span class="line"><span class="comment">#配置RPC的超时时间，默认为60s,可能导致超时异常.设置为180s</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT rpc_response_timeout 180</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf database connection  mysql+pymysql://neutron:123456@10.10.10.10/neutron</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken www_authenticate_uri  http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken auth_url  http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken memcached_servers  controller01:11211,controller02:11211,controller03:11211</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken auth_type  password</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken project_domain_name  default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken user_domain_name  default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken project_name  service</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken username  neutron</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken password  123456</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf nova  auth_url http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf nova  auth_type password</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf nova  project_domain_name default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf nova  user_domain_name default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf nova  region_name RegionOne</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf nova  project_name service</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf nova  username nova</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf nova  password 123456</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf oslo_concurrency lock_path  /var/lib/neutron/tmp</span><br></pre></td></tr></table></figure></div>

<h3 id="配置ml2-conf-ini"><a href="#配置ml2-conf-ini" class="headerlink" title="配置ml2_conf.ini"></a>配置ml2_conf.ini</h3><p>在全部控制节点操作，以controller01节点为例；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/neutron/plugins/ml2/ml2_conf.ini&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/neutron/plugins/ml2/ml2_conf.ini.bak &gt; /etc/neutron/plugins/ml2/ml2_conf.ini</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers  flat,vlan,vxlan</span><br><span class="line"><span class="comment"># 可同时设置多种租户网络类型，第一个值是常规租户创建网络时的默认值，同时也默认是master router心跳信号的传递网络类型</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types vxlan,vlan,flat</span><br><span class="line"><span class="comment"># ml2 mechanism_driver 列表，l2population对gre/vxlan租户网络有效</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers  openvswitch,l2population</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/ml2_conf.ini ml2 extension_drivers  port_security</span><br><span class="line"><span class="comment"># 指定flat网络类型名称为”external”，”*”表示任意网络，空值表示禁用flat网络</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_flat flat_networks  external</span><br><span class="line"><span class="comment"># 指定vlan网络类型的网络名称为”vlan”；如果不设置vlan id则表示不受限</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_vlan network_vlan_ranges  vlan:3001:3500</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_vxlan vni_ranges 10001:20000</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_ipset  <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TUNNEL_INTERFACE_IP_ADDRESS</span></span><br><span class="line"><span class="comment">#openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs local_ip  10.10.30.31</span></span><br><span class="line"><span class="comment">#openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs bridge_mappings  external:br-ex</span></span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/ml2_conf.ini agent enable_distributed_routing  <span class="literal">true</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/ml2_conf.ini agent tunnel_types  vxlan</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/ml2_conf.ini agent l2_population  <span class="literal">true</span></span><br></pre></td></tr></table></figure></div>

<p><strong>创建ml2的软连接 文件指向ML2插件配置的软链接</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini</span><br></pre></td></tr></table></figure></div>

<h3 id="配置nova-conf"><a href="#配置nova-conf" class="headerlink" title="配置nova.conf"></a>配置nova.conf</h3><p>在全部控制节点操作，以controller01节点为例；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改配置文件/etc/nova/nova.conf</span></span><br><span class="line"><span class="comment"># 在全部控制节点上配置nova服务与网络节点服务进行交互</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron url  http://10.10.10.10:9696</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron auth_url  http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron auth_type  password</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron project_domain_name  default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron user_domain_name  default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron region_name  RegionOne</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron project_name  service</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron username  neutron</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron password  123456</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron service_metadata_proxy  <span class="literal">true</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron metadata_proxy_shared_secret  123456</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf DEFAULT linuxnet_interface_driver  nova.network.linux_net.LinuxOVSInterfaceDriver</span><br></pre></td></tr></table></figure></div>

<h3 id="初始化neutron数据库"><a href="#初始化neutron数据库" class="headerlink" title="初始化neutron数据库"></a>初始化neutron数据库</h3><p>任意控制节点操作</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c <span class="string">&quot;neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head&quot;</span> neutron</span><br></pre></td></tr></table></figure></div>

<p>验证neutron数据库是否正常写入</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u neutron -p123456 -e <span class="string">&quot;use neutron;show tables;&quot;</span></span><br></pre></td></tr></table></figure></div>

<p><strong>注意：如果控制节点只跑neutron-server，则修改以上配置即可，然后使用：systemctl restart openstack-nova-api.service &amp;&amp; systemctl enable neutron-server.service &amp;&amp; systemctl restart neutron-server.service 启动服务即可</strong></p>
<h3 id="配置l3-agent-ini（self-networking）"><a href="#配置l3-agent-ini（self-networking）" class="headerlink" title="配置l3_agent.ini（self-networking）"></a>配置l3_agent.ini（self-networking）</h3><ul>
<li>l3代理为租户虚拟网络提供路由和NAT服务</li>
</ul>
<p>在全部控制节点操作，以controller01节点为例；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/neutron/l3_agent.ini&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/neutron/l3_agent.ini.bak &gt; /etc/neutron/l3_agent.ini</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Vbnet"><figure class="iseeu highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="keyword">set</span> /etc/neutron/l3_agent.ini <span class="keyword">DEFAULT</span> interface_driver  neutron.agent.linux.<span class="keyword">interface</span>.OVSInterfaceDriver</span><br><span class="line">#openstack-config --<span class="keyword">set</span> /etc/neutron/l3_agent.ini <span class="keyword">DEFAULT</span> external_network_bridge  br-ex</span><br><span class="line">openstack-config --<span class="keyword">set</span> /etc/neutron/l3_agent.ini <span class="keyword">DEFAULT</span> external_network_bridge</span><br><span class="line">openstack-config --<span class="keyword">set</span> /etc/neutron/l3_agent.ini <span class="keyword">DEFAULT</span> agent_mode  dvr_snat</span><br></pre></td></tr></table></figure></div>

<ul>
<li>注意 agent_mode 为 dvr_snat</li>
<li>官方教程里面设置 external_network_bridge 为空，测试使用 br-ex 好像也没问题，不知其原由</li>
</ul>
<h3 id="配置dhcp-agent-ini"><a href="#配置dhcp-agent-ini" class="headerlink" title="配置dhcp_agent.ini"></a>配置dhcp_agent.ini</h3><ul>
<li>DHCP代理，DHCP代理为虚拟网络提供DHCP服务;</li>
<li>使用dnsmasp提供dhcp服务；</li>
</ul>
<p>在全部控制节点操作，以controller01节点为例；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/neutron/dhcp_agent.ini&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/neutron/dhcp_agent.ini.bak &gt; /etc/neutron/dhcp_agent.ini</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Vbnet"><figure class="iseeu highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="keyword">set</span>  /etc/neutron/dhcp_agent.ini <span class="keyword">DEFAULT</span> interface_driver neutron.agent.linux.<span class="keyword">interface</span>.OVSInterfaceDriver</span><br><span class="line">openstack-config --<span class="keyword">set</span>  /etc/neutron/dhcp_agent.ini <span class="keyword">DEFAULT</span> dhcp_driver neutron.agent.linux.dhcp.Dnsmasq</span><br><span class="line">openstack-config --<span class="keyword">set</span>  /etc/neutron/dhcp_agent.ini <span class="keyword">DEFAULT</span> enable_isolated_metadata <span class="literal">true</span></span><br></pre></td></tr></table></figure></div>

<h3 id="配置metadata-agent-ini"><a href="#配置metadata-agent-ini" class="headerlink" title="配置metadata_agent.ini"></a>配置metadata_agent.ini</h3><ul>
<li>元数据代理提供配置信息，例如实例的凭据</li>
<li><code>metadata_proxy_shared_secret</code> 的密码与控制节点上 <code>/etc/nova/nova.conf</code> 文件中密码一致；</li>
</ul>
<p>在全部控制节点操作，以controller01节点为例；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/neutron/metadata_agent.ini&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/neutron/metadata_agent.ini.bak &gt; /etc/neutron/metadata_agent.ini</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_host 10.10.10.10</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret 123456</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/metadata_agent.ini cache memcache_servers controller01:11211,controller02:11211,controller03:11211</span><br></pre></td></tr></table></figure></div>

<h3 id="配置openvswitch-agent-ini"><a href="#配置openvswitch-agent-ini" class="headerlink" title="配置openvswitch_agent.ini"></a>配置openvswitch_agent.ini</h3><p>在全部控制节点操作，以controller01节点为例；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/neutron/plugins/ml2/openvswitch_agent.ini&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini.bak &gt; /etc/neutron/plugins/ml2/openvswitch_agent.ini</span><br></pre></td></tr></table></figure></div>

<p><code>local_ip</code> 修改为当前节点的主机ip</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini ovs integration_bridge br-int</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini ovs tunnel_bridge br-tun</span><br><span class="line"><span class="comment"># tunnel租户网络（vxlan）vtep端点，这里对应规划的ens35地址，根据节点做相应修改</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini ovs local_ip 10.10.30.31</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini ovs bridge_mappings  external:br-ex</span><br><span class="line"><span class="comment">#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini ovs bridge_mappings</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini agent tunnel_types vxlan,gre</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini agent tunnel_types vxlan</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini agent l2_population <span class="literal">true</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini agent arp_responder <span class="literal">true</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini agent enable_distributed_routing <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini securitygroup enable_security_group <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini securitygroup firewall_driver neutron.agent.linux.openvswitch_firewall.OVSFirewallDriver</span><br></pre></td></tr></table></figure></div>

<h2 id="启动openvswitch服务"><a href="#启动openvswitch服务" class="headerlink" title="启动openvswitch服务"></a>启动openvswitch服务</h2><p>在全部控制节点操作，以controller01节点为例；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> openvswitch.service</span><br><span class="line">systemctl restart openvswitch.service</span><br><span class="line">systemctl status openvswitch.service</span><br></pre></td></tr></table></figure></div>

<h2 id="创建网桥br-ex"><a href="#创建网桥br-ex" class="headerlink" title="创建网桥br-ex"></a>创建网桥br-ex</h2><p>在全部控制节点操作，以controller01节点为例；</p>
<p>将外部网络ip转移到网桥，添加到开机启动</p>
<p>ip地址修改为当前节点ens34地址；以controller01为例；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;#</span></span><br><span class="line"><span class="string">ovs-vsctl add-br br-ex</span></span><br><span class="line"><span class="string">ovs-vsctl add-port br-ex ens34</span></span><br><span class="line"><span class="string">ovs-vsctl show</span></span><br><span class="line"><span class="string">ifconfig ens34 0.0.0.0</span></span><br><span class="line"><span class="string">ifconfig br-ex 10.10.20.31/24</span></span><br><span class="line"><span class="string">#route add default gw 10.10.20.2 # 可选，添加默认路由</span></span><br><span class="line"><span class="string">#&#x27;</span> &gt;&gt; /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure></div>

<p><strong>创建并验证</strong></p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@controller01 ~]<span class="comment"># chmod +x /etc/rc.d/rc.local; tail -n 8 /etc/rc.d/rc.local | bash</span></span><br><span class="line">ad<span class="symbol">5867f</span>6<span class="number">-9</span>ddd<span class="number">-4746</span><span class="number">-9</span>de7-<span class="keyword">bc3c2b2e98f8</span></span><br><span class="line"><span class="keyword"></span>    <span class="keyword">Bridge </span><span class="keyword">br-ex</span></span><br><span class="line"><span class="keyword"></span>        Port <span class="keyword">br-ex</span></span><br><span class="line"><span class="keyword"></span>            Interface <span class="keyword">br-ex</span></span><br><span class="line"><span class="keyword"></span><span class="symbol">                type:</span> internal</span><br><span class="line">Port <span class="string">&quot;ens34&quot;</span></span><br><span class="line">    Interface <span class="string">&quot;ens34&quot;</span></span><br><span class="line"><span class="symbol">    ovs_version:</span> <span class="string">&quot;2.12.0&quot;</span></span><br><span class="line">[root@controller01 ~]#</span><br><span class="line">[root@controller01 ~]<span class="comment"># ifconfig br-ex</span></span><br><span class="line"><span class="keyword">br-ex: </span>flags=<span class="number">4163</span>&lt;UP,<span class="keyword">BROADCAST,RUNNING,MULTICAST&gt; </span> mtu <span class="number">1500</span></span><br><span class="line">inet <span class="number">10</span>.<span class="number">10</span>.<span class="number">20</span>.<span class="number">31</span>  netmask <span class="number">255</span>.<span class="number">255</span>.<span class="number">255</span>.<span class="number">0</span>  <span class="keyword">broadcast </span><span class="number">10</span>.<span class="number">10</span>.<span class="number">20</span>.<span class="number">255</span></span><br><span class="line">inet6 fe80::<span class="number">20</span>c:<span class="number">29</span>ff:fedd:<span class="number">69</span>e5  <span class="keyword">prefixlen </span><span class="number">64</span>  <span class="keyword">scopeid </span><span class="number">0x20</span>&lt;link&gt;</span><br><span class="line">ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:dd:<span class="number">69</span>:e5  txqueuelen <span class="number">1000</span>  (Ethernet)</span><br><span class="line">RX packets <span class="number">0</span>  <span class="keyword">bytes </span><span class="number">0</span> (<span class="number">0</span>.<span class="number">0</span> <span class="keyword">B)</span></span><br><span class="line"><span class="keyword"></span>        RX errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">TX packets <span class="number">7</span>  <span class="keyword">bytes </span><span class="number">586</span> (<span class="number">586</span>.<span class="number">0</span> <span class="keyword">B)</span></span><br><span class="line"><span class="keyword"></span>        TX errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[root@controller01 ~]#</span><br><span class="line">[root@controller01 ~]<span class="comment"># ifconfig ens34</span></span><br><span class="line"><span class="symbol">ens34:</span> flags=<span class="number">4163</span>&lt;UP,<span class="keyword">BROADCAST,RUNNING,MULTICAST&gt; </span> mtu <span class="number">1500</span></span><br><span class="line">inet6 fe80::<span class="number">5</span>f52:<span class="number">19</span>c8:<span class="number">6</span>c65:c<span class="symbol">9f</span>3  <span class="keyword">prefixlen </span><span class="number">64</span>  <span class="keyword">scopeid </span><span class="number">0x20</span>&lt;link&gt;</span><br><span class="line">ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:dd:<span class="number">69</span>:e5  txqueuelen <span class="number">1000</span>  (Ethernet)</span><br><span class="line">RX packets <span class="number">1860</span>  <span class="keyword">bytes </span><span class="number">249541</span> (<span class="number">243</span>.<span class="number">6</span> KiB)</span><br><span class="line">RX errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">TX packets <span class="number">7014</span>  <span class="keyword">bytes </span><span class="number">511816</span> (<span class="number">499</span>.<span class="number">8</span> KiB)</span><br><span class="line">TX errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br></pre></td></tr></table></figure></div>

<p><strong>关闭网卡的开机自启</strong></p>
<p>全部控制节点执行；关闭的目的是以保证OVS创建的网卡可以安全使用</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s#ONBOOT=yes#ONBOOT=no#g&#x27;</span> /etc/sysconfig/network-scripts/ifcfg-ens34</span><br></pre></td></tr></table></figure></div>

<h2 id="启动服务-2"><a href="#启动服务-2" class="headerlink" title="启动服务"></a>启动服务</h2><p>全部控制节点操作；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 变更nova配置文件，首先需要重启nova服务</span></span><br><span class="line">systemctl restart openstack-nova-api.service &amp;&amp; systemctl status openstack-nova-api.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> neutron-server.service \</span><br><span class="line">neutron-openvswitch-agent.service \</span><br><span class="line">neutron-l3-agent.service \</span><br><span class="line">neutron-dhcp-agent.service \</span><br><span class="line">neutron-metadata-agent.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl restart neutron-server.service \</span><br><span class="line">neutron-openvswitch-agent.service \</span><br><span class="line">neutron-l3-agent.service \</span><br><span class="line">neutron-dhcp-agent.service \</span><br><span class="line">neutron-metadata-agent.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">systemctl status neutron-server.service \</span><br><span class="line">neutron-openvswitch-agent.service \</span><br><span class="line">neutron-l3-agent.service \</span><br><span class="line">neutron-dhcp-agent.service \</span><br><span class="line">neutron-metadata-agent.service</span><br></pre></td></tr></table></figure></div>

<h2 id="验证-2"><a href="#验证-2" class="headerlink" title="验证"></a>验证</h2><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">. ~/admin-openrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看加载的扩展服务</span></span><br><span class="line">openstack extension list --network</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看agent服务</span></span><br><span class="line">openstack network agent list</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111231317249.png"
                      alt="image-20211123131745807"
                ></p>
<ul>
<li>agent 启动可能会花一点时间</li>
</ul>
<div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@controller01</span> <span class="string">~</span>]<span class="comment"># ovs-vsctl show</span></span><br><span class="line"><span class="string">2b64473f-6320-411b-b8ce-d9d802c08cd0</span></span><br><span class="line"><span class="string">Manager</span> <span class="string">&quot;ptcp:6640:127.0.0.1&quot;</span></span><br><span class="line"><span class="attr">is_connected:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">Bridge</span> <span class="string">br-ex</span></span><br><span class="line"><span class="string">Controller</span> <span class="string">&quot;tcp:127.0.0.1:6633&quot;</span></span><br><span class="line">    <span class="attr">is_connected:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">fail_mode:</span> <span class="string">secure</span></span><br><span class="line"><span class="attr">datapath_type:</span> <span class="string">system</span></span><br><span class="line"><span class="string">Port</span> <span class="string">phy-br-ex</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">phy-br-ex</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">patch</span></span><br><span class="line">        <span class="attr">options:</span> &#123;<span class="string">peer=int-br-ex</span>&#125;</span><br><span class="line"><span class="string">Port</span> <span class="string">&quot;ens34&quot;</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">&quot;ens34&quot;</span></span><br><span class="line"><span class="string">Port</span> <span class="string">br-ex</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">br-ex</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">internal</span></span><br><span class="line"><span class="string">Bridge</span> <span class="string">br-tun</span></span><br><span class="line"><span class="string">Controller</span> <span class="string">&quot;tcp:127.0.0.1:6633&quot;</span></span><br><span class="line">    <span class="attr">is_connected:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">fail_mode:</span> <span class="string">secure</span></span><br><span class="line"><span class="attr">datapath_type:</span> <span class="string">system</span></span><br><span class="line"><span class="string">Port</span> <span class="string">br-tun</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">br-tun</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">internal</span></span><br><span class="line"><span class="string">Port</span> <span class="string">patch-int</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">patch-int</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">patch</span></span><br><span class="line">        <span class="attr">options:</span> &#123;<span class="string">peer=patch-tun</span>&#125;</span><br><span class="line"><span class="string">Bridge</span> <span class="string">br-int</span></span><br><span class="line"><span class="string">Controller</span> <span class="string">&quot;tcp:127.0.0.1:6633&quot;</span></span><br><span class="line">    <span class="attr">is_connected:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">fail_mode:</span> <span class="string">secure</span></span><br><span class="line"><span class="attr">datapath_type:</span> <span class="string">system</span></span><br><span class="line"><span class="string">Port</span> <span class="string">int-br-ex</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">int-br-ex</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">patch</span></span><br><span class="line">        <span class="attr">options:</span> &#123;<span class="string">peer=phy-br-ex</span>&#125;</span><br><span class="line"><span class="string">Port</span> <span class="string">br-int</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">br-int</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">internal</span></span><br><span class="line"><span class="string">Port</span> <span class="string">patch-tun</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">patch-tun</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">patch</span></span><br><span class="line">        <span class="attr">options:</span> &#123;<span class="string">peer=patch-int</span>&#125;</span><br><span class="line"><span class="attr">ovs_version:</span> <span class="string">&quot;2.12.0&quot;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>br-ex 连接外部网络以及不同网络vm通信用，br-int 同计算节点同网络vm通信用，br-tun 不同计算节点同网络vm通信用</li>
<li>其中 br-ex 需要手动创建，br-int 与 br-tun 由 neutron-openvswitch-agent 自动创建</li>
</ul>
<h1 id="九、Neutron计算节点（openvswitch方式）"><a href="#九、Neutron计算节点（openvswitch方式）" class="headerlink" title="九、Neutron计算节点（openvswitch方式）"></a>九、Neutron计算节点（openvswitch方式）</h1><h2 id="安装neutron-openvswitch"><a href="#安装neutron-openvswitch" class="headerlink" title="安装neutron-openvswitch"></a>安装neutron-openvswitch</h2><p>在全部计算节点安装，以compute01节点为例</p>
<div class="highlight-container" data-rel="Dos"><figure class="iseeu highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install openstack-neutron openstack-neutron-ml2 ebtables conntrack-tools openstack-neutron-openvswitch libibverbs <span class="built_in">net</span>-tools -y</span><br></pre></td></tr></table></figure></div>

<h2 id="内核配置-1"><a href="#内核配置-1" class="headerlink" title="内核配置"></a>内核配置</h2><p><strong>在全部计算节点执行</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter=0</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter=0</span></span><br><span class="line"><span class="string">&#x27;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></div>

<h2 id="配置metadata-agent-ini-1"><a href="#配置metadata-agent-ini-1" class="headerlink" title="配置metadata_agent.ini"></a>配置metadata_agent.ini</h2><ul>
<li>元数据代理提供配置信息，例如实例的凭据</li>
<li><code>metadata_proxy_shared_secret</code> 的密码与控制节点上 <code>/etc/nova/nova.conf</code> 文件中密码一致；</li>
</ul>
<p>在全部计算节点操作；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/neutron/metadata_agent.ini&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/neutron/metadata_agent.ini.bak &gt; /etc/neutron/metadata_agent.ini</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_host 10.10.10.10</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret 123456</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/metadata_agent.ini cache memcache_servers controller01:11211,controller02:11211,controller03:11211</span><br></pre></td></tr></table></figure></div>

<h2 id="配置l3-agent-ini（self-networking）-1"><a href="#配置l3-agent-ini（self-networking）-1" class="headerlink" title="配置l3_agent.ini（self-networking）"></a>配置l3_agent.ini（self-networking）</h2><ul>
<li>l3代理为租户虚拟网络提供路由和NAT服务</li>
</ul>
<p>在全部计算节点操作；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/neutron/l3_agent.ini&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/neutron/l3_agent.ini.bak &gt; /etc/neutron/l3_agent.ini</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Vbnet"><figure class="iseeu highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="keyword">set</span> /etc/neutron/l3_agent.ini <span class="keyword">DEFAULT</span> interface_driver  neutron.agent.linux.<span class="keyword">interface</span>.OVSInterfaceDriver</span><br><span class="line">#openstack-config --<span class="keyword">set</span> /etc/neutron/l3_agent.ini <span class="keyword">DEFAULT</span> external_network_bridge  br-ex</span><br><span class="line">openstack-config --<span class="keyword">set</span> /etc/neutron/l3_agent.ini <span class="keyword">DEFAULT</span> external_network_bridge</span><br><span class="line">openstack-config --<span class="keyword">set</span> /etc/neutron/l3_agent.ini <span class="keyword">DEFAULT</span> agent_mode  dvr</span><br></pre></td></tr></table></figure></div>

<ul>
<li>注意 agent_mode 为 dvr</li>
<li>官方教程里面设置 external_network_bridge 为空，测试使用 br-ex 好像也没问题，不知其原由</li>
</ul>
<h2 id="配置openvswitch-agent-ini-1"><a href="#配置openvswitch-agent-ini-1" class="headerlink" title="配置openvswitch_agent.ini"></a>配置openvswitch_agent.ini</h2><p>所有计算节点操作</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/neutron/plugins/ml2/openvswitch_agent.ini&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini.bak &gt; /etc/neutron/plugins/ml2/openvswitch_agent.ini</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini ovs integration_bridge br-int</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini ovs tunnel_bridge br-tun</span><br><span class="line"><span class="comment"># tunnel租户网络（vxlan）vtep端点，这里对应规划的ens35地址，根据节点做相应修改</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini ovs local_ip 10.10.30.41</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini ovs bridge_mappings  external:br-ex</span><br><span class="line"><span class="comment">#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini ovs bridge_mappings</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini agent tunnel_types vxlan,gre</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini agent tunnel_types vxlan</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini agent l2_population <span class="literal">true</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini agent arp_responder <span class="literal">true</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini agent enable_distributed_routing <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini securitygroup enable_security_group <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/plugins/ml2/openvswitch_agent.ini securitygroup firewall_driver neutron.agent.linux.openvswitch_firewall.OVSFirewallDriver</span><br></pre></td></tr></table></figure></div>

<h2 id="配置neutron-conf-1"><a href="#配置neutron-conf-1" class="headerlink" title="配置neutron.conf"></a>配置neutron.conf</h2><p>所有计算节点操作，注意修改 bind_host</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件/etc/neutron/neutron.conf</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/neutron/neutron.conf&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/neutron/neutron.conf.bak &gt; /etc/neutron/neutron.conf</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT bind_host 10.10.10.41</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/neutron/neutron.conf DEFAULT transport_url rabbit://openstack:123456@controller01:5672,openstack:123456@controller02:5672,openstack:123456@controller03:5672</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT auth_strategy keystone</span><br><span class="line"><span class="comment">#配置RPC的超时时间，默认为60s,可能导致超时异常.设置为180s</span></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf DEFAULT rpc_response_timeout 180</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken www_authenticate_uri http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken auth_url http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller01:11211,controller02:11211,controller03:11211</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken auth_type password</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken project_domain_name default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken user_domain_name default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken project_name service</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken username neutron</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf keystone_authtoken password 123456</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp</span><br></pre></td></tr></table></figure></div>

<h2 id="配置nova-conf-1"><a href="#配置nova-conf-1" class="headerlink" title="配置nova.conf"></a>配置nova.conf</h2><p>在全部计算节点操作；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron url http://10.10.10.10:9696</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron auth_url http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron auth_type password</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron project_domain_name default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron user_domain_name default</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron region_name RegionOne</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron project_name service</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron username neutron</span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf neutron password 123456</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span>  /etc/nova/nova.conf DEFAULT linuxnet_interface_driver  nova.network.linux_net.LinuxOVSInterfaceDriver</span><br></pre></td></tr></table></figure></div>

<h2 id="启动openvswitch服务-1"><a href="#启动openvswitch服务-1" class="headerlink" title="启动openvswitch服务"></a>启动openvswitch服务</h2><p>在全部计算节点操作；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> openvswitch.service</span><br><span class="line">systemctl restart openvswitch.service</span><br><span class="line">systemctl status openvswitch.service</span><br></pre></td></tr></table></figure></div>

<h2 id="创建网桥br-ex-1"><a href="#创建网桥br-ex-1" class="headerlink" title="创建网桥br-ex"></a>创建网桥br-ex</h2><p>在全部计算节点操作；</p>
<p>将外部网络ip转移到网桥，添加到开机启动</p>
<p>ip地址修改为当前节点ens34地址；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;#</span></span><br><span class="line"><span class="string">ovs-vsctl add-br br-ex</span></span><br><span class="line"><span class="string">ovs-vsctl add-port br-ex ens34</span></span><br><span class="line"><span class="string">ovs-vsctl show</span></span><br><span class="line"><span class="string">ifconfig ens34 0.0.0.0</span></span><br><span class="line"><span class="string">ifconfig br-ex 10.10.20.41/24</span></span><br><span class="line"><span class="string">#route add default gw 10.10.20.2 # 可选，添加默认路由</span></span><br><span class="line"><span class="string">#&#x27;</span> &gt;&gt; /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure></div>

<p><strong>创建并验证</strong></p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@compute01 ~]<span class="comment"># chmod +x /etc/rc.d/rc.local; tail -n 8 /etc/rc.d/rc.local | bash</span></span><br><span class="line">ad<span class="symbol">5867f</span>6<span class="number">-9</span>ddd<span class="number">-4746</span><span class="number">-9</span>de7-<span class="keyword">bc3c2b2e98f8</span></span><br><span class="line"><span class="keyword"></span>    <span class="keyword">Bridge </span><span class="keyword">br-ex</span></span><br><span class="line"><span class="keyword"></span>        Port <span class="keyword">br-ex</span></span><br><span class="line"><span class="keyword"></span>            Interface <span class="keyword">br-ex</span></span><br><span class="line"><span class="keyword"></span><span class="symbol">                type:</span> internal</span><br><span class="line">Port <span class="string">&quot;ens34&quot;</span></span><br><span class="line">    Interface <span class="string">&quot;ens34&quot;</span></span><br><span class="line"><span class="symbol">    ovs_version:</span> <span class="string">&quot;2.12.0&quot;</span></span><br><span class="line">[root@compute01 ~]#</span><br><span class="line">[root@compute01 ~]<span class="comment"># ifconfig br-ex</span></span><br><span class="line"><span class="keyword">br-ex: </span>flags=<span class="number">4163</span>&lt;UP,<span class="keyword">BROADCAST,RUNNING,MULTICAST&gt; </span> mtu <span class="number">1500</span></span><br><span class="line">inet <span class="number">10</span>.<span class="number">10</span>.<span class="number">20</span>.<span class="number">31</span>  netmask <span class="number">255</span>.<span class="number">255</span>.<span class="number">255</span>.<span class="number">0</span>  <span class="keyword">broadcast </span><span class="number">10</span>.<span class="number">10</span>.<span class="number">20</span>.<span class="number">255</span></span><br><span class="line">inet6 fe80::<span class="number">20</span>c:<span class="number">29</span>ff:fedd:<span class="number">69</span>e5  <span class="keyword">prefixlen </span><span class="number">64</span>  <span class="keyword">scopeid </span><span class="number">0x20</span>&lt;link&gt;</span><br><span class="line">ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:dd:<span class="number">69</span>:e5  txqueuelen <span class="number">1000</span>  (Ethernet)</span><br><span class="line">RX packets <span class="number">0</span>  <span class="keyword">bytes </span><span class="number">0</span> (<span class="number">0</span>.<span class="number">0</span> <span class="keyword">B)</span></span><br><span class="line"><span class="keyword"></span>        RX errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">TX packets <span class="number">7</span>  <span class="keyword">bytes </span><span class="number">586</span> (<span class="number">586</span>.<span class="number">0</span> <span class="keyword">B)</span></span><br><span class="line"><span class="keyword"></span>        TX errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[root@compute01 ~]#</span><br><span class="line">[root@compute01 ~]<span class="comment"># ifconfig ens34</span></span><br><span class="line"><span class="symbol">ens34:</span> flags=<span class="number">4163</span>&lt;UP,<span class="keyword">BROADCAST,RUNNING,MULTICAST&gt; </span> mtu <span class="number">1500</span></span><br><span class="line">inet6 fe80::<span class="number">5</span>f52:<span class="number">19</span>c8:<span class="number">6</span>c65:c<span class="symbol">9f</span>3  <span class="keyword">prefixlen </span><span class="number">64</span>  <span class="keyword">scopeid </span><span class="number">0x20</span>&lt;link&gt;</span><br><span class="line">ether <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:dd:<span class="number">69</span>:e5  txqueuelen <span class="number">1000</span>  (Ethernet)</span><br><span class="line">RX packets <span class="number">1860</span>  <span class="keyword">bytes </span><span class="number">249541</span> (<span class="number">243</span>.<span class="number">6</span> KiB)</span><br><span class="line">RX errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">TX packets <span class="number">7014</span>  <span class="keyword">bytes </span><span class="number">511816</span> (<span class="number">499</span>.<span class="number">8</span> KiB)</span><br><span class="line">TX errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br></pre></td></tr></table></figure></div>

<p><strong>关闭网卡的开机自启</strong></p>
<p>全部计算节点执行；关闭的目的是以保证OVS创建的网卡可以安全使用</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s#ONBOOT=yes#ONBOOT=no#g&#x27;</span> /etc/sysconfig/network-scripts/ifcfg-ens34</span><br></pre></td></tr></table></figure></div>

<h2 id="启动服务-3"><a href="#启动服务-3" class="headerlink" title="启动服务"></a>启动服务</h2><p>在全部计算节点操作；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nova.conf文件已变更，首先需要重启全部计算节点的nova服务</span></span><br><span class="line">systemctl restart openstack-nova-compute.service &amp;&amp; systemctl status openstack-nova-compute.service</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> neutron-openvswitch-agent.service neutron-metadata-agent.service neutron-l3-agent.service</span><br><span class="line">systemctl restart neutron-openvswitch-agent.service neutron-metadata-agent.service neutron-l3-agent.service</span><br><span class="line">systemctl status neutron-openvswitch-agent.service neutron-metadata-agent.service neutron-l3-agent.service</span><br></pre></td></tr></table></figure></div>

<h2 id="验证-3"><a href="#验证-3" class="headerlink" title="验证"></a>验证</h2><p>在任意控制节点操作；</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">. ~/admin-openrc</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看neutron相关的agent;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或：openstack network agent list --agent-type open-vswitch</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">type</span> 类型 <span class="string">&#x27;bgp&#x27;</span>, <span class="string">&#x27;dhcp&#x27;</span>, <span class="string">&#x27;open-vswitch&#x27;</span>, <span class="string">&#x27;linux-bridge&#x27;</span>, <span class="string">&#x27;ofa&#x27;</span>, <span class="string">&#x27;l3&#x27;</span>, <span class="string">&#x27;loadbalancer&#x27;</span>, <span class="string">&#x27;metering&#x27;</span>, <span class="string">&#x27;metadata&#x27;</span>, <span class="string">&#x27;macvtap&#x27;</span>, <span class="string">&#x27;nic&#x27;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openstack network agent list</span></span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@controller01 ~]# openstack network agent list|grep compute</span><br><span class="line">| <span class="number">03995744</span><span class="number">-16</span>b1<span class="number">-4</span>c48-bde1<span class="number">-2</span>ac9978ec16e | <span class="type">Open</span> vSwitch agent | compute01    | <span class="type">None</span>              | :-)   | <span class="type">UP</span>    | neutron-openvswitch-agent |</span><br><span class="line">| <span class="number">1</span>b80a75e-f579<span class="number">-41</span>d6-ac8a<span class="number">-5</span>bab32ddd575 | <span class="type">L3</span> agent           | compute02    | nova              | :-)   | <span class="type">UP</span>    | neutron-l3-agent          |</span><br><span class="line">| <span class="number">3528</span>f80a<span class="number">-43</span>fa<span class="number">-4</span>c3b<span class="number">-8</span>c41<span class="number">-9</span>ad0c7fcc587 | <span class="type">Open</span> vSwitch agent | compute02    | <span class="type">None</span>              | :-)   | <span class="type">UP</span>    | neutron-openvswitch-agent |</span><br><span class="line">| <span class="number">48317</span>ab2-e4fd<span class="number">-4</span>de7-b544-ddf3ff3dc706 | <span class="type">Metadata</span> agent     | compute01    | <span class="type">None</span>              | :-)   | <span class="type">UP</span>    | neutron-metadata-agent    |</span><br><span class="line">| db15406c-a2f2<span class="number">-49e0</span>-ae21-cb4f6ce1b7c5 | <span class="type">Metadata</span> agent     | compute02    | <span class="type">None</span>              | :-)   | <span class="type">UP</span>    | neutron-metadata-agent    |</span><br><span class="line">| e84b48f1-b830<span class="number">-4</span>af6-a00f<span class="number">-2</span>d1b698256da | <span class="type">L3</span> agent           | compute01    | nova              | :-)   | <span class="type">UP</span>    | neutron-l3-agent          |</span><br><span class="line">[root@controller01 ~]#</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@compute01</span> <span class="string">~</span>]<span class="comment"># ovs-vsctl show</span></span><br><span class="line"><span class="string">9b2ebb43-8831-4aef-ad3a-f7a91160cd6c</span></span><br><span class="line"><span class="string">Manager</span> <span class="string">&quot;ptcp:6640:127.0.0.1&quot;</span></span><br><span class="line"><span class="attr">is_connected:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">Bridge</span> <span class="string">br-tun</span></span><br><span class="line"><span class="string">Controller</span> <span class="string">&quot;tcp:127.0.0.1:6633&quot;</span></span><br><span class="line">    <span class="attr">is_connected:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">fail_mode:</span> <span class="string">secure</span></span><br><span class="line"><span class="attr">datapath_type:</span> <span class="string">system</span></span><br><span class="line"><span class="string">Port</span> <span class="string">patch-int</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">patch-int</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">patch</span></span><br><span class="line">        <span class="attr">options:</span> &#123;<span class="string">peer=patch-tun</span>&#125;</span><br><span class="line"><span class="string">Port</span> <span class="string">br-tun</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">br-tun</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">internal</span></span><br><span class="line"><span class="string">Bridge</span> <span class="string">br-ex</span></span><br><span class="line"><span class="string">Controller</span> <span class="string">&quot;tcp:127.0.0.1:6633&quot;</span></span><br><span class="line">    <span class="attr">is_connected:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">fail_mode:</span> <span class="string">secure</span></span><br><span class="line"><span class="attr">datapath_type:</span> <span class="string">system</span></span><br><span class="line"><span class="string">Port</span> <span class="string">&quot;ens34&quot;</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">&quot;ens34&quot;</span></span><br><span class="line"><span class="string">Port</span> <span class="string">phy-br-ex</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">phy-br-ex</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">patch</span></span><br><span class="line">        <span class="attr">options:</span> &#123;<span class="string">peer=int-br-ex</span>&#125;</span><br><span class="line"><span class="string">Port</span> <span class="string">br-ex</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">br-ex</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">internal</span></span><br><span class="line"><span class="string">Bridge</span> <span class="string">br-int</span></span><br><span class="line"><span class="string">Controller</span> <span class="string">&quot;tcp:127.0.0.1:6633&quot;</span></span><br><span class="line">    <span class="attr">is_connected:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">fail_mode:</span> <span class="string">secure</span></span><br><span class="line"><span class="attr">datapath_type:</span> <span class="string">system</span></span><br><span class="line"><span class="string">Port</span> <span class="string">patch-tun</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">patch-tun</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">patch</span></span><br><span class="line">        <span class="attr">options:</span> &#123;<span class="string">peer=patch-int</span>&#125;</span><br><span class="line"><span class="string">Port</span> <span class="string">br-int</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">br-int</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">internal</span></span><br><span class="line"><span class="string">Port</span> <span class="string">int-br-ex</span></span><br><span class="line">    <span class="string">Interface</span> <span class="string">int-br-ex</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">patch</span></span><br><span class="line">        <span class="attr">options:</span> &#123;<span class="string">peer=phy-br-ex</span>&#125;</span><br><span class="line"><span class="attr">ovs_version:</span> <span class="string">&quot;2.12.0&quot;</span></span><br></pre></td></tr></table></figure></div>

<h1 id="十、Horazion仪表盘集群部署"><a href="#十、Horazion仪表盘集群部署" class="headerlink" title="十、Horazion仪表盘集群部署"></a>十、Horazion仪表盘集群部署</h1><ul>
<li>OpenStack仪表板Dashboard服务的项目名称是Horizon，它所需的唯一服务是身份服务keystone，开发语言是python的web框架Django。</li>
<li>仪表盘使得通过OpenStack API与OpenStack计算云控制器进行基于web的交互成为可能。</li>
<li>Horizon 允许自定义仪表板的商标；并提供了一套内核类和可重复使用的模板及工具。</li>
</ul>
<p><strong>安装Train版本的Horizon有以下要求</strong></p>
<blockquote>
<p>Python 2.7、3.6或3.7</p>
<p> Django 1.11、2.0和2.2</p>
<p> Django 2.0和2.2支持在Train版本中处于试验阶段</p>
<p> Ussuri发行版（Train发行版之后的下一个发行版）将使用Django 2.2作为主要的Django版本。Django 2.0支持将被删除。</p>
</blockquote>
<h2 id="安装dashboard"><a href="#安装dashboard" class="headerlink" title="安装dashboard"></a>安装dashboard</h2><p>在全部控制节点安装dashboard服务，以controller01节点为例</p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>openstack-dashboard memcached python-memcached -y</span><br></pre></td></tr></table></figure></div>

<h2 id="配置local-settings"><a href="#配置local-settings" class="headerlink" title="配置local_settings"></a>配置local_settings</h2><p><a class="link"   target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://blog.csdn.net/u011521019/article/details/51237068" >OpenStack Horizon 参数设置说明 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>在全部控制节点操作；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件/etc/openstack-dashboard/local_settings</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/openstack-dashboard/local_settings&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/openstack-dashboard/local_settings.bak &gt; /etc/openstack-dashboard/local_settings</span><br></pre></td></tr></table></figure></div>

<p>添加或者修改以下配置：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定在网络服务器中配置仪表板的访问位置;默认值: &quot;/&quot;</span></span><br><span class="line">WEBROOT = <span class="string">&#x27;/dashboard/&#x27;</span></span><br><span class="line"><span class="comment"># 配置仪表盘在controller节点上使用OpenStack服务</span></span><br><span class="line">OPENSTACK_HOST = <span class="string">&quot;10.10.10.10&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许主机访问仪表板,接受所有主机,不安全不应在生产中使用</span></span><br><span class="line">ALLOWED_HOSTS = [<span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>]</span><br><span class="line"><span class="comment">#ALLOWED_HOSTS = [&#x27;one.example.com&#x27;, &#x27;two.example.com&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置memcached会话存储服务</span></span><br><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.cache&#x27;</span></span><br><span class="line">CACHES = &#123;</span><br><span class="line"><span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line"> <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.core.cache.backends.memcached.MemcachedCache&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;LOCATION&#x27;</span>: <span class="string">&#x27;controller01:11211,controller02:11211,controller03:11211&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用身份API版本3</span></span><br><span class="line">OPENSTACK_KEYSTONE_URL = <span class="string">&quot;http://%s:5000/v3&quot;</span> % OPENSTACK_HOST</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用对域的支持</span></span><br><span class="line">OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置API版本</span></span><br><span class="line">OPENSTACK_API_VERSIONS = &#123;</span><br><span class="line"><span class="string">&quot;identity&quot;</span>: <span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;image&quot;</span>: <span class="number">2</span>,</span><br><span class="line"><span class="string">&quot;volume&quot;</span>: <span class="number">3</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Default为通过仪表板创建的用户的默认域</span></span><br><span class="line">OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = <span class="string">&quot;Default&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置user为通过仪表板创建的用户的默认角色</span></span><br><span class="line">OPENSTACK_KEYSTONE_DEFAULT_ROLE = <span class="string">&quot;user&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果选择网络选项1，请禁用对第3层网络服务的支持,如果选择网络选项2,则可以打开</span></span><br><span class="line">OPENSTACK_NEUTRON_NETWORK = &#123;</span><br><span class="line"><span class="comment">#自动分配的网络</span></span><br><span class="line"><span class="string">&#x27;enable_auto_allocated_network&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"><span class="comment">#Neutron分布式虚拟路由器（DVR）</span></span><br><span class="line"><span class="string">&#x27;enable_distributed_router&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"><span class="comment">#FIP拓扑检查</span></span><br><span class="line"><span class="string">&#x27;enable_fip_topology_check&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"><span class="comment">#高可用路由器模式</span></span><br><span class="line"><span class="string">&#x27;enable_ha_router&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"><span class="comment">#下面三个已过时,不用过多了解,官方文档配置中是关闭的</span></span><br><span class="line"><span class="string">&#x27;enable_lb&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"><span class="string">&#x27;enable_firewall&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"><span class="string">&#x27;enable_vpn&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"><span class="comment">#ipv6网络</span></span><br><span class="line"><span class="string">&#x27;enable_ipv6&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"><span class="comment">#Neutron配额功能</span></span><br><span class="line"><span class="string">&#x27;enable_quotas&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"><span class="comment">#rbac政策</span></span><br><span class="line"><span class="string">&#x27;enable_rbac_policy&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"><span class="comment">#路由器的菜单和浮动IP功能,Neutron部署中有三层功能的支持;可以打开</span></span><br><span class="line"><span class="string">&#x27;enable_router&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"><span class="comment">#默认的DNS名称服务器</span></span><br><span class="line"><span class="string">&#x27;default_dns_nameservers&#x27;</span>: [],</span><br><span class="line"><span class="comment">#网络支持的提供者类型,在创建网络时，该列表中的网络类型可供选择</span></span><br><span class="line"><span class="string">&#x27;supported_provider_types&#x27;</span>: [<span class="string">&#x27;*&#x27;</span>],</span><br><span class="line"><span class="comment">#使用与提供网络ID范围,仅涉及到VLAN，GRE，和VXLAN网络类型</span></span><br><span class="line"><span class="string">&#x27;segmentation_id_range&#x27;</span>: &#123;&#125;,</span><br><span class="line"><span class="comment">#使用与提供网络类型</span></span><br><span class="line"><span class="string">&#x27;extra_provider_types&#x27;</span>: &#123;&#125;,</span><br><span class="line"><span class="comment">#支持的vnic类型,用于与端口绑定扩展</span></span><br><span class="line"><span class="string">&#x27;supported_vnic_types&#x27;</span>: [<span class="string">&#x27;*&#x27;</span>],</span><br><span class="line"><span class="comment">#物理网络</span></span><br><span class="line"><span class="string">&#x27;physical_networks&#x27;</span>: [],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置时区为亚洲上海</span></span><br><span class="line">TIME_ZONE = <span class="string">&quot;Asia/Shanghai&quot;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>其中的中文注释最好不要写入配置文件</li>
</ul>
<p>修改好的 &#x2F;etc&#x2F;openstack-dashboard&#x2F;local_settings 参考：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> ugettext_lazy <span class="keyword">as</span> _</span><br><span class="line"><span class="keyword">from</span> openstack_dashboard.settings <span class="keyword">import</span> HORIZON_CONFIG</span><br><span class="line">DEBUG = <span class="literal">False</span></span><br><span class="line">ALLOWED_HOSTS = [<span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>]</span><br><span class="line">LOCAL_PATH = <span class="string">&#x27;/tmp&#x27;</span></span><br><span class="line">WEBROOT = <span class="string">&#x27;/dashboard/&#x27;</span></span><br><span class="line">SECRET_KEY=<span class="string">&#x27;00be7c741571a0ea5a64&#x27;</span></span><br><span class="line">EMAIL_BACKEND = <span class="string">&#x27;django.core.mail.backends.console.EmailBackend&#x27;</span></span><br><span class="line">OPENSTACK_HOST = <span class="string">&quot;10.10.10.10&quot;</span></span><br><span class="line">OPENSTACK_KEYSTONE_URL = <span class="string">&quot;http://%s:5000/v3&quot;</span> % OPENSTACK_HOST</span><br><span class="line">OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = <span class="literal">True</span></span><br><span class="line">OPENSTACK_NEUTRON_NETWORK = &#123;</span><br><span class="line"><span class="string">&#x27;enable_auto_allocated_network&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"><span class="string">&#x27;enable_distributed_router&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"><span class="string">&#x27;enable_fip_topology_check&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"><span class="string">&#x27;enable_ha_router&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"><span class="string">&#x27;enable_ipv6&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"><span class="string">&#x27;enable_quotas&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"><span class="string">&#x27;enable_rbac_policy&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"><span class="string">&#x27;enable_router&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"><span class="string">&#x27;default_dns_nameservers&#x27;</span>: [],</span><br><span class="line"><span class="string">&#x27;supported_provider_types&#x27;</span>: [<span class="string">&#x27;*&#x27;</span>],</span><br><span class="line"><span class="string">&#x27;segmentation_id_range&#x27;</span>: &#123;&#125;,</span><br><span class="line"><span class="string">&#x27;extra_provider_types&#x27;</span>: &#123;&#125;,</span><br><span class="line"><span class="string">&#x27;supported_vnic_types&#x27;</span>: [<span class="string">&#x27;*&#x27;</span>],</span><br><span class="line"><span class="string">&#x27;physical_networks&#x27;</span>: [],</span><br><span class="line">&#125;</span><br><span class="line">TIME_ZONE = <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">LOGGING = &#123;</span><br><span class="line"><span class="string">&#x27;version&#x27;</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">&#x27;disable_existing_loggers&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"><span class="string">&#x27;formatters&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;console&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(levelname)s %(name)s %(message)s&#x27;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;operation&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(message)s&#x27;</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;handlers&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;null&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.NullHandler&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;console&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span> <span class="keyword">if</span> DEBUG <span class="keyword">else</span> <span class="string">&#x27;INFO&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.StreamHandler&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;console&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;operation&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;INFO&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.StreamHandler&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;operation&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;loggers&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;horizon&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;horizon.operation_log&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;operation&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;INFO&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;openstack_dashboard&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;novaclient&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;cinderclient&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;keystoneauth&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;keystoneclient&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;glanceclient&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;neutronclient&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;swiftclient&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;oslo_policy&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;openstack_auth&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;django&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;django.db.backends&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;null&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;requests&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;null&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;urllib3&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;null&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;chardet.charsetprober&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;null&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;iso8601&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;null&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;scss&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;null&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">SECURITY_GROUP_RULES = &#123;</span><br><span class="line"><span class="string">&#x27;all_tcp&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: _(<span class="string">&#x27;All TCP&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;65535&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;all_udp&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: _(<span class="string">&#x27;All UDP&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;udp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;65535&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;all_icmp&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: _(<span class="string">&#x27;All ICMP&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;icmp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;-1&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;-1&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;ssh&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;SSH&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;22&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;22&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;smtp&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;SMTP&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;25&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;25&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;dns&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;DNS&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;53&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;53&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;http&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;HTTP&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;80&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;80&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;pop3&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;POP3&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;110&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;110&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;imap&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;IMAP&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;143&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;143&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;ldap&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;LDAP&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;389&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;389&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;https&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;HTTPS&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;443&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;443&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;smtps&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;SMTPS&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;465&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;465&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;imaps&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;IMAPS&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;993&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;993&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;pop3s&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;POP3S&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;995&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;995&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;ms_sql&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;MS SQL&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;1433&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;1433&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;mysql&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;MYSQL&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&#x27;rdp&#x27;</span>: &#123;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;RDP&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;ip_protocol&#x27;</span>: <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;from_port&#x27;</span>: <span class="string">&#x27;3389&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;to_port&#x27;</span>: <span class="string">&#x27;3389&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.cache&#x27;</span></span><br><span class="line">CACHES = &#123;</span><br><span class="line"><span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line"> <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.core.cache.backends.memcached.MemcachedCache&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;LOCATION&#x27;</span>: <span class="string">&#x27;controller01:11211,controller02:11211,controller03:11211&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">OPENSTACK_API_VERSIONS = &#123;</span><br><span class="line"><span class="string">&quot;identity&quot;</span>: <span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;image&quot;</span>: <span class="number">2</span>,</span><br><span class="line"><span class="string">&quot;volume&quot;</span>: <span class="number">3</span>,</span><br><span class="line">&#125;</span><br><span class="line">OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = <span class="string">&quot;Default&quot;</span></span><br><span class="line">OPENSTACK_KEYSTONE_DEFAULT_ROLE = <span class="string">&quot;user&quot;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="配置openstack-dashboard-conf"><a href="#配置openstack-dashboard-conf" class="headerlink" title="配置openstack-dashboard.conf"></a>配置openstack-dashboard.conf</h2><p>在全部控制节点操作；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /etc/httpd/conf.d/openstack-dashboard.conf&#123;,.bak&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#建立策略文件（policy.json）的软链接，否则登录到dashboard将出现权限错误和显示混乱</span></span><br><span class="line"><span class="built_in">ln</span> -s /etc/openstack-dashboard /usr/share/openstack-dashboard/openstack_dashboard/conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#赋权，在第3行后新增 WSGIApplicationGroup %&#123;GLOBAL&#125;</span></span><br><span class="line">sed -i <span class="string">&#x27;3a WSGIApplicationGroup\ %&#123;GLOBAL&#125;&#x27;</span> /etc/httpd/conf.d/openstack-dashboard.conf</span><br></pre></td></tr></table></figure></div>

<p>最终：&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;openstack-dashboard.conf</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line"></span><br><span class="line">ServerAdmin webmaster@openstack.org</span><br><span class="line">ServerName  openstack_dashboard</span><br><span class="line"></span><br><span class="line">DocumentRoot /usr/share/openstack-dashboard/</span><br><span class="line"></span><br><span class="line">LogLevel warn</span><br><span class="line">ErrorLog /var/log/httpd/openstack_dashboard-error.log</span><br><span class="line">CustomLog /var/log/httpd/openstack_dashboard-access.log combined</span><br><span class="line"></span><br><span class="line">WSGIScriptReloading On</span><br><span class="line">WSGIDaemonProcess openstack_dashboard_website processes=3</span><br><span class="line">WSGIProcessGroup openstack_dashboard_website</span><br><span class="line">WSGIApplicationGroup %&#123;GLOBAL&#125;</span><br><span class="line">WSGIPassAuthorization On</span><br><span class="line"></span><br><span class="line">WSGIScriptAlias /dashboard /usr/share/openstack-dashboard/openstack_dashboard/wsgi/django.wsgi</span><br><span class="line"></span><br><span class="line">&lt;Location <span class="string">&quot;/&quot;</span>&gt;</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Location&gt;</span><br><span class="line">Alias /dashboard/static /usr/share/openstack-dashboard/static</span><br><span class="line">&lt;Location <span class="string">&quot;/static&quot;</span>&gt;</span><br><span class="line">SetHandler None</span><br><span class="line">&lt;/Location&gt;</span><br><span class="line">&lt;/Virtualhost&gt;</span><br></pre></td></tr></table></figure></div>

<h2 id="重启apache和memcache"><a href="#重启apache和memcache" class="headerlink" title="重启apache和memcache"></a>重启apache和memcache</h2><p>在全部控制节点操作；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd.service memcached.service</span><br><span class="line">systemctl <span class="built_in">enable</span> httpd.service memcached.service</span><br><span class="line">systemctl status httpd.service memcached.service</span><br></pre></td></tr></table></figure></div>

<h2 id="验证访问"><a href="#验证访问" class="headerlink" title="验证访问"></a>验证访问</h2><p>地址： <a class="link"   target="_blank" rel="noopener" href="http://10.10.10.10/dashboard" >http://10.10.10.10/dashboard <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>域&#x2F;账号&#x2F;密码：default&#x2F;admin&#x2F;123456，或：default&#x2F;demo&#x2F;123456</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091117888.png"
                      alt="image-20211109111725049"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091118274.png"
                      alt="image-20211109111856008"
                ></p>
<h1 id="十一、创建虚拟网络并启动实例操作"><a href="#十一、创建虚拟网络并启动实例操作" class="headerlink" title="十一、创建虚拟网络并启动实例操作"></a>十一、创建虚拟网络并启动实例操作</h1><h2 id="创建external外部网络"><a href="#创建external外部网络" class="headerlink" title="创建external外部网络"></a>创建external外部网络</h2><p>只能admin管理员操作，可添加多个外部网络；</p>
<p>为了验证访问外部网络的功能，需要先在 vmware 中把VMnet2设置为NAT模式，前面已提到过</p>
<p>管理员—网络—创建网络</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091126128.png"
                      alt="image-20211109112621868"
                ></p>
<ul>
<li>物理网络对应前面配置：openstack-config –set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini ml2_type_flat flat_networks external</li>
<li>需要勾选外部网络</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091127965.png"
                      alt="image-20211109112745902"
                ></p>
<ul>
<li>因为前面配置：openstack-config –set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini linux_bridge physical_interface_mappings external:ens34,vlan:ens36，external 对应物理网卡 ens34，所以这里的真实网络地址为：10.10.20.0&#x2F;24</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091129875.png"
                      alt="image-20211109112955005"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091130586.png"
                      alt="image-20211109113021565"
                ></p>
<h2 id="创建路由"><a href="#创建路由" class="headerlink" title="创建路由"></a>创建路由</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111232105683.png"
                      alt="image-20211123210504585"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111232105260.png"
                      alt="image-20211123210533358"
                ></p>
<ul>
<li>可以不选择外部网络（这样的路由器只用于不同vpc之间的连通）</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091503134.png"
                      alt="image-20211109150324241"
                ></p>
<p>路由已连接的外部网络</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091504744.png"
                      alt="image-20211109150420354"
                ></p>
<h2 id="创建安全组"><a href="#创建安全组" class="headerlink" title="创建安全组"></a>创建安全组</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091505254.png"
                      alt="image-20211109150534153"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091506606.png"
                      alt="image-20211109150603513"
                ></p>
<ul>
<li>放行所有出口流量</li>
<li>放行所有同安全组的入口流量</li>
<li>放行外部22、icmp的入口流量</li>
</ul>
<h2 id="创建实例类型"><a href="#创建实例类型" class="headerlink" title="创建实例类型"></a>创建实例类型</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091132698.png"
                      alt="image-20211109113227671"
                ></p>
<ul>
<li>注意Swap磁盘会占用计算节点本地磁盘，即使后面对接了分布式存储ceph，所以你会发现大多数公有云厂商swap默认就是关闭的</li>
<li>对接ceph后根磁盘大小就由创建实例指定的卷大小决定了</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091132077.png"
                      alt="image-20211109113247035"
                ></p>
<h2 id="创建vpc网络"><a href="#创建vpc网络" class="headerlink" title="创建vpc网络"></a>创建vpc网络</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091512662.png"
                      alt="image-20211109151201332"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091512631.png"
                      alt="image-20211109151234550"
                ></p>
<ul>
<li>网络地址自行规划，因为创建的是私网地址</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091513134.png"
                      alt="image-20211109151319968"
                ></p>
<ul>
<li>dns 服务器一般为外部网络的网关即可</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091515544.png"
                      alt="image-20211109151522617"
                ></p>
<p>把 vpc 网络连接到路由器，以便访问外部网络</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091516373.png"
                      alt="image-20211109151626939"
                ></p>
<ul>
<li>IP地址设置为VPC子网的网关IP</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091520498.png"
                      alt="image-20211109151959542"
                ></p>
<h2 id="创建实例"><a href="#创建实例" class="headerlink" title="创建实例"></a>创建实例</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091521987.png"
                      alt="image-20211109152123549"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091521093.png"
                      alt="image-20211109152141132"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091521908.png"
                      alt="image-20211109152158133"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091522735.png"
                      alt="image-20211109152215682"
                ></p>
<ul>
<li>选择 vpc，这里其实可以直接选择 EXT 外部网络，让每个实例分配外部网络IP，直接访问外部网络，但是因为我们外部网络只在3个控制节点存在，如果这里使用 EXT 网络，会报错：ERROR nova.compute.manager [instance: a8847440-8fb9-48ca-a530-4258bd623dce] PortBindingFailed: Binding failed for port f0687181-4539-4096-b09e-0cfdeab000af, please check neutron logs for more information.（计算节点日志 &#x2F;var&#x2F;log&#x2F;nova&#x2F;nova-compute.log）</li>
<li>当某个vpc的子网中有两个（或以上）个网段时，创建虚拟机时，quantum会从默认的子网段（一般为最新创建的子网段）中获取IP地址，绑定新创建的虚拟机port。但是有的时候想让新创建的虚拟机获得指定的子网段IP地址，不使用默认的IP地址段时，则需要设置一下，具体方法自行百度</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091529548.png"
                      alt="image-20211109152926596"
                ></p>
<ul>
<li>使用新建的安全组 group01</li>
</ul>
<p>其他选项卡可以不填</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091530412.png"
                      alt="image-20211109153000484"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091531045.png"
                      alt="image-20211109153124100"
                ></p>
<ul>
<li>默认情况下实例会出错：ImageUnacceptable: Image 1c66cd7e-b6 d9-4e70-a3d4-f73b27a84230 is unacceptable: Image has no associated data。原因是当前glance服务使用的是本地存储镜像，这就会导致三个glance节点只有一个节点上存在镜像，临时解决方法是把 &#x2F;var&#x2F;lib&#x2F;glance&#x2F;images&#x2F; 下所有镜像拷贝到所有glance节点，拷贝完后注意目录授权，最终解决方案是glance使用共享存储（nfs等）、分布式存储（swift、ceph等）</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091545065.png"
                      alt="image-20211109154514811"
                ></p>
<ul>
<li>可以通过SNAT访问外网</li>
</ul>
<p>网络拓扑如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091605012.png"
                      alt="image-20211109160511713"
                ></p>
<h2 id="不同vpc内主机之间通信"><a href="#不同vpc内主机之间通信" class="headerlink" title="不同vpc内主机之间通信"></a>不同vpc内主机之间通信</h2><p>不同vpc之间的主机如果需要通信的话只需要把两个 vpc 都连接到相同路由器上面即可</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091642053.png"
                      alt="image-20211109164209916"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091642994.png"
                      alt="image-20211109164239077"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091644604.png"
                      alt="image-20211109164412262"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091647058.png"
                      alt="image-20211109164712087"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091645685.png"
                      alt="image-20211109164527569"
                ></p>
<h2 id="浮动IP"><a href="#浮动IP" class="headerlink" title="浮动IP"></a>浮动IP</h2><p>把 vpc 通过路由器和ext外部网络连接后，虽然实例可以访问外网了，但是外面无法访问进来，这时候需要使用浮动IP功能了。</p>
<p>先申请浮动IP</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091651880.png"
                      alt="image-20211109165145014"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091652719.png"
                      alt="image-20211109165206741"
                ></p>
<p>绑定浮动ip到具体实例</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091652100.png"
                      alt="image-20211109165250271"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091653477.png"
                      alt="image-20211109165331372"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091653300.png"
                      alt="image-20211109165351184"
                ></p>
<p>验证</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091655298.png"
                      alt="image-20211109165507037"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091658537.png"
                      alt="image-20211109165857594"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111091709278.png"
                      alt="image-20211109170924261"
                ></p>
<h1 id="十二、Ceph集群部署"><a href="#十二、Ceph集群部署" class="headerlink" title="十二、Ceph集群部署"></a>十二、Ceph集群部署</h1><p>基础安装见： <a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/leffss/p/15084093.html" >ceph-deploy 安装 ceph - leffss - 博客园 (cnblogs.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h1 id="十三、Cinder部署"><a href="#十三、Cinder部署" class="headerlink" title="十三、Cinder部署"></a>十三、Cinder部署</h1><p>Cinder的核心功能是对卷的管理，允许对卷、卷的类型、卷的快照、卷备份进行处理。它为后端不同的存储设备提供给了统一的接口，不同的块设备服务厂商在Cinder中实现其驱动，可以被Openstack整合管理，nova与cinder的工作原理类似。支持多种 back-end（后端）存储方式，包括 LVM，NFS，Ceph 和其他诸如 EMC、IBM 等商业存储产品和方案。</p>
<p><strong>Cinder各组件功能</strong></p>
<ul>
<li><strong>Cinder-api</strong> 是 cinder 服务的 endpoint，提供 rest 接口，负责处理 client 请求，并将 RPC 请求发送至 cinder-scheduler 组件。</li>
<li><strong>Cinder-scheduler</strong> 负责 cinder 请求调度，其核心部分就是 scheduler_driver, 作为 scheduler manager 的 driver，负责 cinder-volume 具体的调度处理，发送 cinder RPC 请求到选择的 cinder-volume。</li>
<li><strong>Cinder-volume</strong> 负责具体的 volume 请求处理，由不同后端存储提供 volume 存储空间。目前各大存储厂商已经积极地将存储产品的 driver 贡献到 cinder 社区</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111101227824.webp"
                      alt="img"
                ></p>
<p>其中Cinder-api与Cinder-scheduler构成控制节点，Cinder-volume 构成存储节点；</p>
<p>在采用ceph或其他商业&#x2F;非商业后端存储时，建议将Cinder-api、Cinder-scheduler与Cinder-volume服务部署在控制节点；</p>
<p>这里由于只有计算节点上能访问 ceph 从 client 网络（Cinder-volume需要访问ceph集群，nova计算节点也需要），所以将Cinder-api、Cinder-scheduler部署在3台控制节点，Cinder-volume部署在2台计算节点；</p>
<h2 id="Cinder控制节点集群部署"><a href="#Cinder控制节点集群部署" class="headerlink" title="Cinder控制节点集群部署"></a>Cinder控制节点集群部署</h2><h3 id="创建cinder数据库"><a href="#创建cinder数据库" class="headerlink" title="创建cinder数据库"></a>创建cinder数据库</h3><p>在任意控制节点创建数据库；</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p123456</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> database cinder;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> cinder.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;cinder&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> cinder.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;cinder&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure></div>

<h3 id="创建cinder相关服务凭证"><a href="#创建cinder相关服务凭证" class="headerlink" title="创建cinder相关服务凭证"></a>创建cinder相关服务凭证</h3><p>在任意控制节点操作，以controller01节点为例；</p>
<p><strong>创建cinder服务用户</strong></p>
<div class="highlight-container" data-rel="Scss"><figure class="iseeu highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source admin-openrc</span><br><span class="line">openstack user create <span class="attr">--domain</span> default <span class="attr">--password</span> <span class="number">123456</span> cinder</span><br></pre></td></tr></table></figure></div>

<p><strong>向cinder用户赋予admin权限</strong></p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add <span class="attr">--project</span> service <span class="attr">--user</span> cinder admin</span><br></pre></td></tr></table></figure></div>

<p><strong>创建cinderv2和cinderv3服务实体</strong></p>
<div class="highlight-container" data-rel="Scss"><figure class="iseeu highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cinder服务实体类型 &quot;volume&quot;</span><br><span class="line"></span><br><span class="line">openstack service create <span class="attr">--name</span> cinderv2 <span class="attr">--description</span> &quot;OpenStack Block Storage&quot; volumev2</span><br><span class="line">openstack service create <span class="attr">--name</span> cinderv3 <span class="attr">--description</span> &quot;OpenStack Block Storage&quot; volumev3</span><br></pre></td></tr></table></figure></div>

<p><strong>创建块存储服务API端点</strong></p>
<ul>
<li>块存储服务需要每个服务实体的端点</li>
<li>cinder-api后缀为用户project-id，可通过 <code>openstack project list</code> 查看</li>
</ul>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># v2</span></span><br><span class="line">openstack endpoint create --region RegionOne volumev2 <span class="keyword">public</span> http:<span class="comment">//10.10.10.10:8776/v2/%\(project_id\)s</span></span><br><span class="line">openstack endpoint create --region RegionOne volumev2 <span class="keyword">internal</span> http:<span class="comment">//10.10.10.10:8776/v2/%\(project_id\)s</span></span><br><span class="line">openstack endpoint create --region RegionOne volumev2 admin http:<span class="comment">//10.10.10.10:8776/v2/%\(project_id\)s</span></span><br><span class="line"><span class="meta"># v3</span></span><br><span class="line">openstack endpoint create --region RegionOne volumev3 <span class="keyword">public</span> http:<span class="comment">//10.10.10.10:8776/v3/%\(project_id\)s</span></span><br><span class="line">openstack endpoint create --region RegionOne volumev3 <span class="keyword">internal</span> http:<span class="comment">//10.10.10.10:8776/v3/%\(project_id\)s</span></span><br><span class="line">openstack endpoint create --region RegionOne volumev3 admin http:<span class="comment">//10.10.10.10:8776/v3/%\(project_id\)s</span></span><br></pre></td></tr></table></figure></div>

<h3 id="部署与配置cinder"><a href="#部署与配置cinder" class="headerlink" title="部署与配置cinder"></a>部署与配置cinder</h3><p><strong>安装cinder</strong></p>
<p>在全部控制节点安装cinder服务，以controller01节点为例</p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>openstack-cinder -y</span><br></pre></td></tr></table></figure></div>

<p><strong>配置cinder.conf</strong></p>
<p>在全部控制节点操作，以controller01节点为例；注意 <code>my_ip</code> 参数，根据节点修改；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件/etc/cinder/cinder.conf</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/cinder/cinder.conf&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;^$|#&#x27;</span> /etc/cinder/cinder.conf.bak &gt; /etc/cinder/cinder.conf</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf DEFAULT my_ip 10.10.10.31</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf DEFAULT auth_strategy keystone</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf DEFAULT glance_api_servers http://10.10.10.10:9292</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf DEFAULT osapi_volume_listen <span class="string">&#x27;$my_ip&#x27;</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf DEFAULT osapi_volume_listen_port 8776</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf DEFAULT log_dir /var/log/cinder</span><br><span class="line"><span class="comment">#直接连接rabbitmq集群</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf DEFAULT transport_url rabbit://openstack:123456@controller01:5672,openstack:123456@controller02:5672,openstack:123456@controller03:5672</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  database connection mysql+pymysql://cinder:123456@10.10.10.10/cinder</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken  www_authenticate_uri  http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken  auth_url  http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken  memcached_servers  controller01:11211,controller02:11211,controller03:11211</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken  auth_type  password</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken  project_domain_name  default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken  user_domain_name  default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken  project_name  service</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken  username  cinder</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken  password 123456</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  oslo_concurrency  lock_path  /var/lib/cinder/tmp</span><br></pre></td></tr></table></figure></div>

<p><strong>配置nova.conf使用块存储</strong></p>
<p>在全部控制节点操作，以controller01节点为例；</p>
<p>配置只涉及nova.conf的 <code>[cinder]</code> 字段；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf cinder os_region_name RegionOne</span><br></pre></td></tr></table></figure></div>

<h3 id="初始化cinder数据库"><a href="#初始化cinder数据库" class="headerlink" title="初始化cinder数据库"></a>初始化cinder数据库</h3><p>任意控制节点操作；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c <span class="string">&quot;cinder-manage db sync&quot;</span> cinder</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">mysql -ucinder -p123456 -e <span class="string">&quot;use cinder;show tables;&quot;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="启动服务-4"><a href="#启动服务-4" class="headerlink" title="启动服务"></a>启动服务</h3><p>全部控制节点操作；修改了nova配置文件，首先需要重启nova服务</p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openstack-nova-api.service &amp;&amp; systemctl status openstack-nova-api.service</span><br><span class="line"></span><br><span class="line">systemctl enable openstack-cinder-api.service openstack-cinder-<span class="keyword">scheduler.service</span></span><br><span class="line"><span class="keyword"></span>systemctl restart openstack-cinder-api.service openstack-cinder-<span class="keyword">scheduler.service</span></span><br><span class="line"><span class="keyword"></span>systemctl status openstack-cinder-api.service openstack-cinder-<span class="keyword">scheduler.service</span></span><br></pre></td></tr></table></figure></div>

<h3 id="控制节点验证"><a href="#控制节点验证" class="headerlink" title="控制节点验证"></a>控制节点验证</h3><div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$ </span>source admin-openrc</span><br><span class="line"><span class="string">$ </span>openstack volume service list</span><br><span class="line">+------------------+--------------+------+---------+-------+----------------------------+</span><br><span class="line">| <span class="type">Binary</span>           | <span class="type">Host</span>         | <span class="type">Zone</span> | <span class="type">Status</span>  | <span class="type">State</span> | <span class="type">Updated</span> <span class="type">At</span>                 |</span><br><span class="line">+------------------+--------------+------+---------+-------+----------------------------+</span><br><span class="line">| cinder-scheduler | controller01 | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T04:<span class="number">47</span>:<span class="number">23.000000</span> |</span><br><span class="line">| cinder-scheduler | controller02 | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T04:<span class="number">47</span>:<span class="number">27.000000</span> |</span><br><span class="line">| cinder-scheduler | controller03 | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T04:<span class="number">47</span>:<span class="number">29.000000</span> |</span><br><span class="line">+------------------+--------------+------+---------+-------+----------------------------+</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111101249333.png"
                      alt="image-20211110124902225"
                ></p>
<h2 id="Cinder存储节点集群部署"><a href="#Cinder存储节点集群部署" class="headerlink" title="Cinder存储节点集群部署"></a>Cinder存储节点集群部署</h2><h3 id="Openstack的存储面临的问题"><a href="#Openstack的存储面临的问题" class="headerlink" title="Openstack的存储面临的问题"></a>Openstack的存储面临的问题</h3><p><a class="link"   target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://docs.openstack.org/arch-design/" >https://docs.openstack.org/arch-design/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><strong>企业上线openstack，必须要思考和解决三方面的难题:</strong></p>
<ol>
<li>控制集群的高可用和负载均衡，保障集群没有单点故障，持续可用，</li>
<li>网络的规划和neutron L3的高可用和负载均衡，</li>
<li>存储的高可用性和性能问题。</li>
</ol>
<p><strong>存储openstack中的痛点与难点之一</strong></p>
<p>在上线和运维中，值得考虑和规划的重要点，openstack支持各种存储，包括分布式的文件系统，常见的有: <code>ceph,glusterfs和sheepdog</code>，同时也支持商业的FC存储，如 <code>IBM,EMC,NetApp和huawei</code> 的专业存储设备，一方面能够满足企业的利旧和资源的统一管理。</p>
<p><strong>Ceph概述</strong></p>
<p>ceph作为近年来呼声最高的统一存储，在云环境下适应而生，ceph成就了openstack和cloudstack这类的开源的平台方案，同时openstack的快速发展，也吸引了越来越多的人参与到ceph的研究中来。ceph在整个社区的活跃度越来越高，越来越多的企业，使用ceph做为openstack的 <code>glance，nova，cinder</code> 的存储。</p>
<p><strong>ceph是一种统一的分布式文件系统；能够支持三种常用的接口:</strong></p>
<ol>
<li>对象存储接口，兼容于S3，用于存储结构化的数据，如图片，视频，音频等文件，其他对象存储有: <code>S3,Swift,FastDFS</code> 等；</li>
<li>文件系统接口，通过 <code>cephfs</code> 来完成，能够实现类似于nfs的挂载文件系统，需要由MDS来完成，类似的文件系存储有: <code>nfs,samba,glusterfs</code> 等；</li>
<li>块存储，通过rbd实现，专门用于存储云环境下块设备，如openstack的cinder卷存储，这也是目前ceph应用最广泛的地方。</li>
</ol>
<h3 id="安装cinder"><a href="#安装cinder" class="headerlink" title="安装cinder"></a>安装cinder</h3><p>在全部计算点安装；</p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>openstack-cinder targetcli python2-keystone -y</span><br></pre></td></tr></table></figure></div>

<h3 id="配置cinder-conf"><a href="#配置cinder-conf" class="headerlink" title="配置cinder.conf"></a>配置cinder.conf</h3><p>在全部计算点配置；注意 <code>my_ip</code> 参数，根据节点修改；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份配置文件/etc/cinder/cinder.conf</span></span><br><span class="line"><span class="built_in">cp</span> -a /etc/cinder/cinder.conf&#123;,.bak&#125;</span><br><span class="line">grep -Ev <span class="string">&#x27;#|^$&#x27;</span> /etc/cinder/cinder.conf.bak&gt;/etc/cinder/cinder.conf</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  DEFAULT transport_url rabbit://openstack:123456@controller01:5672,openstack:123456@controller02:5672,openstack:123456@controller03:5672</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  DEFAULT auth_strategy keystone</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  DEFAULT my_ip 10.10.10.41</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  DEFAULT glance_api_servers http://10.10.10.10:9292</span><br><span class="line"><span class="comment">#openstack-config --set /etc/cinder/cinder.conf  DEFAULT enabled_backends lvm</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  DEFAULT enabled_backends ceph</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  database connection mysql+pymysql://cinder:123456@10.10.10.10/cinder</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken www_authenticate_uri http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken auth_url http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken memcached_servers controller01:11211,controller02:11211,controller03:11211</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken auth_type password</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken project_domain_name default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken user_domain_name default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken project_name service</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken username cinder</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  keystone_authtoken password 123456</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf  oslo_concurrency lock_path /var/lib/cinder/tmp</span><br></pre></td></tr></table></figure></div>

<h3 id="启动服务-5"><a href="#启动服务-5" class="headerlink" title="启动服务"></a>启动服务</h3><p>全部计算节点操作；</p>
<div class="highlight-container" data-rel="Cmake"><figure class="iseeu highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openstack-cinder-volume.service <span class="keyword">target</span>.service</span><br><span class="line">systemctl enable openstack-cinder-volume.service <span class="keyword">target</span>.service</span><br><span class="line">systemctl status openstack-cinder-volume.service <span class="keyword">target</span>.service</span><br></pre></td></tr></table></figure></div>

<h3 id="在控制节点进行验证"><a href="#在控制节点进行验证" class="headerlink" title="在控制节点进行验证"></a>在控制节点进行验证</h3><div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$ </span>source admin-openrc</span><br><span class="line"><span class="string">$ </span>openstack volume service list</span><br><span class="line">+------------------+----------------+------+---------+-------+----------------------------+</span><br><span class="line">| <span class="type">Binary</span>           | <span class="type">Host</span>           | <span class="type">Zone</span> | <span class="type">Status</span>  | <span class="type">State</span> | <span class="type">Updated</span> <span class="type">At</span>                 |</span><br><span class="line">+------------------+----------------+------+---------+-------+----------------------------+</span><br><span class="line">| cinder-scheduler | controller01   | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T05:<span class="number">04</span>:<span class="number">24.000000</span> |</span><br><span class="line">| cinder-scheduler | controller02   | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T05:<span class="number">04</span>:<span class="number">27.000000</span> |</span><br><span class="line">| cinder-scheduler | controller03   | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T05:<span class="number">04</span>:<span class="number">20.000000</span> |</span><br><span class="line">| cinder-volume    | compute01@ceph | nova | enabled | down  | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T05:<span class="number">01</span>:<span class="number">08.000000</span> |</span><br><span class="line">| cinder-volume    | compute02@ceph | nova | enabled | down  | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T05:<span class="number">01</span>:<span class="number">10.000000</span> |</span><br><span class="line">+------------------+----------------+------+---------+-------+----------------------------+</span><br></pre></td></tr></table></figure></div>

<ul>
<li>默认情况下 2 个cinder-volume的state状态是down的，原因是此时后端存储服务为ceph，但ceph相关服务尚未启用并集成到cinder-volume</li>
</ul>
<h1 id="十四、对接Ceph存储"><a href="#十四、对接Ceph存储" class="headerlink" title="十四、对接Ceph存储"></a>十四、对接Ceph存储</h1><p>OpenStack 使用 Ceph 作为后端存储可以带来以下好处：</p>
<ul>
<li>不需要购买昂贵的商业存储设备，降低 OpenStack 的部署成本</li>
<li>Ceph 同时提供了块存储、文件系统和对象存储，能够完全满足 OpenStack 的存储类型需求</li>
<li>RBD COW 特性支持快速的并发启动多个 OpenStack 实例</li>
<li>为 OpenStack 实例默认的提供持久化卷</li>
<li>为 OpenStack 卷提供快照、备份以及复制功能</li>
<li>为 Swift 和 S3 对象存储接口提供了兼容的 API 支持</li>
</ul>
<p>在生产环境中，我们经常能够看见将 Nova、Cinder、Glance 与 Ceph RBD 进行对接。除此之外，还可以将 Swift、Manila 分别对接到 Ceph RGW 与 CephFS。Ceph 作为统一存储解决方案，有效降低了 OpenStack 云环境的复杂性与运维成本。</p>
<p>Openstack环境中，数据存储可分为临时性存储与永久性存储。</p>
<p>临时性存储：主要由本地文件系统提供，并主要用于nova虚拟机的本地系统与临时数据盘，以及存储glance上传的系统镜像；</p>
<p>永久性存储：主要由cinder提供的块存储与swift提供的对象存储构成，以cinder提供的块存储应用最为广泛，块存储通常以云盘的形式挂载到虚拟机中使用。</p>
<p>Openstack中需要进行数据存储的三大项目主要是nova项目（虚拟机镜像文件），glance项目（共用模版镜像）与cinder项目（块存储）。</p>
<p>下图为cinder，glance与nova访问ceph集群的逻辑图：</p>
<p>ceph与openstack集成主要用到ceph的rbd服务，ceph底层为rados存储集群，ceph通过librados库实现对底层rados的访问；</p>
<p>openstack各项目客户端调用librbd，再由librbd调用librados访问底层rados；</p>
<p>实际使用中，nova需要使用libvirtdriver驱动以通过libvirt与qemu调用librbd；cinder与glance可直接调用librbd；</p>
<p>写入ceph集群的数据被条带切分成多个object，object通过hash函数映射到pg（构成pg容器池pool），然后pg通过几圈crush算法近似均匀地映射到物理存储设备osd（osd是基于文件系统的物理存储设备，如xfs，ext4等）。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111101309543.webp"
                      alt="img"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111121043328.webp"
                      alt="img"
                ></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://blog.51cto.com/7603402/2433209" >CEPH PG数量设置与详细介绍 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><strong>在创建池之前要设置一下每个OSD的最大PG 数量</strong></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://ceph.com/pgcalc/" >PG PGP官方计算公式计算器 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>参数解释：</p>
<ul>
<li><strong>Target PGs per OSD</strong>：预估每个OSD的PG数，一般取100计算。当预估以后集群OSD数不会增加时，取100计算；当预估以后集群OSD数会增加一倍时，取200计算。</li>
<li>**OSD #**：集群OSD数量。</li>
<li><strong>%Data</strong>：预估该pool占该OSD集群总容量的近似百分比。</li>
<li><strong>Size</strong>：该pool的副本数。</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111101310108.webp"
                      alt="img"
                ></p>
<p>依据参数使用公式计算新的 PG 的数目:</p>
<p>PG 总数&#x3D; ((OSD总数*100)&#x2F;最大副本数)&#x2F;池数</p>
<p><code>3x100/3/3=33.33 ;舍入到2的N次幕为32</code></p>
<p>我们会将三个重要的OpenStack服务：Cinder（块存储）、Glance（镜像）和Nova（虚拟机虚拟磁盘）与Ceph集成。</p>
<h2 id="openstack-集群准备"><a href="#openstack-集群准备" class="headerlink" title="openstack 集群准备"></a>openstack 集群准备</h2><p>openstack集群作为ceph的客户端；下面需要再openstack集群上进行ceph客户端的环境配置</p>
<h3 id="全部节点上添加ceph的yum源"><a href="#全部节点上添加ceph的yum源" class="headerlink" title="全部节点上添加ceph的yum源"></a>全部节点上添加ceph的yum源</h3><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh http://download.ceph.com/rpm-luminous/el7/noarch/ceph-release-1-1.el7.noarch.rpm</span><br><span class="line">sed -i <span class="string">&#x27;s#download.ceph.com#mirrors.aliyun.com/ceph#g&#x27;</span> /etc/yum.repos.d/ceph.repo</span><br></pre></td></tr></table></figure></div>

<ul>
<li>ha 节点可以不需要</li>
</ul>
<h3 id="安装Ceph客户端"><a href="#安装Ceph客户端" class="headerlink" title="安装Ceph客户端"></a>安装Ceph客户端</h3><p>openstack全部节点安装ceph;已配置yum源，直接安装即可；目的是可以在openstack集群使用ceph的命令</p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>ceph -y</span><br></pre></td></tr></table></figure></div>

<p>glance服务所在节点安装python2-rbd</p>
<p><code>glance-api</code> 服务运行在3个控制节点， <strong>因此3台控制节点都必须安装</strong></p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>python-rbd -y</span><br></pre></td></tr></table></figure></div>

<p>cinder-volume与nova-compute服务所在节点安装ceph-common</p>
<p><code>cinder-volume</code> 与 <code>nova-compute</code> 服务运行在2个计算（存储）节点； <strong>因此2台计算节点都必须安装</strong></p>
<div class="highlight-container" data-rel="Armasm"><figure class="iseeu highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">yum</span> install ceph-<span class="meta">common</span> -y</span><br></pre></td></tr></table></figure></div>

<h3 id="需要有ceph的配置文件-ceph集群上操作"><a href="#需要有ceph的配置文件-ceph集群上操作" class="headerlink" title="需要有ceph的配置文件(ceph集群上操作)"></a>需要有ceph的配置文件(ceph集群上操作)</h3><p>将配置文件和密钥复制到openstack集群各节点</p>
<p>配置文件就是生成的ceph.conf；而密钥是 <code>ceph.client.admin.keyring</code>，当使用ceph客户端连接至ceph集群时需要使用的密默认密钥，这里我们所有节点都要复制，命令如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy admin controller01 controller02 controller03 compute01 compute02</span><br></pre></td></tr></table></figure></div>

<ul>
<li>复制后配置文件在 &#x2F;etc&#x2F;ceph 目录下</li>
</ul>
<h2 id="ceph-集群准备"><a href="#ceph-集群准备" class="headerlink" title="ceph 集群准备"></a>ceph 集群准备</h2><h3 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h3><p><strong>※Glance</strong> 作为openstack中镜像服务，支持多种适配器，支持将镜像存放到本地文件系统，http服务器，ceph分布式文件系统，glusterfs和sleepdog等开源的分布式文件系统上。目前glance采用的是本地filesystem的方式存储，存放在默认的路径 <code>/var/lib/glance/images</code> 下，当把本地的文件系统修改为分布式的文件系统ceph之后，原本在系统中镜像将无法使用，所以建议当前的镜像删除，部署好ceph之后，再统一上传至ceph中存储。</p>
<p><strong>※Nova</strong> 负责虚拟机的生命周期管理，包括创建，删除，重建，开机，关机，重启，快照等，作为openstack的核心，nova负责IaaS中计算重要的职责，其中nova的存储格外重要，默认情况下，nova将instance的数据存放在&#x2F;var&#x2F;lib&#x2F;nova&#x2F;instances&#x2F;%UUID目录下，使用本地的存储空间。使用这种方式带来的好处是:简单，易实现，速度快，故障域在一个可控制的范围内。然而，缺点也非常明显：compute出故障，上面的虚拟机down机时间长，没法快速恢复，此外，一些特性如热迁移live-migration,虚拟机容灾nova evacuate等高级特性，将无法使用，对于后期的云平台建设，有明显的缺陷。对接 Ceph 主要是希望将实例的系统磁盘文件储存到 Ceph 集群中。与其说是对接 Nova，更准确来说是对接 QEMU-KVM&#x2F;libvirt，因为 librbd 早已原生集成到其中。</p>
<p><strong>※Cinder</strong> 为 OpenStack 提供卷服务，支持非常广泛的后端存储类型。对接 Ceph 后，Cinder 创建的 Volume 本质就是 Ceph RBD 的块设备，当 Volume 被虚拟机挂载后，Libvirt 会以 rbd 协议的方式使用这些 Disk 设备。除了 cinder-volume 之后，Cinder 的 Backup 服务也可以对接 Ceph，将备份的 Image 以对象或块设备的形式上传到 Ceph 集群。</p>
<h3 id="原理解析"><a href="#原理解析" class="headerlink" title="原理解析"></a>原理解析</h3><p>使用ceph的rbd接口，需要通过libvirt，所以需要在客户端机器上安装libvirt和qemu，关于ceph和openstack结合的结构如下，同时，在openstack中，需要用到存储的地方有三个:</p>
<ol>
<li>glance的镜像，默认的本地存储，路径在 <code>/var/lib/glance/images</code> 目录下，</li>
<li>nova虚拟机存储，默认本地，路径位于 <code>/var/lib/nova/instances</code> 目录下，</li>
<li>cinder存储，默认采用LVM的存储方式。</li>
</ol>
<h3 id="创建pool池"><a href="#创建pool池" class="headerlink" title="创建pool池"></a>创建pool池</h3><p><strong>为 Glance、Nova、Cinder 创建专用的RBD Pools池</strong></p>
<p>需要配置hosts解析文件，这里最开始已经配置完成，如未添加hosts解析需要进行配置</p>
<p><strong>在ceph01管理节点上操作</strong>；命名为：volumes，vms，images，分布给Glance，Nova，Cinder 使用</p>
<p>依据参数使用公式计算新的 PG 的数目，集群中15个 osd，2个副本（默认3个，生产也建议3个），3个池:</p>
<p>PG 总数&#x3D; ((OSD总数*100)&#x2F;最大副本数)&#x2F;池数</p>
<p><code>15x100/2/3=250 ;舍入到2的N次幕为128</code></p>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># ceph默认创建了一个pool池为rbd</span></span><br><span class="line">[<span class="meta">root@ceph01 ~</span>]<span class="meta"># ceph osd lspools</span></span><br><span class="line"><span class="number">1</span> .rgw.root,<span class="number">2</span> <span class="literal">default</span>.rgw.control,<span class="number">3</span> <span class="literal">default</span>.rgw.meta,<span class="number">4</span> <span class="literal">default</span>.rgw.log,</span><br><span class="line">-----------------------------------</span><br><span class="line"></span><br><span class="line"><span class="meta"># 为 Glance、Nova、Cinder 创建专用的 RBD Pools，并格式化</span></span><br><span class="line">ceph osd pool create images <span class="number">128</span> <span class="number">128</span></span><br><span class="line">ceph osd pool create volumes <span class="number">128</span> <span class="number">128</span></span><br><span class="line">ceph osd pool create vms <span class="number">128</span> <span class="number">128</span></span><br><span class="line"></span><br><span class="line">rbd pool <span class="keyword">init</span> images</span><br><span class="line">rbd pool <span class="keyword">init</span> volumes</span><br><span class="line">rbd pool <span class="keyword">init</span> vms</span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line"></span><br><span class="line"><span class="meta"># 查看pool的pg_num和pgp_num大小</span></span><br><span class="line">[<span class="meta">root@ceph01 ~</span>]<span class="meta"># ceph osd pool get vms pg_num</span></span><br><span class="line">pg_num: <span class="number">128</span></span><br><span class="line">[<span class="meta">root@ceph01 ~</span>]<span class="meta"># ceph osd pool get vms pgp_num</span></span><br><span class="line">pgp_num: <span class="number">128</span></span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line"></span><br><span class="line"><span class="meta"># 查看ceph中的pools;忽略之前创建的pool</span></span><br><span class="line">[<span class="meta">root@ceph01 ~</span>]<span class="meta"># ceph osd lspools</span></span><br><span class="line"><span class="number">1</span> .rgw.root,<span class="number">2</span> <span class="literal">default</span>.rgw.control,<span class="number">3</span> <span class="literal">default</span>.rgw.meta,<span class="number">4</span> <span class="literal">default</span>.rgw.log,<span class="number">5</span> images,<span class="number">6</span> volumes,<span class="number">7</span> vms,</span><br><span class="line"></span><br><span class="line">[<span class="meta">root@ceph01 ~</span>]<span class="meta"># ceph osd pool stats</span></span><br><span class="line">...</span><br><span class="line">pool images id <span class="number">5</span></span><br><span class="line">nothing <span class="keyword">is</span> going <span class="keyword">on</span></span><br><span class="line"></span><br><span class="line">pool volumes id <span class="number">6</span></span><br><span class="line">nothing <span class="keyword">is</span> going <span class="keyword">on</span></span><br><span class="line"></span><br><span class="line">pool vms id <span class="number">7</span></span><br><span class="line">nothing <span class="keyword">is</span> going <span class="keyword">on</span></span><br></pre></td></tr></table></figure></div>

<h3 id="ceph授权认证"><a href="#ceph授权认证" class="headerlink" title="ceph授权认证"></a>ceph授权认证</h3><p><strong>在ceph01管理节点上操作</strong>；</p>
<p><strong>通过ceph管理节点为Glance、cinder创建用户</strong></p>
<p>针对pool设置权限，pool名对应创建的pool</p>
<div class="highlight-container" data-rel="Ini"><figure class="iseeu highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@ceph01 ~]</span><span class="comment"># ceph auth get-or-create client.glance mon &#x27;allow r&#x27; osd &#x27;allow class-read object_prefix rbd_children, allow rwx pool=images&#x27;</span></span><br><span class="line"><span class="section">[client.glance]</span></span><br><span class="line"><span class="attr">key</span> = AQCyX4thKE90ERAAw7mrCSGzDip60gZQpoth7g==</span><br><span class="line"></span><br><span class="line"><span class="section">[root@ceph01 ~]</span><span class="comment"># ceph auth get-or-create client.cinder mon &#x27;allow r&#x27; osd &#x27;allow class-read object_prefix rbd_children, allow rwx pool=volumes, allow rwx pool=vms, allow rx pool=images&#x27;</span></span><br><span class="line"><span class="section">[client.cinder]</span></span><br><span class="line"><span class="attr">key</span> = AQC9X4thS8JUKxAApugrXmAkkgHt3NvW/v4lJg==</span><br></pre></td></tr></table></figure></div>

<p><strong>配置openstack节点与ceph的ssh免密连接</strong></p>
<p>前面已配置，省略</p>
<p><strong>推送client.glance和client.cinder秘钥</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将创建client.glance用户生成的秘钥推送到运行glance-api服务的控制节点</span></span><br><span class="line">ceph auth get-or-create client.glance | <span class="built_in">tee</span> /etc/ceph/ceph.client.glance.keyring</span><br><span class="line">[client.glance]</span><br><span class="line">key = AQCyX4thKE90ERAAw7mrCSGzDip60gZQpoth7g==</span><br><span class="line"></span><br><span class="line">ceph auth get-or-create client.glance | ssh root@controller01 <span class="built_in">tee</span> /etc/ceph/ceph.client.glance.keyring</span><br><span class="line">ceph auth get-or-create client.glance | ssh root@controller02 <span class="built_in">tee</span> /etc/ceph/ceph.client.glance.keyring</span><br><span class="line">ceph auth get-or-create client.glance | ssh root@controller03 <span class="built_in">tee</span> /etc/ceph/ceph.client.glance.keyring</span><br><span class="line"></span><br><span class="line"><span class="comment">#同时修改秘钥文件的属主与用户组</span></span><br><span class="line">ssh root@controller01 <span class="built_in">chown</span> glance:glance /etc/ceph/ceph.client.glance.keyring</span><br><span class="line">ssh root@controller02 <span class="built_in">chown</span> glance:glance /etc/ceph/ceph.client.glance.keyring</span><br><span class="line">ssh root@controller03 <span class="built_in">chown</span> glance:glance /etc/ceph/ceph.client.glance.keyring</span><br></pre></td></tr></table></figure></div>

<p><strong>nova-compute与cinder-volume都部署在计算节点</strong>，不必重复操作,如果nova计算节点与cinder存储节点分离则需要分别推送；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将创建client.cinder用户生成的秘钥推送到运行cinder-volume服务的节点</span></span><br><span class="line">ceph auth get-or-create client.cinder | <span class="built_in">tee</span> /etc/ceph/ceph.client.cinder.keyring</span><br><span class="line">[client.cinder]</span><br><span class="line">key = AQC9X4thS8JUKxAApugrXmAkkgHt3NvW/v4lJg==</span><br><span class="line"></span><br><span class="line">ceph auth get-or-create client.cinder | ssh root@compute01 <span class="built_in">tee</span> /etc/ceph/ceph.client.cinder.keyring</span><br><span class="line">ceph auth get-or-create client.cinder | ssh root@compute02 <span class="built_in">tee</span> /etc/ceph/ceph.client.cinder.keyring</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同时修改秘钥文件的属主与用户组</span></span><br><span class="line">ssh root@compute01 <span class="built_in">chown</span> cinder:cinder /etc/ceph/ceph.client.cinder.keyring</span><br><span class="line">ssh root@compute02 <span class="built_in">chown</span> cinder:cinder /etc/ceph/ceph.client.cinder.keyring</span><br></pre></td></tr></table></figure></div>

<h3 id="授权添加到Libvirt守护进程"><a href="#授权添加到Libvirt守护进程" class="headerlink" title="授权添加到Libvirt守护进程"></a>授权添加到Libvirt守护进程</h3><p><strong>在ceph管理节点上为nova节点创建keyring文件</strong></p>
<ul>
<li>nova-compute所在节点需要将client.cinder用户的秘钥文件存储到libvirt中；当基于ceph后端的cinder卷被attach到虚拟机实例时，libvirt需要用到该秘钥以访问ceph集群；</li>
<li>在ceph管理节点向计算（存储）节点推送client.cinder秘钥文件，生成的文件是临时性的，将秘钥添加到libvirt后可删除</li>
</ul>
<div class="highlight-container" data-rel="Vbnet"><figure class="iseeu highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph auth <span class="keyword">get</span>-<span class="keyword">key</span> client.cinder | ssh root@compute01 tee /etc/ceph/client.cinder.<span class="keyword">key</span></span><br><span class="line">ceph auth <span class="keyword">get</span>-<span class="keyword">key</span> client.cinder | ssh root@compute02 tee /etc/ceph/client.cinder.<span class="keyword">key</span></span><br></pre></td></tr></table></figure></div>

<p><strong>在计算节点将秘钥加入libvirt</strong></p>
<p>全部计算节点配置；以compute01节点为例；</p>
<ul>
<li>生成随机 UUID,作为Libvirt秘钥的唯一标识,全部计算节点可共用此uuid;</li>
<li>只需要生成一次，所有的cinder-volume、nova-compute都是用同一个UUID,请保持一致;</li>
</ul>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@compute01 ~</span>]<span class="meta"># uuidgen</span></span><br><span class="line">bae8efd1-e319<span class="number">-48</span>cc<span class="number">-8f</span>d0<span class="number">-9213</span>dd0e3497</span><br><span class="line">[<span class="meta">root@compute01 ~</span>]<span class="meta">#</span></span><br><span class="line"><span class="meta"># 创建Libvirt秘钥文件,修改为生成的uuid</span></span><br><span class="line">[<span class="meta">root@compute01 ~</span>]<span class="meta"># cat &gt;&gt; /etc/ceph/secret.xml &lt;&lt;EOF</span></span><br><span class="line">&lt;secret ephemeral=<span class="string">&#x27;no&#x27;</span> <span class="keyword">private</span>=<span class="string">&#x27;no&#x27;</span>&gt;</span><br><span class="line">&lt;uuid&gt;bae8efd1-e319<span class="number">-48</span>cc<span class="number">-8f</span>d0<span class="number">-9213</span>dd0e3497&lt;/uuid&gt;</span><br><span class="line">&lt;usage type=<span class="string">&#x27;ceph&#x27;</span>&gt;</span><br><span class="line">&lt;name&gt;client.cinder secret&lt;/name&gt;</span><br><span class="line">&lt;/usage&gt;</span><br><span class="line">&lt;/secret&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">scp -rp /etc/ceph/secret.xml compute02:/etc/ceph/</span><br><span class="line"></span><br><span class="line"><span class="meta"># 定义Libvirt秘钥;全部计算节点执行</span></span><br><span class="line">[<span class="meta">root@compute01 ~</span>]<span class="meta"># virsh secret-<span class="keyword">define</span> --file /etc/ceph/secret.xml</span></span><br><span class="line">Secret bae8efd1-e319<span class="number">-48</span>cc<span class="number">-8f</span>d0<span class="number">-9213</span>dd0e3497 created</span><br><span class="line"></span><br><span class="line">[<span class="meta">root@compute02 ~</span>]<span class="meta"># virsh secret-<span class="keyword">define</span> --file /etc/ceph/secret.xml</span></span><br><span class="line">Secret bae8efd1-e319<span class="number">-48</span>cc<span class="number">-8f</span>d0<span class="number">-9213</span>dd0e3497 created</span><br><span class="line"></span><br><span class="line"><span class="meta"># 设置秘钥的值为client.cinder用户的key，Libvirt;凭此key就能以Cinder的用户访问Ceph集群</span></span><br><span class="line">[<span class="meta">root@compute01 ~</span>]<span class="meta"># virsh secret-set-value --secret bae8efd1-e319-48cc-8fd0-9213dd0e3497 --base64 $(cat /etc/ceph/client.cinder.key)</span></span><br><span class="line">Secret <span class="keyword">value</span> <span class="keyword">set</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">root@compute02 ~</span>]<span class="meta"># virsh secret-set-value --secret bae8efd1-e319-48cc-8fd0-9213dd0e3497 --base64 $(cat /etc/ceph/client.cinder.key)</span></span><br><span class="line">Secret <span class="keyword">value</span> <span class="keyword">set</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 查看每台计算节点上的秘钥清单</span></span><br><span class="line">[<span class="meta">root@compute01 ~</span>]<span class="meta"># virsh secret-list</span></span><br><span class="line">UUID                                  Usage</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">bae8efd1-e319<span class="number">-48</span>cc<span class="number">-8f</span>d0<span class="number">-9213</span>dd0e3497  ceph client.cinder secret</span><br><span class="line"></span><br><span class="line">[<span class="meta">root@compute02 ~</span>]<span class="meta"># virsh secret-list</span></span><br><span class="line">UUID                                  Usage</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">bae8efd1-e319<span class="number">-48</span>cc<span class="number">-8f</span>d0<span class="number">-9213</span>dd0e3497  ceph client.cinder secret</span><br></pre></td></tr></table></figure></div>

<h2 id="配置glance集成ceph"><a href="#配置glance集成ceph" class="headerlink" title="配置glance集成ceph"></a>配置glance集成ceph</h2><p>Glance 为 OpenStack 提供镜像及其元数据注册服务，Glance 支持对接多种后端存储。与 Ceph 完成对接后，Glance 上传的 Image 会作为块设备储存在 Ceph 集群中。新版本的 Glance 也开始支持 enabled_backends 了，可以同时对接多个存储提供商。</p>
<p>**写时复制技术(copy-on-write)**：内核只为新生成的子进程创建虚拟空间结构，它们复制于父进程的虚拟空间结构，但是不为这些段分配物理内存，它们共享父进程的物理空间，当父子进程中有更改相应的段的行为发生时，再为子进程相应的段分配物理空间。写时复制技术大大降低了进程对资源的浪费。</p>
<h3 id="配置glance-api-conf-1"><a href="#配置glance-api-conf-1" class="headerlink" title="配置glance-api.conf"></a>配置glance-api.conf</h3><p><strong>全部控制节点进行配置；以controller01节点为例；</strong></p>
<p>只修改涉及glance集成ceph的相关配置</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份glance-api的配置文件;以便于恢复</span></span><br><span class="line"><span class="built_in">cp</span> /etc/glance/glance-api.conf&#123;,.bak2&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除glance-api如下的默认配置</span></span><br><span class="line">[glance_store]</span><br><span class="line">stores = file,http</span><br><span class="line">default_store = file</span><br><span class="line">filesystem_store_datadir = /var/lib/glance/images/</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用映像的写时复制</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf DEFAULT show_image_direct_url True</span><br><span class="line"><span class="comment"># 变更默认使用的本地文件存储为ceph rbd存储</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf glance_store stores rbd</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf glance_store default_store rbd</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf glance_store rbd_store_pool images</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf glance_store rbd_store_user glance</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf glance_store rbd_store_ceph_conf /etc/ceph/ceph.conf</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/glance/glance-api.conf glance_store rbd_store_chunk_size 8</span><br></pre></td></tr></table></figure></div>

<p><strong>变更配置文件，重启服务</strong></p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openstack-glance-api<span class="selector-class">.service</span></span><br><span class="line">lsof -<span class="selector-tag">i</span>:<span class="number">9292</span></span><br></pre></td></tr></table></figure></div>

<h3 id="上传镜像测试"><a href="#上传镜像测试" class="headerlink" title="上传镜像测试"></a>上传镜像测试</h3><p>对接 Ceph 之后，通常会以 RAW 格式创建 Glance Image，而不再使用 QCOW2 格式，否则创建虚拟机时需要进行镜像复制，没有利用 Ceph RBD COW 的优秀特性。</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# ll</span><br><span class="line">total <span class="number">16448</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root      277 Nov  4 16:11 admin-openrc</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root 16338944 Aug 17 14:31 cirros-0.5.1-x86_64-disk.img</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root      269 Nov  4 16:21 demo-openrc</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root   300067 Nov  4 15:43 python2-qpid-proton-0.28.0-1.el7.x86_64.rpm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root   190368 Nov  4 15:43 qpid-proton-c-0.28.0-1.el7.x86_64.rpm</span></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]#</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# qemu<span class="operator">-</span>img info cirros<span class="number">-0.5</span><span class="number">.1</span><span class="operator">-</span>x86_64<span class="operator">-</span>disk.img</span><br><span class="line">image: cirros<span class="number">-0.5</span><span class="number">.1</span><span class="operator">-</span>x86_64<span class="operator">-</span>disk.img</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: <span class="number">112</span>M (<span class="number">117440512</span> bytes)</span><br><span class="line">disk size: <span class="number">16</span>M</span><br><span class="line">cluster_size: <span class="number">65536</span></span><br><span class="line">Format <span class="keyword">specific</span> information:</span><br><span class="line">compat: <span class="number">1.1</span></span><br><span class="line">lazy refcounts: <span class="literal">false</span></span><br><span class="line">refcount bits: <span class="number">16</span></span><br><span class="line">corrupt: <span class="literal">false</span></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]#</span><br><span class="line"></span><br><span class="line"># 将镜像从qcow2格式转换为raw格式</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# qemu<span class="operator">-</span>img <span class="keyword">convert</span> <span class="operator">-</span>f qcow2 <span class="operator">-</span>O raw cirros<span class="number">-0.5</span><span class="number">.1</span><span class="operator">-</span>x86_64<span class="operator">-</span>disk.img  cirros<span class="number">-0.5</span><span class="number">.1</span><span class="operator">-</span>x86_64<span class="operator">-</span>disk.raw</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# ls <span class="operator">-</span>l</span><br><span class="line">total <span class="number">33504</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root       277 Nov  4 16:11 admin-openrc</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root  16338944 Aug 17 14:31 cirros-0.5.1-x86_64-disk.img</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root 117440512 Nov 10 19:11 cirros-0.5.1-x86_64-disk.raw</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root       269 Nov  4 16:21 demo-openrc</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root    300067 Nov  4 15:43 python2-qpid-proton-0.28.0-1.el7.x86_64.rpm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root    190368 Nov  4 15:43 qpid-proton-c-0.28.0-1.el7.x86_64.rpm</span></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]#</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# qemu<span class="operator">-</span>img info cirros<span class="number">-0.5</span><span class="number">.1</span><span class="operator">-</span>x86_64<span class="operator">-</span>disk.raw</span><br><span class="line">image: cirros<span class="number">-0.5</span><span class="number">.1</span><span class="operator">-</span>x86_64<span class="operator">-</span>disk.raw</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: <span class="number">112</span>M (<span class="number">117440512</span> bytes)</span><br><span class="line">disk size: <span class="number">17</span>M</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]#</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]#</span><br><span class="line"></span><br><span class="line"># 上传镜像;查看glance和ceph联动情况</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# openstack image <span class="keyword">create</span> <span class="comment">--container-format bare --disk-format raw --file cirros-0.5.1-x86_64-disk.raw --unprotected --public cirros_raw</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Field            <span class="operator">|</span> <span class="keyword">Value</span>                                                                                                                                                                                                                                                                                                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> checksum         <span class="operator">|</span> <span class="number">01e7</span>d1515ee776be3228673441d449e6                                                                                                                                                                                                                                                                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> container_format <span class="operator">|</span> bare                                                                                                                                                                                                                                                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> created_at       <span class="operator">|</span> <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T11:<span class="number">13</span>:<span class="number">57</span>Z                                                                                                                                                                                                                                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> disk_format      <span class="operator">|</span> raw                                                                                                                                                                                                                                                                                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> file             <span class="operator">|</span> <span class="operator">/</span>v2<span class="operator">/</span>images<span class="operator">/</span><span class="number">1</span>c72f484<span class="operator">-</span>f828<span class="number">-4</span>a9d<span class="number">-9</span>a4c<span class="number">-5</span>d542acbd203<span class="operator">/</span>file                                                                                                                                                                                                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> id               <span class="operator">|</span> <span class="number">1</span>c72f484<span class="operator">-</span>f828<span class="number">-4</span>a9d<span class="number">-9</span>a4c<span class="number">-5</span>d542acbd203                                                                                                                                                                                                                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> min_disk         <span class="operator">|</span> <span class="number">0</span>                                                                                                                                                                                                                                                                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> min_ram          <span class="operator">|</span> <span class="number">0</span>                                                                                                                                                                                                                                                                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name             <span class="operator">|</span> cirros_raw                                                                                                                                                                                                                                                                                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> owner            <span class="operator">|</span> <span class="number">60</span>f490ceabcb493db09bdd4c1990655f                                                                                                                                                                                                                                                                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> properties       <span class="operator">|</span> direct_url<span class="operator">=</span><span class="string">&#x27;rbd://18bdcd50-2ea5-4130-b27b-d1b61d1460c7/images/1c72f484-f828-4a9d-9a4c-5d542acbd203/snap&#x27;</span>, os_hash_algo<span class="operator">=</span><span class="string">&#x27;sha512&#x27;</span>, os_hash_value<span class="operator">=</span><span class="string">&#x27;d663dc8d739adc772acee23be3931075ea82a14ba49748553ab05f0e191286a8fe937d00d9f685ac69fd817d867b50be965e82e46d8cf3e57df6f86a57fa3c36&#x27;</span>, os_hidden<span class="operator">=</span><span class="string">&#x27;False&#x27;</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> protected        <span class="operator">|</span> <span class="literal">False</span>                                                                                                                                                                                                                                                                                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> schema           <span class="operator">|</span> <span class="operator">/</span>v2<span class="operator">/</span>schemas<span class="operator">/</span>image                                                                                                                                                                                                                                                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> size             <span class="operator">|</span> <span class="number">117440512</span>                                                                                                                                                                                                                                                                                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> status           <span class="operator">|</span> active                                                                                                                                                                                                                                                                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tags             <span class="operator">|</span>                                                                                                                                                                                                                                                                                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> updated_at       <span class="operator">|</span> <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T11:<span class="number">14</span>:<span class="number">01</span>Z                                                                                                                                                                                                                                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> virtual_size     <span class="operator">|</span> <span class="keyword">None</span>                                                                                                                                                                                                                                                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> visibility       <span class="operator">|</span> public                                                                                                                                                                                                                                                                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]#</span><br></pre></td></tr></table></figure></div>

<h3 id="查看镜像和glance池数据"><a href="#查看镜像和glance池数据" class="headerlink" title="查看镜像和glance池数据"></a>查看镜像和glance池数据</h3><ul>
<li>查看openstack镜像列表</li>
</ul>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# openstack image list</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+--------------+--------+</span></span><br><span class="line"><span class="operator">|</span> ID                                   <span class="operator">|</span> Name         <span class="operator">|</span> Status <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+--------------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>c66cd7e<span class="operator">-</span>b6d9<span class="number">-4e70</span><span class="operator">-</span>a3d4<span class="operator">-</span>f73b27a84230 <span class="operator">|</span> cirros<span class="operator">-</span>qcow2 <span class="operator">|</span> active <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>c72f484<span class="operator">-</span>f828<span class="number">-4</span>a9d<span class="number">-9</span>a4c<span class="number">-5</span>d542acbd203 <span class="operator">|</span> cirros_raw   <span class="operator">|</span> active <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+--------------+--------+</span></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]#</span><br></pre></td></tr></table></figure></div>

<ul>
<li>查看images池的数据</li>
</ul>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta"># rbd ls images</span></span><br><span class="line"><span class="number">1</span>c72f484-f828<span class="number">-4</span>a9d<span class="number">-9</span>a4c<span class="number">-5</span>d542acbd203</span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta">#</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>查看上传的镜像详细rbd信息</li>
</ul>
<div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@controller01</span> <span class="string">~</span>]<span class="comment"># rbd info images/1c72f484-f828-4a9d-9a4c-5d542acbd203</span></span><br><span class="line"><span class="string">rbd</span> <span class="string">image</span> <span class="attr">&#x27;1c72f484-f828-4a9d-9a4c-5d542acbd203&#x27;:</span></span><br><span class="line"><span class="string">size</span> <span class="number">112</span> <span class="string">MiB</span> <span class="string">in</span> <span class="number">14</span> <span class="string">objects</span></span><br><span class="line"><span class="string">order</span> <span class="number">23</span> <span class="string">(8</span> <span class="string">MiB</span> <span class="string">objects)</span></span><br><span class="line"><span class="attr">snapshot_count:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">id:</span> <span class="string">5e9ee3899042</span></span><br><span class="line"><span class="attr">block_name_prefix:</span> <span class="string">rbd_data.5e9ee3899042</span></span><br><span class="line"><span class="attr">format:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">features:</span> <span class="string">layering,</span> <span class="string">exclusive-lock,</span> <span class="string">object-map,</span> <span class="string">fast-diff,</span> <span class="string">deep-flatten</span></span><br><span class="line"><span class="attr">op_features:</span></span><br><span class="line"><span class="attr">flags:</span></span><br><span class="line"><span class="attr">create_timestamp:</span> <span class="string">Wed</span> <span class="string">Nov</span> <span class="number">10</span> <span class="number">19</span><span class="string">:14:01</span> <span class="number">2021</span></span><br><span class="line">[<span class="string">root@controller01</span> <span class="string">~</span>]<span class="comment">#</span></span><br><span class="line">[<span class="string">root@controller01</span> <span class="string">~</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>查看上传的镜像的快照列表</li>
</ul>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta"># rbd snap ls images/1c72f484-f828-4a9d-9a4c-5d542acbd203</span></span><br><span class="line">SNAPID NAME SIZE    PROTECTED TIMESTAMP</span><br><span class="line"><span class="number">4</span> snap <span class="number">112</span> MiB yes       Wed Nov <span class="number">10</span> <span class="number">19</span>:<span class="number">14</span>:<span class="number">04</span> <span class="number">2021</span></span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta">#</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>glance中的数据存储到了ceph块设备中</li>
</ul>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta"># rados ls -p images</span></span><br><span class="line">rbd_directory</span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.0000000000000008</span></span><br><span class="line">rbd_info</span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.0000000000000002</span></span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.0000000000000006</span></span><br><span class="line">rbd_object_map<span class="number">.5e9</span>ee3899042<span class="number">.0000000000000004</span></span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.0000000000000003</span></span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.0000000000000005</span></span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.000000000000000b</span></span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.000000000000000</span>d</span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.0000000000000007</span></span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.0000000000000000</span></span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.0000000000000009</span></span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.000000000000000</span>a</span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.0000000000000004</span></span><br><span class="line">rbd_object_map<span class="number">.5e9</span>ee3899042</span><br><span class="line">rbd_id<span class="number">.1</span>c72f484-f828<span class="number">-4</span>a9d<span class="number">-9</span>a4c<span class="number">-5</span>d542acbd203</span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.000000000000000</span>c</span><br><span class="line">rbd_header<span class="number">.5e9</span>ee3899042</span><br><span class="line">rbd_data<span class="number">.5e9</span>ee3899042<span class="number">.0000000000000001</span></span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta">#</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>在dashboard界面查看镜像列表</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111101920716.png"
                      alt="image-20211110192056586"
                ></p>
<ul>
<li>在ceph监控界面查看上传的镜像</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111101922271.png"
                      alt="image-20211110192238322"
                ></p>
<h3 id="Ceph执行image镜像的步骤过程详解"><a href="#Ceph执行image镜像的步骤过程详解" class="headerlink" title="Ceph执行image镜像的步骤过程详解"></a>Ceph执行image镜像的步骤过程详解</h3><p><strong>创建raw格式的Image时;Ceph中执行了以下步骤：</strong></p>
<ul>
<li>在 Pool images 中新建了一个 {glance_image_uuid} 块设备，块设备的 Object Size 为 8M，对应的 Objects 有 2 个，足以放下 cirros.raw 13M 的数据。</li>
<li>对新建块设备执行快照。</li>
<li>对该快照执行保护。</li>
</ul>
<div class="highlight-container" data-rel="Ruby"><figure class="iseeu highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rbd -p <span class="variable">$&#123;</span><span class="variable constant_">GLANCE_POOL</span>&#125; create --size <span class="variable">$&#123;</span><span class="variable constant_">SIZE</span>&#125; <span class="variable">$&#123;</span><span class="variable constant_">IMAGE_ID</span>&#125;</span><br><span class="line">rbd -p <span class="variable">$&#123;</span><span class="variable constant_">GLANCE_POOL</span>&#125; snap create <span class="variable">$&#123;</span><span class="variable constant_">IMAGE_ID</span>&#125;<span class="variable">@snap</span></span><br><span class="line">rbd -p <span class="variable">$&#123;</span><span class="variable constant_">GLANCE_POOL</span>&#125; snap protect <span class="variable">$&#123;</span><span class="variable constant_">IMAGE_ID</span>&#125;@snap</span><br></pre></td></tr></table></figure></div>

<p><strong>删除raw格式的Image时;Ceph中执行了以下步骤：</strong></p>
<ul>
<li>先取消快照保护</li>
<li>对快照执行删除</li>
<li>对镜像执行删除</li>
</ul>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rbd -p <span class="variable">$&#123;GLANCE_POOL&#125;</span> snap unprotect <span class="variable">$&#123;IMAGE_ID&#125;</span>@snap</span><br><span class="line">rbd -p <span class="variable">$&#123;GLANCE_POOL&#125;</span> snap <span class="built_in">rm</span> <span class="variable">$&#123;IMAGE_ID&#125;</span>@snap</span><br><span class="line">rbd -p <span class="variable">$&#123;GLANCE_POOL&#125;</span> <span class="built_in">rm</span> <span class="variable">$&#123;IMAGE_ID&#125;</span></span><br></pre></td></tr></table></figure></div>

<p><strong>总结</strong></p>
<p>将openstack集群中的glance镜像的数据存储到ceph中是一种非常好的解决方案，既能够保障镜像数据的安全性，同时glance和nova在同个存储池中，能够基于copy-on-write(写时复制)的方式快速创建虚拟机，能够在秒级为单位实现vm的创建。</p>
<h2 id="使用Ceph作为Cinder的后端存储"><a href="#使用Ceph作为Cinder的后端存储" class="headerlink" title="使用Ceph作为Cinder的后端存储"></a>使用Ceph作为Cinder的后端存储</h2><h3 id="配置cinder-conf-1"><a href="#配置cinder-conf-1" class="headerlink" title="配置cinder.conf"></a>配置cinder.conf</h3><ul>
<li>cinder利用插件式结构，支持同时使用多种后端存储；</li>
<li>在cinder-volume所在节点设置cinder.conf中设置相应的ceph rbd驱动即可；</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://docs.openstack.org/cinder/train/configuration/block-storage/drivers/ceph-rbd-volume-driver.html" >openstack官方文档-ceph配置参数说明 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
</ul>
<p><strong>全部计算节点进行配置；</strong> 以compute01节点为例；只修改glance集成ceph的相关配置</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备份cinder.conf的配置文件;以便于恢复</span></span><br><span class="line">cp /etc/cinder/cinder.conf&#123;,.bak2&#125;</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 后端使用ceph存储已经在部署cinder服务时进行配置</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf DEFAULT enabled_backends ceph</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf DEFAULT glance_api_version 2</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf ceph volume_driver cinder.volume.drivers.rbd.RBDDriver</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf ceph rbd_pool volumes</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf ceph rbd_ceph_conf /etc/ceph/ceph.conf</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf ceph rbd_flatten_volume_from_snapshot <span class="literal">false</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf ceph rbd_max_clone_depth 5</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf ceph rbd_store_chunk_size 4</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf ceph rados_connect_timeout -1</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf ceph rbd_user cinder</span><br><span class="line"><span class="comment"># 注意替换cinder用户访问ceph集群使用的Secret UUID</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf ceph rbd_secret_uuid bae8efd1-e319-48cc-8fd0-9213dd0e3497</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/cinder/cinder.conf ceph volume_backend_name ceph</span><br></pre></td></tr></table></figure></div>

<h3 id="重启cinder-volume服务"><a href="#重启cinder-volume服务" class="headerlink" title="重启cinder-volume服务"></a>重启cinder-volume服务</h3><p>全部计算节点重启cinder-volume服务；</p>
<div class="highlight-container" data-rel="Lua"><figure class="iseeu highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openstack-cinder-volume.service</span><br><span class="line">systemctl <span class="built_in">status</span> openstack-cinder-volume.service</span><br></pre></td></tr></table></figure></div>

<h3 id="验证服务状态"><a href="#验证服务状态" class="headerlink" title="验证服务状态"></a>验证服务状态</h3><p>任意控制节点上查看;</p>
<div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@controller01 ~]# openstack volume service list</span><br><span class="line">+------------------+----------------+------+---------+-------+----------------------------+</span><br><span class="line">| <span class="type">Binary</span>           | <span class="type">Host</span>           | <span class="type">Zone</span> | <span class="type">Status</span>  | <span class="type">State</span> | <span class="type">Updated</span> <span class="type">At</span>                 |</span><br><span class="line">+------------------+----------------+------+---------+-------+----------------------------+</span><br><span class="line">| cinder-scheduler | controller01   | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T11:<span class="number">45</span>:<span class="number">19.000000</span> |</span><br><span class="line">| cinder-scheduler | controller02   | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T11:<span class="number">45</span>:<span class="number">11.000000</span> |</span><br><span class="line">| cinder-scheduler | controller03   | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T11:<span class="number">45</span>:<span class="number">14.000000</span> |</span><br><span class="line">| cinder-volume    | compute01@ceph | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T11:<span class="number">45</span>:<span class="number">17.000000</span> |</span><br><span class="line">| cinder-volume    | compute02@ceph | nova | enabled | up    | <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T11:<span class="number">45</span>:<span class="number">21.000000</span> |</span><br><span class="line">+------------------+----------------+------+---------+-------+----------------------------+</span><br></pre></td></tr></table></figure></div>

<h3 id="创建空白卷Volume测试"><a href="#创建空白卷Volume测试" class="headerlink" title="创建空白卷Volume测试"></a>创建空白卷Volume测试</h3><p><strong>设置卷类型</strong></p>
<p>在任意控制节点为cinder的ceph后端存储创建对应的type，在配置多存储后端时可区分类型；</p>
<div class="highlight-container" data-rel="Lua"><figure class="iseeu highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@controller01 ~]# cinder <span class="built_in">type</span>-<span class="built_in">create</span> ceph</span><br><span class="line">+<span class="comment">--------------------------------------+------+-------------+-----------+</span></span><br><span class="line">| ID                                   | Name | Description | Is_Public |</span><br><span class="line">+<span class="comment">--------------------------------------+------+-------------+-----------+</span></span><br><span class="line">| <span class="number">98718</span>aae-b0e8<span class="number">-4</span>a4e<span class="number">-8</span>b94-de0ace67b392 | ceph | -           | True      |</span><br><span class="line">+<span class="comment">--------------------------------------+------+-------------+-----------+</span></span><br><span class="line">[root@controller01 ~]#</span><br><span class="line"># 可通过 cinder <span class="built_in">type</span>-list 或 openstack volume <span class="built_in">type</span> list 查看</span><br></pre></td></tr></table></figure></div>

<p>为ceph type设置扩展规格，键值 <code>volume_backend_name</code>，value值 <code>ceph</code></p>
<div class="highlight-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@controller01 ~]<span class="comment"># cinder type-key ceph set volume_backend_name=ceph</span></span><br><span class="line">[root@controller01 ~]<span class="comment">#</span></span><br><span class="line">[root@controller01 ~]<span class="comment"># cinder extra-specs-list</span></span><br><span class="line">+--------------------------------------+-------------+---------------------------------+</span><br><span class="line">| ID                                   | Name        | extra_specs                     |</span><br><span class="line">+--------------------------------------+-------------+---------------------------------+</span><br><span class="line">| <span class="number">1</span>eae6f86-f6ae-<span class="number">4685</span>-<span class="number">8</span>f2b-<span class="number">0064</span>dcb9d917 | __DEFAULT_<span class="number">_</span> | &#123;&#125;                              |</span><br><span class="line">| <span class="number">98718</span>aae-b0e8-<span class="number">4</span>a4e-<span class="number">8</span>b94-de0ace67b392 | ceph        | &#123;<span class="string">&#x27;volume_backend_name&#x27;</span>: <span class="string">&#x27;ceph&#x27;</span>&#125; |</span><br><span class="line">+--------------------------------------+-------------+---------------------------------+</span><br><span class="line">[root@controller01 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></div>

<p><strong>创建一个volume卷</strong></p>
<p><strong>任意控制节点上创建一个1GB的卷</strong>；最后的数字1代表容量为1G</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# openstack volume <span class="keyword">create</span> <span class="comment">--type ceph --size 1 ceph-volume</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Field               <span class="operator">|</span> <span class="keyword">Value</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> attachments         <span class="operator">|</span> []                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> availability_zone   <span class="operator">|</span> nova                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> bootable            <span class="operator">|</span> <span class="literal">false</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> consistencygroup_id <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> created_at          <span class="operator">|</span> <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T11:<span class="number">56</span>:<span class="number">02.000000</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> description         <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> encrypted           <span class="operator">|</span> <span class="literal">False</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> id                  <span class="operator">|</span> <span class="number">77</span>d1dc9c<span class="number">-2826</span><span class="number">-45</span>f2<span class="operator">-</span>b738<span class="operator">-</span>f3571f90ef87 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> migration_status    <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> multiattach         <span class="operator">|</span> <span class="literal">False</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name                <span class="operator">|</span> ceph<span class="operator">-</span>volume                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> properties          <span class="operator">|</span>                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> replication_status  <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> size                <span class="operator">|</span> <span class="number">1</span>                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> snapshot_id         <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> source_volid        <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> status              <span class="operator">|</span> creating                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> type                <span class="operator">|</span> ceph                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> updated_at          <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> user_id             <span class="operator">|</span> <span class="number">05</span>a3ad27698e41b0a3e10a6daffbf64e     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+--------------------------------------+</span></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]#</span><br></pre></td></tr></table></figure></div>

<p><strong>验证</strong></p>
<p><strong>查看创建好的卷</strong></p>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta"># openstack volume list</span></span><br><span class="line">+--------------------------------------+-------------+-----------+------+-----------------------------+</span><br><span class="line">| ID                                   | Name        | Status    | Size | Attached to                 |</span><br><span class="line">+--------------------------------------+-------------+-----------+------+-----------------------------+</span><br><span class="line">| <span class="number">77</span>d1dc9c<span class="number">-2826</span><span class="number">-45f</span>2-b738-f3571f90ef87 | ceph-volume | available |    <span class="number">1</span> |                             |</span><br><span class="line">| <span class="number">0092b</span>891-a249<span class="number">-4</span>c62-b06d<span class="number">-71f</span>9a5e66e37 |             | <span class="keyword">in</span>-use    |    <span class="number">1</span> | Attached to s6 <span class="keyword">on</span> /dev/vda  |</span><br><span class="line">+--------------------------------------+-------------+-----------+------+-----------------------------+</span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta">#</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 检查ceph集群的volumes池</span></span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta"># rbd ls volumes</span></span><br><span class="line">volume<span class="number">-0092b</span>891-a249<span class="number">-4</span>c62-b06d<span class="number">-71f</span>9a5e66e37</span><br><span class="line">volume<span class="number">-77</span>d1dc9c<span class="number">-2826</span><span class="number">-45f</span>2-b738-f3571f90ef87</span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta">#</span></span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta">#</span></span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta"># rbd info volumes/volume-77d1dc9c-2826-45f2-b738-f3571f90ef87</span></span><br><span class="line">rbd image <span class="string">&#x27;volume-77d1dc9c-2826-45f2-b738-f3571f90ef87&#x27;</span>:</span><br><span class="line">size <span class="number">1</span> GiB <span class="keyword">in</span> <span class="number">256</span> objects</span><br><span class="line">order <span class="number">22</span> (<span class="number">4</span> MiB objects)</span><br><span class="line">snapshot_count: <span class="number">0</span></span><br><span class="line">id: <span class="number">60754</span>c5853d9</span><br><span class="line">block_name_prefix: rbd_data<span class="number">.60754</span>c5853d9</span><br><span class="line">format: <span class="number">2</span></span><br><span class="line">features: layering, exclusive-<span class="keyword">lock</span>, <span class="built_in">object</span>-map, fast-diff, deep-flatten</span><br><span class="line">op_features:</span><br><span class="line">flags:</span><br><span class="line">create_timestamp: Wed Nov <span class="number">10</span> <span class="number">19</span>:<span class="number">56</span>:<span class="number">05</span> <span class="number">2021</span></span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta">#</span></span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta"># rados ls -p volumes</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>c8</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000056</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000b</span>8</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000011</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000026</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000000</span>e</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000080</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>ae</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>ac</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000003</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>ce</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000060</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000012</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000e4</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000008</span>c</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000042</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000001</span>c</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000002</span>c</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>cc</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000086</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000082</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000006</span>e</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000f</span>4</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000094</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000008</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>d4</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000015</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>ca</span><br><span class="line">rbd_header<span class="number">.60754</span>c5853d9</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>da</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000084</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000009</span></span><br><span class="line">rbd_directory</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000f</span>a</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000003</span>a</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000004</span>c</span><br><span class="line">rbd_object_map<span class="number">.60754</span>c5853d9</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000e8</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000003</span>c</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000e6</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000054</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000006</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000032</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000046</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000f</span>2</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000038</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000096</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000016</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000004</span>e</span><br><span class="line">rbd_children</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>d6</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>aa</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000006</span>c</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000068</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000036</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000000</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000078</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000b</span>a</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000004</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000014</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>c0</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000009</span>a</span><br><span class="line">rbd_info</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000007</span>e</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000000b</span></span><br><span class="line">rbd_header<span class="number">.5f</span>93fbe03211</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000000</span>c</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000b</span>0</span><br><span class="line">rbd_id.volume<span class="number">-0092b</span>891-a249<span class="number">-4</span>c62-b06d<span class="number">-71f</span>9a5e66e37</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000b</span>4</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000005</span>c</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000058</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000024</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000b</span>6</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>a8</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000062</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000066</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>a0</span><br><span class="line">rbd_id.volume<span class="number">-77</span>d1dc9c<span class="number">-2826</span><span class="number">-45f</span>2-b738-f3571f90ef87</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>d8</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000022</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000007</span>a</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000003</span>e</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000b</span>2</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000000</span>d</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000009</span>c</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000001</span>e</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000020</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000076</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>a4</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>a6</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000004</span>a</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000010</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000030</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>d0</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000064</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000000</span>a</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000001</span>a</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000007</span>c</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>c4</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000005</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000008</span>a</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000008</span>e</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000f</span>f</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000002</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>a2</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000e0</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000070</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000b</span>c</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000f</span>c</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000050</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000f</span>0</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>dc</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000034</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000002</span>a</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>ec</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000052</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000074</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>d2</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000006</span>a</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>ee</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>c6</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>de</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000f</span>e</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000088</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000e2</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000098</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000f</span>6</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>c2</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000044</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000002</span>e</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000005</span>a</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000048</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000009</span>e</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000018</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000072</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000090</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000b</span>e</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000</span>ea</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000028</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.00000000000000f</span>8</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000040</span></span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.000000000000005</span>e</span><br><span class="line">rbd_data<span class="number">.5f</span>93fbe03211<span class="number">.0000000000000092</span></span><br><span class="line">rbd_object_map<span class="number">.5f</span>93fbe03211</span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta">#</span></span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111102001607.png"
                      alt="image-20211110200150645"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111102002694.png"
                      alt="image-20211110200214845"
                ></p>
<p><strong>openstack创建一个空白 Volume，Ceph相当于执行了以下指令</strong></p>
<div class="highlight-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd -p $&#123;CINDER_POOL&#125; create --new-<span class="keyword">format</span> --size $&#123;SIZE&#125; volume-$&#123;VOLUME_ID&#125;</span><br></pre></td></tr></table></figure></div>

<p>卷可以连接到实例</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111102047269.png"
                      alt="微信截图_20211110204617"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111102047053.png"
                      alt="image-20211110204724904"
                ></p>
<h3 id="从镜像创建Volume测试"><a href="#从镜像创建Volume测试" class="headerlink" title="从镜像创建Volume测试"></a>从镜像创建Volume测试</h3><p>从镜像创建 Volume 的时候应用了 Ceph RBD COW Clone 功能，这是通过 <code>glance-api.conf [DEFAULT] show_image_direct_url = True</code> 来开启。这个配置项的作用是持久化 Image 的 location，此时 Glance RBD Driver 才可以通过 Image location 执行 Clone 操作。并且还会根据指定的 Volume Size 来调整 RBD Image 的 Size。</p>
<p><strong>删除僵尸镜像的方法</strong></p>
<div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@controller01 ~]# openstack image list</span><br><span class="line">+--------------------------------------+--------------+--------+</span><br><span class="line">| <span class="type">ID</span>                                   | <span class="type">Name</span>         | <span class="type">Status</span> |</span><br><span class="line">+--------------------------------------+--------------+--------+</span><br><span class="line">| <span class="number">1</span>c66cd7e-b6d9<span class="number">-4e70</span>-a3d4-f73b27a84230 | cirros-qcow2 | active |</span><br><span class="line">| <span class="number">1</span>c72f484-f828<span class="number">-4</span>a9d<span class="number">-9</span>a4c<span class="number">-5</span>d542acbd203 | cirros_raw   | active |</span><br><span class="line">+--------------------------------------+--------------+--------+</span><br></pre></td></tr></table></figure></div>

<p>一直存在的cirros_qcow2镜像为对接ceph之前的镜像，现在已无法使用，所以将之删除</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 把镜像属性变为非可用状态,必须保证无实例正在使用，否则会报 HTTP <span class="number">500</span> 错误</span><br><span class="line">$ openstack image <span class="keyword">set</span> <span class="comment">--deactivate 1c66cd7e-b6d9-4e70-a3d4-f73b27a84230</span></span><br><span class="line">$ openstack image list</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+--------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> ID                                   <span class="operator">|</span> Name         <span class="operator">|</span> Status      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+--------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>c66cd7e<span class="operator">-</span>b6d9<span class="number">-4e70</span><span class="operator">-</span>a3d4<span class="operator">-</span>f73b27a84230 <span class="operator">|</span> cirros<span class="operator">-</span>qcow2 <span class="operator">|</span> deactivated <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>c72f484<span class="operator">-</span>f828<span class="number">-4</span>a9d<span class="number">-9</span>a4c<span class="number">-5</span>d542acbd203 <span class="operator">|</span> cirros_raw   <span class="operator">|</span> active      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+--------------+-------------+</span></span><br><span class="line"></span><br><span class="line"># 进入数据库</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123456</span><br><span class="line">use glance;</span><br><span class="line"><span class="keyword">select</span> id, status, name <span class="keyword">from</span> images <span class="keyword">where</span> id<span class="operator">=</span><span class="string">&#x27;1c66cd7e-b6d9-4e70-a3d4-f73b27a84230&#x27;</span>;</span><br><span class="line"><span class="keyword">update</span> images <span class="keyword">set</span> deleted<span class="operator">=</span><span class="number">1</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="string">&#x27;1c66cd7e-b6d9-4e70-a3d4-f73b27a84230&#x27;</span>;</span><br><span class="line"></span><br><span class="line">$ openstack image list</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+------------+--------+</span></span><br><span class="line"><span class="operator">|</span> ID                                   <span class="operator">|</span> Name       <span class="operator">|</span> Status <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+------------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>c72f484<span class="operator">-</span>f828<span class="number">-4</span>a9d<span class="number">-9</span>a4c<span class="number">-5</span>d542acbd203 <span class="operator">|</span> cirros_raw <span class="operator">|</span> active <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+------------+--------+</span></span><br></pre></td></tr></table></figure></div>

<p><strong>为cirros_raw镜像创建一个1G的卷</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ openstack volume <span class="keyword">create</span> <span class="comment">--image 1c72f484-f828-4a9d-9a4c-5d542acbd203 --type ceph --size 1 cirros_raw_image</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Field               <span class="operator">|</span> <span class="keyword">Value</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> attachments         <span class="operator">|</span> []                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> availability_zone   <span class="operator">|</span> nova                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> bootable            <span class="operator">|</span> <span class="literal">false</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> consistencygroup_id <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> created_at          <span class="operator">|</span> <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T12:<span class="number">14</span>:<span class="number">29.000000</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> description         <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> encrypted           <span class="operator">|</span> <span class="literal">False</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> id                  <span class="operator">|</span> f79c3af2<span class="number">-101e-4</span>a76<span class="number">-9e88</span><span class="number">-37</span>ceb51f622c <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> migration_status    <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> multiattach         <span class="operator">|</span> <span class="literal">False</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name                <span class="operator">|</span> cirros_raw_image                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> properties          <span class="operator">|</span>                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> replication_status  <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> size                <span class="operator">|</span> <span class="number">1</span>                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> snapshot_id         <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> source_volid        <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> status              <span class="operator">|</span> creating                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> type                <span class="operator">|</span> ceph                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> updated_at          <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> user_id             <span class="operator">|</span> <span class="number">05</span>a3ad27698e41b0a3e10a6daffbf64e     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+--------------------------------------+</span></span><br></pre></td></tr></table></figure></div>

<p>或者web界面</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111102014876.png"
                      alt="image-20211110201422261"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111102015585.png"
                      alt="image-20211110201512521"
                ></p>
<p>从镜像创建的卷就可以在创建实例时使用了</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111102017825.png"
                      alt="微信截图_20211110201638"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111102018434.png"
                      alt="image-20211110201844522"
                ></p>
<p><strong>查看images池的Objects信息</strong></p>
<div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@controller01</span> <span class="string">~</span>]<span class="comment"># rbd ls volumes</span></span><br><span class="line"><span class="string">volume-0092b891-a249-4c62-b06d-71f9a5e66e37</span></span><br><span class="line"><span class="string">volume-77d1dc9c-2826-45f2-b738-f3571f90ef87</span></span><br><span class="line"><span class="string">volume-f79c3af2-101e-4a76-9e88-37ceb51f622c</span></span><br><span class="line">[<span class="string">root@controller01</span> <span class="string">~</span>]<span class="comment">#</span></span><br><span class="line">[<span class="string">root@controller01</span> <span class="string">~</span>]<span class="comment"># rbd info volumes/volume-f79c3af2-101e-4a76-9e88-37ceb51f622c</span></span><br><span class="line"><span class="string">rbd</span> <span class="string">image</span> <span class="attr">&#x27;volume-f79c3af2-101e-4a76-9e88-37ceb51f622c&#x27;:</span></span><br><span class="line"><span class="string">size</span> <span class="number">1</span> <span class="string">GiB</span> <span class="string">in</span> <span class="number">256</span> <span class="string">objects</span></span><br><span class="line"><span class="string">order</span> <span class="number">22</span> <span class="string">(4</span> <span class="string">MiB</span> <span class="string">objects)</span></span><br><span class="line"><span class="attr">snapshot_count:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">id:</span> <span class="string">62606c5008db</span></span><br><span class="line"><span class="attr">block_name_prefix:</span> <span class="string">rbd_data.62606c5008db</span></span><br><span class="line"><span class="attr">format:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">features:</span> <span class="string">layering,</span> <span class="string">exclusive-lock,</span> <span class="string">object-map,</span> <span class="string">fast-diff,</span> <span class="string">deep-flatten</span></span><br><span class="line"><span class="attr">op_features:</span></span><br><span class="line"><span class="attr">flags:</span></span><br><span class="line"><span class="attr">create_timestamp:</span> <span class="string">Wed</span> <span class="string">Nov</span> <span class="number">10</span> <span class="number">20</span><span class="string">:14:29</span> <span class="number">2021</span></span><br><span class="line"><span class="attr">parent:</span> <span class="string">images/1c72f484-f828-4a9d-9a4c-5d542acbd203@snap</span></span><br><span class="line"><span class="attr">overlap:</span> <span class="number">112</span> <span class="string">MiB</span></span><br><span class="line">[<span class="string">root@controller01</span> <span class="string">~</span>]<span class="comment">#</span></span><br><span class="line">[<span class="string">root@controller01</span> <span class="string">~</span>]<span class="comment"># rados ls -p volumes|grep id</span></span><br><span class="line"><span class="string">rbd_id.volume-0092b891-a249-4c62-b06d-71f9a5e66e37</span></span><br><span class="line"><span class="string">rbd_id.volume-77d1dc9c-2826-45f2-b738-f3571f90ef87</span></span><br><span class="line"><span class="string">rbd_id.volume-f79c3af2-101e-4a76-9e88-37ceb51f622c</span></span><br><span class="line">[<span class="string">root@controller01</span> <span class="string">~</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure></div>

<p><strong>在openstack上从镜像创建一个Volume，Ceph相当于执行了以下指令</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rbd <span class="built_in">clone</span> <span class="variable">$&#123;GLANCE_POOL&#125;</span>/<span class="variable">$&#123;IMAGE_ID&#125;</span>@snap <span class="variable">$&#123;CINDER_POOL&#125;</span>/volume-<span class="variable">$&#123;VOLUME_ID&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$&#123;SIZE&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">rbd resize --size <span class="variable">$&#123;SIZE&#125;</span> <span class="variable">$&#123;CINDER_POOL&#125;</span>/volume-<span class="variable">$&#123;VOLUME_ID&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></div>

<h3 id="为镜像创建的卷生成快照测试"><a href="#为镜像创建的卷生成快照测试" class="headerlink" title="为镜像创建的卷生成快照测试"></a>为镜像创建的卷生成快照测试</h3><p>任意控制节点操作；</p>
<p><strong>创建cirros_raw_image卷的快照</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# openstack volume snapshot <span class="keyword">create</span> <span class="comment">--volume cirros_raw_image cirros_raw_image_snap01</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Field       <span class="operator">|</span> <span class="keyword">Value</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> created_at  <span class="operator">|</span> <span class="number">2021</span><span class="number">-11</span><span class="number">-10</span>T12:<span class="number">26</span>:<span class="number">02.607424</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> description <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> id          <span class="operator">|</span> <span class="number">6658</span>c988<span class="number">-8</span>dcd<span class="number">-411e-9882</span><span class="operator">-</span>a1ac357fbe93 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name        <span class="operator">|</span> cirros_raw_image_snap01              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> properties  <span class="operator">|</span>                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> size        <span class="operator">|</span> <span class="number">1</span>                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> status      <span class="operator">|</span> creating                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> updated_at  <span class="operator">|</span> <span class="keyword">None</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> volume_id   <span class="operator">|</span> f79c3af2<span class="number">-101e-4</span>a76<span class="number">-9e88</span><span class="number">-37</span>ceb51f622c <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------------------------+</span></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]#</span><br></pre></td></tr></table></figure></div>

<p><strong>查看快照列表</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# openstack volume snapshot list</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+-------------------------+-------------+-----------+------+</span></span><br><span class="line"><span class="operator">|</span> ID                                   <span class="operator">|</span> Name                    <span class="operator">|</span> Description <span class="operator">|</span> Status    <span class="operator">|</span> Size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+-------------------------+-------------+-----------+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">6658</span>c988<span class="number">-8</span>dcd<span class="number">-411e-9882</span><span class="operator">-</span>a1ac357fbe93 <span class="operator">|</span> cirros_raw_image_snap01 <span class="operator">|</span> <span class="keyword">None</span>        <span class="operator">|</span> available <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+-------------------------+-------------+-----------+------+</span></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]#</span><br></pre></td></tr></table></figure></div>

<p>或者 web 查看</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111102027181.png"
                      alt="image-20211110202724151"
                ></p>
<p><strong>在ceph上查镜像看创建的快照</strong></p>
<div class="highlight-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@controller01 ~]<span class="comment"># openstack volume snapshot list</span></span><br><span class="line">+--------------------------------------+-------------------------+-------------+-----------+------+</span><br><span class="line">| ID                                   | Name                    | Description | Status    | Size |</span><br><span class="line">+--------------------------------------+-------------------------+-------------+-----------+------+</span><br><span class="line">| <span class="number">6658</span>c988-<span class="number">8</span>dcd-<span class="number">411</span>e-<span class="number">9882</span>-a1ac357fbe93 | cirros_raw_image_snap01 | None        | available |    <span class="number">1</span> |</span><br><span class="line">+--------------------------------------+-------------------------+-------------+-----------+------+</span><br><span class="line">[root@controller01 ~]<span class="comment">#</span></span><br><span class="line">[root@controller01 ~]<span class="comment"># openstack volume list</span></span><br><span class="line">+--------------------------------------+------------------+-----------+------+-----------------------------+</span><br><span class="line">| ID                                   | Name             | Status    | Size | Attached to                 |</span><br><span class="line">+--------------------------------------+------------------+-----------+------+-----------------------------+</span><br><span class="line">| f79c3af2-<span class="number">101</span>e-<span class="number">4</span>a76-<span class="number">9</span>e88-<span class="number">37</span>ceb51f622c | cirros_raw_image | available |    <span class="number">1</span> |                             |</span><br><span class="line">| <span class="number">77</span>d1dc9c-<span class="number">2826</span>-<span class="number">45</span>f2-b738-f3571f90ef87 | ceph-volume      | available |    <span class="number">1</span> |                             |</span><br><span class="line">| <span class="number">00</span>92b891-a249-<span class="number">4</span>c62-b06d-<span class="number">71</span>f9a5e66e37 |                  | in-<span class="keyword">use</span>    |    <span class="number">1</span> | Attached to s6 on /dev/vda  |</span><br><span class="line">+--------------------------------------+------------------+-----------+------+-----------------------------+</span><br><span class="line">[root@controller01 ~]<span class="comment">#</span></span><br><span class="line">[root@controller01 ~]<span class="comment">#</span></span><br><span class="line">[root@controller01 ~]<span class="comment"># rbd snap ls volumes/volume-f79c3af2-101e-4a76-9e88-37ceb51f622c</span></span><br><span class="line">SNAPID NAME                                          SIZE  PROTECTED TIMESTAMP</span><br><span class="line"><span class="number">4</span> snapshot-<span class="number">6658</span>c988-<span class="number">8</span>dcd-<span class="number">411</span>e-<span class="number">9882</span>-a1ac357fbe93 <span class="number">1</span> GiB yes       Wed Nov <span class="number">10</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">02</span> <span class="number">2021</span></span><br><span class="line">[root@controller01 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></div>

<p>查看快照详细信息</p>
<div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@controller01</span> <span class="string">~</span>]<span class="comment"># rbd info volumes/volume-f79c3af2-101e-4a76-9e88-37ceb51f622c</span></span><br><span class="line"><span class="string">rbd</span> <span class="string">image</span> <span class="attr">&#x27;volume-f79c3af2-101e-4a76-9e88-37ceb51f622c&#x27;:</span></span><br><span class="line"><span class="string">size</span> <span class="number">1</span> <span class="string">GiB</span> <span class="string">in</span> <span class="number">256</span> <span class="string">objects</span></span><br><span class="line"><span class="string">order</span> <span class="number">22</span> <span class="string">(4</span> <span class="string">MiB</span> <span class="string">objects)</span></span><br><span class="line"><span class="attr">snapshot_count:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">id:</span> <span class="string">62606c5008db</span></span><br><span class="line"><span class="attr">block_name_prefix:</span> <span class="string">rbd_data.62606c5008db</span></span><br><span class="line"><span class="attr">format:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">features:</span> <span class="string">layering,</span> <span class="string">exclusive-lock,</span> <span class="string">object-map,</span> <span class="string">fast-diff,</span> <span class="string">deep-flatten</span></span><br><span class="line"><span class="attr">op_features:</span></span><br><span class="line"><span class="attr">flags:</span></span><br><span class="line"><span class="attr">create_timestamp:</span> <span class="string">Wed</span> <span class="string">Nov</span> <span class="number">10</span> <span class="number">20</span><span class="string">:14:29</span> <span class="number">2021</span></span><br><span class="line"><span class="attr">parent:</span> <span class="string">images/1c72f484-f828-4a9d-9a4c-5d542acbd203@snap</span></span><br><span class="line"><span class="attr">overlap:</span> <span class="number">112</span> <span class="string">MiB</span></span><br><span class="line">[<span class="string">root@controller01</span> <span class="string">~</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure></div>

<p><strong>在openstack上对镜像的卷创建快照，Ceph相当于执行了以下指令</strong></p>
<div class="highlight-container" data-rel="Ruby"><figure class="iseeu highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rbd -p <span class="variable">$&#123;</span><span class="variable constant_">CINDER_POOL</span>&#125; snap create volume-<span class="variable">$&#123;</span><span class="variable constant_">VOLUME_ID</span>&#125;<span class="variable">@snapshot</span>-<span class="variable">$&#123;</span><span class="variable constant_">SNAPSHOT_ID</span>&#125;</span><br><span class="line">rbd -p <span class="variable">$&#123;</span><span class="variable constant_">CINDER_POOL</span>&#125; snap protect volume-<span class="variable">$&#123;</span><span class="variable constant_">VOLUME_ID</span>&#125;<span class="variable">@snapshot</span>-<span class="variable">$&#123;</span><span class="variable constant_">SNAPSHOT_ID</span>&#125;</span><br></pre></td></tr></table></figure></div>

<p>完成后就可以从快照创建实例了</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111102039046.png"
                      alt="微信截图_20211110203938"
                ></p>
<h3 id="创建-Volume卷备份测试"><a href="#创建-Volume卷备份测试" class="headerlink" title="创建 Volume卷备份测试"></a>创建 Volume卷备份测试</h3><p>如果说快照时一个时间机器，那么备份就是一个异地的时间机器，它具有容灾的含义。所以一般来说 Ceph Pool backup 应该与 Pool images、volumes 以及 vms 处于不同的灾备隔离域。</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://www.cnblogs.com/luohaixian/p/9344803.html" >https://www.cnblogs.com/luohaixian/p/9344803.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://docs.openstack.org/zh_CN/user-guide/backup-db-incremental.html" >https://docs.openstack.org/zh_CN&#x2F;user-guide&#x2F;backup-db-incremental.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>一般的，备份具有以下类型：</p>
<ul>
<li>全量备份</li>
<li>增量备份：</li>
<li>差异备份</li>
</ul>
<h2 id="使用Ceph作为Nova的虚拟机存储"><a href="#使用Ceph作为Nova的虚拟机存储" class="headerlink" title="使用Ceph作为Nova的虚拟机存储"></a>使用Ceph作为Nova的虚拟机存储</h2><p>Nova是OpenStack中的计算服务。 Nova存储与默认的运行虚拟机相关联的虚拟磁盘镜像，在 <code>/var/lib/nova/instances/%UUID</code> 目录下。Ceph是可以直接与Nova集成的存储后端之一。</p>
<p>在虚拟磁盘映像的计算节点上使用本地存储有一些缺点：</p>
<ul>
<li>镜像存储在根文件系统下。大镜像可能导致文件系统被填满，从而导致计算节点崩溃。</li>
<li>计算节点上的磁盘崩溃可能导致虚拟磁盘丢失，因此无法进行虚拟机恢复。</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111102054862.webp"
                      alt="img"
                ></p>
<p>Nova 为 OpenStack 提供计算服务，对接 Ceph 主要是希望将实例的系统磁盘文件储存到 Ceph 集群中。与其说是对接 Nova，更准确来说是对接 <code>QEMU-KVM/libvirt</code>，因为 librbd 早已原生集成到其中。</p>
<p>如果需要从ceph rbd中启动虚拟机，必须将ceph配置为nova的临时后端；</p>
<p>推荐在计算节点的配置文件中启用rbd cache功能；</p>
<p>为了便于故障排查，配置admin socket参数，这样每个使用ceph rbd的虚拟机都有1个socket将有利于虚拟机性能分析与故障解决；</p>
<p>相关配置只涉及全部计算节点ceph.conf文件的[client]与[client.cinder]字段，以compute01节点为例；</p>
<h3 id="配置ceph-conf"><a href="#配置ceph-conf" class="headerlink" title="配置ceph.conf"></a>配置ceph.conf</h3><ul>
<li>如果需要从ceph rbd中启动虚拟机，必须将ceph配置为nova的临时后端；</li>
<li>推荐在计算节点的配置文件中启用rbd cache功能；</li>
<li>为了便于故障排查，配置admin socket参数，这样每个使用ceph rbd的虚拟机都有1个socket将有利于虚拟机性能分析与故障解决；</li>
</ul>
<p><strong>全部计算节点配置</strong> ceph.conf文件相关的 <code>[client]</code> 与 <code>[client.cinder]</code> 字段，以compute01节点为例；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建ceph.conf文件中指定的socker与log相关的目录，并更改属主，必须</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /var/run/ceph/guests/ /var/log/qemu/</span><br><span class="line"><span class="built_in">chown</span> qemu:libvirt /var/run/ceph/guests/ /var/log/qemu/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增以下配置</span></span><br><span class="line">[root@compute01 ~]<span class="comment"># vim /etc/ceph/ceph.conf</span></span><br><span class="line">[client]</span><br><span class="line">rbd_cache = <span class="literal">true</span></span><br><span class="line">rbd_cache_writethrough_until_flush = <span class="literal">true</span></span><br><span class="line">admin_socket = /var/run/ceph/guests/<span class="variable">$cluster</span>-<span class="variable">$type</span>.<span class="variable">$id</span>.<span class="variable">$pid</span>.<span class="variable">$cctid</span>.asok</span><br><span class="line">log_file = /var/log/qemu/qemu-guest-<span class="variable">$pid</span>.<span class="built_in">log</span></span><br><span class="line">rbd_concurrent_management_ops = 20</span><br><span class="line"></span><br><span class="line">[client.cinder]</span><br><span class="line">keyring = /etc/ceph/ceph.client.cinder.keyring</span><br></pre></td></tr></table></figure></div>

<h3 id="配置nova-conf-2"><a href="#配置nova-conf-2" class="headerlink" title="配置nova.conf"></a>配置nova.conf</h3><p>在全部计算节点配置nova后端使用ceph集群的vms池，以compute01节点为例；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份nova.conf的配置文件;以便于恢复</span></span><br><span class="line"><span class="built_in">cp</span> /etc/nova/nova.conf&#123;,.bak2&#125;</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 有时候碰到硬盘太大,比如需要创建80G的虚拟机,则会创建失败,需要修改nova.conf里面的vif超时参数</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf DEFAULT vif_plugging_timeout 0</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf DEFAULT vif_plugging_is_fatal False</span><br><span class="line"></span><br><span class="line"><span class="comment"># 支持虚拟机硬件加速;前面已添加</span></span><br><span class="line"><span class="comment">#openstack-config --set /etc/nova/nova.conf libvirt virt_type qemu</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf libvirt images_type rbd</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf libvirt images_rbd_pool vms</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf libvirt images_rbd_ceph_conf /etc/ceph/ceph.conf</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf libvirt rbd_user cinder</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf libvirt rbd_secret_uuid bae8efd1-e319-48cc-8fd0-9213dd0e3497</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf libvirt disk_cachemodes \&quot;network=writeback\&quot;</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf libvirt live_migration_flag \&quot;VIR_MIGRATE_UNDEFINE_SOURCE,VIR_MIGRATE_PEER2PEER,VIR_MIGRATE_LIVE,VIR_MIGRATE_PERSIST_DEST,VIR_MIGRATE_TUNNELLED\&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用文件注入</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf libvirt inject_password <span class="literal">false</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf libvirt inject_key <span class="literal">false</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf libvirt inject_partition -2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 虚拟机临时root磁盘discard功能;unmap参数在scsi接口类型磁盘释放后可立即释放空间</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/nova/nova.conf libvirt hw_disk_discard unmap</span><br></pre></td></tr></table></figure></div>

<h3 id="重启计算服务"><a href="#重启计算服务" class="headerlink" title="重启计算服务"></a>重启计算服务</h3><p>在全部计算节点操作;</p>
<div class="highlight-container" data-rel="Lua"><figure class="iseeu highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart libvirtd.service openstack-nova-compute.service</span><br><span class="line">systemctl <span class="built_in">status</span> libvirtd.service openstack-nova-compute.service</span><br></pre></td></tr></table></figure></div>

<h3 id="配置live-migration热迁移"><a href="#配置live-migration热迁移" class="headerlink" title="配置live-migration热迁移"></a>配置live-migration热迁移</h3><p><strong>修改&#x2F;etc&#x2F;libvirt&#x2F;libvirtd.conf</strong></p>
<p>在全部计算节点操作，以compute01节点为例；</p>
<p>以下给出libvirtd.conf文件的修改处所在的行num</p>
<div class="highlight-container" data-rel="Ruby"><figure class="iseeu highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#compute01</span></span><br><span class="line">[root<span class="variable">@compute01</span> ~]<span class="comment"># egrep -vn &quot;^$|^#&quot; /etc/libvirt/libvirtd.conf</span></span><br><span class="line"><span class="number">20</span><span class="symbol">:listen_tls</span> = <span class="number">0</span></span><br><span class="line"><span class="number">34</span><span class="symbol">:listen_tcp</span> = <span class="number">1</span></span><br><span class="line"><span class="number">52</span><span class="symbol">:tcp_port</span> = <span class="string">&quot;16509&quot;</span></span><br><span class="line"><span class="comment">#取消注释,并修改监听端口</span></span><br><span class="line"><span class="number">65</span><span class="symbol">:listen_addr</span> = <span class="string">&quot;10.10.10.41&quot;</span></span><br><span class="line"><span class="comment">#取消注释,同时取消认证</span></span><br><span class="line"><span class="number">167</span><span class="symbol">:auth_tcp</span> = <span class="string">&quot;none&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#compute02</span></span><br><span class="line">[root<span class="variable">@compute02</span> ~]<span class="comment"># egrep -vn &quot;^$|^#&quot; /etc/libvirt/libvirtd.conf</span></span><br><span class="line"><span class="number">20</span><span class="symbol">:listen_tls</span> = <span class="number">0</span></span><br><span class="line"><span class="number">34</span><span class="symbol">:listen_tcp</span> = <span class="number">1</span></span><br><span class="line"><span class="number">52</span><span class="symbol">:tcp_port</span> = <span class="string">&quot;16509&quot;</span></span><br><span class="line"><span class="number">65</span><span class="symbol">:listen_addr</span> = <span class="string">&quot;10.10.10.42&quot;</span></span><br><span class="line"><span class="number">167</span><span class="symbol">:auth_tcp</span> = <span class="string">&quot;none&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p><strong>修改&#x2F;etc&#x2F;sysconfig&#x2F;libvirtd</strong></p>
<p>在全部计算节点操作，以compute01节点为例；设置libvirtd 服务监听</p>
<div class="highlight-container" data-rel="Ruby"><figure class="iseeu highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@compute01</span> ~]<span class="comment"># egrep -vn &quot;^$|^#&quot; /etc/sysconfig/libvirtd</span></span><br><span class="line"><span class="number">12</span><span class="symbol">:LIBVIRTD_ARGS=<span class="string">&quot;--listen&quot;</span></span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@compute02</span> ~]<span class="comment"># egrep -vn &quot;^$|^#&quot; /etc/sysconfig/libvirtd</span></span><br><span class="line"><span class="number">12</span><span class="symbol">:LIBVIRTD_ARGS=<span class="string">&quot;--listen&quot;</span></span></span><br></pre></td></tr></table></figure></div>

<h3 id="计算节点设置免密访问"><a href="#计算节点设置免密访问" class="headerlink" title="计算节点设置免密访问"></a>计算节点设置免密访问</h3><p>所有计算节点都必须相互设置nova用户免密，迁移必须，不做迁移会失败；</p>
<div class="highlight-container" data-rel="Ruby"><figure class="iseeu highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有计算节点操作</span></span><br><span class="line"><span class="comment"># 设置登陆 shell</span></span><br><span class="line">usermod  -s /bin/bash nova</span><br><span class="line"><span class="comment"># 设置一个密码</span></span><br><span class="line">passwd nova</span><br><span class="line"></span><br><span class="line"><span class="comment"># compute01 操作即可</span></span><br><span class="line">su - nova</span><br><span class="line"><span class="comment"># 生成密钥</span></span><br><span class="line">ssh-keygen -t rsa -P <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝公钥给本机</span></span><br><span class="line">ssh-copy-id -i .ssh/id_rsa.pub nova<span class="variable">@localhost</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝 .ssh 目录所有文件到集群其他节点</span></span><br><span class="line">scp -rp .ssh/ nova<span class="variable">@compute02</span><span class="symbol">:/var/lib/nova</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh 登陆测试</span></span><br><span class="line"><span class="comment"># compute01 nova 账号测试</span></span><br><span class="line">ssh nova<span class="variable">@compute02</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># compute02 nova 账号测试</span></span><br><span class="line">ssh nova<span class="variable">@compute0</span>1</span><br></pre></td></tr></table></figure></div>

<h3 id="设置iptables"><a href="#设置iptables" class="headerlink" title="设置iptables"></a>设置iptables</h3><p>测试环境已经关闭了iptables，因此暂时不需要设置；正式环境需要配置</p>
<ul>
<li>live-migration时，源计算节点主动连接目的计算节点 <code>tcp 16509</code> 端口，可以使用 <code>virsh -c qemu+tcp://&#123;node_ip or node_name&#125;/system</code> 连接目的计算节点测试;</li>
<li>迁移前后，在源目地计算节点上的被迁移instance使用 <code>tcp 49152~49161</code> 端口做临时通信；</li>
<li>因虚拟机已经启用iptables相关规则，此时切忌随意重启iptables服务，尽量使用插入的方式添加规则；</li>
<li>同时以修改配置文件的方式写入相关规则，切忌使用 <code>iptables saved</code> 命令；</li>
</ul>
<p>在全部计算节点操作；</p>
<div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -<span class="selector-tag">I</span> <span class="selector-tag">INPUT</span> -<span class="selector-tag">p</span> tcp -m state <span class="attr">--state</span> NEW -m tcp <span class="attr">--dport</span> <span class="number">16509</span> -j ACCEPT</span><br><span class="line">iptables -<span class="selector-tag">I</span> <span class="selector-tag">INPUT</span> -<span class="selector-tag">p</span> tcp -m state <span class="attr">--state</span> NEW -m tcp <span class="attr">--dport</span> <span class="number">49152</span>:<span class="number">49161</span> -j ACCEPT</span><br></pre></td></tr></table></figure></div>

<h3 id="需重启服务"><a href="#需重启服务" class="headerlink" title="需重启服务"></a>需重启服务</h3><p>全部计算节点操作；</p>
<div class="highlight-container" data-rel="Lua"><figure class="iseeu highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl mask libvirtd.socket libvirtd-ro.socket libvirtd-admin.socket libvirtd-tls.socket libvirtd-tcp.socket</span><br><span class="line">systemctl restart libvirtd.service</span><br><span class="line">systemctl restart openstack-nova-compute.service</span><br><span class="line">systemctl <span class="built_in">status</span> libvirtd.service openstack-nova-compute.service</span><br><span class="line">ss -ntlp|grep libvirtd</span><br></pre></td></tr></table></figure></div>

<h3 id="验证热迁移"><a href="#验证热迁移" class="headerlink" title="验证热迁移"></a>验证热迁移</h3><p>首先创建一个存储在 ceph 中是实例</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111111032591.png"
                      alt="image-20211111103241520"
                ></p>
<ul>
<li>卷大小就是实例 &#x2F; 目录的大小</li>
<li>创建新卷选项选择不的话，实例还是存储在计算节点本机目录：&#x2F;var&#x2F;lib&#x2F;nova&#x2F;instances&#x2F;，不能实现热迁移</li>
<li>其他选项和创建普通实例没区别，就不列出了</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111111036789.png"
                      alt="image-20211111103628096"
                ></p>
<p>查看 s1 在哪个计算节点</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line">[root@controller01 ~]# source admin-openrc</span><br><span class="line">[root@controller01 ~]#</span><br><span class="line">[root@controller01 ~]# nova list</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+---------------------+</span><br><span class="line">| ID                                   | Name | Status | Task State | Power State | Networks            |</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+---------------------+</span><br><span class="line">| d5a0812e-59ba-4508-ac35-636717e20f04 | s1   | ACTIVE | -          | Running     | vpc03=172.20.10.168 |</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+---------------------+</span><br><span class="line">[root@controller01 ~]#</span><br><span class="line">[root@controller01 ~]# nova show s1</span><br><span class="line">+--------------------------------------+----------------------------------------------------------------------------------+</span><br><span class="line">| Property                             | Value                                                                            |</span><br><span class="line">+--------------------------------------+----------------------------------------------------------------------------------+</span><br><span class="line">| OS-DCF:diskConfig                    | AUTO                                                                             |</span><br><span class="line">| OS-EXT-AZ:availability_zone          | nova                                                                             |</span><br><span class="line">| OS-EXT-SRV-ATTR:host                 | compute02                                                                        |</span><br><span class="line">| OS-EXT-SRV-ATTR:hostname             | s1                                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname  | compute02                                                                        |</span><br><span class="line">| OS-EXT-SRV-ATTR:instance_name        | instance-00000061                                                                |</span><br><span class="line">| OS-EXT-SRV-ATTR:kernel_id            |                                                                                  |</span><br><span class="line">| OS-EXT-SRV-ATTR:launch_index         | 0                                                                                |</span><br><span class="line">| OS-EXT-SRV-ATTR:ramdisk_id           |                                                                                  |</span><br><span class="line">| OS-EXT-SRV-ATTR:reservation_id       | r-rny3edjk                                                                       |</span><br><span class="line">| OS-EXT-SRV-ATTR:root_device_name     | /dev/vda                                                                         |</span><br><span class="line">| OS-EXT-SRV-ATTR:user_data            | -                                                                                |</span><br><span class="line">| OS-EXT-STS:power_state               | 1                                                                                |</span><br><span class="line">| OS-EXT-STS:task_state                | -                                                                                |</span><br><span class="line">| OS-EXT-STS:vm_state                  | active                                                                           |</span><br><span class="line">| OS-SRV-USG:launched_at               | 2021-11-11T02:35:56.000000                                                       |</span><br><span class="line">| OS-SRV-USG:terminated_at             | -                                                                                |</span><br><span class="line">| accessIPv4                           |                                                                                  |</span><br><span class="line">| accessIPv6                           |                                                                                  |</span><br><span class="line">| config_drive                         |                                                                                  |</span><br><span class="line">| created                              | 2021-11-11T02:35:48Z                                                             |</span><br><span class="line">| description                          | -                                                                                |</span><br><span class="line">| flavor:disk                          | 10                                                                               |</span><br><span class="line">| flavor:ephemeral                     | 0                                                                                |</span><br><span class="line">| flavor:extra_specs                   | &#123;&#125;                                                                               |</span><br><span class="line">| flavor:original_name                 | instance1                                                                        |</span><br><span class="line">| flavor:ram                           | 256                                                                              |</span><br><span class="line">| flavor:swap                          | 128                                                                              |</span><br><span class="line">| flavor:vcpus                         | 1                                                                                |</span><br><span class="line">| hostId                               | 5822a85b8dd4e33ef68488497628775f8a77b492223e44535c31858d                         |</span><br><span class="line">| host_status                          | UP                                                                               |</span><br><span class="line">| id                                   | d5a0812e-59ba-4508-ac35-636717e20f04                                             |</span><br><span class="line">| image                                | Attempt to boot from volume - no image supplied                                  |</span><br><span class="line">| key_name                             | -                                                                                |</span><br><span class="line">| locked                               | False                                                                            |</span><br><span class="line">| locked_reason                        | -                                                                                |</span><br><span class="line">| metadata                             | &#123;&#125;                                                                               |</span><br><span class="line">| name                                 | s1                                                                               |</span><br><span class="line">| os-extended-volumes:volumes_attached | [&#123;&quot;id&quot;: &quot;03a348c2-f5cb-4258-ae7c-f4b4462c9856&quot;, &quot;delete_on_termination&quot;: false&#125;] |</span><br><span class="line">| progress                             | 0                                                                                |</span><br><span class="line">| security_groups                      | default                                                                          |</span><br><span class="line">| server_groups                        | []                                                                               |</span><br><span class="line">| status                               | ACTIVE                                                                           |</span><br><span class="line">| tags                                 | []                                                                               |</span><br><span class="line">| tenant_id                            | 60f490ceabcb493db09bdd4c1990655f                                                 |</span><br><span class="line">| trusted_image_certificates           | -                                                                                |</span><br><span class="line">| updated                              | 2021-11-11T02:35:57Z                                                             |</span><br><span class="line">| user_id                              | 05a3ad27698e41b0a3e10a6daffbf64e                                                 |</span><br><span class="line">| vpc03 network                        | 172.20.10.168                                                                    |</span><br><span class="line">+--------------------------------------+----------------------------------------------------------------------------------+</span><br><span class="line">[root@controller01 ~]#</span><br><span class="line"># 当前在 compute02 上，迁移到 compute01</span><br><span class="line">[root@controller01 ~]# nova live-migration s1 compute01</span><br><span class="line">[root@controller01 ~]#</span><br><span class="line">[root@controller01 ~]# nova list</span><br><span class="line">+--------------------------------------+------+-----------+------------+-------------+---------------------+</span><br><span class="line">| ID                                   | Name | Status    | Task State | Power State | Networks            |</span><br><span class="line">+--------------------------------------+------+-----------+------------+-------------+---------------------+</span><br><span class="line">| d5a0812e-59ba-4508-ac35-636717e20f04 | s1   | MIGRATING | migrating  | Running     | vpc03=172.20.10.168 |</span><br><span class="line">+--------------------------------------+------+-----------+------------+-------------+---------------------+</span><br><span class="line">[root@controller01 ~]#</span><br><span class="line">[root@controller01 ~]#</span><br><span class="line">[root@controller01 ~]# nova list</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+---------------------+</span><br><span class="line">| ID                                   | Name | Status | Task State | Power State | Networks            |</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+---------------------+</span><br><span class="line">| d5a0812e-59ba-4508-ac35-636717e20f04 | s1   | ACTIVE | -          | Running     | vpc03=172.20.10.168 |</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+---------------------+</span><br><span class="line">[root@controller01 ~]#</span><br><span class="line">+--------------------------------------+----------------------------------------------------------------------------------+</span><br><span class="line">| Property                             | Value                                                                            |</span><br><span class="line">+--------------------------------------+----------------------------------------------------------------------------------+</span><br><span class="line">| OS-DCF:diskConfig                    | AUTO                                                                             |</span><br><span class="line">| OS-EXT-AZ:availability_zone          | nova                                                                             |</span><br><span class="line">| OS-EXT-SRV-ATTR:host                 | compute01                                                                        |</span><br><span class="line">| OS-EXT-SRV-ATTR:hostname             | s1                                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname  | compute01                                                                        |</span><br><span class="line">| OS-EXT-SRV-ATTR:instance_name        | instance-00000061                                                                |</span><br><span class="line">| OS-EXT-SRV-ATTR:kernel_id            |                                                                                  |</span><br><span class="line">| OS-EXT-SRV-ATTR:launch_index         | 0                                                                                |</span><br><span class="line">| OS-EXT-SRV-ATTR:ramdisk_id           |                                                                                  |</span><br><span class="line">| OS-EXT-SRV-ATTR:reservation_id       | r-rny3edjk                                                                       |</span><br><span class="line">| OS-EXT-SRV-ATTR:root_device_name     | /dev/vda                                                                         |</span><br><span class="line">| OS-EXT-SRV-ATTR:user_data            | -                                                                                |</span><br><span class="line">| OS-EXT-STS:power_state               | 1                                                                                |</span><br><span class="line">| OS-EXT-STS:task_state                | -                                                                                |</span><br><span class="line">| OS-EXT-STS:vm_state                  | active                                                                           |</span><br><span class="line">| OS-SRV-USG:launched_at               | 2021-11-11T02:35:56.000000                                                       |</span><br><span class="line">| OS-SRV-USG:terminated_at             | -                                                                                |</span><br><span class="line">| accessIPv4                           |                                                                                  |</span><br><span class="line">| accessIPv6                           |                                                                                  |</span><br><span class="line">| config_drive                         |                                                                                  |</span><br><span class="line">| created                              | 2021-11-11T02:35:48Z                                                             |</span><br><span class="line">| description                          | -                                                                                |</span><br><span class="line">| flavor:disk                          | 10                                                                               |</span><br><span class="line">| flavor:ephemeral                     | 0                                                                                |</span><br><span class="line">| flavor:extra_specs                   | &#123;&#125;                                                                               |</span><br><span class="line">| flavor:original_name                 | instance1                                                                        |</span><br><span class="line">| flavor:ram                           | 256                                                                              |</span><br><span class="line">| flavor:swap                          | 128                                                                              |</span><br><span class="line">| flavor:vcpus                         | 1                                                                                |</span><br><span class="line">| hostId                               | bcb1cd1c0027f77a3e41d871686633a7e9dc272b27252fadf846e887                         |</span><br><span class="line">| host_status                          | UP                                                                               |</span><br><span class="line">| id                                   | d5a0812e-59ba-4508-ac35-636717e20f04                                             |</span><br><span class="line">| image                                | Attempt to boot from volume - no image supplied                                  |</span><br><span class="line">| key_name                             | -                                                                                |</span><br><span class="line">| locked                               | False                                                                            |</span><br><span class="line">| locked_reason                        | -                                                                                |</span><br><span class="line">| metadata                             | &#123;&#125;                                                                               |</span><br><span class="line">| name                                 | s1                                                                               |</span><br><span class="line">| os-extended-volumes:volumes_attached | [&#123;&quot;id&quot;: &quot;03a348c2-f5cb-4258-ae7c-f4b4462c9856&quot;, &quot;delete_on_termination&quot;: false&#125;] |</span><br><span class="line">| progress                             | 0                                                                                |</span><br><span class="line">| security_groups                      | default                                                                          |</span><br><span class="line">| server_groups                        | []                                                                               |</span><br><span class="line">| status                               | ACTIVE                                                                           |</span><br><span class="line">| tags                                 | []                                                                               |</span><br><span class="line">| tenant_id                            | 60f490ceabcb493db09bdd4c1990655f                                                 |</span><br><span class="line">| trusted_image_certificates           | -                                                                                |</span><br><span class="line">| updated                              | 2021-11-11T02:39:41Z                                                             |</span><br><span class="line">| user_id                              | 05a3ad27698e41b0a3e10a6daffbf64e                                                 |</span><br><span class="line">| vpc03 network                        | 172.20.10.168                                                                    |</span><br><span class="line">+--------------------------------------+----------------------------------------------------------------------------------+</span><br><span class="line">[root@controller01 ~]#</span><br><span class="line"># 查看实例所在节点</span><br><span class="line">[root@controller01 ~]# nova hypervisor-servers compute01</span><br><span class="line">+--------------------------------------+-------------------+--------------------------------------+---------------------+</span><br><span class="line">| ID                                   | Name              | Hypervisor ID                        | Hypervisor Hostname |</span><br><span class="line">+--------------------------------------+-------------------+--------------------------------------+---------------------+</span><br><span class="line">| d5a0812e-59ba-4508-ac35-636717e20f04  | instance-0000006d | ed0a899f-d898-4a73-9100-a69a26edb932 | compute01           |</span><br><span class="line">+--------------------------------------+-------------------+--------------------------------------+---------------------+</span><br><span class="line"></span><br><span class="line"># 计算节点上 qemu 的对应的实例配置文件记录着挂载的磁盘，<span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span> 配置段</span><br><span class="line">[root@compute01 ~]# cat /etc/libvirt/qemu/instance-0000006d.xml</span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</span></span><br><span class="line"><span class="comment">OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:</span></span><br><span class="line"><span class="comment">virsh edit instance-0000006d</span></span><br><span class="line"><span class="comment">or other application using the libvirt API.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;qemu&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-0000006d<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uuid</span>&gt;</span>e4bbad3e-499b-442b-9789-5fb386edfb3f<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">metadata</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:instance</span> <span class="attr">xmlns:nova</span>=<span class="string">&quot;http://openstack.org/xmlns/libvirt/nova/1.0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:package</span> <span class="attr">version</span>=<span class="string">&quot;20.6.0-1.el7&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:name</span>&gt;</span>s1<span class="tag">&lt;/<span class="name">nova:name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:creationTime</span>&gt;</span>2021-11-11 05:34:19<span class="tag">&lt;/<span class="name">nova:creationTime</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:flavor</span> <span class="attr">name</span>=<span class="string">&quot;instance2&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:memory</span>&gt;</span>2048<span class="tag">&lt;/<span class="name">nova:memory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:disk</span>&gt;</span>20<span class="tag">&lt;/<span class="name">nova:disk</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:swap</span>&gt;</span>0<span class="tag">&lt;/<span class="name">nova:swap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:ephemeral</span>&gt;</span>0<span class="tag">&lt;/<span class="name">nova:ephemeral</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:vcpus</span>&gt;</span>2<span class="tag">&lt;/<span class="name">nova:vcpus</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nova:flavor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:owner</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:user</span> <span class="attr">uuid</span>=<span class="string">&quot;05a3ad27698e41b0a3e10a6daffbf64e&quot;</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">nova:user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nova:project</span> <span class="attr">uuid</span>=<span class="string">&quot;60f490ceabcb493db09bdd4c1990655f&quot;</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">nova:project</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nova:owner</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nova:instance</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">metadata</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>2097152<span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>2097152<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shares</span>&gt;</span>2048<span class="tag">&lt;/<span class="name">shares</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sysinfo</span> <span class="attr">type</span>=<span class="string">&#x27;smbios&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">system</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;manufacturer&#x27;</span>&gt;</span>RDO<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;product&#x27;</span>&gt;</span>OpenStack Compute<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;version&#x27;</span>&gt;</span>20.6.0-1.el7<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;serial&#x27;</span>&gt;</span>e4bbad3e-499b-442b-9789-5fb386edfb3f<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;uuid&#x27;</span>&gt;</span>e4bbad3e-499b-442b-9789-5fb386edfb3f<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;family&#x27;</span>&gt;</span>Virtual Machine<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">system</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sysinfo</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">&#x27;x86_64&#x27;</span> <span class="attr">machine</span>=<span class="string">&#x27;pc-i440fx-rhel7.6.0&#x27;</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">boot</span> <span class="attr">dev</span>=<span class="string">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">smbios</span> <span class="attr">mode</span>=<span class="string">&#x27;sysinfo&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-model&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;partial&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">model</span> <span class="attr">fallback</span>=<span class="string">&#x27;allow&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">&#x27;utc&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;writeback&#x27;</span> <span class="attr">discard</span>=<span class="string">&#x27;unmap&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">auth</span> <span class="attr">username</span>=<span class="string">&#x27;cinder&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">secret</span> <span class="attr">type</span>=<span class="string">&#x27;ceph&#x27;</span> <span class="attr">uuid</span>=<span class="string">&#x27;bae8efd1-e319-48cc-8fd0-9213dd0e3497&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">auth</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">source</span> <span class="attr">protocol</span>=<span class="string">&#x27;rbd&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;volumes/volume-4106914a-7f5c-4723-b3f8-410cb955d6d3&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;10.10.50.51&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;10.10.50.52&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;10.10.50.53&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">serial</span>&gt;</span>4106914a-7f5c-4723-b3f8-410cb955d6d3<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;writeback&#x27;</span> <span class="attr">discard</span>=<span class="string">&#x27;unmap&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">auth</span> <span class="attr">username</span>=<span class="string">&#x27;cinder&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">secret</span> <span class="attr">type</span>=<span class="string">&#x27;ceph&#x27;</span> <span class="attr">uuid</span>=<span class="string">&#x27;bae8efd1-e319-48cc-8fd0-9213dd0e3497&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">auth</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">source</span> <span class="attr">protocol</span>=<span class="string">&#x27;rbd&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;volumes/volume-6c5c6991-ca91-455d-835b-c3e0e9651ef6&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;10.10.50.51&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;10.10.50.52&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;10.10.50.53&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vdb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">serial</span>&gt;</span>6c5c6991-ca91-455d-835b-c3e0e9651ef6<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x06&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;piix3-uhci&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x01&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pci-root&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;bridge&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;fa:16:3e:66:ba:0c&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">source</span> <span class="attr">bridge</span>=<span class="string">&#x27;brq7f327278-8f&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;tapea75128c-89&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mtu</span> <span class="attr">size</span>=<span class="string">&#x27;1450&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x03&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">log</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/e4bbad3e-499b-442b-9789-5fb386edfb3f/console.log&#x27;</span> <span class="attr">append</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;isa-serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">log</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/e4bbad3e-499b-442b-9789-5fb386edfb3f/console.log&#x27;</span> <span class="attr">append</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;tablet&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;mouse&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;keyboard&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;vnc&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;-1&#x27;</span> <span class="attr">autoport</span>=<span class="string">&#x27;yes&#x27;</span> <span class="attr">listen</span>=<span class="string">&#x27;0.0.0.0&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">&#x27;address&#x27;</span> <span class="attr">address</span>=<span class="string">&#x27;0.0.0.0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;cirrus&#x27;</span> <span class="attr">vram</span>=<span class="string">&#x27;16384&#x27;</span> <span class="attr">heads</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">primary</span>=<span class="string">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;virtio&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">stats</span> <span class="attr">period</span>=<span class="string">&#x27;10&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">memballoon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>迁移会把实例整个内存状态也迁移过去，注意目标计算节点的空闲资源</li>
<li>迁移过程中实例会出现闪断，具体闪断时间跟实例内存大小有关</li>
<li>如果迁移出错，可以查看日志：控制节点 &#x2F;var&#x2F;log&#x2F;nova&#x2F;nova-conductor.log，或者计算节点 &#x2F;var&#x2F;log&#x2F;nova&#x2F;nova-compute.log</li>
</ul>
<h1 id="十五、负载均衡Octavia部署"><a href="#十五、负载均衡Octavia部署" class="headerlink" title="十五、负载均衡Octavia部署"></a>十五、负载均衡Octavia部署</h1><h2 id="更新-haproxy-配置"><a href="#更新-haproxy-配置" class="headerlink" title="更新 haproxy 配置"></a>更新 haproxy 配置</h2><p>ha 高可用节点 &#x2F;etc&#x2F;haproxy&#x2F;haproxy.cfg新增配置：</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> listen octavia_api_cluster</span><br><span class="line">bind <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span>:<span class="number">9876</span></span><br><span class="line">balance  source</span><br><span class="line">option  tcpka</span><br><span class="line">option  httpchk</span><br><span class="line">option  tcplog</span><br><span class="line">server controller01 <span class="number">10.10</span><span class="number">.10</span><span class="number">.31</span>:<span class="number">9876</span> <span class="keyword">check</span> inter <span class="number">2000</span> rise <span class="number">2</span> fall <span class="number">5</span></span><br><span class="line">server controller02 <span class="number">10.10</span><span class="number">.10</span><span class="number">.32</span>:<span class="number">9876</span> <span class="keyword">check</span> inter <span class="number">2000</span> rise <span class="number">2</span> fall <span class="number">5</span></span><br><span class="line">server controller03 <span class="number">10.10</span><span class="number">.10</span><span class="number">.33</span>:<span class="number">9876</span> <span class="keyword">check</span> inter <span class="number">2000</span> rise <span class="number">2</span> fall <span class="number">5</span></span><br></pre></td></tr></table></figure></div>

<h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><p>任意控制节点执行；</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123456</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE octavia;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> octavia.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;octavia&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> octavia.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;octavia&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line">exit;</span><br></pre></td></tr></table></figure></div>

<h2 id="创建octavia的keystone认证体系（用户、角色、endpoint）"><a href="#创建octavia的keystone认证体系（用户、角色、endpoint）" class="headerlink" title="创建octavia的keystone认证体系（用户、角色、endpoint）"></a>创建octavia的keystone认证体系（用户、角色、endpoint）</h2><p>任意控制节点执行；</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">. <span class="operator">~</span><span class="operator">/</span>admin<span class="operator">-</span>openrc</span><br><span class="line">openstack <span class="keyword">user</span> <span class="keyword">create</span> <span class="comment">--domain default --password 123456 octavia</span></span><br><span class="line">#openstack role <span class="keyword">add</span> <span class="comment">--project admin --user octavia admin</span></span><br><span class="line">openstack role <span class="keyword">add</span> <span class="comment">--project service --user octavia admin</span></span><br><span class="line">openstack service <span class="keyword">create</span> <span class="comment">--name octavia --description &quot;OpenStack Octavia&quot; load-balancer</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne load-balancer public http://10.10.10.10:9876</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne load-balancer internal http://10.10.10.10:9876</span></span><br><span class="line">openstack endpoint <span class="keyword">create</span> <span class="comment">--region RegionOne load-balancer admin http://10.10.10.10:9876</span></span><br></pre></td></tr></table></figure></div>

<p>生成octavia-openrc，全部控制节点执行；</p>
<div class="highlight-container" data-rel="Delphi"><figure class="iseeu highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; ~/octavia-openrc &lt;&lt; EOF</span><br><span class="line"># octavia-openrc</span><br><span class="line"><span class="keyword">export</span> OS_USERNAME=octavia</span><br><span class="line"><span class="keyword">export</span> OS_PASSWORD=<span class="number">123456</span></span><br><span class="line"><span class="keyword">export</span> OS_PROJECT_NAME=service</span><br><span class="line"><span class="keyword">export</span> OS_USER_DOMAIN_NAME=<span class="keyword">Default</span></span><br><span class="line"><span class="keyword">export</span> OS_PROJECT_DOMAIN_NAME=<span class="keyword">Default</span></span><br><span class="line"><span class="keyword">export</span> OS_AUTH_URL=http:<span class="comment">//10.10.10.10:5000/v3</span></span><br><span class="line"><span class="keyword">export</span> OS_IDENTITY_API_VERSION=<span class="number">3</span></span><br><span class="line"><span class="keyword">export</span> OS_IMAGE_API_VERSION=<span class="number">2</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></div>

<h2 id="安装软件包-1"><a href="#安装软件包-1" class="headerlink" title="安装软件包"></a>安装软件包</h2><p>全部控制节点执行；</p>
<div class="highlight-container" data-rel="Mipsasm"><figure class="iseeu highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>-y openstack-octavia-api openstack-octavia-common openstack-octavia-health-manager openstack-octavia-housekeeping openstack-octavia-worker openstack-octavia-<span class="keyword">diskimage-create </span>python2-octaviaclient net-tools <span class="keyword">bridge-utils</span></span><br></pre></td></tr></table></figure></div>

<p>or 第二种安装方法</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/python-octaviaclient.git -b stable/train</span><br><span class="line"><span class="built_in">cd</span> python-octaviaclient</span><br><span class="line">pip install -r requirements.txt -e .</span><br></pre></td></tr></table></figure></div>

<h2 id="制作Amphora镜像"><a href="#制作Amphora镜像" class="headerlink" title="制作Amphora镜像"></a>制作Amphora镜像</h2><p>官方教程： <a class="link"   target="_blank" rel="noopener" href="https://docs.openstack.org/octavia/latest/admin/amphora-image-build.html" >Building Octavia Amphora Images — octavia 9.1.0.dev16 documentation (openstack.org) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>任意控制节点执行；</p>
<h3 id="升级-git"><a href="#升级-git" class="headerlink" title="升级 git"></a>升级 git</h3><p>centos7.9使用yum安装的git最新版本也只是1.8，无-C参数，会报错</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果不升级，制作镜像时报错</span></span><br><span class="line">2021-11-18 02:52:31.402 | Unknown option: -C</span><br><span class="line">2021-11-18 02:52:31.402 | usage: git [--version] [--<span class="built_in">help</span>] [-c name=value]</span><br><span class="line">2021-11-18 02:52:31.402 |            [--exec-path[=&lt;path&gt;]] [--html-path] [--man-path] [--info-path]</span><br><span class="line">2021-11-18 02:52:31.402 |            [-p|--paginate|--no-pager] [--no-replace-objects] [--bare]</span><br><span class="line">2021-11-18 02:52:31.402 |            [--git-dir=&lt;path&gt;] [--work-tree=&lt;path&gt;] [--namespace=&lt;name&gt;]</span><br><span class="line">2021-11-18 02:52:31.402 |            &lt;<span class="built_in">command</span>&gt; [&lt;args&gt;]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级 git</span></span><br><span class="line">yum install gcc openssl-devel libcurl-devel expat-devel zlib-devel perl cpio gettext-devel xmlto docbook2X autoconf xmlto -y</span><br><span class="line"></span><br><span class="line"><span class="built_in">ln</span> -s /usr/bin/db2x_docbook2texi /usr/bin/docbook2x-texi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 asciidoc:</span></span><br><span class="line"><span class="comment"># 到官网下载 asciidoc</span></span><br><span class="line"><span class="comment"># http://www.methods.co.nz/asciidoc/index.html</span></span><br><span class="line"><span class="comment"># http://sourceforge.net/projects/asciidoc/</span></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="built_in">cp</span> asciidoc-8.5.2.tar.gz /root/src</span><br><span class="line"><span class="built_in">cd</span> /root/src</span><br><span class="line">tar xvfz asciidoc-8.5.2.tar.gz</span><br><span class="line"><span class="built_in">cd</span> asciidoc-8.5.2</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/git/git</span><br><span class="line"><span class="built_in">cd</span> git</span><br><span class="line">make prefix=/usr/local install install-doc install-html install-info</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/bin</span><br><span class="line"><span class="built_in">mv</span> git&#123;,.bak&#125;</span><br><span class="line"><span class="built_in">mv</span> git-receive-pack&#123;,.bak&#125;</span><br><span class="line"><span class="built_in">mv</span> git-shell&#123;,.bak&#125;</span><br><span class="line"><span class="built_in">mv</span> git-upload-archive&#123;,.bak&#125;</span><br><span class="line"><span class="built_in">mv</span> git-upload-pack&#123;,.bak&#125;</span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/bin/git* /usr/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出重新登陆</span></span><br><span class="line">$ git --version</span><br><span class="line">git version 2.34.0</span><br></pre></td></tr></table></figure></div>

<h3 id="开始制作"><a href="#开始制作" class="headerlink" title="开始制作"></a>开始制作</h3><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">yum install python-pip -y</span><br><span class="line">pip install pip==20.0.1</span><br><span class="line">pip install virtualenv</span><br><span class="line">yum install python3 -y</span><br><span class="line">virtualenv -p /usr/bin/python3 octavia_disk_image_create</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> octavia_disk_image_create/bin/activate</span><br><span class="line"></span><br><span class="line">git config --global http.postBuffer 242800000</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/octavia.git</span><br><span class="line"><span class="built_in">cd</span> octavia/diskimage-create/</span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line">yum install qemu-img git e2fsprogs policycoreutils-python-utils -y</span><br><span class="line"></span><br><span class="line"><span class="comment">#export DIB_REPOLOCATION_amphora_agent=/root/octavia</span></span><br><span class="line">./diskimage-create.sh -i centos-minimal -t qcow2 -o amphora-x64-haproxy -s 5</span><br><span class="line"></span><br><span class="line">$ ll</span><br><span class="line">total 1463100</span><br><span class="line">drwxr-xr-x 3 root root         27 Nov 18 11:31 amphora-x64-haproxy.d</span><br><span class="line">-rw-r--r-- 1 root root  490209280 Nov 18 11:32 amphora-x64-haproxy.qcow2</span><br></pre></td></tr></table></figure></div>

<ul>
<li>-h 查看帮助，-i 设置发行系统，-r 指定 root 密码，生成环境不建议使用 root 密码</li>
<li>-s 大小最好和后面的 flavor 大小一样</li>
<li>制作镜像时脚本会去读取国外的源，网络环境不好的情况下会无法顺利创建镜像</li>
<li>注意这里不要加 -g stable&#x2F;train，使用这个方式制作的镜像有问题，跑出来的amphora实例会如下错误：</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># amphora 实例中 /var/log/amphora-agent.log 报错</span></span><br><span class="line"><span class="comment"># 这个问题折腾了好几天才搞定</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">11</span>-<span class="number">19</span> 06:09:<span class="number">16</span> +<span class="number">0000</span>] [<span class="number">1086</span>] [ERROR] Socket error processing request.</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">&quot;/opt/amphora-agent-venv/lib64/python3.6/site-packages/gunicorn/workers/sync.py&quot;</span>, line <span class="number">133</span>, <span class="keyword">in</span> handle</span><br><span class="line">req = <span class="built_in">next</span>(parser)</span><br><span class="line">File <span class="string">&quot;/opt/amphora-agent-venv/lib64/python3.6/site-packages/gunicorn/http/parser.py&quot;</span>, line <span class="number">41</span>, <span class="keyword">in</span> __next__</span><br><span class="line">self.mesg = self.mesg_class(self.cfg, self.unreader, self.req_count)</span><br><span class="line">File <span class="string">&quot;/opt/amphora-agent-venv/lib64/python3.6/site-packages/gunicorn/http/message.py&quot;</span>, line <span class="number">180</span>, <span class="keyword">in</span> __init__</span><br><span class="line"><span class="built_in">super</span>().__init__(cfg, unreader)</span><br><span class="line">File <span class="string">&quot;/opt/amphora-agent-venv/lib64/python3.6/site-packages/gunicorn/http/message.py&quot;</span>, line <span class="number">53</span>, <span class="keyword">in</span> __init__</span><br><span class="line">unused = self.parse(self.unreader)</span><br><span class="line">File <span class="string">&quot;/opt/amphora-agent-venv/lib64/python3.6/site-packages/gunicorn/http/message.py&quot;</span>, line <span class="number">192</span>, <span class="keyword">in</span> parse</span><br><span class="line">self.get_data(unreader, buf, stop=<span class="literal">True</span>)</span><br><span class="line">File <span class="string">&quot;/opt/amphora-agent-venv/lib64/python3.6/site-packages/gunicorn/http/message.py&quot;</span>, line <span class="number">183</span>, <span class="keyword">in</span> get_data</span><br><span class="line">data = unreader.read()</span><br><span class="line">File <span class="string">&quot;/opt/amphora-agent-venv/lib64/python3.6/site-packages/gunicorn/http/unreader.py&quot;</span>, line <span class="number">37</span>, <span class="keyword">in</span> read</span><br><span class="line">d = self.chunk()</span><br><span class="line">File <span class="string">&quot;/opt/amphora-agent-venv/lib64/python3.6/site-packages/gunicorn/http/unreader.py&quot;</span>, line <span class="number">64</span>, <span class="keyword">in</span> chunk</span><br><span class="line"><span class="keyword">return</span> self.sock.recv(self.mxchunk)</span><br><span class="line">File <span class="string">&quot;/usr/lib64/python3.6/ssl.py&quot;</span>, line <span class="number">956</span>, <span class="keyword">in</span> recv</span><br><span class="line"><span class="keyword">return</span> self.read(buflen)</span><br><span class="line">File <span class="string">&quot;/usr/lib64/python3.6/ssl.py&quot;</span>, line <span class="number">833</span>, <span class="keyword">in</span> read</span><br><span class="line"><span class="keyword">return</span> self._sslobj.read(<span class="built_in">len</span>, buffer)</span><br><span class="line">File <span class="string">&quot;/usr/lib64/python3.6/ssl.py&quot;</span>, line <span class="number">592</span>, <span class="keyword">in</span> read</span><br><span class="line">v = self._sslobj.read(<span class="built_in">len</span>)</span><br><span class="line">OSError: [Errno <span class="number">0</span>] Error</span><br></pre></td></tr></table></figure></div>

<h3 id="自行下载centos镜像制作"><a href="#自行下载centos镜像制作" class="headerlink" title="自行下载centos镜像制作"></a>自行下载centos镜像制作</h3><p>前面的方式是脚本自动下载镜像，还可以自行提前下载好镜像</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">wget https://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud-2009.qcow2</span><br><span class="line"></span><br><span class="line">yum install yum-utils -y</span><br><span class="line"></span><br><span class="line">yum install python3 -y</span><br><span class="line">pip3 install pyyaml</span><br><span class="line">pip3 install diskimage-builder</span><br><span class="line"><span class="built_in">cp</span> /usr/bin/pip3 /usr/bin/pip</span><br><span class="line">pip install --upgrade pip</span><br><span class="line"></span><br><span class="line">yum -y install libvirt libguestfs-tools</span><br><span class="line"></span><br><span class="line">systemctl start libvirtd</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> LIBGUESTFS_BACKEND=direct</span><br><span class="line"></span><br><span class="line"><span class="comment"># 时间有点久</span></span><br><span class="line">virt-customize -a CentOS-7-x86_64-GenericCloud-2009.qcow2  --selinux-relabel --run-command <span class="string">&#x27;yum install -y centos-release-openstack-train&#x27;</span></span><br><span class="line"></span><br><span class="line">git config --global http.postBuffer 242800000</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> DIB_REPOLOCATION_amphora_agent=/root/octavia</span><br><span class="line"><span class="built_in">export</span> DIB_LOCAL_IMAGE=/root/octavia/diskimage-create/CentOS-7-x86_64-GenericCloud-2009.qcow2</span><br><span class="line"></span><br><span class="line">./diskimage-create.sh -i centos-minimal -t qcow2 -o amphora-x64-haproxy -s 5</span><br></pre></td></tr></table></figure></div>

<h2 id="导入镜像"><a href="#导入镜像" class="headerlink" title="导入镜像"></a>导入镜像</h2><p>任意控制节点执行；</p>
<div class="highlight-container" data-rel="Smalltalk"><figure class="iseeu highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$ </span>. ~/octavia-openrc</span><br><span class="line"><span class="string">$ </span>openstack image create --disk-format qcow2 --container-format bare --private --tag amphora --file amphora-x64-haproxy.qcow2 amphora-x64-haproxy</span><br><span class="line"></span><br><span class="line"><span class="string">$ </span>openstack image list</span><br><span class="line">+--------------------------------------+---------------------+--------+</span><br><span class="line">| <span class="type">ID</span>                                   | <span class="type">Name</span>                | <span class="type">Status</span> |</span><br><span class="line">+--------------------------------------+---------------------+--------+</span><br><span class="line">| <span class="number">677</span>c0174-dffc<span class="number">-47</span>d8<span class="number">-828</span>b<span class="number">-26</span>aeb0ba44a5 | amphora-x64-haproxy | active |</span><br><span class="line">| c1f2829f<span class="number">-1</span>f52<span class="number">-48</span>c9<span class="number">-8</span>c23<span class="number">-689</span>f1a745ebd | cirros-qcow2        | active |</span><br><span class="line">| <span class="number">4</span>ea7b60f-b7ed<span class="number">-4</span>b7e<span class="number">-8</span>f37-a02c85099ec5 | cirros-qcow2<span class="number">-0.5</span><span class="number">.2</span>  | active |</span><br><span class="line">+--------------------------------------+---------------------+--------+</span><br></pre></td></tr></table></figure></div>

<p>镜像注册到其中一台控制节点，需要手动复制到其他控制节点上，并且修改镜像权限，否则会报错，使用 ceph 后不需要</p>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@controller03 ~</span>]<span class="meta"># ls -l /var/lib/glance/images/</span></span><br><span class="line">total <span class="number">510596</span></span><br><span class="line">-rw-r----- <span class="number">1</span> glance glance  <span class="number">16300544</span> Nov <span class="number">16</span> <span class="number">19</span>:<span class="number">49</span> <span class="number">4</span>ea7b60f-b7ed<span class="number">-4b</span>7e<span class="number">-8f</span>37-a02c85099ec5</span><br><span class="line">-rw-r----- <span class="number">1</span> glance glance <span class="number">490209280</span> Nov <span class="number">18</span> <span class="number">12</span>:<span class="number">20</span> <span class="number">677</span>c0174-dffc<span class="number">-47</span>d8<span class="number">-828b</span><span class="number">-26</span>aeb0ba44a5</span><br><span class="line">-rw-r----- <span class="number">1</span> glance glance  <span class="number">16338944</span> Nov <span class="number">16</span> <span class="number">15</span>:<span class="number">42</span> c1f2829f<span class="number">-1f</span>52<span class="number">-48</span>c9<span class="number">-8</span>c23<span class="number">-689f</span>1a745ebd</span><br><span class="line">[<span class="meta">root@controller03 ~</span>]<span class="meta">#</span></span><br><span class="line">[<span class="meta">root@controller03 ~</span>]<span class="meta"># cd /var/lib/glance/images/</span></span><br><span class="line">[<span class="meta">root@controller03 ~</span>]<span class="meta">#</span></span><br><span class="line">[<span class="meta">root@controller03 images</span>]<span class="meta"># scp 677c0174-dffc-47d8-828b-26aeb0ba44a5 controller01:/var/lib/glance/images/</span></span><br><span class="line"><span class="number">677</span>c0174-dffc<span class="number">-47</span>d8<span class="number">-828b</span><span class="number">-26</span>aeb0ba44a5                                                           <span class="number">100</span>%  <span class="number">468</span>MB  <span class="number">94.4</span>MB/s   <span class="number">00</span>:<span class="number">04</span></span><br><span class="line">[<span class="meta">root@controller03 images</span>]<span class="meta">#</span></span><br><span class="line">[<span class="meta">root@controller03 images</span>]<span class="meta"># scp 677c0174-dffc-47d8-828b-26aeb0ba44a5 controller02:/var/lib/glance/images/</span></span><br><span class="line"><span class="number">677</span>c0174-dffc<span class="number">-47</span>d8<span class="number">-828b</span><span class="number">-26</span>aeb0ba44a5                                                           <span class="number">100</span>%  <span class="number">468</span>MB  <span class="number">97.4</span>MB/s   <span class="number">00</span>:<span class="number">04</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">root@controller01 ~</span>]<span class="meta"># chown -R glance:glance /var/lib/glance/images/*</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">root@controller02 ~</span>]<span class="meta"># chown -R glance:glance /var/lib/glance/images/*</span></span><br></pre></td></tr></table></figure></div>

<h2 id="创建实例模板"><a href="#创建实例模板" class="headerlink" title="创建实例模板"></a>创建实例模板</h2><p>任意控制节点执行；</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 规则酌情修改,disk大小不能小于前面打包镜像是设置的<span class="operator">-</span>s大小</span><br><span class="line">$ openstack flavor <span class="keyword">create</span> <span class="comment">--id 200 --vcpus 1 --ram 512 --disk 5 &quot;amphora&quot; --private</span></span><br><span class="line">$ openstack flavor list <span class="comment">--all</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+-----------+------+------+-----------+-------+-----------+</span></span><br><span class="line"><span class="operator">|</span> ID                                   <span class="operator">|</span> Name      <span class="operator">|</span>  RAM <span class="operator">|</span> Disk <span class="operator">|</span> Ephemeral <span class="operator">|</span> VCPUs <span class="operator">|</span> <span class="keyword">Is</span> Public <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+-----------+------+------+-----------+-------+-----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">0e97</span>b5a0<span class="number">-8</span>cca<span class="number">-4126</span><span class="operator">-</span>baeb<span class="number">-9</span>d0194129985 <span class="operator">|</span> instance1 <span class="operator">|</span>  <span class="number">128</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> <span class="literal">True</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">200</span>                                  <span class="operator">|</span> amphora   <span class="operator">|</span> <span class="number">1024</span> <span class="operator">|</span>    <span class="number">5</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> <span class="literal">False</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">9</span>b87cf02<span class="number">-6e3</span>a<span class="number">-4</span>b00<span class="operator">-</span>ac26<span class="number">-048</span>d3b611d97 <span class="operator">|</span> instance2 <span class="operator">|</span> <span class="number">2048</span> <span class="operator">|</span>   <span class="number">10</span> <span class="operator">|</span>         <span class="number">0</span> <span class="operator">|</span>     <span class="number">4</span> <span class="operator">|</span> <span class="literal">True</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+-----------+------+------+-----------+-------+-----------+</span></span><br></pre></td></tr></table></figure></div>

<h2 id="创建认证密钥"><a href="#创建认证密钥" class="headerlink" title="创建认证密钥"></a>创建认证密钥</h2><p>octavia controller与amphora通信的证书，双向认证</p>
<p>官方教程： <a class="link"   target="_blank" rel="noopener" href="https://docs.openstack.org/octavia/latest/admin/guides/certificates.html" >Octavia Certificate Configuration Guide <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>任意控制节点执行；</p>
<p>创建目录</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> certs</span><br><span class="line"><span class="built_in">chmod</span> 700 certs</span><br><span class="line"><span class="built_in">cd</span> certs</span><br></pre></td></tr></table></figure></div>

<p>创建证书配置文件 vi openssl.cnf</p>
<div class="highlight-container" data-rel="Ini"><figure class="iseeu highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OpenSSL root CA configuration file.</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ ca ]</span></span><br><span class="line"><span class="comment"># `man ca`</span></span><br><span class="line"><span class="attr">default_ca</span> = CA_default</span><br><span class="line"></span><br><span class="line"><span class="section">[ CA_default ]</span></span><br><span class="line"><span class="comment"># Directory and file locations.</span></span><br><span class="line"><span class="attr">dir</span>               = ./</span><br><span class="line"><span class="attr">certs</span>             = <span class="variable">$dir</span>/certs</span><br><span class="line"><span class="attr">crl_dir</span>           = <span class="variable">$dir</span>/crl</span><br><span class="line"><span class="attr">new_certs_dir</span>     = <span class="variable">$dir</span>/newcerts</span><br><span class="line"><span class="attr">database</span>          = <span class="variable">$dir</span>/index.txt</span><br><span class="line"><span class="attr">serial</span>            = <span class="variable">$dir</span>/serial</span><br><span class="line"><span class="attr">RANDFILE</span>          = <span class="variable">$dir</span>/private/.rand</span><br><span class="line"></span><br><span class="line"><span class="comment"># The root key and root certificate.</span></span><br><span class="line"><span class="attr">private_key</span>       = <span class="variable">$dir</span>/private/ca.key.pem</span><br><span class="line"><span class="attr">certificate</span>       = <span class="variable">$dir</span>/certs/ca.cert.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># For certificate revocation lists.</span></span><br><span class="line"><span class="attr">crlnumber</span>         = <span class="variable">$dir</span>/crlnumber</span><br><span class="line"><span class="attr">crl</span>               = <span class="variable">$dir</span>/crl/ca.crl.pem</span><br><span class="line"><span class="attr">crl_extensions</span>    = crl_ext</span><br><span class="line"><span class="attr">default_crl_days</span>  = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SHA-1 is deprecated, so use SHA-2 instead.</span></span><br><span class="line"><span class="attr">default_md</span>        = sha256</span><br><span class="line"></span><br><span class="line"><span class="attr">name_opt</span>          = ca_default</span><br><span class="line"><span class="attr">cert_opt</span>          = ca_default</span><br><span class="line"><span class="attr">default_days</span>      = <span class="number">3650</span></span><br><span class="line"><span class="attr">preserve</span>          = <span class="literal">no</span></span><br><span class="line"><span class="attr">policy</span>            = policy_strict</span><br><span class="line"></span><br><span class="line"><span class="section">[ policy_strict ]</span></span><br><span class="line"><span class="comment"># The root CA should only sign intermediate certificates that match.</span></span><br><span class="line"><span class="comment"># See the POLICY FORMAT section of `man ca`.</span></span><br><span class="line"><span class="attr">countryName</span>             = match</span><br><span class="line"><span class="attr">stateOrProvinceName</span>     = match</span><br><span class="line"><span class="attr">organizationName</span>        = match</span><br><span class="line"><span class="attr">organizationalUnitName</span>  = optional</span><br><span class="line"><span class="attr">commonName</span>              = supplied</span><br><span class="line"><span class="attr">emailAddress</span>            = optional</span><br><span class="line"></span><br><span class="line"><span class="section">[ req ]</span></span><br><span class="line"><span class="comment"># Options for the `req` tool (`man req`).</span></span><br><span class="line"><span class="attr">default_bits</span>        = <span class="number">2048</span></span><br><span class="line"><span class="attr">distinguished_name</span>  = req_distinguished_name</span><br><span class="line"><span class="attr">string_mask</span>         = utf8only</span><br><span class="line"></span><br><span class="line"><span class="comment"># SHA-1 is deprecated, so use SHA-2 instead.</span></span><br><span class="line"><span class="attr">default_md</span>          = sha256</span><br><span class="line"></span><br><span class="line"><span class="comment"># Extension to add when the -x509 option is used.</span></span><br><span class="line"><span class="attr">x509_extensions</span>     = v3_ca</span><br><span class="line"></span><br><span class="line"><span class="section">[ req_distinguished_name ]</span></span><br><span class="line"><span class="comment"># See &lt;https://en.wikipedia.org/wiki/Certificate_signing_request&gt;.</span></span><br><span class="line"><span class="attr">countryName</span>                     = Country Name (<span class="number">2</span> letter code)</span><br><span class="line"><span class="attr">stateOrProvinceName</span>             = State or Province Name</span><br><span class="line"><span class="attr">localityName</span>                    = Locality Name</span><br><span class="line"><span class="attr">0.organizationName</span>              = Organization Name</span><br><span class="line"><span class="attr">organizationalUnitName</span>          = Organizational Unit Name</span><br><span class="line"><span class="attr">commonName</span>                      = Common Name</span><br><span class="line"><span class="attr">emailAddress</span>                    = Email Address</span><br><span class="line"></span><br><span class="line"><span class="comment"># Optionally, specify some defaults.</span></span><br><span class="line"><span class="attr">countryName_default</span>             = US</span><br><span class="line"><span class="attr">stateOrProvinceName_default</span>     = Oregon</span><br><span class="line"><span class="attr">localityName_default</span>            =</span><br><span class="line"><span class="attr">0.organizationName_default</span>      = OpenStack</span><br><span class="line"><span class="attr">organizationalUnitName_default</span>  = Octavia</span><br><span class="line"><span class="attr">emailAddress_default</span>            =</span><br><span class="line"><span class="attr">commonName_default</span>              = example.org</span><br><span class="line"></span><br><span class="line"><span class="section">[ v3_ca ]</span></span><br><span class="line"><span class="comment"># Extensions for a typical CA (`man x509v3_config`).</span></span><br><span class="line"><span class="attr">subjectKeyIdentifier</span> = hash</span><br><span class="line"><span class="attr">authorityKeyIdentifier</span> = keyid:always,issuer</span><br><span class="line"><span class="attr">basicConstraints</span> = critical, CA:<span class="literal">true</span></span><br><span class="line"><span class="attr">keyUsage</span> = critical, digitalSignature, cRLSign, keyCertSign</span><br><span class="line"></span><br><span class="line"><span class="section">[ usr_cert ]</span></span><br><span class="line"><span class="comment"># Extensions for client certificates (`man x509v3_config`).</span></span><br><span class="line"><span class="attr">basicConstraints</span> = CA:<span class="literal">FALSE</span></span><br><span class="line"><span class="attr">nsCertType</span> = client, email</span><br><span class="line"><span class="attr">nsComment</span> = <span class="string">&quot;OpenSSL Generated Client Certificate&quot;</span></span><br><span class="line"><span class="attr">subjectKeyIdentifier</span> = hash</span><br><span class="line"><span class="attr">authorityKeyIdentifier</span> = keyid,issuer</span><br><span class="line"><span class="attr">keyUsage</span> = critical, nonRepudiation, digitalSignature, keyEncipherment</span><br><span class="line"><span class="attr">extendedKeyUsage</span> = clientAuth, emailProtection</span><br><span class="line"></span><br><span class="line"><span class="section">[ server_cert ]</span></span><br><span class="line"><span class="comment"># Extensions for server certificates (`man x509v3_config`).</span></span><br><span class="line"><span class="attr">basicConstraints</span> = CA:<span class="literal">FALSE</span></span><br><span class="line"><span class="attr">nsCertType</span> = server</span><br><span class="line"><span class="attr">nsComment</span> = <span class="string">&quot;OpenSSL Generated Server Certificate&quot;</span></span><br><span class="line"><span class="attr">subjectKeyIdentifier</span> = hash</span><br><span class="line"><span class="attr">authorityKeyIdentifier</span> = keyid,issuer:always</span><br><span class="line"><span class="attr">keyUsage</span> = critical, digitalSignature, keyEncipherment</span><br><span class="line"><span class="attr">extendedKeyUsage</span> = serverAuth</span><br><span class="line"></span><br><span class="line"><span class="section">[ crl_ext ]</span></span><br><span class="line"><span class="comment"># Extension for CRLs (`man x509v3_config`).</span></span><br><span class="line"><span class="attr">authorityKeyIdentifier</span>=keyid:always</span><br></pre></td></tr></table></figure></div>

<ul>
<li>默认证书有效期 10 年，证书长度 2048 位</li>
</ul>
<p>从服务器证书颁发机构，准备服务器端 CA 密钥</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> client_ca</span><br><span class="line"><span class="built_in">mkdir</span> server_ca</span><br><span class="line"><span class="built_in">cd</span> server_ca</span><br><span class="line"><span class="built_in">mkdir</span> certs crl newcerts private</span><br><span class="line"><span class="built_in">chmod</span> 700 private</span><br><span class="line"><span class="built_in">touch</span> index.txt</span><br><span class="line"><span class="built_in">echo</span> 1000 &gt; serial</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要输入密码，这里设置 123456</span></span><br><span class="line">openssl genrsa -aes256 -out private/ca.key.pem 4096</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> 400 private/ca.key.pem</span><br></pre></td></tr></table></figure></div>

<p>签发服务器端 CA 证书</p>
<div class="highlight-container" data-rel="Delphi"><figure class="iseeu highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -config ../openssl.cnf -key <span class="keyword">private</span>/ca.key.pem -new -x509 -days <span class="number">7300</span> -sha256 -extensions v3_ca -<span class="keyword">out</span> certs/ca.cert.pem</span><br><span class="line"></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> <span class="keyword">private</span>/ca.key.pem:</span><br><span class="line">You are about <span class="keyword">to</span> be asked <span class="keyword">to</span> enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about <span class="keyword">to</span> enter <span class="keyword">is</span> what <span class="keyword">is</span> called a Distinguished <span class="keyword">Name</span> <span class="keyword">or</span> a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line"><span class="keyword">For</span> some fields there will be a <span class="keyword">default</span> value,</span><br><span class="line"><span class="keyword">If</span> you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country <span class="keyword">Name</span> (<span class="number">2</span> letter code) [US]:CN</span><br><span class="line">State <span class="keyword">or</span> Province <span class="keyword">Name</span> [Oregon]:SICHUAN</span><br><span class="line">Locality <span class="keyword">Name</span> []:CHENGDU</span><br><span class="line">Organization <span class="keyword">Name</span> [OpenStack]:</span><br><span class="line">Organizational <span class="keyword">Unit</span> <span class="keyword">Name</span> [Octavia]:</span><br><span class="line">Common <span class="keyword">Name</span> [example.org]:</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure></div>

<ul>
<li>需要输入服务器端CA密钥的密码，也就是123456</li>
<li>注意：后面需要输入Country Name等信息的地方请保持和这里的一致</li>
</ul>
<p>从服务器证书颁发机构，准备客户端 CA 密钥</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ../client_ca</span><br><span class="line"><span class="built_in">mkdir</span> certs crl csr newcerts private</span><br><span class="line"><span class="built_in">chmod</span> 700 private</span><br><span class="line"><span class="built_in">touch</span> index.txt</span><br><span class="line"><span class="built_in">echo</span> 1000 &gt; serial</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要输入密码，这里设置 123456</span></span><br><span class="line">openssl genrsa -aes256 -out private/ca.key.pem 4096</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> 400 private/ca.key.pem</span><br></pre></td></tr></table></figure></div>

<p>签发客户端 CA 证书</p>
<div class="highlight-container" data-rel="Delphi"><figure class="iseeu highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -config ../openssl.cnf -key <span class="keyword">private</span>/ca.key.pem -new -x509 -days <span class="number">7300</span> -sha256 -extensions v3_ca -<span class="keyword">out</span> certs/ca.cert.pem</span><br><span class="line"></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> <span class="keyword">private</span>/ca.key.pem:</span><br><span class="line">You are about <span class="keyword">to</span> be asked <span class="keyword">to</span> enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about <span class="keyword">to</span> enter <span class="keyword">is</span> what <span class="keyword">is</span> called a Distinguished <span class="keyword">Name</span> <span class="keyword">or</span> a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line"><span class="keyword">For</span> some fields there will be a <span class="keyword">default</span> value,</span><br><span class="line"><span class="keyword">If</span> you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country <span class="keyword">Name</span> (<span class="number">2</span> letter code) [US]:CN</span><br><span class="line">State <span class="keyword">or</span> Province <span class="keyword">Name</span> [Oregon]:SICHUAN</span><br><span class="line">Locality <span class="keyword">Name</span> []:CHENGDU</span><br><span class="line">Organization <span class="keyword">Name</span> [OpenStack]:</span><br><span class="line">Organizational <span class="keyword">Unit</span> <span class="keyword">Name</span> [Octavia]:</span><br><span class="line">Common <span class="keyword">Name</span> [example.org]:</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure></div>

<ul>
<li>需要输入客户端 CA 密钥的密码，也就是123456</li>
</ul>
<p>从服务器证书颁发机构，创建客户端连接密钥</p>
<div class="highlight-container" data-rel="Csharp"><figure class="iseeu highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 需要输入密码，这里设置 123456</span></span><br><span class="line">openssl genrsa -aes256 -<span class="keyword">out</span> <span class="keyword">private</span>/client.key.pem <span class="number">2048</span></span><br></pre></td></tr></table></figure></div>

<p>创建客户端连接签证请求</p>
<div class="highlight-container" data-rel="Delphi"><figure class="iseeu highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -config ../openssl.cnf -new -sha256 -key <span class="keyword">private</span>/client.key.pem -<span class="keyword">out</span> csr/client.csr.pem</span><br><span class="line"></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> <span class="keyword">private</span>/client.key.pem:</span><br><span class="line">You are about <span class="keyword">to</span> be asked <span class="keyword">to</span> enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about <span class="keyword">to</span> enter <span class="keyword">is</span> what <span class="keyword">is</span> called a Distinguished <span class="keyword">Name</span> <span class="keyword">or</span> a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line"><span class="keyword">For</span> some fields there will be a <span class="keyword">default</span> value,</span><br><span class="line"><span class="keyword">If</span> you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country <span class="keyword">Name</span> (<span class="number">2</span> letter code) [US]:CN</span><br><span class="line">State <span class="keyword">or</span> Province <span class="keyword">Name</span> [Oregon]:SICHUAN</span><br><span class="line">Locality <span class="keyword">Name</span> []:CHENGDU</span><br><span class="line">Organization <span class="keyword">Name</span> [OpenStack]:</span><br><span class="line">Organizational <span class="keyword">Unit</span> <span class="keyword">Name</span> [Octavia]:</span><br><span class="line">Common <span class="keyword">Name</span> [example.org]:</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure></div>

<ul>
<li>需要输入客户端连接密钥的密码，也就是123456</li>
</ul>
<p>签发客户端连接证书</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl ca -config ../openssl.cnf -extensions usr_cert -days 7300 -notext -md sha256 -<span class="keyword">in</span> csr/client.csr.pem -out certs/client.cert.pem</span><br></pre></td></tr></table></figure></div>

<ul>
<li>需要输入客户端连接密钥的密码，也就是123456</li>
</ul>
<p>把客户端连接私钥和证书组合成一个文件</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要输入客户端连接密钥的密码</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> private/client.key.pem -out private/client.cert-and-key.pem</span><br><span class="line"><span class="built_in">cat</span> certs/client.cert.pem &gt;&gt; private/client.cert-and-key.pem</span><br></pre></td></tr></table></figure></div>

<p>复制相关证书到 Octavia 配置目录</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/octavia/certs</span><br><span class="line"><span class="built_in">chmod</span> 700 /etc/octavia/certs</span><br><span class="line"><span class="built_in">cp</span> server_ca/private/ca.key.pem /etc/octavia/certs/server_ca.key.pem</span><br><span class="line"><span class="built_in">chmod</span> 700 /etc/octavia/certs/server_ca.key.pem</span><br><span class="line"><span class="built_in">cp</span> server_ca/certs/ca.cert.pem /etc/octavia/certs/server_ca.cert.pem</span><br><span class="line"><span class="built_in">cp</span> client_ca/certs/ca.cert.pem /etc/octavia/certs/client_ca.cert.pem</span><br><span class="line"><span class="built_in">cp</span> client_ca/private/client.cert-and-key.pem /etc/octavia/certs/client.cert-and-key.pem</span><br><span class="line"><span class="built_in">chmod</span> 700 /etc/octavia/certs/client.cert-and-key.pem</span><br><span class="line"><span class="built_in">chown</span> -R octavia.octavia /etc/octavia/certs</span><br></pre></td></tr></table></figure></div>

<p><strong>然后把&#x2F;etc&#x2F;octavia&#x2F;certs复制到所有其他控制节点，注意权限</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ssh controller02 <span class="string">&#x27;mkdir -p /etc/octavia/certs&#x27;</span></span><br><span class="line">ssh controller03 <span class="string">&#x27;mkdir -p /etc/octavia/certs&#x27;</span></span><br><span class="line"></span><br><span class="line">scp /etc/octavia/certs/* controller02:/etc/octavia/certs/</span><br><span class="line">scp /etc/octavia/certs/* controller03:/etc/octavia/certs/</span><br><span class="line"></span><br><span class="line">ssh controller02 <span class="string">&#x27;chmod 700 /etc/octavia/certs&#x27;</span></span><br><span class="line">ssh controller03 <span class="string">&#x27;chmod 700 /etc/octavia/certs&#x27;</span></span><br><span class="line"></span><br><span class="line">ssh controller02 <span class="string">&#x27;chmod 700 /etc/octavia/certs/server_ca.key.pem&#x27;</span></span><br><span class="line">ssh controller03 <span class="string">&#x27;chmod 700 /etc/octavia/certs/server_ca.key.pem&#x27;</span></span><br><span class="line"></span><br><span class="line">ssh controller02 <span class="string">&#x27;chmod 700 /etc/octavia/certs/client.cert-and-key.pem&#x27;</span></span><br><span class="line">ssh controller03 <span class="string">&#x27;chmod 700 /etc/octavia/certs/client.cert-and-key.pem&#x27;</span></span><br><span class="line"></span><br><span class="line">ssh controller02 <span class="string">&#x27;chown -R octavia. /etc/octavia/certs&#x27;</span></span><br><span class="line">ssh controller03 <span class="string">&#x27;chown -R octavia. /etc/octavia/certs&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="创建安全组-1"><a href="#创建安全组-1" class="headerlink" title="创建安全组"></a>创建安全组</h2><p>任意控制节点执行</p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">. <span class="operator">~</span><span class="operator">/</span>octavia<span class="operator">-</span>openrc</span><br><span class="line"></span><br><span class="line"># Amphora 虚拟机使用，LB Network 与 Amphora 通信</span><br><span class="line">openstack security <span class="keyword">group</span> <span class="keyword">create</span> lb<span class="operator">-</span>mgmt<span class="operator">-</span>sec<span class="operator">-</span>grp</span><br><span class="line">openstack security <span class="keyword">group</span> rule <span class="keyword">create</span> <span class="comment">--protocol icmp lb-mgmt-sec-grp</span></span><br><span class="line">openstack security <span class="keyword">group</span> rule <span class="keyword">create</span> <span class="comment">--protocol udp --dst-port 5555 lb-mgmt-sec-grp</span></span><br><span class="line">openstack security <span class="keyword">group</span> rule <span class="keyword">create</span> <span class="comment">--protocol tcp --dst-port 22 lb-mgmt-sec-grp</span></span><br><span class="line">openstack security <span class="keyword">group</span> rule <span class="keyword">create</span> <span class="comment">--protocol tcp --dst-port 9443 lb-mgmt-sec-grp</span></span><br><span class="line"></span><br><span class="line"># Amphora 虚拟机使用，Health Manager 与 Amphora 通信</span><br><span class="line">openstack security <span class="keyword">group</span> <span class="keyword">create</span> lb<span class="operator">-</span>health<span class="operator">-</span>mgr<span class="operator">-</span>sec<span class="operator">-</span>grp</span><br><span class="line">openstack security <span class="keyword">group</span> rule <span class="keyword">create</span> <span class="comment">--protocol icmp lb-health-mgr-sec-grp</span></span><br><span class="line">openstack security <span class="keyword">group</span> rule <span class="keyword">create</span> <span class="comment">--protocol udp --dst-port 5555 lb-health-mgr-sec-grp</span></span><br><span class="line">openstack security <span class="keyword">group</span> rule <span class="keyword">create</span> <span class="comment">--protocol tcp --dst-port 22 lb-health-mgr-sec-grp</span></span><br><span class="line">openstack security <span class="keyword">group</span> rule <span class="keyword">create</span> <span class="comment">--protocol tcp --dst-port 9443 lb-health-mgr-sec-grp</span></span><br></pre></td></tr></table></figure></div>

<h2 id="创建登陆-amphora-实例的-ssh-key"><a href="#创建登陆-amphora-实例的-ssh-key" class="headerlink" title="创建登陆 amphora 实例的 ssh key"></a>创建登陆 amphora 实例的 ssh key</h2><p>任意控制节点执行；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">. ~/octavia-openrc</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/octavia/.ssh</span><br><span class="line"></span><br><span class="line">ssh-keygen -b 2048 -t rsa -N <span class="string">&quot;&quot;</span> -f /etc/octavia/.ssh/octavia_ssh_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意 key 的名称 octavia_ssh_key，后面配置文件会用到</span></span><br><span class="line"><span class="comment"># nova keypair-add --pub-key=/etc/octavia/.ssh/octavia_ssh_key.pub octavia_ssh_key</span></span><br><span class="line">openstack keypair create --public-key /etc/octavia/.ssh/octavia_ssh_key.pub octavia_ssh_key</span><br><span class="line"></span><br><span class="line"><span class="built_in">chown</span> -R octavia. /etc/octavia/.ssh/</span><br></pre></td></tr></table></figure></div>

<p><strong>然后把&#x2F;etc&#x2F;octavia&#x2F;.ssh&#x2F;复制到所有其他控制节点，注意权限</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ssh controller02 <span class="string">&#x27;mkdir -p /etc/octavia/.ssh/&#x27;</span></span><br><span class="line">ssh controller03 <span class="string">&#x27;mkdir -p /etc/octavia/.ssh/&#x27;</span></span><br><span class="line"></span><br><span class="line">scp /etc/octavia/.ssh/* controller02:/etc/octavia/.ssh/</span><br><span class="line">scp /etc/octavia/.ssh/* controller03:/etc/octavia/.ssh/</span><br><span class="line"></span><br><span class="line">ssh controller02 <span class="string">&#x27;chown -R octavia. /etc/octavia/.ssh/&#x27;</span></span><br><span class="line">ssh controller03 <span class="string">&#x27;chown -R octavia. /etc/octavia/.ssh/&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="创建-dhclient-conf-配置文件"><a href="#创建-dhclient-conf-配置文件" class="headerlink" title="创建 dhclient.conf 配置文件"></a>创建 dhclient.conf 配置文件</h2><p>全部控制节点执行；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/octavia.git</span><br><span class="line"><span class="built_in">mkdir</span> -m755 -p /etc/dhcp/octavia</span><br><span class="line"><span class="built_in">cp</span> octavia/etc/dhcp/dhclient.conf /etc/dhcp/octavia</span><br></pre></td></tr></table></figure></div>

<h2 id="创建网络"><a href="#创建网络" class="headerlink" title="创建网络"></a>创建网络</h2><h3 id="controller01执行"><a href="#controller01执行" class="headerlink" title="controller01执行"></a>controller01执行</h3><div class="highlight-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">. ~/octavia<span class="literal">-openrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># openstack 租户 tunnel 网络，可设置随意设置</span></span><br><span class="line">OCTAVIA_MGMT_SUBNET=<span class="number">172.16</span>.<span class="number">0.0</span>/<span class="number">24</span></span><br><span class="line">OCTAVIA_MGMT_SUBNET_START=<span class="number">172.16</span>.<span class="number">0.100</span></span><br><span class="line">OCTAVIA_MGMT_SUBNET_END=<span class="number">172.16</span>.<span class="number">0.254</span></span><br><span class="line"><span class="comment"># 172.16.0.1网关，172.16.0.2 controller01，172.16.0.3 controller02，172.16.0.4 controller03</span></span><br><span class="line">OCTAVIA_MGMT_PORT_IP=<span class="number">172.16</span>.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">openstack network create lb<span class="literal">-mgmt-net</span></span><br><span class="line">openstack subnet create <span class="literal">--subnet-range</span> <span class="variable">$OCTAVIA_MGMT_SUBNET</span> <span class="literal">--allocation-pool</span> \</span><br><span class="line"><span class="built_in">start</span>=<span class="variable">$OCTAVIA_MGMT_SUBNET_START</span>,<span class="keyword">end</span>=<span class="variable">$OCTAVIA_MGMT_SUBNET_END</span> \</span><br><span class="line"><span class="literal">--network</span> lb<span class="literal">-mgmt-net</span> lb<span class="literal">-mgmt-subnet</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取子网id</span></span><br><span class="line">SUBNET_ID=<span class="variable">$</span>(openstack subnet show lb<span class="literal">-mgmt-subnet</span> <span class="operator">-f</span> value <span class="literal">-c</span> id)</span><br><span class="line">PORT_FIXED_IP=<span class="string">&quot;--fixed-ip subnet=<span class="variable">$SUBNET_ID</span>,ip-address=<span class="variable">$OCTAVIA_MGMT_PORT_IP</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建controller01使用的端口</span></span><br><span class="line">MGMT_PORT_ID=<span class="variable">$</span>(openstack port create <span class="literal">--security-group</span> \</span><br><span class="line">lb<span class="literal">-health-mgr-sec-grp</span> <span class="literal">--device-owner</span> Octavia:health<span class="literal">-mgr</span> \</span><br><span class="line"><span class="literal">--host</span>=<span class="variable">$</span>(hostname) <span class="literal">-c</span> id <span class="operator">-f</span> value <span class="literal">--network</span> lb<span class="literal">-mgmt-net</span> \</span><br><span class="line"><span class="variable">$PORT_FIXED_IP</span> octavia<span class="literal">-health-manager-listen-port</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 端口 mac 地址</span></span><br><span class="line">MGMT_PORT_MAC=<span class="variable">$</span>(openstack port show <span class="literal">-c</span> mac_address <span class="operator">-f</span> value <span class="variable">$MGMT_PORT_ID</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;OCTAVIA_MGMT_PORT_IP: <span class="variable">$OCTAVIA_MGMT_PORT_IP</span></span></span><br><span class="line"><span class="string">SUBNET_ID: <span class="variable">$SUBNET_ID</span></span></span><br><span class="line"><span class="string">PORT_FIXED_IP: <span class="variable">$PORT_FIXED_IP</span></span></span><br><span class="line"><span class="string">MGMT_PORT_ID: <span class="variable">$MGMT_PORT_ID</span></span></span><br><span class="line"><span class="string">MGMT_PORT_MAC: <span class="variable">$MGMT_PORT_MAC</span>&quot;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="openvswitch方式"><a href="#openvswitch方式" class="headerlink" title="openvswitch方式"></a>openvswitch方式</h4><p><strong>创建管理端口</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">ovs<span class="operator">-</span>vsctl <span class="comment">--may-exist add-port br-int o-hm0 \</span></span><br><span class="line"><span class="comment">-- set Interface o-hm0 type=internal \</span></span><br><span class="line"><span class="comment">-- set Interface o-hm0 external-ids:iface-status=active \</span></span><br><span class="line"><span class="comment">-- set Interface o-hm0 external-ids:attached-mac=$MGMT_PORT_MAC \</span></span><br><span class="line"><span class="comment">-- set Interface o-hm0 external-ids:iface-id=$MGMT_PORT_ID</span></span><br><span class="line"></span><br><span class="line">ip link <span class="keyword">set</span> dev o<span class="operator">-</span>hm0 address $MGMT_PORT_MAC</span><br><span class="line">ip link <span class="keyword">set</span> dev o<span class="operator">-</span>hm0 up</span><br><span class="line">iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>i o<span class="operator">-</span>hm0 <span class="operator">-</span>p udp <span class="comment">--dport 5555 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"># 获取刚才设置的 ip</span><br><span class="line">$ dhclient <span class="operator">-</span>v o<span class="operator">-</span>hm0 <span class="operator">-</span>cf <span class="operator">/</span>etc<span class="operator">/</span>dhcp<span class="operator">/</span>octavia</span><br><span class="line"></span><br><span class="line">Internet Systems Consortium DHCP Client <span class="number">4.2</span><span class="number">.5</span></span><br><span class="line">Copyright <span class="number">2004</span><span class="number">-2013</span> Internet Systems Consortium.</span><br><span class="line"><span class="keyword">All</span> rights reserved.</span><br><span class="line"><span class="keyword">For</span> info, please visit https:<span class="operator">/</span><span class="operator">/</span>www.isc.org<span class="operator">/</span>software<span class="operator">/</span>dhcp<span class="operator">/</span></span><br><span class="line"></span><br><span class="line">Listening <span class="keyword">on</span> LPF<span class="operator">/</span>o<span class="operator">-</span>hm0<span class="operator">/</span>fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">3</span>c:<span class="number">17</span>:ee</span><br><span class="line">Sending <span class="keyword">on</span>   LPF<span class="operator">/</span>o<span class="operator">-</span>hm0<span class="operator">/</span>fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">3</span>c:<span class="number">17</span>:ee</span><br><span class="line">Sending <span class="keyword">on</span>   Socket<span class="operator">/</span>fallback</span><br><span class="line">DHCPDISCOVER <span class="keyword">on</span> o<span class="operator">-</span>hm0 <span class="keyword">to</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> port <span class="number">67</span> <span class="type">interval</span> <span class="number">6</span> (xid<span class="operator">=</span><span class="number">0x5cee3ddf</span>)</span><br><span class="line">DHCPREQUEST <span class="keyword">on</span> o<span class="operator">-</span>hm0 <span class="keyword">to</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> port <span class="number">67</span> (xid<span class="operator">=</span><span class="number">0x5cee3ddf</span>)</span><br><span class="line">DHCPOFFER <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span></span><br><span class="line">DHCPACK <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span> (xid<span class="operator">=</span><span class="number">0x5cee3ddf</span>)</span><br><span class="line">bound <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.2</span> <span class="comment">-- renewal in 33571 seconds.</span></span><br><span class="line"></span><br><span class="line">$ ip a s dev o<span class="operator">-</span>hm0</span><br><span class="line"><span class="number">13</span>: o<span class="operator">-</span>hm0<span class="variable">@o</span><span class="operator">-</span>bhm0: <span class="operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="operator">&gt;</span> mtu <span class="number">1450</span> qdisc noqueue state UP <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">link<span class="operator">/</span>ether fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">3</span>c:<span class="number">17</span>:ee brd ff:ff:ff:ff:ff:ff</span><br><span class="line">inet <span class="number">172.16</span><span class="number">.0</span><span class="number">.2</span><span class="operator">/</span><span class="number">24</span> brd <span class="number">172.16</span><span class="number">.0</span><span class="number">.255</span> <span class="keyword">scope</span> <span class="keyword">global</span> <span class="keyword">dynamic</span> o<span class="operator">-</span>hm0</span><br><span class="line">valid_lft <span class="number">86292</span>sec preferred_lft <span class="number">86292</span>sec</span><br><span class="line">inet6 fe80::f816:<span class="number">3</span>eff:fe3c:<span class="number">17</span>ee<span class="operator">/</span><span class="number">64</span> <span class="keyword">scope</span> link</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"># 使用 dhclient 获取到 ip 地址后，会设置一条默认路由 <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> UG <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> o<span class="operator">-</span>hm0</span><br><span class="line"># 这会和本机默认网关路由冲突，可能会导致本机连接外部网络，建议删除</span><br><span class="line"># 并且还会设置本机 dns 地址为 <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> 网段的 dns 服务器地址，也需要改回来</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# route <span class="operator">-</span>n</span><br><span class="line">Kernel IP routing <span class="keyword">table</span></span><br><span class="line">Destination     Gateway         Genmask         Flags Metric <span class="keyword">Ref</span>    Use Iface</span><br><span class="line"><span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         UG    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> o<span class="operator">-</span>hm0</span><br><span class="line"><span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">10.10</span><span class="number">.10</span><span class="number">.2</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         UG    <span class="number">100</span>    <span class="number">0</span>        <span class="number">0</span> ens33</span><br><span class="line"><span class="number">10.10</span><span class="number">.10</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">100</span>    <span class="number">0</span>        <span class="number">0</span> ens33</span><br><span class="line"><span class="number">10.10</span><span class="number">.20</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> brq5ba4cced<span class="number">-83</span></span><br><span class="line"><span class="number">10.10</span><span class="number">.30</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">102</span>    <span class="number">0</span>        <span class="number">0</span> ens35</span><br><span class="line"><span class="number">169.254</span><span class="number">.169</span><span class="number">.254</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span>    <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> UGH   <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> o<span class="operator">-</span>hm0</span><br><span class="line"><span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> o<span class="operator">-</span>hm0</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# route del <span class="keyword">default</span> gw <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# cat <span class="operator">/</span>etc<span class="operator">/</span>resolv.conf</span><br><span class="line">; generated <span class="keyword">by</span> <span class="operator">/</span>usr<span class="operator">/</span>sbin<span class="operator">/</span>dhclient<span class="operator">-</span>script</span><br><span class="line"><span class="keyword">search</span> openstacklocal</span><br><span class="line">nameserver <span class="number">172.16</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line">nameserver <span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# echo <span class="string">&#x27;nameserver 10.10.10.2&#x27;</span> <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>resolv.conf</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# ping www.baidu.com</span><br><span class="line">PING www.a.shifen.com (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>) <span class="number">56</span>(<span class="number">84</span>) bytes <span class="keyword">of</span> data.</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span> (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>): icmp_seq<span class="operator">=</span><span class="number">1</span> ttl<span class="operator">=</span><span class="number">128</span> <span class="type">time</span><span class="operator">=</span><span class="number">40.5</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span> (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>): icmp_seq<span class="operator">=</span><span class="number">2</span> ttl<span class="operator">=</span><span class="number">128</span> <span class="type">time</span><span class="operator">=</span><span class="number">42.3</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span> (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>): icmp_seq<span class="operator">=</span><span class="number">3</span> ttl<span class="operator">=</span><span class="number">128</span> <span class="type">time</span><span class="operator">=</span><span class="number">40.8</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span> (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>): icmp_seq<span class="operator">=</span><span class="number">4</span> ttl<span class="operator">=</span><span class="number">128</span> <span class="type">time</span><span class="operator">=</span><span class="number">40.8</span> ms</span><br><span class="line"><span class="operator">^</span>C</span><br><span class="line"><span class="comment">--- www.a.shifen.com ping statistics ---</span></span><br><span class="line"><span class="number">5</span> packets transmitted, <span class="number">5</span> received, <span class="number">0</span><span class="operator">%</span> packet loss, <span class="type">time</span> <span class="number">4007</span>ms</span><br><span class="line">rtt min<span class="operator">/</span>avg<span class="operator">/</span>max<span class="operator">/</span>mdev <span class="operator">=</span> <span class="number">40.586</span><span class="operator">/</span><span class="number">41.609</span><span class="operator">/</span><span class="number">43.340</span><span class="operator">/</span><span class="number">1.098</span> ms</span><br></pre></td></tr></table></figure></div>

<p><strong>设置开机启动</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ vi /opt/octavia-interface-start.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line"><span class="comment">#MAC=$MGMT_PORT_MAC</span></span><br><span class="line"><span class="comment">#PORT_ID=$MGMT_PORT_ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MAC 为 $MGMT_PORT_MAC ，PORT_ID 为 $MGMT_PORT_ID，具体含义看前面</span></span><br><span class="line">MAC=<span class="string">&quot;fa:16:3e:3c:17:ee&quot;</span></span><br><span class="line">PORT_ID=<span class="string">&quot;6d83909a-33cd-43aa-8d3f-baaa3bf87daf&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sleep</span> 120s</span><br><span class="line"></span><br><span class="line">ovs-vsctl --may-exist add-port br-int o-hm0 \</span><br><span class="line">-- <span class="built_in">set</span> Interface o-hm0 <span class="built_in">type</span>=internal \</span><br><span class="line">-- <span class="built_in">set</span> Interface o-hm0 external-ids:iface-status=active \</span><br><span class="line">-- <span class="built_in">set</span> Interface o-hm0 external-ids:attached-mac=<span class="variable">$MAC</span> \</span><br><span class="line">-- <span class="built_in">set</span> Interface o-hm0 external-ids:iface-id=<span class="variable">$PORT_ID</span></span><br><span class="line"></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev o-hm0 address <span class="variable">$MAC</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev o-hm0 up</span><br><span class="line">iptables -I INPUT -i o-hm0 -p udp --dport 5555 -j ACCEPT</span><br><span class="line"></span><br><span class="line">dhclient -v o-hm0 -cf /etc/dhcp/octavia</span><br><span class="line">route del default gw 172.16.0.1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;nameserver 10.10.10.2&#x27;</span> &gt; /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">chmod</span> +x /opt/octavia-interface-start.sh</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;nohup sh /opt/octavia-interface-start.sh &gt; /var/log/octavia-interface-start.log 2&gt;&amp;1 &amp;&#x27;</span> &gt;&gt; /etc/rc.d/rc.local</span><br><span class="line">$ <span class="built_in">chmod</span> +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure></div>

<h3 id="controller02执行"><a href="#controller02执行" class="headerlink" title="controller02执行"></a>controller02执行</h3><div class="highlight-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">. ~/octavia<span class="literal">-openrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># openstack 租户 tunnel 网络，可设置随意设置</span></span><br><span class="line">OCTAVIA_MGMT_SUBNET=<span class="number">172.16</span>.<span class="number">0.0</span>/<span class="number">24</span></span><br><span class="line">OCTAVIA_MGMT_SUBNET_START=<span class="number">172.16</span>.<span class="number">0.100</span></span><br><span class="line">OCTAVIA_MGMT_SUBNET_END=<span class="number">172.16</span>.<span class="number">0.254</span></span><br><span class="line"><span class="comment"># 172.16.0.1网关，172.16.0.2 controller01，172.16.0.3 controller02，172.16.0.4 controller03</span></span><br><span class="line">OCTAVIA_MGMT_PORT_IP=<span class="number">172.16</span>.<span class="number">0.3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取子网id</span></span><br><span class="line">SUBNET_ID=<span class="variable">$</span>(openstack subnet show lb<span class="literal">-mgmt-subnet</span> <span class="operator">-f</span> value <span class="literal">-c</span> id)</span><br><span class="line">PORT_FIXED_IP=<span class="string">&quot;--fixed-ip subnet=<span class="variable">$SUBNET_ID</span>,ip-address=<span class="variable">$OCTAVIA_MGMT_PORT_IP</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建controller02使用的端口</span></span><br><span class="line">MGMT_PORT_ID=<span class="variable">$</span>(openstack port create <span class="literal">--security-group</span> \</span><br><span class="line">lb<span class="literal">-health-mgr-sec-grp</span> <span class="literal">--device-owner</span> Octavia:health<span class="literal">-mgr</span> \</span><br><span class="line"><span class="literal">--host</span>=<span class="variable">$</span>(hostname) <span class="literal">-c</span> id <span class="operator">-f</span> value <span class="literal">--network</span> lb<span class="literal">-mgmt-net</span> \</span><br><span class="line"><span class="variable">$PORT_FIXED_IP</span> octavia<span class="literal">-health-manager-listen-port</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 端口 mac 地址</span></span><br><span class="line">MGMT_PORT_MAC=<span class="variable">$</span>(openstack port show <span class="literal">-c</span> mac_address <span class="operator">-f</span> value <span class="variable">$MGMT_PORT_ID</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;OCTAVIA_MGMT_PORT_IP: <span class="variable">$OCTAVIA_MGMT_PORT_IP</span></span></span><br><span class="line"><span class="string">SUBNET_ID: <span class="variable">$SUBNET_ID</span></span></span><br><span class="line"><span class="string">PORT_FIXED_IP: <span class="variable">$PORT_FIXED_IP</span></span></span><br><span class="line"><span class="string">MGMT_PORT_ID: <span class="variable">$MGMT_PORT_ID</span></span></span><br><span class="line"><span class="string">MGMT_PORT_MAC: <span class="variable">$MGMT_PORT_MAC</span>&quot;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="openvswitch方式-1"><a href="#openvswitch方式-1" class="headerlink" title="openvswitch方式"></a>openvswitch方式</h4><p><strong>创建管理端口</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">ovs<span class="operator">-</span>vsctl <span class="comment">--may-exist add-port br-int o-hm0 \</span></span><br><span class="line"><span class="comment">-- set Interface o-hm0 type=internal \</span></span><br><span class="line"><span class="comment">-- set Interface o-hm0 external-ids:iface-status=active \</span></span><br><span class="line"><span class="comment">-- set Interface o-hm0 external-ids:attached-mac=$MGMT_PORT_MAC \</span></span><br><span class="line"><span class="comment">-- set Interface o-hm0 external-ids:iface-id=$MGMT_PORT_ID</span></span><br><span class="line"></span><br><span class="line">ip link <span class="keyword">set</span> dev o<span class="operator">-</span>hm0 address $MGMT_PORT_MAC</span><br><span class="line">ip link <span class="keyword">set</span> dev o<span class="operator">-</span>hm0 up</span><br><span class="line">iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>i o<span class="operator">-</span>hm0 <span class="operator">-</span>p udp <span class="comment">--dport 5555 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"># 获取刚才设置的 ip</span><br><span class="line">$ dhclient <span class="operator">-</span>v o<span class="operator">-</span>hm0 <span class="operator">-</span>cf <span class="operator">/</span>etc<span class="operator">/</span>dhcp<span class="operator">/</span>octavia</span><br><span class="line"></span><br><span class="line">Internet Systems Consortium DHCP Client <span class="number">4.2</span><span class="number">.5</span></span><br><span class="line">Copyright <span class="number">2004</span><span class="number">-2013</span> Internet Systems Consortium.</span><br><span class="line"><span class="keyword">All</span> rights reserved.</span><br><span class="line"><span class="keyword">For</span> info, please visit https:<span class="operator">/</span><span class="operator">/</span>www.isc.org<span class="operator">/</span>software<span class="operator">/</span>dhcp<span class="operator">/</span></span><br><span class="line"></span><br><span class="line">Listening <span class="keyword">on</span> LPF<span class="operator">/</span>o<span class="operator">-</span>hm0<span class="operator">/</span>fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">3</span>c:<span class="number">17</span>:ee</span><br><span class="line">Sending <span class="keyword">on</span>   LPF<span class="operator">/</span>o<span class="operator">-</span>hm0<span class="operator">/</span>fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">3</span>c:<span class="number">17</span>:ee</span><br><span class="line">Sending <span class="keyword">on</span>   Socket<span class="operator">/</span>fallback</span><br><span class="line">DHCPDISCOVER <span class="keyword">on</span> o<span class="operator">-</span>hm0 <span class="keyword">to</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> port <span class="number">67</span> <span class="type">interval</span> <span class="number">6</span> (xid<span class="operator">=</span><span class="number">0x5cee3ddf</span>)</span><br><span class="line">DHCPREQUEST <span class="keyword">on</span> o<span class="operator">-</span>hm0 <span class="keyword">to</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> port <span class="number">67</span> (xid<span class="operator">=</span><span class="number">0x5cee3ddf</span>)</span><br><span class="line">DHCPOFFER <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span></span><br><span class="line">DHCPACK <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span> (xid<span class="operator">=</span><span class="number">0x5cee3ddf</span>)</span><br><span class="line">bound <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.3</span> <span class="comment">-- renewal in 33571 seconds.</span></span><br><span class="line"></span><br><span class="line">$ ip a s dev o<span class="operator">-</span>hm0</span><br><span class="line"><span class="number">13</span>: o<span class="operator">-</span>hm0<span class="variable">@o</span><span class="operator">-</span>bhm0: <span class="operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="operator">&gt;</span> mtu <span class="number">1450</span> qdisc noqueue state UP <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">link<span class="operator">/</span>ether fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">3</span>c:<span class="number">17</span>:ee brd ff:ff:ff:ff:ff:ff</span><br><span class="line">inet <span class="number">172.16</span><span class="number">.0</span><span class="number">.3</span><span class="operator">/</span><span class="number">24</span> brd <span class="number">172.16</span><span class="number">.0</span><span class="number">.255</span> <span class="keyword">scope</span> <span class="keyword">global</span> <span class="keyword">dynamic</span> o<span class="operator">-</span>hm0</span><br><span class="line">valid_lft <span class="number">86292</span>sec preferred_lft <span class="number">86292</span>sec</span><br><span class="line">inet6 fe80::f816:<span class="number">3</span>eff:fe3c:<span class="number">17</span>ee<span class="operator">/</span><span class="number">64</span> <span class="keyword">scope</span> link</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"># 使用 dhclient 获取到 ip 地址后，会设置一条默认路由 <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> UG <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> o<span class="operator">-</span>hm0</span><br><span class="line"># 这会和本机默认网关路由冲突，可能会导致本机连接外部网络，建议删除</span><br><span class="line"># 并且还会设置本机 dns 地址为 <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> 网段的 dns 服务器地址，也需要改回来</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# route <span class="operator">-</span>n</span><br><span class="line">Kernel IP routing <span class="keyword">table</span></span><br><span class="line">Destination     Gateway         Genmask         Flags Metric <span class="keyword">Ref</span>    Use Iface</span><br><span class="line"><span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         UG    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> o<span class="operator">-</span>hm0</span><br><span class="line"><span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">10.10</span><span class="number">.10</span><span class="number">.2</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         UG    <span class="number">100</span>    <span class="number">0</span>        <span class="number">0</span> ens33</span><br><span class="line"><span class="number">10.10</span><span class="number">.10</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">100</span>    <span class="number">0</span>        <span class="number">0</span> ens33</span><br><span class="line"><span class="number">10.10</span><span class="number">.20</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> brq5ba4cced<span class="number">-83</span></span><br><span class="line"><span class="number">10.10</span><span class="number">.30</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">102</span>    <span class="number">0</span>        <span class="number">0</span> ens35</span><br><span class="line"><span class="number">169.254</span><span class="number">.169</span><span class="number">.254</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span>    <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> UGH   <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> o<span class="operator">-</span>hm0</span><br><span class="line"><span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> o<span class="operator">-</span>hm0</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# route del <span class="keyword">default</span> gw <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# cat <span class="operator">/</span>etc<span class="operator">/</span>resolv.conf</span><br><span class="line">; generated <span class="keyword">by</span> <span class="operator">/</span>usr<span class="operator">/</span>sbin<span class="operator">/</span>dhclient<span class="operator">-</span>script</span><br><span class="line"><span class="keyword">search</span> openstacklocal</span><br><span class="line">nameserver <span class="number">172.16</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line">nameserver <span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# echo <span class="string">&#x27;nameserver 10.10.10.2&#x27;</span> <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>resolv.conf</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# ping www.baidu.com</span><br><span class="line">PING www.a.shifen.com (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>) <span class="number">56</span>(<span class="number">84</span>) bytes <span class="keyword">of</span> data.</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span> (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>): icmp_seq<span class="operator">=</span><span class="number">1</span> ttl<span class="operator">=</span><span class="number">128</span> <span class="type">time</span><span class="operator">=</span><span class="number">40.5</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span> (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>): icmp_seq<span class="operator">=</span><span class="number">2</span> ttl<span class="operator">=</span><span class="number">128</span> <span class="type">time</span><span class="operator">=</span><span class="number">42.3</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span> (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>): icmp_seq<span class="operator">=</span><span class="number">3</span> ttl<span class="operator">=</span><span class="number">128</span> <span class="type">time</span><span class="operator">=</span><span class="number">40.8</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span> (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>): icmp_seq<span class="operator">=</span><span class="number">4</span> ttl<span class="operator">=</span><span class="number">128</span> <span class="type">time</span><span class="operator">=</span><span class="number">40.8</span> ms</span><br><span class="line"><span class="operator">^</span>C</span><br><span class="line"><span class="comment">--- www.a.shifen.com ping statistics ---</span></span><br><span class="line"><span class="number">5</span> packets transmitted, <span class="number">5</span> received, <span class="number">0</span><span class="operator">%</span> packet loss, <span class="type">time</span> <span class="number">4007</span>ms</span><br><span class="line">rtt min<span class="operator">/</span>avg<span class="operator">/</span>max<span class="operator">/</span>mdev <span class="operator">=</span> <span class="number">40.586</span><span class="operator">/</span><span class="number">41.609</span><span class="operator">/</span><span class="number">43.340</span><span class="operator">/</span><span class="number">1.098</span> ms</span><br></pre></td></tr></table></figure></div>

<p><strong>设置开机启动</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ vi /opt/octavia-interface-start.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line"><span class="comment">#MAC=$MGMT_PORT_MAC</span></span><br><span class="line"><span class="comment">#PORT_ID=$MGMT_PORT_ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MAC 为 $MGMT_PORT_MAC ，PORT_ID 为 $MGMT_PORT_ID，具体含义看前面</span></span><br><span class="line">MAC=<span class="string">&quot;fa:16:3e:7c:57:19&quot;</span></span><br><span class="line">PORT_ID=<span class="string">&quot;19964a42-8e06-4d87-9408-ce2348cfdf43&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sleep</span> 120s</span><br><span class="line"></span><br><span class="line">ovs-vsctl --may-exist add-port br-int o-hm0 \</span><br><span class="line">-- <span class="built_in">set</span> Interface o-hm0 <span class="built_in">type</span>=internal \</span><br><span class="line">-- <span class="built_in">set</span> Interface o-hm0 external-ids:iface-status=active \</span><br><span class="line">-- <span class="built_in">set</span> Interface o-hm0 external-ids:attached-mac=<span class="variable">$MAC</span> \</span><br><span class="line">-- <span class="built_in">set</span> Interface o-hm0 external-ids:iface-id=<span class="variable">$PORT_ID</span></span><br><span class="line"></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev o-hm0 address <span class="variable">$MAC</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev o-hm0 up</span><br><span class="line">iptables -I INPUT -i o-hm0 -p udp --dport 5555 -j ACCEPT</span><br><span class="line"></span><br><span class="line">dhclient -v o-hm0 -cf /etc/dhcp/octavia</span><br><span class="line">route del default gw 172.16.0.1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;nameserver 10.10.10.2&#x27;</span> &gt; /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">chmod</span> +x /opt/octavia-interface-start.sh</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;nohup sh /opt/octavia-interface-start.sh &gt; /var/log/octavia-interface-start.log 2&gt;&amp;1 &amp;&#x27;</span> &gt;&gt; /etc/rc.d/rc.local</span><br><span class="line">$ <span class="built_in">chmod</span> +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure></div>

<h3 id="controller03执行"><a href="#controller03执行" class="headerlink" title="controller03执行"></a>controller03执行</h3><div class="highlight-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">. ~/octavia<span class="literal">-openrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># openstack 租户 tunnel 网络，可设置随意设置</span></span><br><span class="line">OCTAVIA_MGMT_SUBNET=<span class="number">172.16</span>.<span class="number">0.0</span>/<span class="number">24</span></span><br><span class="line">OCTAVIA_MGMT_SUBNET_START=<span class="number">172.16</span>.<span class="number">0.100</span></span><br><span class="line">OCTAVIA_MGMT_SUBNET_END=<span class="number">172.16</span>.<span class="number">0.254</span></span><br><span class="line"><span class="comment"># 172.16.0.1网关，172.16.0.2 controller01，172.16.0.3 controller02，172.16.0.4 controller03</span></span><br><span class="line">OCTAVIA_MGMT_PORT_IP=<span class="number">172.16</span>.<span class="number">0.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取子网id</span></span><br><span class="line">SUBNET_ID=<span class="variable">$</span>(openstack subnet show lb<span class="literal">-mgmt-subnet</span> <span class="operator">-f</span> value <span class="literal">-c</span> id)</span><br><span class="line">PORT_FIXED_IP=<span class="string">&quot;--fixed-ip subnet=<span class="variable">$SUBNET_ID</span>,ip-address=<span class="variable">$OCTAVIA_MGMT_PORT_IP</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建controller03使用的端口</span></span><br><span class="line">MGMT_PORT_ID=<span class="variable">$</span>(openstack port create <span class="literal">--security-group</span> \</span><br><span class="line">lb<span class="literal">-health-mgr-sec-grp</span> <span class="literal">--device-owner</span> Octavia:health<span class="literal">-mgr</span> \</span><br><span class="line"><span class="literal">--host</span>=<span class="variable">$</span>(hostname) <span class="literal">-c</span> id <span class="operator">-f</span> value <span class="literal">--network</span> lb<span class="literal">-mgmt-net</span> \</span><br><span class="line"><span class="variable">$PORT_FIXED_IP</span> octavia<span class="literal">-health-manager-listen-port</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 端口 mac 地址</span></span><br><span class="line">MGMT_PORT_MAC=<span class="variable">$</span>(openstack port show <span class="literal">-c</span> mac_address <span class="operator">-f</span> value <span class="variable">$MGMT_PORT_ID</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;OCTAVIA_MGMT_PORT_IP: <span class="variable">$OCTAVIA_MGMT_PORT_IP</span></span></span><br><span class="line"><span class="string">SUBNET_ID: <span class="variable">$SUBNET_ID</span></span></span><br><span class="line"><span class="string">PORT_FIXED_IP: <span class="variable">$PORT_FIXED_IP</span></span></span><br><span class="line"><span class="string">MGMT_PORT_ID: <span class="variable">$MGMT_PORT_ID</span></span></span><br><span class="line"><span class="string">MGMT_PORT_MAC: <span class="variable">$MGMT_PORT_MAC</span>&quot;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="openvswitch方式-2"><a href="#openvswitch方式-2" class="headerlink" title="openvswitch方式"></a>openvswitch方式</h4><p><strong>创建管理端口</strong></p>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">ovs<span class="operator">-</span>vsctl <span class="comment">--may-exist add-port br-int o-hm0 \</span></span><br><span class="line"><span class="comment">-- set Interface o-hm0 type=internal \</span></span><br><span class="line"><span class="comment">-- set Interface o-hm0 external-ids:iface-status=active \</span></span><br><span class="line"><span class="comment">-- set Interface o-hm0 external-ids:attached-mac=$MGMT_PORT_MAC \</span></span><br><span class="line"><span class="comment">-- set Interface o-hm0 external-ids:iface-id=$MGMT_PORT_ID</span></span><br><span class="line"></span><br><span class="line">ip link <span class="keyword">set</span> dev o<span class="operator">-</span>hm0 address $MGMT_PORT_MAC</span><br><span class="line">ip link <span class="keyword">set</span> dev o<span class="operator">-</span>hm0 up</span><br><span class="line">iptables <span class="operator">-</span>I INPUT <span class="operator">-</span>i o<span class="operator">-</span>hm0 <span class="operator">-</span>p udp <span class="comment">--dport 5555 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"># 获取刚才设置的 ip</span><br><span class="line">$ dhclient <span class="operator">-</span>v o<span class="operator">-</span>hm0 <span class="operator">-</span>cf <span class="operator">/</span>etc<span class="operator">/</span>dhcp<span class="operator">/</span>octavia</span><br><span class="line"></span><br><span class="line">Internet Systems Consortium DHCP Client <span class="number">4.2</span><span class="number">.5</span></span><br><span class="line">Copyright <span class="number">2004</span><span class="number">-2013</span> Internet Systems Consortium.</span><br><span class="line"><span class="keyword">All</span> rights reserved.</span><br><span class="line"><span class="keyword">For</span> info, please visit https:<span class="operator">/</span><span class="operator">/</span>www.isc.org<span class="operator">/</span>software<span class="operator">/</span>dhcp<span class="operator">/</span></span><br><span class="line"></span><br><span class="line">Listening <span class="keyword">on</span> LPF<span class="operator">/</span>o<span class="operator">-</span>hm0<span class="operator">/</span>fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">3</span>c:<span class="number">17</span>:ee</span><br><span class="line">Sending <span class="keyword">on</span>   LPF<span class="operator">/</span>o<span class="operator">-</span>hm0<span class="operator">/</span>fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">3</span>c:<span class="number">17</span>:ee</span><br><span class="line">Sending <span class="keyword">on</span>   Socket<span class="operator">/</span>fallback</span><br><span class="line">DHCPDISCOVER <span class="keyword">on</span> o<span class="operator">-</span>hm0 <span class="keyword">to</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> port <span class="number">67</span> <span class="type">interval</span> <span class="number">6</span> (xid<span class="operator">=</span><span class="number">0x5cee3ddf</span>)</span><br><span class="line">DHCPREQUEST <span class="keyword">on</span> o<span class="operator">-</span>hm0 <span class="keyword">to</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> port <span class="number">67</span> (xid<span class="operator">=</span><span class="number">0x5cee3ddf</span>)</span><br><span class="line">DHCPOFFER <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span></span><br><span class="line">DHCPACK <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span> (xid<span class="operator">=</span><span class="number">0x5cee3ddf</span>)</span><br><span class="line">bound <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.2</span> <span class="comment">-- renewal in 33571 seconds.</span></span><br><span class="line"></span><br><span class="line">$ ip a s dev o<span class="operator">-</span>hm0</span><br><span class="line"><span class="number">13</span>: o<span class="operator">-</span>hm0<span class="variable">@o</span><span class="operator">-</span>bhm0: <span class="operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="operator">&gt;</span> mtu <span class="number">1450</span> qdisc noqueue state UP <span class="keyword">group</span> <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">link<span class="operator">/</span>ether fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">3</span>c:<span class="number">17</span>:ee brd ff:ff:ff:ff:ff:ff</span><br><span class="line">inet <span class="number">172.16</span><span class="number">.0</span><span class="number">.2</span><span class="operator">/</span><span class="number">24</span> brd <span class="number">172.16</span><span class="number">.0</span><span class="number">.255</span> <span class="keyword">scope</span> <span class="keyword">global</span> <span class="keyword">dynamic</span> o<span class="operator">-</span>hm0</span><br><span class="line">valid_lft <span class="number">86292</span>sec preferred_lft <span class="number">86292</span>sec</span><br><span class="line">inet6 fe80::f816:<span class="number">3</span>eff:fe3c:<span class="number">17</span>ee<span class="operator">/</span><span class="number">64</span> <span class="keyword">scope</span> link</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"># 使用 dhclient 获取到 ip 地址后，会设置一条默认路由 <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> UG <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> o<span class="operator">-</span>hm0</span><br><span class="line"># 这会和本机默认网关路由冲突，可能会导致本机连接外部网络，建议删除</span><br><span class="line"># 并且还会设置本机 dns 地址为 <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span><span class="operator">/</span><span class="number">24</span> 网段的 dns 服务器地址，也需要改回来</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# route <span class="operator">-</span>n</span><br><span class="line">Kernel IP routing <span class="keyword">table</span></span><br><span class="line">Destination     Gateway         Genmask         Flags Metric <span class="keyword">Ref</span>    Use Iface</span><br><span class="line"><span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         UG    <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> o<span class="operator">-</span>hm0</span><br><span class="line"><span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">10.10</span><span class="number">.10</span><span class="number">.2</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         UG    <span class="number">100</span>    <span class="number">0</span>        <span class="number">0</span> ens33</span><br><span class="line"><span class="number">10.10</span><span class="number">.10</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">100</span>    <span class="number">0</span>        <span class="number">0</span> ens33</span><br><span class="line"><span class="number">10.10</span><span class="number">.20</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> brq5ba4cced<span class="number">-83</span></span><br><span class="line"><span class="number">10.10</span><span class="number">.30</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">102</span>    <span class="number">0</span>        <span class="number">0</span> ens35</span><br><span class="line"><span class="number">169.254</span><span class="number">.169</span><span class="number">.254</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span>    <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> UGH   <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> o<span class="operator">-</span>hm0</span><br><span class="line"><span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>         <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>   U     <span class="number">0</span>      <span class="number">0</span>        <span class="number">0</span> o<span class="operator">-</span>hm0</span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# route del <span class="keyword">default</span> gw <span class="number">172.16</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# cat <span class="operator">/</span>etc<span class="operator">/</span>resolv.conf</span><br><span class="line">; generated <span class="keyword">by</span> <span class="operator">/</span>usr<span class="operator">/</span>sbin<span class="operator">/</span>dhclient<span class="operator">-</span>script</span><br><span class="line"><span class="keyword">search</span> openstacklocal</span><br><span class="line">nameserver <span class="number">172.16</span><span class="number">.0</span><span class="number">.101</span></span><br><span class="line">nameserver <span class="number">172.16</span><span class="number">.0</span><span class="number">.100</span></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# echo <span class="string">&#x27;nameserver 10.10.10.2&#x27;</span> <span class="operator">&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>resolv.conf</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@controller01</span> <span class="operator">~</span>]# ping www.baidu.com</span><br><span class="line">PING www.a.shifen.com (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>) <span class="number">56</span>(<span class="number">84</span>) bytes <span class="keyword">of</span> data.</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span> (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>): icmp_seq<span class="operator">=</span><span class="number">1</span> ttl<span class="operator">=</span><span class="number">128</span> <span class="type">time</span><span class="operator">=</span><span class="number">40.5</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span> (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>): icmp_seq<span class="operator">=</span><span class="number">2</span> ttl<span class="operator">=</span><span class="number">128</span> <span class="type">time</span><span class="operator">=</span><span class="number">42.3</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span> (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>): icmp_seq<span class="operator">=</span><span class="number">3</span> ttl<span class="operator">=</span><span class="number">128</span> <span class="type">time</span><span class="operator">=</span><span class="number">40.8</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span> (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>): icmp_seq<span class="operator">=</span><span class="number">4</span> ttl<span class="operator">=</span><span class="number">128</span> <span class="type">time</span><span class="operator">=</span><span class="number">40.8</span> ms</span><br><span class="line"><span class="operator">^</span>C</span><br><span class="line"><span class="comment">--- www.a.shifen.com ping statistics ---</span></span><br><span class="line"><span class="number">5</span> packets transmitted, <span class="number">5</span> received, <span class="number">0</span><span class="operator">%</span> packet loss, <span class="type">time</span> <span class="number">4007</span>ms</span><br><span class="line">rtt min<span class="operator">/</span>avg<span class="operator">/</span>max<span class="operator">/</span>mdev <span class="operator">=</span> <span class="number">40.586</span><span class="operator">/</span><span class="number">41.609</span><span class="operator">/</span><span class="number">43.340</span><span class="operator">/</span><span class="number">1.098</span> ms</span><br></pre></td></tr></table></figure></div>

<p><strong>设置开机启动</strong></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ vi /opt/octavia-interface-start.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line"><span class="comment">#MAC=$MGMT_PORT_MAC</span></span><br><span class="line"><span class="comment">#PORT_ID=$MGMT_PORT_ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MAC 为 $MGMT_PORT_MAC ，PORT_ID 为 $MGMT_PORT_ID，具体含义看前面</span></span><br><span class="line">MAC=<span class="string">&quot;fa:16:3e:c5:d8:78&quot;</span></span><br><span class="line">PORT_ID=<span class="string">&quot;c7112971-1252-4bc5-8ae6-67bda4153376&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sleep</span> 120s</span><br><span class="line"></span><br><span class="line">ovs-vsctl --may-exist add-port br-int o-hm0 \</span><br><span class="line">-- <span class="built_in">set</span> Interface o-hm0 <span class="built_in">type</span>=internal \</span><br><span class="line">-- <span class="built_in">set</span> Interface o-hm0 external-ids:iface-status=active \</span><br><span class="line">-- <span class="built_in">set</span> Interface o-hm0 external-ids:attached-mac=<span class="variable">$MAC</span> \</span><br><span class="line">-- <span class="built_in">set</span> Interface o-hm0 external-ids:iface-id=<span class="variable">$PORT_ID</span></span><br><span class="line"></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev o-hm0 address <span class="variable">$MAC</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev o-hm0 up</span><br><span class="line">iptables -I INPUT -i o-hm0 -p udp --dport 5555 -j ACCEPT</span><br><span class="line"></span><br><span class="line">dhclient -v o-hm0 -cf /etc/dhcp/octavia</span><br><span class="line">route del default gw 172.16.0.1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;nameserver 10.10.10.2&#x27;</span> &gt; /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">chmod</span> +x /opt/octavia-interface-start.sh</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;nohup sh /opt/octavia-interface-start.sh &gt; /var/log/octavia-interface-start.log 2&gt;&amp;1 &amp;&#x27;</span> &gt;&gt; /etc/rc.d/rc.local</span><br><span class="line">$ <span class="built_in">chmod</span> +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure></div>

<h2 id="修改配置文件-1"><a href="#修改配置文件-1" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p>全部控制节点执行，注意 bind_host；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份/etc/octavia/octavia.conf配置文件</span></span><br><span class="line"><span class="built_in">cp</span> /etc/octavia/octavia.conf&#123;,.bak&#125;</span><br><span class="line">egrep -v <span class="string">&#x27;^$|^#&#x27;</span> /etc/octavia/octavia.conf.bak &gt; /etc/octavia/octavia.conf</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf DEFAULT transport_url  rabbit://openstack:123456@controller01:5672,openstack:123456@controller02:5672,openstack:123456@controller03:5672</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf database connection  mysql+pymysql://octavia:123456@10.10.10.10/octavia</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf api_settings bind_host 10.10.10.31</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf api_settings bind_port 9876</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf api_settings auth_strategy keystone</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf health_manager bind_port 5555</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf health_manager bind_ip <span class="variable">$OCTAVIA_MGMT_PORT_IP</span></span><br><span class="line"><span class="comment"># 高可用环境填多个</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf health_manager controller_ip_port_list 172.16.0.2:5555,172.16.0.3:5555,172.16.0.4:5555</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf keystone_authtoken www_authenticate_uri http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf keystone_authtoken auth_url  http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf keystone_authtoken memcached_servers controller01:11211,controller02:11211,controller03:11211</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf keystone_authtoken auth_type password</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf keystone_authtoken project_domain_name default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf keystone_authtoken user_domain_name default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf keystone_authtoken project_name service</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf keystone_authtoken username octavia</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf keystone_authtoken password 123456</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf certificates cert_generator local_cert_generator</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf certificates ca_private_key_passphrase 123456</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf certificates ca_private_key /etc/octavia/certs/server_ca.key.pem</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf certificates ca_certificate /etc/octavia/certs/server_ca.cert.pem</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf haproxy_amphora client_cert /etc/octavia/certs/client.cert-and-key.pem</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf haproxy_amphora server_ca /etc/octavia/certs/server_ca.cert.pem</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf haproxy_amphora key_path  /etc/octavia/.ssh/octavia_ssh_key</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf haproxy_amphora base_path  /var/lib/octavia</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf haproxy_amphora base_cert_dir  /var/lib/octavia/certs</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf haproxy_amphora connection_max_retries  5500</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf haproxy_amphora connection_retry_interval  5</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf haproxy_amphora rest_request_conn_timeout  10</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf haproxy_amphora rest_request_read_timeout  120</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf oslo_messaging topic octavia_prov</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf oslo_messaging rpc_thread_pool_size 2</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf house_keeping load_balancer_expiry_age 3600</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf house_keeping amphora_expiry_age 3600</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf service_auth auth_url http://10.10.10.10:5000</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf service_auth memcached_servers controller01:11211,controller02:11211,controller03:11211</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf service_auth auth_type password</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf service_auth project_domain_name default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf service_auth user_domain_name default</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf service_auth project_name service</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf service_auth username octavia</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf service_auth password 123456</span><br><span class="line"></span><br><span class="line">AMP_IMAGE_OWNER_ID=$(openstack project show service -c <span class="built_in">id</span> -f value)</span><br><span class="line">AMP_SECGROUP_LIST=$(openstack security group show lb-mgmt-sec-grp -c <span class="built_in">id</span> -f value)</span><br><span class="line">AMP_BOOT_NETWORK_LIST=$(openstack network show lb-mgmt-net -c <span class="built_in">id</span> -f value)</span><br><span class="line"></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf controller_worker client_ca /etc/octavia/certs/client_ca.cert.pem</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf controller_worker amp_image_tag amphora</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf controller_worker amp_flavor_id 200</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf controller_worker amp_image_owner_id <span class="variable">$AMP_IMAGE_OWNER_ID</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf controller_worker amp_secgroup_list <span class="variable">$AMP_SECGROUP_LIST</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf controller_worker amp_boot_network_list <span class="variable">$AMP_BOOT_NETWORK_LIST</span></span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf controller_worker amp_ssh_key_name octavia_ssh_key</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf controller_worker network_driver allowed_address_pairs_driver</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf controller_worker compute_driver compute_nova_driver</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf controller_worker amphora_driver amphora_haproxy_rest_driver</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf controller_worker workers 2</span><br><span class="line">openstack-config --<span class="built_in">set</span> /etc/octavia/octavia.conf controller_worker loadbalancer_topology ACTIVE_STANDBY</span><br></pre></td></tr></table></figure></div>

<h2 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h2><p>任意控制节点执行；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">octavia-db-manage --config-file /etc/octavia/octavia.conf upgrade <span class="built_in">head</span></span><br></pre></td></tr></table></figure></div>

<h2 id="启动服务-6"><a href="#启动服务-6" class="headerlink" title="启动服务"></a>启动服务</h2><p>全部控制节点执行；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> octavia-api.service octavia-health-manager.service octavia-housekeeping.service octavia-worker.service</span><br><span class="line">systemctl restart octavia-api.service octavia-health-manager.service octavia-housekeeping.service octavia-worker.service</span><br><span class="line">systemctl status octavia-api.service octavia-health-manager.service octavia-housekeeping.service octavia-worker.service</span><br></pre></td></tr></table></figure></div>

<h2 id="升级dashboard开启"><a href="#升级dashboard开启" class="headerlink" title="升级dashboard开启"></a>升级dashboard开启</h2><p>全部控制节点执行；</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/openstack/octavia-dashboard.git -b stable/train</span><br><span class="line"><span class="built_in">cd</span> /root/octavia-dashboard</span><br><span class="line">python setup.py install</span><br><span class="line"><span class="built_in">cd</span> /root/octavia-dashboard/octavia_dashboard/enabled</span><br><span class="line"><span class="built_in">cp</span> _1482_project_load_balancer_panel.py /usr/share/openstack-dashboard/openstack_dashboard/enabled/</span><br><span class="line"><span class="built_in">cd</span> /usr/share/openstack-dashboard</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">yes</span>|./manage.py collectstatic</span><br><span class="line">./manage.py compress</span><br><span class="line">systemctl restart httpd</span><br><span class="line">systemctl status httpd</span><br></pre></td></tr></table></figure></div>

<h2 id="创建-loadbalancer"><a href="#创建-loadbalancer" class="headerlink" title="创建 loadbalancer"></a>创建 loadbalancer</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111222046328.png"
                      alt="image-20211122204630997"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111222047130.png"
                      alt="image-20211122204734065"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111222047665.png"
                      alt="image-20211122204754298"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111222048097.png"
                      alt="image-20211122204826071"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111222048081.png"
                      alt="image-20211122204848243"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111222049262.png"
                      alt="image-20211122204911400"
                ></p>
<p>稍等一会，系统会自动创建两个 amphora-x64-haproxy 的实例，并且会分配后端服务的 vpc 的网络地址，如果后端服务器属于多个vpc，则会分配多个 vpc 的网络地址</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111222050120.png"
                      alt="image-20211122205037844"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111222105239.png"
                      alt="image-20211122210517854"
                ></p>
<ul>
<li>如果需要ssh登陆到实例中，可以在任意控制节点：</li>
</ul>
<div class="highlight-container" data-rel="Vbnet"><figure class="iseeu highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@controller01 ~]# ssh -i /etc/octavia/.ssh/octavia_ssh_key cloud-user@<span class="number">172.16</span>.<span class="number">0.162</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">&#x27;172.16.0.162 (172.16.0.162)&#x27; can&#x27;t be established.</span></span><br><span class="line">ECDSA <span class="keyword">key</span> fingerprint <span class="built_in">is</span> SHA256:kAbm5G1FbZPZEmWGNbzvcYYubxeKlr6l456XEVr886o.</span><br><span class="line">ECDSA <span class="keyword">key</span> fingerprint <span class="built_in">is</span> MD5:<span class="number">3</span>c:<span class="number">87</span>:<span class="number">63</span>:e3:cc:e9:<span class="number">90</span>:f6:<span class="number">33</span>:<span class="number">5</span>a:<span class="number">06</span>:<span class="number">73</span>:<span class="number">1</span>e:<span class="number">6</span>d:b7:<span class="number">82</span>.</span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line"><span class="symbol">Warning:</span> Permanently added <span class="comment">&#x27;172.16.0.162&#x27; (ECDSA) to the list of known hosts.</span></span><br><span class="line">[cloud-user@amphora-<span class="number">65</span>ef42f2-ef2d-<span class="number">4e7d</span>-bd48-a0de84a12e3a ~]$</span><br><span class="line">[cloud-user@amphora-<span class="number">65</span>ef42f2-ef2d-<span class="number">4e7d</span>-bd48-a0de84a12e3a ~]$ sudo su -</span><br><span class="line">[root@amphora-<span class="number">65</span>ef42f2-ef2d-<span class="number">4e7d</span>-bd48-a0de84a12e3a ~]#</span><br></pre></td></tr></table></figure></div>

<ul>
<li>测试还发现：使用管理员把 amphora 实例手动删除后并不会自动重新创建</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111222052369.png"
                      alt="image-20211122205202340"
                ></p>
<p>绑定一个浮动IP，测试是否能ssh过去</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111222054613.png"
                      alt="image-20211122205428673"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://raw.githubusercontent.com/leffss/images/master/img/202111222055750.png"
                      alt="image-20211122205533628"
                ></p>
<p><strong>其他七层代理的具体设置就不赘述了，可自行研究</strong></p>
<h1 id="其他组件"><a href="#其他组件" class="headerlink" title="其他组件"></a>其他组件</h1><p>其他 <strong>Ceilometer</strong>、 <strong>Heat</strong>、 <strong>Trove</strong>、 <strong>VPNaaS</strong>、 <strong>FWaaS</strong> 等组件，后期有空再研究。</p>
<h1 id="错误记录"><a href="#错误记录" class="headerlink" title="错误记录"></a>错误记录</h1><h2 id="libvirtError-internal-error-End-of-file-from-qemu-monitor"><a href="#libvirtError-internal-error-End-of-file-from-qemu-monitor" class="headerlink" title="libvirtError: internal error: End of file from qemu monitor"></a>libvirtError: internal error: End of file from qemu monitor</h2><p>创建loadbalancer时现在状态错误</p>
<p>查看计算节点日志 &#x2F;var&#x2F;log&#x2F;nova&#x2F;nova-compute.log ，发现报错 ：</p>
<div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="string">req-d6b447e9-d0c7-4529-afba-a162f34ca96b</span> <span class="string">4841c9405a204f608ea7c253f45c308f</span> <span class="string">1e92f7de5ed646c7a16d422bcbe040bb</span> <span class="bullet">-</span> <span class="string">default</span> <span class="string">default</span>] [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>] <span class="attr">detaching network adapter failed.: libvirtError: internal error:</span> <span class="string">End</span> <span class="string">of</span> <span class="string">file</span> <span class="string">from</span> <span class="string">qemu</span> <span class="string">monitor</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>] <span class="string">Traceback</span> <span class="string">(most</span> <span class="string">recent</span> <span class="string">call</span> <span class="string">last):</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">2199</span><span class="string">,</span> <span class="string">in</span> <span class="string">detach_interface</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]     <span class="string">supports_device_missing_error_code=supports_device_missing)</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/nova/virt/libvirt/guest.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">455</span><span class="string">,</span> <span class="string">in</span> <span class="string">detach_device_with_retry</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]     <span class="string">_try_detach_device(conf,</span> <span class="string">persistent,</span> <span class="string">live)</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/nova/virt/libvirt/guest.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">444</span><span class="string">,</span> <span class="string">in</span> <span class="string">_try_detach_device</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]     <span class="string">ctx.reraise</span> <span class="string">=</span> <span class="literal">True</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">220</span><span class="string">,</span> <span class="string">in</span> <span class="string">__exit__</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]     <span class="string">self.force_reraise()</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">196</span><span class="string">,</span> <span class="string">in</span> <span class="string">force_reraise</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]     <span class="string">six.reraise(self.type_,</span> <span class="string">self.value,</span> <span class="string">self.tb)</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/nova/virt/libvirt/guest.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">408</span><span class="string">,</span> <span class="string">in</span> <span class="string">_try_detach_device</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]     <span class="string">self.detach_device(conf,</span> <span class="string">persistent=persistent,</span> <span class="string">live=live)</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/nova/virt/libvirt/guest.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">505</span><span class="string">,</span> <span class="string">in</span> <span class="string">detach_device</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]     <span class="string">self._domain.detachDeviceFlags(device_xml,</span> <span class="string">flags=flags)</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/eventlet/tpool.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">190</span><span class="string">,</span> <span class="string">in</span> <span class="string">doit</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]     <span class="string">result</span> <span class="string">=</span> <span class="string">proxy_call(self._autowrap,</span> <span class="string">f,</span> <span class="string">*args,</span> <span class="string">**kwargs)</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/eventlet/tpool.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">148</span><span class="string">,</span> <span class="string">in</span> <span class="string">proxy_call</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]     <span class="string">rv</span> <span class="string">=</span> <span class="string">execute(f,</span> <span class="string">*args,</span> <span class="string">**kwargs)</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/eventlet/tpool.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">129</span><span class="string">,</span> <span class="string">in</span> <span class="string">execute</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]     <span class="string">six.reraise(c,</span> <span class="string">e,</span> <span class="string">tb)</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/eventlet/tpool.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">83</span><span class="string">,</span> <span class="string">in</span> <span class="string">tworker</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]     <span class="string">rv</span> <span class="string">=</span> <span class="string">meth(*args,</span> <span class="string">**kwargs)</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]   <span class="string">File</span> <span class="string">&quot;/usr/lib64/python2.7/site-packages/libvirt.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">1253</span><span class="string">,</span> <span class="string">in</span> <span class="string">detachDeviceFlags</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>]     <span class="string">if</span> <span class="string">ret</span> <span class="string">==</span> <span class="number">-1</span><span class="string">:</span> <span class="string">raise</span> <span class="string">libvirtError</span> <span class="string">(&#x27;virDomainDetachDeviceFlags()</span> <span class="string">failed&#x27;,</span> <span class="string">dom=self)</span></span><br><span class="line"><span class="number">2021-11-24 15:08:24.462 </span><span class="number">3924 </span><span class="string">ERROR</span> <span class="string">nova.virt.libvirt.driver</span> [<span class="attr">instance:</span> <span class="string">c3282fab-d210-4b35-a8b5-7eee1f07943d</span>] <span class="attr">libvirtError: internal error:</span> <span class="string">End</span> <span class="string">of</span> <span class="string">file</span> <span class="string">from</span> <span class="string">qemu</span> <span class="string">monitor</span></span><br></pre></td></tr></table></figure></div>

<p>网上查了下，好像是 libvirt 的 bug，删除错误的负载均衡，重新创建一个就好了</p>
<h2 id="Lost-connection-to-MySQL-server-during-query"><a href="#Lost-connection-to-MySQL-server-during-query" class="headerlink" title="Lost connection to MySQL server during query"></a>Lost connection to MySQL server during query</h2><p>集群种使用 mysql 的组件都有此报错：</p>
<div class="highlight-container" data-rel="Vhdl"><figure class="iseeu highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines Traceback (most recent call last):</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/oslo_db/sqlalchemy/engines.py&quot;</span>, <span class="literal">line</span> <span class="number">73</span>, <span class="keyword">in</span> _connect_ping_listener</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     connection.scalar(<span class="keyword">select</span>([<span class="number">1</span>]))</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py&quot;</span>, <span class="literal">line</span> <span class="number">912</span>, <span class="keyword">in</span> scalar</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     <span class="keyword">return</span> self.execute(object_, *multiparams, **params).scalar()</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py&quot;</span>, <span class="literal">line</span> <span class="number">980</span>, <span class="keyword">in</span> execute</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     <span class="keyword">return</span> meth(self, multiparams, params)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib64/python2.7/site-packages/sqlalchemy/sql/elements.py&quot;</span>, <span class="literal">line</span> <span class="number">273</span>, <span class="keyword">in</span> _execute_on_connection</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     <span class="keyword">return</span> connection._execute_clauseelement(self, multiparams, params)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py&quot;</span>, <span class="literal">line</span> <span class="number">1099</span>, <span class="keyword">in</span> _execute_clauseelement</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     distilled_params,</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py&quot;</span>, <span class="literal">line</span> <span class="number">1240</span>, <span class="keyword">in</span> _execute_context</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     e, statement, parameters, cursor, <span class="keyword">context</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py&quot;</span>, <span class="literal">line</span> <span class="number">1456</span>, <span class="keyword">in</span> _handle_dbapi_exception</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     util.raise_from_cause(newraise, exc_info)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib64/python2.7/site-packages/sqlalchemy/util/compat.py&quot;</span>, <span class="literal">line</span> <span class="number">296</span>, <span class="keyword">in</span> raise_from_cause</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     reraise(<span class="keyword">type</span>(exception), exception, tb=exc_tb, cause=cause)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib64/python2.7/site-packages/sqlalchemy/engine/base.py&quot;</span>, <span class="literal">line</span> <span class="number">1236</span>, <span class="keyword">in</span> _execute_context</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     cursor, statement, parameters, <span class="keyword">context</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib64/python2.7/site-packages/sqlalchemy/engine/default.py&quot;</span>, <span class="literal">line</span> <span class="number">536</span>, <span class="keyword">in</span> do_execute</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     cursor.execute(statement, parameters)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/pymysql/cursors.py&quot;</span>, <span class="literal">line</span> <span class="number">170</span>, <span class="keyword">in</span> execute</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     result = self._query(query)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/pymysql/cursors.py&quot;</span>, <span class="literal">line</span> <span class="number">328</span>, <span class="keyword">in</span> _query</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     conn.query(q)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/pymysql/connections.py&quot;</span>, <span class="literal">line</span> <span class="number">517</span>, <span class="keyword">in</span> query</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     self._affected_rows = self._read_query_result(unbuffered=unbuffered)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/pymysql/connections.py&quot;</span>, <span class="literal">line</span> <span class="number">732</span>, <span class="keyword">in</span> _read_query_result</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     result.read()</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/pymysql/connections.py&quot;</span>, <span class="literal">line</span> <span class="number">1075</span>, <span class="keyword">in</span> read</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     first_packet = self.connection._read_packet()</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/pymysql/connections.py&quot;</span>, <span class="literal">line</span> <span class="number">657</span>, <span class="keyword">in</span> _read_packet</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     packet_header = self._read_bytes(<span class="number">4</span>)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines   <span class="keyword">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/pymysql/connections.py&quot;</span>, <span class="literal">line</span> <span class="number">707</span>, <span class="keyword">in</span> _read_bytes</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines     CR.CR_SERVER_LOST, <span class="string">&quot;Lost connection to MySQL server during query&quot;</span>)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines DBConnectionError: (pymysql.err.OperationalError) (<span class="number">2013</span>, <span class="symbol">&#x27;Lost</span> connection <span class="keyword">to</span> MySQL server during query&#x27;) [SQL: u<span class="symbol">&#x27;SELECT</span> <span class="number">1</span>&#x27;] (Background <span class="keyword">on</span> this <span class="literal">error</span> at: http://sqlalche.me/e/e3q8)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">09.098</span> <span class="number">11394</span> <span class="literal">ERROR</span> oslo_db.sqlalchemy.engines</span><br></pre></td></tr></table></figure></div>

<p>查看 &#x2F;var&#x2F;log&#x2F;mariadb&#x2F;mariadb.log 发现大量 Warning</p>
<div class="highlight-container" data-rel="Vhdl"><figure class="iseeu highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> packets)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">14</span>:<span class="number">12</span>:<span class="number">13</span> <span class="number">1079</span> [<span class="literal">Warning</span>] Aborted connection <span class="number">1079</span> <span class="keyword">to</span> db: <span class="symbol">&#x27;neutron</span>&#x27; user: <span class="symbol">&#x27;neutron</span>&#x27; host: <span class="symbol">&#x27;ha01</span>&#x27; (Got an <span class="literal">error</span> reading communication packets)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">14</span>:<span class="number">12</span>:<span class="number">13</span> <span class="number">1080</span> [<span class="literal">Warning</span>] Aborted connection <span class="number">1080</span> <span class="keyword">to</span> db: <span class="symbol">&#x27;neutron</span>&#x27; user: <span class="symbol">&#x27;neutron</span>&#x27; host: <span class="symbol">&#x27;ha01</span>&#x27; (Got an <span class="literal">error</span> reading communication packets)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">14</span>:<span class="number">12</span>:<span class="number">13</span> <span class="number">1077</span> [<span class="literal">Warning</span>] Aborted connection <span class="number">1077</span> <span class="keyword">to</span> db: <span class="symbol">&#x27;neutron</span>&#x27; user: <span class="symbol">&#x27;neutron</span>&#x27; host: <span class="symbol">&#x27;ha01</span>&#x27; (Got an <span class="literal">error</span> reading communication packets)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">14</span>:<span class="number">12</span>:<span class="number">16</span> <span class="number">1081</span> [<span class="literal">Warning</span>] Aborted connection <span class="number">1081</span> <span class="keyword">to</span> db: <span class="symbol">&#x27;placement</span>&#x27; user: <span class="symbol">&#x27;placement</span>&#x27; host: <span class="symbol">&#x27;ha01</span>&#x27; (Got an <span class="literal">error</span> reading communication packets)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">14</span>:<span class="number">12</span>:<span class="number">55</span> <span class="number">1082</span> [<span class="literal">Warning</span>] Aborted connection <span class="number">1082</span> <span class="keyword">to</span> db: <span class="symbol">&#x27;placement</span>&#x27; user: <span class="symbol">&#x27;placement</span>&#x27; host: <span class="symbol">&#x27;ha01</span>&#x27; (Got an <span class="literal">error</span> reading communication packets)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">14</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">1085</span> [<span class="literal">Warning</span>] Aborted connection <span class="number">1085</span> <span class="keyword">to</span> db: <span class="symbol">&#x27;neutron</span>&#x27; user: <span class="symbol">&#x27;neutron</span>&#x27; host: <span class="symbol">&#x27;ha01</span>&#x27; (Got an <span class="literal">error</span> reading communication packets)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">14</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">1083</span> [<span class="literal">Warning</span>] Aborted connection <span class="number">1083</span> <span class="keyword">to</span> db: <span class="symbol">&#x27;neutron</span>&#x27; user: <span class="symbol">&#x27;neutron</span>&#x27; host: <span class="symbol">&#x27;ha01</span>&#x27; (Got an <span class="literal">error</span> reading communication packets)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">14</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">1084</span> [<span class="literal">Warning</span>] Aborted connection <span class="number">1084</span> <span class="keyword">to</span> db: <span class="symbol">&#x27;neutron</span>&#x27; user: <span class="symbol">&#x27;neutron</span>&#x27; host: <span class="symbol">&#x27;ha01</span>&#x27; (Got an <span class="literal">error</span> reading communication packets)</span><br><span class="line"><span class="number">2021</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">14</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">1090</span> [<span class="literal">Warning</span>] Aborted connection <span class="number">1090</span> <span class="keyword">to</span> db: <span class="symbol">&#x27;placement</span>&#x27; user: <span class="symbol">&#x27;placement</span>&#x27; host: <span class="symbol">&#x27;ha01</span>&#x27; (Got an <span class="literal">error</span> reading communication packets)</span><br></pre></td></tr></table></figure></div>

<p>参考以下文章：</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/KangKangShenShen/article/details/116208961?depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link" >完美解决MySQL错误日志出现大量的 Got an error reading communication packets 报错_KangKangShenShen的博客-CSDN博客 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/274560394" >mysql之Got an error reading communication packets排查 - 知乎 (zhihu.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/gaoquan/p/5775457.html" >mysql5.7碰到的坑 - 高权 - 博客园 (cnblogs.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>做了相关设置，好像依然会报错，但是不影响集群使用，暂时忽略。</p>
<h2 id="Could-not-sign-the-certificate-request-Failed-to-load-CA-Certificate"><a href="#Could-not-sign-the-certificate-request-Failed-to-load-CA-Certificate" class="headerlink" title="Could not sign the certificate request: Failed to load CA Certificate"></a>Could not sign the certificate request: Failed to load CA Certificate</h2><p>创建 loadbalancer 时出错，查看控制节点日志：&#x2F;var&#x2F;log&#x2F;octavia&#x2F;worker.log ，发现报错</p>
<div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span> <span class="string">Traceback</span> <span class="string">(most</span> <span class="string">recent</span> <span class="string">call</span> <span class="string">last):</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/oslo_messaging/rpc/server.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">1</span></span><br><span class="line"><span class="number">65</span><span class="string">,</span> <span class="string">in</span> <span class="string">_process_incoming</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">res</span> <span class="string">=</span> <span class="string">self.dispatcher.dispatch(message)</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py&quot;</span><span class="string">,</span> <span class="string">li</span></span><br><span class="line"><span class="string">ne</span> <span class="number">274</span><span class="string">,</span> <span class="string">in</span> <span class="string">dispatch</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">return</span> <span class="string">self._do_dispatch(endpoint,</span> <span class="string">method,</span> <span class="string">ctxt,</span> <span class="string">args)</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/oslo_messaging/rpc/dispatcher.py&quot;</span><span class="string">,</span> <span class="string">li</span></span><br><span class="line"><span class="string">ne</span> <span class="number">194</span><span class="string">,</span> <span class="string">in</span> <span class="string">_do_dispatch</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">result</span> <span class="string">=</span> <span class="string">func(ctxt,</span> <span class="string">**new_args)</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/octavia/controller/queue/v1/endpoints</span></span><br><span class="line"><span class="string">.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">45</span><span class="string">,</span> <span class="string">in</span> <span class="string">create_load_balancer</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">self.worker.create_load_balancer(load_balancer_id,</span> <span class="string">flavor)</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/tenacity/__init__.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">292</span><span class="string">,</span> <span class="string">in</span> <span class="string">w</span></span><br><span class="line"><span class="string">rapped_f</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">return</span> <span class="string">self.call(f,</span> <span class="string">*args,</span> <span class="string">**kw)</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/tenacity/__init__.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">358</span><span class="string">,</span> <span class="string">in</span> <span class="string">c</span></span><br><span class="line"><span class="string">all</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">do</span> <span class="string">=</span> <span class="string">self.iter(retry_state=retry_state)</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/tenacity/__init__.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">319</span><span class="string">,</span> <span class="string">in</span> <span class="string">i</span></span><br><span class="line"><span class="string">ter</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">return</span> <span class="string">fut.result()</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/concurrent/futures/_base.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">42</span></span><br><span class="line"><span class="number">2</span><span class="string">,</span> <span class="string">in</span> <span class="string">result</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">return</span> <span class="string">self.__get_result()</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/tenacity/__init__.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">361</span><span class="string">,</span> <span class="string">in</span> <span class="string">c</span></span><br><span class="line"><span class="string">all</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">result</span> <span class="string">=</span> <span class="string">fn(*args,</span> <span class="string">**kwargs)</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/octavia/controller/worker/v1/controll</span></span><br><span class="line"><span class="string">er_worker.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">342</span><span class="string">,</span> <span class="string">in</span> <span class="string">create_load_balancer</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">create_lb_tf.run()</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/taskflow/engines/action_engine/engine</span></span><br><span class="line"><span class="string">.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">247</span><span class="string">,</span> <span class="string">in</span> <span class="string">run</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">for</span> <span class="string">_state</span> <span class="string">in</span> <span class="string">self.run_iter(timeout=timeout):</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/taskflow/engines/action_engine/engine</span></span><br><span class="line"><span class="string">.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">340</span><span class="string">,</span> <span class="string">in</span> <span class="string">run_iter</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">failure.Failure.reraise_if_any(er_failures)</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>   <span class="string">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/taskflow/types/failure.py&quot;</span><span class="string">,</span> <span class="string">line</span> <span class="number">341</span><span class="string">,</span></span><br><span class="line"><span class="string">in</span> <span class="string">reraise_if_any</span></span><br><span class="line"><span class="number">2021-11-23 21:46:48.844 </span><span class="number">23697</span> <span class="string">ERROR</span> <span class="string">oslo_messaging.rpc.server</span>     <span class="string">raise</span> <span class="string">exc.WrappedFailure(failures)</span></span><br><span class="line"><span class="attr">2021-11-23 21:46:48.844 23697 ERROR oslo_messaging.rpc.server WrappedFailure: WrappedFailure:</span> [<span class="attr">Failure:</span> <span class="string">octavia.common.exceptions.Certificat</span></span><br><span class="line"><span class="attr">eGenerationException: Could not sign the certificate request:</span> <span class="string">Failed</span> <span class="string">to</span> <span class="string">load</span> <span class="string">CA</span> <span class="string">Certificate</span> <span class="string">/etc/octavia/certs/server_ca.cert.pem.</span>, <span class="attr">Failure:</span></span><br><span class="line"><span class="attr">octavia.common.exceptions.CertificateGenerationException: Could not sign the certificate request:</span> <span class="string">Failed</span> <span class="string">to</span> <span class="string">load</span> <span class="string">CA</span> <span class="string">Certificate</span> <span class="string">/etc/octavia/certs/server_ca.cert.pem.</span>]</span><br></pre></td></tr></table></figure></div>

<p>一般是证书有问题，重新生成所有控制节点的证书，然后重启 octavia 服务即可</p>
<div class="highlight-container" data-rel="Lua"><figure class="iseeu highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart octavia-api.service octavia-health-manager.service octavia-housekeeping.service octavia-worker.service</span><br><span class="line">systemctl <span class="built_in">status</span> octavia-api.service octavia-health-manager.service octavia-housekeeping.service octavia-worker.service</span><br></pre></td></tr></table></figure></div>
            </div>

            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/Openstack/">#Openstack</a>&nbsp;
                        </li>
                    
                </ul>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/2023/12/20/gtapic1/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">GTA5 Online Screenshots 1</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/2023/11/22/cephfs/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">记CephFS测试环境搭建</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">&lt;转&gt;openstack高可用集群搭建(分布式路由)(train版)</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E8%A7%84%E5%88%92"><span class="nav-text">一、规划</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E8%A7%84%E5%88%92"><span class="nav-text">主机规划</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%8B%93%E6%89%91"><span class="nav-text">系统拓扑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vmware-%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="nav-text">Vmware 虚拟机网络配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E8%AE%BE%E7%BD%AE"><span class="nav-text">虚拟网络设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ha-node"><span class="nav-text">ha node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#controller-network-node"><span class="nav-text">controller + network node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#compute-node"><span class="nav-text">compute node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-node"><span class="nav-text">ceph node</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E8%A7%84%E5%88%92"><span class="nav-text">整体规划</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE%E5%8F%82%E8%80%83"><span class="nav-text">网卡配置参考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7%E5%86%85%E6%A0%B8"><span class="nav-text">升级内核</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEfirewalld%E3%80%81selinux%E3%80%81ntp%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5%E3%80%81hostname%E3%80%81hosts%E6%96%87%E4%BB%B6"><span class="nav-text">配置firewalld、selinux、ntp时间同步、hostname、hosts文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4-ssh-%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB"><span class="nav-text">配置集群 ssh 信任关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96-ssh-%E7%99%BB%E9%99%86%E9%80%9F%E5%BA%A6"><span class="nav-text">优化 ssh 登陆速度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96"><span class="nav-text">内核参数优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%9F%BA%E7%A1%80%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="nav-text">安装基础软件包</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1"><span class="nav-text">二、基础服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MariaDB%E9%9B%86%E7%BE%A4"><span class="nav-text">MariaDB集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE%E4%BF%AE%E6%94%B9"><span class="nav-text">安装与配置修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-text">构建集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%BF%83%E8%B7%B3%E6%A3%80%E6%B5%8Bclustercheck"><span class="nav-text">设置心跳检测clustercheck</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%85%B3%E6%9C%BA%E6%88%96%E5%BC%82%E5%B8%B8%E6%96%AD%E7%94%B5%E5%90%8E%E7%9A%84%E4%BF%AE%E5%A4%8D"><span class="nav-text">异常关机或异常断电后的修复</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ%E9%9B%86%E7%BE%A4"><span class="nav-text">RabbitMQ集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E7%9B%B8%E5%85%B3%E8%BD%AF%E4%BB%B6%E5%8C%85-%E6%89%80%E6%9C%89%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9"><span class="nav-text">下载相关软件包(所有控制节点)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BArabbitmq%E9%9B%86%E7%BE%A4"><span class="nav-text">构建rabbitmq集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memcached%E9%9B%86%E7%BE%A4"><span class="nav-text">Memcached集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85memcache%E7%9A%84%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="nav-text">安装memcache的软件包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEmemcached"><span class="nav-text">设置memcached</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="nav-text">启动服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8-haproxy-keepalived"><span class="nav-text">高可用 haproxy + keepalived</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6"><span class="nav-text">安装软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-keepalived"><span class="nav-text">配置 keepalived</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8-haproxy-%E4%B8%8E-keepalived"><span class="nav-text">启动 haproxy 与 keepalived</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-text">测试高可用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-haproxy"><span class="nav-text">配置 haproxy</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81Keystone%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-text">三、Keystone集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAkeystone%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">创建keystone数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85keystone"><span class="nav-text">安装keystone</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEKeystone"><span class="nav-text">配置Keystone</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96keystone%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">初始化keystone数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEHttp-Server"><span class="nav-text">配置Http Server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEadmin%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F%E8%84%9A%E6%9C%AC"><span class="nav-text">配置admin用户变量脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E5%9F%9F%E3%80%81%E9%A1%B9%E7%9B%AE%E3%80%81%E7%94%A8%E6%88%B7%E5%92%8C%E8%A7%92%E8%89%B2"><span class="nav-text">创建新域、项目、用户和角色</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%9F%9F"><span class="nav-text">创建域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAdemo%E9%A1%B9%E7%9B%AE"><span class="nav-text">创建demo项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAdemo%E7%94%A8%E6%88%B7"><span class="nav-text">创建demo用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAuser%E8%A7%92%E8%89%B2"><span class="nav-text">创建user角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E8%A7%92%E8%89%B2"><span class="nav-text">查看角色</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81keystone"><span class="nav-text">验证keystone</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Glance%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-text">四、Glance集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAglance%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">创建glance数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAglance-api%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1%E5%87%AD%E8%AF%81"><span class="nav-text">创建glance-api相关服务凭证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E4%B8%8E%E9%85%8D%E7%BD%AEglance"><span class="nav-text">部署与配置glance</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85glance"><span class="nav-text">安装glance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEglance-api-conf"><span class="nav-text">配置glance-api.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E5%AD%98%E5%82%A8%E7%9B%AE%E5%BD%95%E5%B9%B6%E8%B5%8B%E6%9D%83%E9%99%90"><span class="nav-text">创建镜像存储目录并赋权限</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96glance%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">初始化glance数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-1"><span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BDcirros%E9%95%9C%E5%83%8F%E9%AA%8C%E8%AF%81glance%E6%9C%8D%E5%8A%A1"><span class="nav-text">下载cirros镜像验证glance服务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81Placement%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2"><span class="nav-text">五、Placement服务部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAPlacement%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">创建Placement数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAplacement-api"><span class="nav-text">创建placement-api</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85placement%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="nav-text">安装placement软件包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">修改配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96placement%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">初始化placement数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE00-placement-api-conf"><span class="nav-text">配置00-placement-api.conf</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9placement%E7%9A%84apache%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">修改placement的apache配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E7%94%A8placement-API%E8%AE%BF%E9%97%AE"><span class="nav-text">启用placement API访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%90%AFapache%E6%9C%8D%E5%8A%A1"><span class="nav-text">重启apache服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E6%A3%80%E6%9F%A5Placement%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="nav-text">验证检查Placement健康状态</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81Nova%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-text">六、Nova控制节点集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAnova%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">创建nova相关数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAnova%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1%E5%87%AD%E8%AF%81"><span class="nav-text">创建nova相关服务凭证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85nova%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="nav-text">安装nova软件包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-text">部署与配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96nova%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B9%B6%E9%AA%8C%E8%AF%81"><span class="nav-text">初始化nova相关数据库并验证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8nova%E6%9C%8D%E5%8A%A1"><span class="nav-text">启动nova服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81"><span class="nav-text">验证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81Nova%E8%AE%A1%E7%AE%97%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-text">七、Nova计算节点集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85nova-compute"><span class="nav-text">安装nova-compute</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E4%B8%8E%E9%85%8D%E7%BD%AE-1"><span class="nav-text">部署与配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E8%AE%A1%E7%AE%97%E8%8A%82%E7%82%B9%E7%9A%84nova%E6%9C%8D%E5%8A%A1"><span class="nav-text">启动计算节点的nova服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%91cell%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B7%BB%E5%8A%A0%E8%AE%A1%E7%AE%97%E8%8A%82%E7%82%B9"><span class="nav-text">向cell数据库添加计算节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9%E4%B8%8A%E5%8F%91%E7%8E%B0%E8%AE%A1%E7%AE%97%E4%B8%BB%E6%9C%BA"><span class="nav-text">控制节点上发现计算主机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81-1"><span class="nav-text">验证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%EF%BC%9Aopenstack-nova-%E3%80%81kvm%E3%80%81qemu%E5%92%8Clibvirtd%E4%B9%8B%E9%97%B4%E7%9A%84%E8%81%94%E7%B3%BB"><span class="nav-text">扩展：openstack(nova)、kvm、qemu和libvirtd之间的联系</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81Neutron%E6%8E%A7%E5%88%B6-%E7%BD%91%E7%BB%9C%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%EF%BC%88openvswitch%E6%96%B9%E5%BC%8F%EF%BC%89"><span class="nav-text">八、Neutron控制+网络节点集群部署（openvswitch方式）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAnova%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%88%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9%EF%BC%89"><span class="nav-text">创建nova相关数据库（控制节点）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAneutron%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1%E5%87%AD%E8%AF%81"><span class="nav-text">创建neutron相关服务凭证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="nav-text">安装配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="nav-text">安装软件包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE"><span class="nav-text">内核配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEneutron-conf"><span class="nav-text">配置neutron.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEml2-conf-ini"><span class="nav-text">配置ml2_conf.ini</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEnova-conf"><span class="nav-text">配置nova.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96neutron%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">初始化neutron数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEl3-agent-ini%EF%BC%88self-networking%EF%BC%89"><span class="nav-text">配置l3_agent.ini（self-networking）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEdhcp-agent-ini"><span class="nav-text">配置dhcp_agent.ini</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEmetadata-agent-ini"><span class="nav-text">配置metadata_agent.ini</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEopenvswitch-agent-ini"><span class="nav-text">配置openvswitch_agent.ini</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8openvswitch%E6%9C%8D%E5%8A%A1"><span class="nav-text">启动openvswitch服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E6%A1%A5br-ex"><span class="nav-text">创建网桥br-ex</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-2"><span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81-2"><span class="nav-text">验证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%9D%E3%80%81Neutron%E8%AE%A1%E7%AE%97%E8%8A%82%E7%82%B9%EF%BC%88openvswitch%E6%96%B9%E5%BC%8F%EF%BC%89"><span class="nav-text">九、Neutron计算节点（openvswitch方式）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85neutron-openvswitch"><span class="nav-text">安装neutron-openvswitch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE-1"><span class="nav-text">内核配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEmetadata-agent-ini-1"><span class="nav-text">配置metadata_agent.ini</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEl3-agent-ini%EF%BC%88self-networking%EF%BC%89-1"><span class="nav-text">配置l3_agent.ini（self-networking）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEopenvswitch-agent-ini-1"><span class="nav-text">配置openvswitch_agent.ini</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEneutron-conf-1"><span class="nav-text">配置neutron.conf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEnova-conf-1"><span class="nav-text">配置nova.conf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8openvswitch%E6%9C%8D%E5%8A%A1-1"><span class="nav-text">启动openvswitch服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E6%A1%A5br-ex-1"><span class="nav-text">创建网桥br-ex</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-3"><span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81-3"><span class="nav-text">验证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E3%80%81Horazion%E4%BB%AA%E8%A1%A8%E7%9B%98%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-text">十、Horazion仪表盘集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85dashboard"><span class="nav-text">安装dashboard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AElocal-settings"><span class="nav-text">配置local_settings</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEopenstack-dashboard-conf"><span class="nav-text">配置openstack-dashboard.conf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%90%AFapache%E5%92%8Cmemcache"><span class="nav-text">重启apache和memcache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E8%AE%BF%E9%97%AE"><span class="nav-text">验证访问</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E5%B9%B6%E5%90%AF%E5%8A%A8%E5%AE%9E%E4%BE%8B%E6%93%8D%E4%BD%9C"><span class="nav-text">十一、创建虚拟网络并启动实例操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAexternal%E5%A4%96%E9%83%A8%E7%BD%91%E7%BB%9C"><span class="nav-text">创建external外部网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%B7%AF%E7%94%B1"><span class="nav-text">创建路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%89%E5%85%A8%E7%BB%84"><span class="nav-text">创建安全组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B%E7%B1%BB%E5%9E%8B"><span class="nav-text">创建实例类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAvpc%E7%BD%91%E7%BB%9C"><span class="nav-text">创建vpc网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B"><span class="nav-text">创建实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E5%90%8Cvpc%E5%86%85%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="nav-text">不同vpc内主机之间通信</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%AE%E5%8A%A8IP"><span class="nav-text">浮动IP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81Ceph%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-text">十二、Ceph集群部署</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%89%E3%80%81Cinder%E9%83%A8%E7%BD%B2"><span class="nav-text">十三、Cinder部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Cinder%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-text">Cinder控制节点集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAcinder%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">创建cinder数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAcinder%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1%E5%87%AD%E8%AF%81"><span class="nav-text">创建cinder相关服务凭证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E4%B8%8E%E9%85%8D%E7%BD%AEcinder"><span class="nav-text">部署与配置cinder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96cinder%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">初始化cinder数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-4"><span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9%E9%AA%8C%E8%AF%81"><span class="nav-text">控制节点验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cinder%E5%AD%98%E5%82%A8%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-text">Cinder存储节点集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Openstack%E7%9A%84%E5%AD%98%E5%82%A8%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">Openstack的存储面临的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85cinder"><span class="nav-text">安装cinder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEcinder-conf"><span class="nav-text">配置cinder.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-5"><span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81"><span class="nav-text">在控制节点进行验证</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81%E5%AF%B9%E6%8E%A5Ceph%E5%AD%98%E5%82%A8"><span class="nav-text">十四、对接Ceph存储</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#openstack-%E9%9B%86%E7%BE%A4%E5%87%86%E5%A4%87"><span class="nav-text">openstack 集群准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E9%83%A8%E8%8A%82%E7%82%B9%E4%B8%8A%E6%B7%BB%E5%8A%A0ceph%E7%9A%84yum%E6%BA%90"><span class="nav-text">全部节点上添加ceph的yum源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Ceph%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">安装Ceph客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E8%A6%81%E6%9C%89ceph%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-ceph%E9%9B%86%E7%BE%A4%E4%B8%8A%E6%93%8D%E4%BD%9C"><span class="nav-text">需要有ceph的配置文件(ceph集群上操作)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ceph-%E9%9B%86%E7%BE%A4%E5%87%86%E5%A4%87"><span class="nav-text">ceph 集群准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E8%AF%B4%E6%98%8E"><span class="nav-text">需求说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90"><span class="nav-text">原理解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BApool%E6%B1%A0"><span class="nav-text">创建pool池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81"><span class="nav-text">ceph授权认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%88%E6%9D%83%E6%B7%BB%E5%8A%A0%E5%88%B0Libvirt%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="nav-text">授权添加到Libvirt守护进程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEglance%E9%9B%86%E6%88%90ceph"><span class="nav-text">配置glance集成ceph</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEglance-api-conf-1"><span class="nav-text">配置glance-api.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E6%B5%8B%E8%AF%95"><span class="nav-text">上传镜像测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E9%95%9C%E5%83%8F%E5%92%8Cglance%E6%B1%A0%E6%95%B0%E6%8D%AE"><span class="nav-text">查看镜像和glance池数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ceph%E6%89%A7%E8%A1%8Cimage%E9%95%9C%E5%83%8F%E7%9A%84%E6%AD%A5%E9%AA%A4%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="nav-text">Ceph执行image镜像的步骤过程详解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Ceph%E4%BD%9C%E4%B8%BACinder%E7%9A%84%E5%90%8E%E7%AB%AF%E5%AD%98%E5%82%A8"><span class="nav-text">使用Ceph作为Cinder的后端存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEcinder-conf-1"><span class="nav-text">配置cinder.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%90%AFcinder-volume%E6%9C%8D%E5%8A%A1"><span class="nav-text">重启cinder-volume服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="nav-text">验证服务状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%A9%BA%E7%99%BD%E5%8D%B7Volume%E6%B5%8B%E8%AF%95"><span class="nav-text">创建空白卷Volume测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E9%95%9C%E5%83%8F%E5%88%9B%E5%BB%BAVolume%E6%B5%8B%E8%AF%95"><span class="nav-text">从镜像创建Volume测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E9%95%9C%E5%83%8F%E5%88%9B%E5%BB%BA%E7%9A%84%E5%8D%B7%E7%94%9F%E6%88%90%E5%BF%AB%E7%85%A7%E6%B5%8B%E8%AF%95"><span class="nav-text">为镜像创建的卷生成快照测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-Volume%E5%8D%B7%E5%A4%87%E4%BB%BD%E6%B5%8B%E8%AF%95"><span class="nav-text">创建 Volume卷备份测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Ceph%E4%BD%9C%E4%B8%BANova%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AD%98%E5%82%A8"><span class="nav-text">使用Ceph作为Nova的虚拟机存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEceph-conf"><span class="nav-text">配置ceph.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEnova-conf-2"><span class="nav-text">配置nova.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%90%AF%E8%AE%A1%E7%AE%97%E6%9C%8D%E5%8A%A1"><span class="nav-text">重启计算服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AElive-migration%E7%83%AD%E8%BF%81%E7%A7%BB"><span class="nav-text">配置live-migration热迁移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E8%8A%82%E7%82%B9%E8%AE%BE%E7%BD%AE%E5%85%8D%E5%AF%86%E8%AE%BF%E9%97%AE"><span class="nav-text">计算节点设置免密访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEiptables"><span class="nav-text">设置iptables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E9%87%8D%E5%90%AF%E6%9C%8D%E5%8A%A1"><span class="nav-text">需重启服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E7%83%AD%E8%BF%81%E7%A7%BB"><span class="nav-text">验证热迁移</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%BA%94%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1Octavia%E9%83%A8%E7%BD%B2"><span class="nav-text">十五、负载均衡Octavia部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-haproxy-%E9%85%8D%E7%BD%AE"><span class="nav-text">更新 haproxy 配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">创建数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAoctavia%E7%9A%84keystone%E8%AE%A4%E8%AF%81%E4%BD%93%E7%B3%BB%EF%BC%88%E7%94%A8%E6%88%B7%E3%80%81%E8%A7%92%E8%89%B2%E3%80%81endpoint%EF%BC%89"><span class="nav-text">创建octavia的keystone认证体系（用户、角色、endpoint）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E5%8C%85-1"><span class="nav-text">安装软件包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%B6%E4%BD%9CAmphora%E9%95%9C%E5%83%8F"><span class="nav-text">制作Amphora镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7-git"><span class="nav-text">升级 git</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B%E5%88%B6%E4%BD%9C"><span class="nav-text">开始制作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E8%A1%8C%E4%B8%8B%E8%BD%BDcentos%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C"><span class="nav-text">自行下载centos镜像制作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E9%95%9C%E5%83%8F"><span class="nav-text">导入镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B%E6%A8%A1%E6%9D%BF"><span class="nav-text">创建实例模板</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%A4%E8%AF%81%E5%AF%86%E9%92%A5"><span class="nav-text">创建认证密钥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%89%E5%85%A8%E7%BB%84-1"><span class="nav-text">创建安全组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%99%BB%E9%99%86-amphora-%E5%AE%9E%E4%BE%8B%E7%9A%84-ssh-key"><span class="nav-text">创建登陆 amphora 实例的 ssh key</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-dhclient-conf-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">创建 dhclient.conf 配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C"><span class="nav-text">创建网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#controller01%E6%89%A7%E8%A1%8C"><span class="nav-text">controller01执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#controller02%E6%89%A7%E8%A1%8C"><span class="nav-text">controller02执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#controller03%E6%89%A7%E8%A1%8C"><span class="nav-text">controller03执行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="nav-text">修改配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">初始化数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-6"><span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7dashboard%E5%BC%80%E5%90%AF"><span class="nav-text">升级dashboard开启</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-loadbalancer"><span class="nav-text">创建 loadbalancer</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E7%BB%84%E4%BB%B6"><span class="nav-text">其他组件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BD%95"><span class="nav-text">错误记录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#libvirtError-internal-error-End-of-file-from-qemu-monitor"><span class="nav-text">libvirtError: internal error: End of file from qemu monitor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lost-connection-to-MySQL-server-during-query"><span class="nav-text">Lost connection to MySQL server during query</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Could-not-sign-the-certificate-request-Failed-to-load-CA-Certificate"><span class="nav-text">Could not sign the certificate request: Failed to load CA Certificate</span></a></li></ol></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>
            
            

        </div>

        <div class="main-content-footer">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2023</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-light fa-whale fa-bounce"></i>&nbsp;&nbsp;<a href="/">Chromy Chen</a>
        </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a></span>
                <br>
            <span class="theme-version-container">THEME&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.7.1</a>
        </div>
        
        
        
        
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    


</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/layouts/navbarShrink.js"></script>

<script src="/js/tools/scrollTopBottom.js"></script>

<script src="/js/tools/lightDarkSwitch.js"></script>





    
<script src="/js/tools/codeBlock.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>






  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>







<div class="post-scripts pjax">
    
        
<script src="/js/tools/tocToggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/layouts/toc.js"></script>

<script src="/js/plugins/tabs.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax',
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            Global.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            Global.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            Global.refresh();
        });
    });
</script>




</body>
</html>
